<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>User Management - 8BFR</title>
  <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Work+Sans:wght@300;400;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    :root { --primary:#7c3aed; --dark:#0b0014; --card:#0c0618; --text:#eae6ff; --border:rgba(124,58,237,.35); --red:#ff0044; }
    * { margin:0; padding:0; box-sizing:border-box; }
    body { font-family:'Work Sans',sans-serif; background:linear-gradient(#0b0014,#000); color:var(--text); min-height:100vh; }
    .header { background:rgba(15,0,30,.9); border-bottom:2px solid var(--primary); padding:1.25rem 2rem; display:flex; justify-content:space-between; align-items:center; position:sticky; top:0; z-index:50; }
    .header h1 { font-family:'Bebas Neue',cursive; font-size:1.8rem; color:var(--primary); }
    .container { max-width:1200px; margin:0 auto; padding:2rem; }
    .card { background:var(--card); border:1px solid var(--border); border-radius:16px; padding:1.5rem; margin-bottom:1.5rem; }
    .notice { background:rgba(255,0,68,0.08); border:1px solid rgba(255,0,68,0.3); border-radius:8px; padding:1rem; margin-bottom:1.25rem; font-size:0.88rem; color:#ffb3c6; line-height:1.8; }
    .notice code { background:rgba(0,0,0,0.4); padding:0.3rem 0.5rem; border-radius:4px; font-family:monospace; font-size:0.82em; display:block; margin-top:0.5rem; word-break:break-all; }
    .search-row { display:flex; gap:0.75rem; margin-bottom:1rem; align-items:center; flex-wrap:wrap; }
    .search-box { flex:1; min-width:180px; padding:0.7rem 1rem; background:var(--dark); border:1px solid var(--border); border-radius:8px; color:var(--text); font-size:0.9rem; }
    .btn { background:var(--primary); color:white; border:none; padding:0.55rem 1.1rem; border-radius:6px; cursor:pointer; font-weight:600; font-size:0.85rem; transition:opacity 0.2s; }
    .btn:hover { opacity:0.85; }
    .btn-danger { background:var(--red); }
    .btn-green { background:#059669; }
    .btn-gray { background:#444; }
    .user-item { background:var(--dark); border:1px solid var(--border); padding:1rem 1.25rem; margin-bottom:0.5rem; border-radius:10px; display:flex; justify-content:space-between; align-items:center; gap:1rem; }
    .user-meta { flex:1; min-width:0; }
    .user-name { font-weight:700; color:#a855f7; font-size:1rem; }
    .user-detail { font-size:0.8rem; color:rgba(234,230,255,0.55); margin-top:0.15rem; }
    .role-pill { display:inline-block; padding:0.15rem 0.6rem; border-radius:20px; font-size:0.72rem; font-weight:700; margin-left:0.4rem; }
    .role-owner { background:rgba(245,158,11,0.15); color:#f59e0b; border:1px solid rgba(245,158,11,0.3); }
    .role-admin { background:rgba(124,58,237,0.2); color:#a855f7; border:1px solid var(--border); }
    .role-mod { background:rgba(0,217,255,0.1); color:#00d9ff; border:1px solid rgba(0,217,255,0.3); }
    .role-music { background:rgba(0,255,136,0.1); color:#00ff88; border:1px solid rgba(0,255,136,0.3); }
    .modal { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.85); z-index:1000; align-items:flex-start; justify-content:center; padding:2rem 1rem; overflow-y:auto; }
    .modal.show { display:flex; }
    .modal-box { background:var(--card); border:1px solid var(--border); border-radius:16px; padding:2rem; width:100%; max-width:560px; margin:auto; }
    .modal-box h2 { color:var(--primary); margin-bottom:1.5rem; font-family:'Bebas Neue',cursive; font-size:1.6rem; }
    .form-group { margin-bottom:1rem; }
    .form-group label { display:block; margin-bottom:0.4rem; font-size:0.88rem; font-weight:600; color:rgba(234,230,255,0.7); }
    .form-input { width:100%; padding:0.7rem 0.9rem; background:var(--dark); border:1px solid var(--border); border-radius:8px; color:var(--text); font-size:0.9rem; }
    .form-input:focus { outline:none; border-color:#a855f7; }
    .section-label { font-size:0.78rem; font-weight:700; color:#a855f7; text-transform:uppercase; letter-spacing:0.06em; margin:1.25rem 0 0.5rem; }
    .badge-grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(155px,1fr)); gap:0.3rem; }
    .bci { display:flex; align-items:center; gap:0.45rem; padding:0.4rem 0.6rem; border-radius:6px; border:1px solid rgba(124,58,237,0.2); background:rgba(124,58,237,0.04); cursor:pointer; transition:all 0.15s; }
    .bci:hover { border-color:rgba(124,58,237,0.5); background:rgba(124,58,237,0.1); }
    .bci input { cursor:pointer; accent-color:#7c3aed; flex-shrink:0; }
    .bci label { cursor:pointer; font-size:0.82rem; }
    .modal-footer { display:flex; gap:0.75rem; margin-top:1.5rem; flex-wrap:wrap; }
    .notice-msg { margin-top:0.75rem; font-size:0.85rem; }
    .spinner { width:28px; height:28px; border-radius:50%; border:3px solid rgba(168,85,247,0.2); border-top-color:#a855f7; animation:spin 0.7s linear infinite; margin:2rem auto; }
    @keyframes spin { to { transform:rotate(360deg); } }
  </style>
</head>
<body>
  <div class="header">
    <h1>üë• User Management</h1>
    <a href="owner-panel.html" style="color:var(--text);text-decoration:none;font-weight:600;">‚Üê Back</a>
  </div>
  <div class="container">

    <div class="notice" id="rlsNotice">
      ‚ö†Ô∏è <strong>If saves aren't working</strong>, add this RLS policy in Supabase ‚Üí SQL Editor:
      <code>CREATE POLICY "Owners manage profiles" ON public.profiles FOR ALL USING ( (SELECT role FROM public.profiles WHERE user_id = auth.uid()) = 'owner' );</code>
      <button onclick="document.getElementById('rlsNotice').style.display='none'" style="background:none;border:1px solid rgba(255,0,68,0.4);color:#ffb3c6;padding:0.25rem 0.75rem;border-radius:4px;cursor:pointer;margin-top:0.75rem;display:block;">Dismiss</button>
    </div>

    <!-- REAL USERS -->
    <div class="card">
      <div class="search-row">
        <input type="text" class="search-box" id="searchBox" placeholder="Search by username, role, or badges‚Ä¶" oninput="searchUsers()">
        <a href="https://supabase.com/dashboard/project/novbuvwpjnxwwvdekjhr/auth/users" target="_blank" class="btn btn-green">‚ûï Add Real User</a>
        <button class="btn" style="background:#0e7490;" onclick="showDummySection()">ü§ñ Dummy Accounts</button>
      </div>
      <div id="userList"><div class="spinner"></div></div>
    </div>

    <!-- DUMMY ACCOUNTS SECTION (inside container so it gets proper padding) -->
    <div id="dummySection" style="display:none;">
      <div class="card" style="border-color:rgba(14,116,144,0.5);">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem;">
          <h2 style="font-family:'Bebas Neue',cursive;color:#22d3ee;font-size:1.4rem;letter-spacing:1px;">ü§ñ Dummy Accounts <span style="font-size:0.75rem;color:rgba(234,230,255,0.4);font-family:'Work Sans',sans-serif;font-weight:normal;">(cosmetic only ‚Äî stored in Supabase dummy_profiles table, cannot log in)</span></h2>
          <button class="btn btn-gray" onclick="hideDummySection()">‚úï Close</button>
        </div>

        <div style="display:grid;grid-template-columns:1fr 1fr;gap:0.75rem;margin-bottom:1rem;">
          <div class="form-group" style="margin:0;">
            <label>Username *</label>
            <input class="form-input" type="text" id="dUsername" placeholder="e.g. beatking99">
          </div>
          <div class="form-group" style="margin:0;">
            <label>Display Name</label>
            <input class="form-input" type="text" id="dDispName" placeholder="e.g. Beat King">
          </div>
          <div class="form-group" style="margin:0;">
            <label>Primary Role</label>
            <select class="form-input" id="dRole"></select>
          </div>
          <div class="form-group" style="margin:0;">
            <label>Bio</label>
            <input class="form-input" type="text" id="dBio" placeholder="Short bio‚Ä¶">
          </div>
        </div>
        <div style="display:flex;align-items:center;gap:1.5rem;margin-bottom:1rem;flex-wrap:wrap;">
          <label style="display:flex;align-items:center;gap:0.5rem;cursor:pointer;font-size:0.9rem;">
            <input type="checkbox" id="dVerified" style="accent-color:#7c3aed;"> üõ°Ô∏è Verified
          </label>
          <div style="display:flex;align-items:center;gap:0.75rem;">
            <div id="dAvatarPreview" style="width:48px;height:48px;border-radius:50%;background:rgba(14,116,144,0.3);border:2px dashed rgba(34,211,238,0.4);display:flex;align-items:center;justify-content:center;font-size:1.2rem;overflow:hidden;">ü§ñ</div>
            <div>
              <label style="font-size:0.85rem;color:rgba(234,230,255,0.6);display:block;margin-bottom:0.25rem;">Avatar (optional)</label>
              <input type="file" id="dAvatarFile" accept="image/*" onchange="previewDummyAvatar()" style="font-size:0.8rem;color:var(--text);">
            </div>
          </div>
        </div>
        <button class="btn" style="background:#0e7490;" onclick="createDummy()">+ Create Dummy</button>
        <div id="dNotice" style="margin-top:0.5rem;font-size:0.85rem;"></div>

        <div id="dummyList" style="margin-top:1.25rem;"></div>
      </div>
    </div>

  </div><!-- end .container -->

  <!-- EDIT MODAL -->
  <div id="editModal" class="modal">
    <div class="modal-box">
      <h2>‚úèÔ∏è Edit User</h2>
      <input type="hidden" id="eUserId">
      <div class="form-group"><label>Username</label><input class="form-input" type="text" id="eUsername"></div>
      <div class="form-group"><label>Display Name</label><input class="form-input" type="text" id="eDispName"></div>
      <div class="form-group"><label>Bio</label><textarea class="form-input" id="eBio" rows="2"></textarea></div>
      <div class="form-group"><label>Primary Role</label><select class="form-input" id="eRole"></select></div>
      <div class="section-label">üéµ Music Creator Badges</div>
      <div class="badge-grid" id="eMusicBadges"></div>
      <div class="section-label">üåê Community Badges</div>
      <div class="badge-grid" id="eCommunityBadges"></div>
      <div class="section-label">üèÖ Special Badges</div>
      <div class="badge-grid" id="eSpecialBadges"></div>
      <div class="form-group" style="margin-top:1rem;">
        <label style="display:flex;align-items:center;gap:0.5rem;cursor:pointer;font-weight:normal;">
          <input type="checkbox" id="eVerified" style="accent-color:#7c3aed;"> üõ°Ô∏è Verified Artist/Beatmaker
        </label>
      </div>
      <div class="modal-footer">
        <button class="btn" onclick="saveUser()">üíæ Save Changes</button>
        <button class="btn btn-gray" onclick="closeModal('editModal')">Cancel</button>
      </div>
      <div class="notice-msg" id="eNotice"></div>
    </div>
  </div>

  <script>
  const SUPABASE_URL = 'https://novbuvwpjnxwwvdekjhr.supabase.co';
  const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5vdmJ1dndwam54d3d2ZGVramhyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjExODkxODUsImV4cCI6MjA3Njc2NTE4NX0.1UUkdGafh6ZplAX8hi7Bvj94D2gvFQZUl0an1RvcSA0';
  const db = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

  const ROLES = [
    {v:'fan',l:'üíé Fan'},{v:'artist',l:'üé§ Artist'},{v:'beatmaker',l:'üéöÔ∏è Beatmaker'},
    {v:'producer',l:'üéß Producer'},{v:'rapper',l:'üé§ Rapper'},{v:'singer',l:'üéôÔ∏è Singer'},
    {v:'songwriter',l:'üéº Songwriter'},{v:'dj',l:'üìÄ DJ'},{v:'musician',l:'üé∏ Musician'},
    {v:'engineer',l:'üéõÔ∏è Engineer'},{v:'label',l:'üè∑Ô∏è Label'},{v:'promoter',l:'üöÄ Promoter'},
    {v:'designer',l:'üé® Designer'},{v:'influencer',l:'üí´ Influencer'},{v:'blogger',l:'üì∞ Blogger'},
    {v:'developer',l:'üß† Developer'},{v:'streamer',l:'üì° Streamer'},{v:'gamer',l:'üéÆ Gamer'},
    {v:'mod',l:'üí¨ Moderator'},{v:'admin',l:'‚öôÔ∏è Admin'},{v:'owner',l:'üëë Owner'}
  ];
  const MUSIC_B = [
    {v:'artist',l:'üé§ Artist'},{v:'beatmaker',l:'üéöÔ∏è Beatmaker'},{v:'producer',l:'üéß Producer'},
    {v:'rapper',l:'üé§ Rapper'},{v:'singer',l:'üéôÔ∏è Singer'},{v:'songwriter',l:'üéº Songwriter'},
    {v:'dj',l:'üìÄ DJ'},{v:'musician',l:'üé∏ Musician'},{v:'engineer',l:'üéõÔ∏è Engineer'},
    {v:'label',l:'üè∑Ô∏è Label'},{v:'promoter',l:'üöÄ Promoter'},{v:'designer',l:'üé® Designer'}
  ];
  const COMMUNITY_B = [
    {v:'influencer',l:'üí´ Influencer'},{v:'community_leader',l:'üë• Community Leader'},
    {v:'fan',l:'üíé Fan'},{v:'supporter',l:'ü§ù Supporter'},{v:'mentor',l:'üß≠ Mentor'},
    {v:'blogger',l:'üì∞ Blogger'},{v:'developer',l:'üß† Developer'},{v:'streamer',l:'üì° Streamer'},{v:'gamer',l:'üéÆ Gamer'}
  ];
  const SPECIAL_B = [
    {v:'verified',l:'üõ°Ô∏è Verified'},{v:'founder',l:'‚ö° Founder'},{v:'vip_member',l:'üéñÔ∏è VIP'},
    {v:'donor',l:'üí∞ Donor'},{v:'sponsor',l:'üíµ Sponsor'},{v:'beta_tester',l:'üß™ Beta Tester'},
    {v:'early_supporter',l:'üé´ Early Supporter'},{v:'top_creator',l:'üèÖ Top Creator'},{v:'g7',l:'üëë G7'}
  ];

  let allUsers = [];

  function buildRoleSelect(elId) {
    const el = document.getElementById(elId);
    if (el) el.innerHTML = ROLES.map(r => `<option value="${r.v}">${r.l}</option>`).join('');
  }
  function buildBadgeGrid(elId, items, prefix) {
    const el = document.getElementById(elId);
    if (el) el.innerHTML = items.map(b =>
      `<div class="bci"><input type="checkbox" id="${prefix}_${b.v}" value="${b.v}"><label for="${prefix}_${b.v}">${b.l}</label></div>`
    ).join('');
  }
  function getChecked(prefix) {
    return [...document.querySelectorAll(`input[id^="${prefix}_"]:checked`)].map(el => el.value);
  }
  function setChecked(prefix, vals) {
    document.querySelectorAll(`input[id^="${prefix}_"]`).forEach(el => { el.checked = vals.includes(el.value); });
  }
  function setNotice(id, msg, color) {
    const el = document.getElementById(id);
    if (el) { el.textContent = msg; el.style.color = color || '#a855f7'; }
  }

  async function init() {
    buildRoleSelect('eRole');
    buildBadgeGrid('eMusicBadges', MUSIC_B, 'eb');
    buildBadgeGrid('eCommunityBadges', COMMUNITY_B, 'eb');
    buildBadgeGrid('eSpecialBadges', SPECIAL_B, 'eb');

    const { data: { user } } = await db.auth.getUser();
    if (!user) { window.location.href = 'login.html'; return; }

    const { data: profile } = await db
      .from('profiles')
      .select('role, username, user_id')
      .eq('user_id', user.id)
      .single();

    if (!profile || profile.role !== 'owner') {
      alert('Owner access only. Your role: ' + (profile?.role || 'none'));
      window.location.href = 'owner-panel.html';
      return;
    }

    loadUsers();
  }

  async function loadUsers() {
    const { data, error } = await db.from('profiles')
      .select('user_id, username, display_name, bio, role, badges, tags, verified_artist, avatar_url, created_at')
      .order('created_at', { ascending: false });
    if (error) { document.getElementById('userList').innerHTML = `<p style="color:#ff0044;">${error.message}</p>`; return; }
    allUsers = data || [];
    displayUsers(allUsers);
  }

  function getBadges(u) {
    // Support both 'badges' and 'tags' column names
    if (Array.isArray(u.badges) && u.badges.length) return u.badges;
    if (Array.isArray(u.tags) && u.tags.length) return u.tags;
    return [];
  }

  function rolePill(role) {
    const cls = role==='owner'?'role-owner':role==='admin'?'role-admin':role==='mod'?'role-mod':['artist','beatmaker','rapper','producer','singer','songwriter','dj'].includes(role)?'role-music':'';
    return cls ? `<span class="role-pill ${cls}">${role}</span>` : `<span style="font-size:0.78rem;color:rgba(234,230,255,0.5);margin-left:6px;">${role}</span>`;
  }

  function displayUsers(users) {
    const el = document.getElementById('userList');
    if (!users.length) { el.innerHTML = '<p style="text-align:center;padding:2rem;color:rgba(168,85,247,0.4);">No users found</p>'; return; }
    el.innerHTML = users.map(u => {
      const tags = getBadges(u);
      const badgeStr = tags.length ? tags.slice(0,6).join(', ')+(tags.length>6?` +${tags.length-6}`:'') : 'None';
      return `<div class="user-item">
        <div class="user-meta">
          <div class="user-name">${u.username||'No username'} ${rolePill(u.role||'fan')}</div>
          <div class="user-detail">${u.display_name?'üìõ '+u.display_name+' ¬∑ ':''}${u.verified_artist?'‚úì Verified ¬∑ ':''}üèÖ ${badgeStr}</div>
          <div class="user-detail" style="font-size:0.7rem;opacity:0.4;margin-top:2px;">ID: ${u.user_id}</div>
        </div>
        <div style="display:flex;gap:0.4rem;flex-shrink:0;">
          <button class="btn" onclick="editUser('${u.user_id}')">Edit</button>
          <button class="btn btn-danger" onclick="deleteUser('${u.user_id}','${(u.username||'').replace(/'/g,"\\'")}')">Del</button>
        </div>
      </div>`;
    }).join('');
  }

  function searchUsers() {
    const q = document.getElementById('searchBox').value.toLowerCase().trim();
    if (!q) { displayUsers(allUsers); return; }
    displayUsers(allUsers.filter(u => {
      const tags = getBadges(u);
      return (u.username||'').toLowerCase().includes(q) ||
        (u.display_name||'').toLowerCase().includes(q) ||
        (u.role||'').toLowerCase().includes(q) ||
        tags.some(t=>t.toLowerCase().includes(q));
    }));
  }

  function closeModal(id) { document.getElementById(id).classList.remove('show'); }

  function editUser(userId) {
    const u = allUsers.find(x=>x.user_id===userId);
    if (!u) return;
    document.getElementById('eUserId').value = userId;
    document.getElementById('eUsername').value = u.username||'';
    document.getElementById('eDispName').value = u.display_name||'';
    document.getElementById('eBio').value = u.bio||'';
    document.getElementById('eRole').value = u.role||'fan';
    document.getElementById('eVerified').checked = !!u.verified_artist;
    setChecked('eb', getBadges(u));
    document.getElementById('editModal').classList.add('show');
  }

  async function saveUser() {
    const userId = document.getElementById('eUserId').value;
    const username = document.getElementById('eUsername').value.trim();
    const dispName = document.getElementById('eDispName').value.trim();
    const bio = document.getElementById('eBio').value.trim();
    const role = document.getElementById('eRole').value;
    const verified = document.getElementById('eVerified').checked;
    const badgeList = getChecked('eb');
    const allBadges = [...new Set([role,...badgeList])];
    if (!username) { setNotice('eNotice','‚ö†Ô∏è Username required.','#ef4444'); return; }
    setNotice('eNotice','Saving‚Ä¶','#a855f7');
    try {
      const { error } = await db.from('profiles')
        .update({ username, display_name:dispName, bio, role, badges:allBadges, tags:allBadges, verified_artist:verified })
        .eq('user_id', userId);
      if (error) throw error;
      setNotice('eNotice','‚úÖ Saved!','#4ade80');
      const idx = allUsers.findIndex(x=>x.user_id===userId);
      if (idx>=0) allUsers[idx] = {...allUsers[idx], username, display_name:dispName, bio, role, badges:allBadges, tags:allBadges, verified_artist:verified};
      displayUsers(allUsers);
      setTimeout(()=>closeModal('editModal'), 800);
    } catch(err) { setNotice('eNotice','‚ùå '+err.message+' ‚Äî Check RLS policy (see notice at top).','#ef4444'); }
  }

  async function deleteUser(userId, username) {
    if (!confirm(`Delete "${username}" profile? This removes their profile but NOT their auth account. To fully delete, also remove from Supabase Auth.`)) return;
    const { error } = await db.from('profiles').delete().eq('user_id', userId);
    if (error) { alert('Error: '+error.message); return; }
    allUsers = allUsers.filter(u=>u.user_id!==userId);
    displayUsers(allUsers);
  }

  init();

  // ‚îÄ‚îÄ DUMMY ACCOUNTS (Supabase dummy_profiles table) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  // These are cosmetic-only profiles. They do NOT create auth accounts,
  // cannot log in, and exist purely to make the site look fuller.

  function showDummySection() {
    document.getElementById('dummySection').style.display = 'block';
    buildRoleSelect('dRole');
    loadDummies();
    document.getElementById('dummySection').scrollIntoView({ behavior: 'smooth' });
  }

  function hideDummySection() {
    document.getElementById('dummySection').style.display = 'none';
  }

  async function loadDummies() {
    const el = document.getElementById('dummyList');
    el.innerHTML = '<div class="spinner"></div>';
    const { data, error } = await db.from('dummy_profiles')
      .select('*')
      .order('created_at', { ascending: false });
    if (error) {
      el.innerHTML = `<p style="color:#f87171;">‚ùå ${error.message}</p>`;
      return;
    }
    renderDummies(data || []);
  }

  function previewDummyAvatar() {
    const file = document.getElementById('dAvatarFile').files[0];
    const preview = document.getElementById('dAvatarPreview');
    if (!file) return;
    const reader = new FileReader();
    reader.onload = e => { preview.innerHTML = `<img src="${e.target.result}" style="width:100%;height:100%;object-fit:cover;">`; };
    reader.readAsDataURL(file);
  }

  async function uploadAvatarToStorage(file, filename) {
    const { data, error } = await db.storage
      .from('avatars')
      .upload(`dummy/${filename}`, file, { upsert: true, contentType: file.type });
    if (error) throw error;
    const { data: urlData } = db.storage.from('avatars').getPublicUrl(`dummy/${filename}`);
    return urlData.publicUrl;
  }

  async function createDummy() {
    const username = document.getElementById('dUsername').value.trim();
    const dispName = document.getElementById('dDispName').value.trim();
    const role = document.getElementById('dRole').value;
    const bio = document.getElementById('dBio').value.trim();
    const verified = document.getElementById('dVerified').checked;
    const tags = [role];
    const avatarFile = document.getElementById('dAvatarFile').files[0];

    if (!username) { document.getElementById('dNotice').innerHTML = '<span style="color:#f87171;">‚ö†Ô∏è Username required</span>'; return; }

    document.getElementById('dNotice').innerHTML = '<span style="color:#a855f7;">Creating‚Ä¶</span>';

    let avatar_url = null;
    if (avatarFile) {
      try {
        document.getElementById('dNotice').innerHTML = '<span style="color:#a855f7;">Uploading avatar‚Ä¶</span>';
        const ext = avatarFile.name.split('.').pop();
        avatar_url = await uploadAvatarToStorage(avatarFile, `${username}_${Date.now()}.${ext}`);
      } catch(e) {
        document.getElementById('dNotice').innerHTML = `<span style="color:#f87171;">‚ùå Avatar upload failed: ${e.message}</span>`;
        return;
      }
    }

    document.getElementById('dNotice').innerHTML = '<span style="color:#a855f7;">Saving dummy profile‚Ä¶</span>';
    const { error } = await db.from('dummy_profiles').insert({
      username, display_name: dispName || username, role, bio, tags, verified_artist: verified, avatar_url
    });

    if (error) {
      document.getElementById('dNotice').innerHTML = `<span style="color:#f87171;">‚ùå ${error.message}</span>`;
      return;
    }

    document.getElementById('dUsername').value = '';
    document.getElementById('dDispName').value = '';
    document.getElementById('dBio').value = '';
    document.getElementById('dVerified').checked = false;
    document.getElementById('dAvatarFile').value = '';
    document.getElementById('dAvatarPreview').innerHTML = 'ü§ñ';
    document.getElementById('dNotice').innerHTML = '<span style="color:#4ade80;">‚úÖ Dummy created!</span>';
    setTimeout(() => document.getElementById('dNotice').innerHTML = '', 2000);
    loadDummies();
  }

  async function deleteDummy(id) {
    if (!confirm('Delete this dummy account?')) return;
    const { error } = await db.from('dummy_profiles').delete().eq('id', id);
    if (error) { alert('‚ùå ' + error.message); return; }
    loadDummies();
  }

  function renderDummies(list) {
    const el = document.getElementById('dummyList');
    if (!list.length) {
      el.innerHTML = '<p style="color:rgba(234,230,255,0.4);font-size:0.85rem;padding:0.5rem 0;">No dummy accounts yet. Create one above!</p>';
      return;
    }
    el.innerHTML = list.map(d => `
      <div class="user-item" style="border-color:rgba(14,116,144,0.4);">
        <div style="width:44px;height:44px;border-radius:50%;overflow:hidden;flex-shrink:0;background:rgba(14,116,144,0.3);display:flex;align-items:center;justify-content:center;font-size:1.2rem;">
          ${d.avatar_url ? `<img src="${d.avatar_url}" style="width:100%;height:100%;object-fit:cover;" onerror="this.parentElement.innerHTML='ü§ñ'">` : 'ü§ñ'}
        </div>
        <div class="user-meta">
          <div class="user-name">${d.username} ${d.verified_artist ? 'üõ°Ô∏è' : ''} <span class="role-pill" style="background:rgba(14,116,144,0.3);color:#22d3ee;">${d.role}</span> <span style="font-size:0.7rem;color:rgba(234,230,255,0.3);">DUMMY</span></div>
          <div class="user-detail">${d.display_name||''}${d.bio ? ' ¬∑ ' + d.bio : ''}</div>
          <div class="user-detail">Created: ${new Date(d.created_at).toLocaleDateString()}</div>
        </div>
        <div style="display:flex;gap:0.5rem;flex-wrap:wrap;justify-content:flex-end;">
          <label class="btn" style="background:#0e7490;cursor:pointer;font-size:0.8rem;" title="Change avatar">
            üñºÔ∏è
            <input type="file" accept="image/*" style="display:none;" onchange="changeDummyAvatar('${d.id}', '${d.username}', this)">
          </label>
          <button class="btn btn-danger" onclick="deleteDummy('${d.id}')">üóëÔ∏è</button>
        </div>
      </div>
    `).join('');
  }

  async function changeDummyAvatar(id, username, input) {
    const file = input.files[0];
    if (!file) return;
    const notice = document.getElementById('dNotice');
    notice.innerHTML = '<span style="color:#a855f7;">Uploading avatar‚Ä¶</span>';
    try {
      const ext = file.name.split('.').pop();
      const avatar_url = await uploadAvatarToStorage(file, `${username}_${Date.now()}.${ext}`);
      const { error } = await db.from('dummy_profiles').update({ avatar_url }).eq('id', id);
      if (error) throw error;
      notice.innerHTML = '<span style="color:#4ade80;">‚úÖ Avatar updated!</span>';
      setTimeout(() => notice.innerHTML = '', 2000);
      loadDummies();
    } catch(e) {
      notice.innerHTML = `<span style="color:#f87171;">‚ùå ${e.message}</span>`;
    }
  }
  </script>
</body>
</html>
