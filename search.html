<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Site Search</title>
  <style>
    :root{
      --bg:#040014;
      --card:#12051c;
      --accent:#a855f7;
      --muted:#b7a7dc;
      --text:#f4eeff;
      --focus: 3px rgba(168,85,247,0.12);
    }
    html,body{height:100%}
    body{
      background:linear-gradient(180deg,#03000a,#070016);
      color:var(--text);
      font-family:Inter,system-ui,Arial,Helvetica,sans-serif;
      margin:0;padding:20px;
      -webkit-font-smoothing:antialiased;
    }
    .container{max-width:980px;margin:0 auto}
    header{display:flex;flex-direction:column; gap:8px; margin-bottom:18px}
    h1{margin:0;font-size:1.3rem}
    .search-row{display:flex; gap:8px; align-items:center}
    input[type="search"]{
      flex:1;padding:10px 14px;border-radius:10px;border:1px solid rgba(255,255,255,0.06);
      background:rgba(255,255,255,0.02); color:var(--text); outline:none;
    }
    input[type="search"]:focus{box-shadow:var(--focus); border-color: rgba(168,85,247,0.6)}
    button{
      padding:10px 12px;border-radius:10px;background:linear-gradient(90deg,var(--accent),#7c3aed);
      border:none;color:#fff;cursor:pointer;
    }
    .filters{display:flex;gap:8px;margin-top:10px;flex-wrap:wrap}
    .chip{
      padding:6px 10px;border-radius:999px;background:rgba(255,255,255,0.03);
      border:1px solid rgba(168,85,247,0.06);cursor:pointer;color:var(--muted);
      user-select:none;
    }
    .chip.active{
      background:linear-gradient(90deg,var(--accent),#7c3aed);
      color:white;border-color:transparent;
      box-shadow:0 6px 18px rgba(124,58,237,0.18);
    }
    #searchResults{margin-top:18px}
    .result-card{
      background:rgba(255,255,255,0.02);border:1px solid rgba(168,85,247,0.04);
      padding:12px;border-radius:10px;margin-bottom:10px;display:flex;justify-content:space-between;
      gap:12px;align-items:flex-start;
    }
    .result-info{flex:1;margin-left:10px}
    .result-name{font-weight:700;color:#fff}
    .result-snippet{color:var(--muted);margin-top:6px;white-space:pre-wrap}
    .empty-state{text-align:center;padding:36px;border:1px dashed rgba(168,85,247,0.06);
      border-radius:12px;color:var(--muted)}
    .meta{color:var(--muted);font-size:12px}
    .results-count{color:var(--muted);font-size:13px;margin-bottom:8px}
    a.result-link{color:inherit;text-decoration:none}
    .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"></script>
</head>
<body>
  <div class="container" role="main">
    <header>
      <h1>Search the site</h1>
      <div class="search-row" role="search" aria-label="Site search">
        <input id="searchInput" type="search" placeholder="Search profiles, songs, posts, pages, content, ads, comments, coins..." aria-label="Search input" />
        <button id="searchBtn" aria-label="Run search">Search</button>
      </div>

      <div class="filters" id="sourceFilters" aria-hidden="false" role="list">
        <div class="chip active" data-src="all" role="listitem" tabindex="0">All</div>
        <div class="chip" data-src="profiles" role="listitem" tabindex="0">Profiles</div>
        <div class="chip" data-src="songs" role="listitem" tabindex="0">Songs</div>
        <div class="chip" data-src="posts" role="listitem" tabindex="0">Posts</div>
        <div class="chip" data-src="pages" role="listitem" tabindex="0">Pages</div>
        <div class="chip" data-src="content" role="listitem" tabindex="0">Content</div>
        <div class="chip" data-src="ads" role="listitem" tabindex="0">Ads</div>
        <div class="chip" data-src="comments" role="listitem" tabindex="0">Comments</div>
        <div class="chip" data-src="coins" role="listitem" tabindex="0">Coins</div>
      </div>
    </header>

    <main>
      <div id="searchResults" aria-live="polite">
        <div class="empty-state">
          <div style="font-size:3rem">ðŸ”Ž</div>
          <div style="font-weight:700;margin-top:8px">Start typing to search or click a category to browse</div>
          <div style="margin-top:6px;color:var(--muted)">Searching profiles, songs, posts, pages, content, ads, comments and coins</div>
        </div>
      </div>
    </main>
  </div>

  <script>
    const SUPABASE_URL = 'https://novbuvwpjnxwwvdekjhr.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5vdmJ1dndwam54d3d2ZGVramhyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjExODkxODUsImV4cCI6MjA3Njc2NTE4NX0.1UUkdGafh6ZplAX8hi7Bvj94D2gvFQZUl0an1RvcSA0';

    const { createClient } = window.supabase;
    const db = createClient(SUPABASE_URL, SUPABASE_KEY);

    const input = document.getElementById('searchInput');
    const btn = document.getElementById('searchBtn');
    const resultsEl = document.getElementById('searchResults');
    const chips = Array.from(document.querySelectorAll('.chip'));
    let activeSource = 'all';

    function escapeHtml(s) {
      if (s == null) return '';
      return String(s).replaceAll('&','&amp;').replaceAll('<','&lt;')
        .replaceAll('>','&gt;').replaceAll('"','&quot;').replaceAll("'",'&#039;');
    }

    function debounce(fn, wait) {
      let t;
      return (...args) => {
        clearTimeout(t);
        t = setTimeout(() => fn.apply(this, args), wait);
      };
    }

    function normalizeQuery(q) {
      return q.replace(/[\x00-\x1F\x7F]/g, ' ').replace(/\s+/g,' ').trim();
    }

    function validQuery(q) {
      if (!q) return false;
      const cleaned = normalizeQuery(q);
      if (cleaned.length < 2) return false;
      const tokens = cleaned.split(' ').filter(Boolean);
      return tokens.some(t => t.length >= 2);
    }

    // CHIP INTERACTIONS - Browse category when clicked
    chips.forEach(c => {
      c.addEventListener('click', () => setActiveChip(c));
      c.addEventListener('keydown', (e) => { if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); setActiveChip(c); } });
    });
    
    async function setActiveChip(c) {
      chips.forEach(x => x.classList.remove('active'));
      c.classList.add('active');
      activeSource = c.dataset.src || 'all';
      
      // If there's a search query, re-run search with new filter
      if (input.value && input.value.trim()) {
        doSiteSearch(input.value.trim());
      } else {
        // No search query - load ALL items from this category
        await loadAllFromCategory(activeSource);
      }
    }

    // LOAD ALL ITEMS FROM A CATEGORY
    async function loadAllFromCategory(source) {
      if (source === 'all') {
        renderEmpty();
        return;
      }

      resultsEl.innerHTML = '<div class="empty-state">Loading...</div>';

      try {
        let data = [];
        
        if (source === 'profiles') {
          const { data: profiles } = await db.from('profiles').select('user_id, username, display_name, bio, created_at').order('created_at', { ascending: false }).limit(100);
          data = (profiles || []).map(p => ({
            id: p.user_id,
            source: 'profiles',
            title: p.display_name || p.username || 'Profile',
            snippet: p.bio || '',
            created_at: p.created_at
          }));
        } else if (source === 'songs') {
          const { data: songs } = await db.from('songs').select('id, title, artist, uploaded_by, created_at').order('created_at', { ascending: false }).limit(100);
          data = (songs || []).map(s => ({
            id: s.id,
            source: 'songs',
            title: s.title,
            snippet: s.artist || '',
            created_at: s.created_at,
            uploaded_by: s.uploaded_by  // Add this for linking to artist profile
          }));
        } else if (source === 'posts') {
          const { data: posts } = await db.from('posts').select('id, text, created_at').order('created_at', { ascending: false }).limit(100);
          data = (posts || []).map(p => ({
            id: p.id,
            source: 'posts',
            title: (p.text || '').substring(0, 50),
            snippet: (p.text || '').substring(0, 200),
            created_at: p.created_at
          }));
        } else if (source === 'pages') {
          const { data: pages } = await db.from('pages').select('id, name, description, created_at').order('created_at', { ascending: false }).limit(100);
          data = (pages || []).map(p => ({
            id: p.id,
            source: 'pages',
            title: p.name,
            snippet: p.description || '',
            created_at: p.created_at
          }));
        } else if (source === 'ads') {
          const { data: ads } = await db.from('ads').select('id, title, description, created_at').order('created_at', { ascending: false }).limit(100);
          data = (ads || []).map(a => ({
            id: a.id,
            source: 'ads',
            title: a.title,
            snippet: a.description || '',
            created_at: a.created_at
          }));
        } else if (source === 'comments') {
          const { data: comments } = await db.from('comments').select('id, content, created_at').order('created_at', { ascending: false }).limit(100);
          data = (comments || []).map(c => ({
            id: c.id,
            source: 'comments',
            title: 'Comment',
            snippet: (c.content || '').substring(0, 200),
            created_at: c.created_at
          }));
        } else if (source === 'content') {
          const { data: content } = await db.from('content').select('id, title, content, created_at').order('created_at', { ascending: false }).limit(100);
          data = (content || []).map(c => ({
            id: c.id,
            source: 'content',
            title: c.title || 'Content',
            snippet: (c.content || '').substring(0, 200),
            created_at: c.created_at
          }));
        } else if (source === 'coins') {
          const { data: coins } = await db.from('coins').select('id, user_id, balance, updated_at').order('updated_at', { ascending: false }).limit(100);
          data = (coins || []).map(c => ({
            id: c.id,
            source: 'coins',
            title: 'Coin Balance',
            snippet: `Balance: ${c.balance}`,
            created_at: c.updated_at
          }));
        }

        renderCombinedResults(data);
        
      } catch (err) {
        console.error('Load error:', err);
        renderError(err?.message || String(err));
      }
    }

    // SEARCH LOGIC
    const doSiteSearch = debounce(async (qRaw) => {
      const q = normalizeQuery(qRaw || '');
      if (!validQuery(q)) {
        renderEmpty(qRaw ? 'Please enter a longer search term.' : null);
        return;
      }

      resultsEl.innerHTML = '<div class="empty-state">Searchingâ€¦</div>';

      try {
        const { data, error } = await db.rpc('site_search', { q: q, limit_rows: 200 });
        if (error) throw error;
        const items = Array.isArray(data) ? data : [];
        renderCombinedResults(items);
      } catch (err) {
        console.error('Search error', err);
        renderError(err?.message || String(err));
      }
    }, 220);

    btn.addEventListener('click', () => doSiteSearch(input.value.trim()));
    input.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') { e.preventDefault(); doSiteSearch(input.value.trim()); }
    });
    input.addEventListener('input', (e) => doSiteSearch(e.target.value));

    // RENDERERS
    function renderEmpty(note) {
      resultsEl.innerHTML = `
        <div class="empty-state">
          <div style="font-size:3rem">ðŸ”Ž</div>
          <div style="font-weight:700;margin-top:8px">${ note ? escapeHtml(note) : 'Start typing to search or click a category to browse' }</div>
          <div style="margin-top:6px;color:var(--muted)">Searching profiles, songs, posts, pages, content, ads, comments and coins</div>
        </div>
      `;
    }

    function renderError(msg) {
      resultsEl.innerHTML = `<div class="empty-state"><div style="font-weight:700">Error</div><div style="margin-top:6px;color:var(--muted)">${escapeHtml(msg)}</div></div>`;
    }

    function renderCombinedResults(items) {
      if (!items || items.length === 0) {
        resultsEl.innerHTML = '<div class="empty-state">No results</div>';
        return;
      }

      let filtered = items;
      if (activeSource && activeSource !== 'all') {
        filtered = items.filter(it => (it.source || '').toLowerCase() === activeSource.toLowerCase());
      }

      if (filtered.length === 0) {
        resultsEl.innerHTML = '<div class="empty-state">No results for selected category</div>';
        return;
      }

      const countHtml = `<div class="results-count">${filtered.length} result${filtered.length===1?'':'s'}</div>`;

      const labelMap = { profiles: 'Profiles', songs: 'Songs', posts: 'Posts', pages: 'Pages', content: 'Content', ads: 'Ads', comments: 'Comments', coins: 'Coins' };
      const iconMap = { profiles: 'ðŸ‘¤', songs: 'ðŸŽµ', posts: 'ðŸ“', pages: 'ðŸ“„', content: 'ðŸ“š', ads: 'ðŸ“¢', comments: 'ðŸ’¬', coins: 'ðŸª™' };

      const html = filtered.map(it => {
        const src = (it.source || '').toLowerCase();
        const title = escapeHtml(it.title || (src === 'profiles' ? 'Profile' : src || 'Result'));
        const snippet = escapeHtml((it.snippet || '').toString()).replace(/\n/g, ' ');
        const created = it.created_at ? new Date(it.created_at).toLocaleString() : '';
        let href = '#';
        if (src === 'profiles') href = `profile.html?id=${encodeURIComponent(it.id)}`;
        else if (src === 'songs') href = it.uploaded_by ? `profile.html?id=${encodeURIComponent(it.uploaded_by)}` : `song.html?id=${encodeURIComponent(it.id)}`;
        else if (src === 'posts') href = `feed.html`;
        else if (src === 'pages') href = `#`; // No page viewer yet
        else if (src === 'content') href = `#`; // No content viewer yet
        else if (src === 'ads') href = `all-ads.html`;
        else if (src === 'comments') href = `feed.html`;
        else if (src === 'coins') href = `#`; // No coin page
        else if (src === 'shop') href = `shop.html`;

        return `
          <div class="result-card" role="article" aria-labelledby="r-${escapeHtml(it.id)}">
            <div style="display:flex;align-items:center;gap:12px">
              <div style="font-size:22px">${iconMap[src] || 'ðŸ“Œ'}</div>
              <div class="result-info">
                <div class="result-name" id="r-${escapeHtml(it.id)}">
                  <a class="result-link" href="${href}">${title}</a>
                  <small style="color:var(--muted);font-weight:600;margin-left:8px">${escapeHtml(labelMap[src] || src)}</small>
                </div>
                <div class="result-snippet">${snippet}</div>
              </div>
            </div>
            <div style="text-align:right;min-width:120px;color:var(--muted);font-size:12px">
              <div>${escapeHtml(created)}</div>
              ${ typeof it.rank !== 'undefined' ? `<div class="meta">score: ${Number(it.rank).toFixed(3)}</div>` : '' }
            </div>
          </div>
        `;
      }).join('');

      resultsEl.innerHTML = countHtml + html;
    }

    renderEmpty();
    try { input.focus(); } catch(e){/*ignore*/}
  </script>

</body>
</html>
