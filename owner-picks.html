<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Owner Picks - 8BFR</title>
    <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Work+Sans:wght@300;400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { --primary: #7c3aed; --dark: #0b0014; --dark-card: #0c0618; --text: #eae6ff; --border: rgba(124,58,237,.35); }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Work Sans', sans-serif; background: radial-gradient(1200px 600px at 10% -10%, rgba(124,58,237,.35), transparent 60%), radial-gradient(900px 400px at 110% 10%, rgba(0,217,255,.22), transparent 60%), linear-gradient(#0b0014,#000); color: var(--text); min-height: 100vh; }
        .header { background: rgba(15,0,30,.9); border-bottom: 2px solid var(--primary); padding: 1.5rem 2rem; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 100; }
        .header h1 { font-family: 'Bebas Neue', cursive; font-size: 2rem; color: var(--primary); }
        .container { max-width: 1400px; margin: 0 auto; padding: 2rem; }
        .tabs { display: flex; gap: 0.5rem; margin-bottom: 2rem; border-bottom: 2px solid var(--border); }
        .tab { background: transparent; color: var(--text); border: none; padding: 1rem 1.5rem; cursor: pointer; font-weight: 600; border-bottom: 3px solid transparent; opacity: 0.6; }
        .tab.active { color: var(--primary); border-bottom-color: var(--primary); opacity: 1; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .card { background: var(--dark-card); border: 1px solid var(--border); border-radius: 16px; padding: 1.5rem; margin-bottom: 1.5rem; }
        .card h2 { color: var(--primary); margin-bottom: 1rem; font-size: 1.1rem; }
        .btn { background: var(--primary); color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 0.9rem; transition: filter 0.2s; }
        .btn:hover { filter: brightness(1.1); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-danger { background: #dc2626; }
        .btn-danger:hover { filter: brightness(1.1); }

        /* Dropdown styles */
        .artist-select {
            width: 100%;
            padding: 0.75rem;
            background: var(--dark);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text);
            font-size: 0.95rem;
            margin-bottom: 1rem;
            appearance: none;
            cursor: pointer;
        }
        .artist-select:focus { outline: none; border-color: var(--primary); }
        .select-wrapper { position: relative; }
        .select-wrapper::after { content: 'â–¾'; position: absolute; right: 1rem; top: 50%; transform: translateY(-60%); color: var(--primary); pointer-events: none; font-size: 1.1rem; }
        .search-box { width: 100%; padding: 0.75rem; background: var(--dark); border: 1px solid var(--border); border-radius: 8px; color: var(--text); margin-bottom: 1rem; font-size: 0.95rem; }
        .search-box:focus { outline: none; border-color: var(--primary); }

        /* Owner pick badge */
        .owner-pick-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.3rem;
            background: linear-gradient(135deg, #f59e0b, #d97706);
            color: white;
            padding: 0.2rem 0.6rem;
            border-radius: 20px;
            font-size: 0.72rem;
            font-weight: 700;
            letter-spacing: 0.03em;
            flex-shrink: 0;
        }

        /* Featured list */
        .featured-list { display: flex; flex-direction: column; gap: 0.75rem; }
        .featured-item {
            background: var(--dark);
            border: 1px solid var(--border);
            padding: 1rem;
            border-radius: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 1rem;
        }
        .featured-item:hover { border-color: rgba(124,58,237,0.6); }
        .featured-item-info { display: flex; align-items: center; gap: 0.75rem; flex: 1; min-width: 0; }
        .featured-avatar {
            width: 44px; height: 44px; border-radius: 50%;
            background: linear-gradient(135deg, #7c3aed, #a855f7);
            display: flex; align-items: center; justify-content: center;
            font-size: 1.2rem; flex-shrink: 0; overflow: hidden;
        }
        .featured-avatar img { width: 100%; height: 100%; object-fit: cover; }
        .featured-name { font-weight: 700; font-size: 0.95rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .featured-meta { font-size: 0.8rem; color: rgba(168,85,247,0.7); margin-top: 0.15rem; }

        .notice { padding: 0.75rem 1rem; border-radius: 8px; font-size: 0.88rem; margin-top: 0.75rem; }
        .notice.success { background: rgba(74,222,128,0.1); border: 1px solid rgba(74,222,128,0.3); color: #4ade80; }
        .notice.error { background: rgba(239,68,68,0.1); border: 1px solid rgba(239,68,68,0.3); color: #ef4444; }
        .notice.info { background: rgba(124,58,237,0.1); border: 1px solid rgba(124,58,237,0.3); color: #a855f7; }
        .empty-state { text-align: center; padding: 2rem; color: rgba(168,85,247,0.6); font-size: 0.9rem; }
    </style>
</head>
<body>
    <div class="header">
        <h1>â­ Owner Picks</h1>
        <a href="owner-panel.html" style="color: var(--text); text-decoration: none;">â† Back</a>
    </div>

    <div class="container">
        <div class="tabs">
            <button class="tab active" onclick="switchTab('artists', this)">ğŸ¤ Artists</button>
            <button class="tab" onclick="switchTab('songs', this)">ğŸµ Songs</button>
            <button class="tab" onclick="switchTab('posts', this)">ğŸ“ Posts</button>
        </div>

        <!-- Artists Tab -->
        <div id="tab-artists" class="tab-content active">
            <div class="card">
                <h2>Add Featured Artist</h2>
                <p style="font-size:0.85rem;color:rgba(168,85,247,0.7);margin-bottom:1rem;">Only artists and beatmakers are shown.</p>
                <div class="select-wrapper">
                    <select class="artist-select" id="artistDropdown">
                        <option value="">Loading artistsâ€¦</option>
                    </select>
                </div>
                <button class="btn" id="addArtistBtn" onclick="addFromDropdown('artist')">â­ Add to Owner Picks</button>
                <div id="artistNotice"></div>
            </div>
            <div class="card">
                <h2>Currently Featured Artists</h2>
                <div id="featuredArtists" class="featured-list">
                    <div class="empty-state">Loadingâ€¦</div>
                </div>
            </div>
        </div>

        <!-- Songs Tab -->
        <div id="tab-songs" class="tab-content">
            <div class="card">
                <h2>Search & Add Songs</h2>
                <input type="text" class="search-box" id="searchSongs" placeholder="Search songs by titleâ€¦" oninput="searchSongs()">
                <div id="songResults" style="color:rgba(168,85,247,0.5);font-size:0.9rem;">Type to searchâ€¦</div>
                <button class="btn" style="margin-top:1rem;" onclick="addSelectedToFeatured('song')">â­ Add Selected to Owner Picks</button>
                <div id="songNotice"></div>
            </div>
            <div class="card">
                <h2>Currently Featured Songs</h2>
                <div id="featuredSongs" class="featured-list">
                    <div class="empty-state">Loadingâ€¦</div>
                </div>
            </div>
        </div>

        <!-- Posts Tab -->
        <div id="tab-posts" class="tab-content">
            <div class="card">
                <h2>Search & Add Posts</h2>
                <input type="text" class="search-box" id="searchPosts" placeholder="Search postsâ€¦" oninput="searchPosts()">
                <div id="postResults" style="color:rgba(168,85,247,0.5);font-size:0.9rem;">Type to searchâ€¦</div>
                <button class="btn" style="margin-top:1rem;" onclick="addSelectedToFeatured('post')">â­ Add Selected to Owner Picks</button>
                <div id="postNotice"></div>
            </div>
            <div class="card">
                <h2>Currently Featured Posts</h2>
                <div id="featuredPosts" class="featured-list">
                    <div class="empty-state">Loadingâ€¦</div>
                </div>
            </div>
        </div>
    </div>

    <script src="scripts.js"></script>
    <script>
        const SUPABASE_URL = 'https://novbuvwpjnxwwvdekjhr.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5vdmJ1dndwam54d3d2ZGVramhyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjExODkxODUsImV4cCI6MjA3Njc2NTE4NX0.1UUkdGafh6ZplAX8hi7Bvj94D2gvFQZUl0an1RvcSA0';
        const s = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        let selectedSongs = new Set();
        let selectedPosts = new Set();
        let featuredArtistIds = new Set(); // track which are already featured

        // â”€â”€ INIT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        async function init() {
            try {
                const { data: { session } } = await s.auth.getSession();
                if (!session) { location.href = 'login.html'; return; }
                const { data: profile } = await s.from('profiles').select('role').eq('user_id', session.user.id).single();
                if (!profile || !['owner','admin'].includes(profile.role)) {
                    alert('Owner/Admin only');
                    location.href = 'owner-panel.html';
                    return;
                }
                await loadFeatured();
                await populateArtistDropdown();
            } catch (err) {
                console.error('Init error:', err);
            }
        }

        // â”€â”€ TABS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function switchTab(tab, btn) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            btn.classList.add('active');
            document.getElementById('tab-' + tab).classList.add('active');
            selectedSongs.clear();
            selectedPosts.clear();
        }

        // â”€â”€ NOTICE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function showNotice(elId, msg, type) {
            const el = document.getElementById(elId);
            if (!el) return;
            el.innerHTML = '<div class="notice ' + type + '">' + msg + '</div>';
            if (type === 'success') setTimeout(() => el.innerHTML = '', 3000);
        }

        // â”€â”€ ARTIST DROPDOWN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        async function populateArtistDropdown() {
            const dd = document.getElementById('artistDropdown');
            dd.innerHTML = '<option value="">Loadingâ€¦</option>';
            try {
                const { data, error } = await s
                    .from('profiles')
                    .select('user_id, username, display_name, role, badges, avatar_url')
                    .or('role.eq.artist,role.eq.beatmaker,role.eq.songwriter')
                    .order('username', { ascending: true });

                if (error) throw error;

                if (!data || data.length === 0) {
                    dd.innerHTML = '<option value="">No artists found</option>';
                    return;
                }

                dd.innerHTML = '<option value="">â€” Select an artist to feature â€”</option>';
                data.filter(p => p.user_id).forEach(p => {
                    const name = p.display_name || p.username || p.user_id;
                    const already = featuredArtistIds.has(p.user_id);
                    const badge = p.badges?.includes('beatmaker') ? 'ğŸšï¸' : p.badges?.includes('artist') ? 'ğŸ¤' : 'ğŸµ';
                    const opt = document.createElement('option');
                    opt.value = p.user_id;
                    opt.textContent = (already ? 'â­ ' : badge + ' ') + name + (already ? ' (already featured)' : '');
                    if (already) opt.style.color = '#f59e0b';
                    dd.appendChild(opt);
                });
            } catch (err) {
                dd.innerHTML = '<option value="">Error loading artists</option>';
                showNotice('artistNotice', 'Error loading artists: ' + err.message, 'error');
            }
        }

        // â”€â”€ ADD FROM DROPDOWN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        async function addFromDropdown(type) {
            const dd = document.getElementById('artistDropdown');
            const userId = dd.value;
            if (!userId || userId === 'null') {
                showNotice('artistNotice', 'Please select an artist first.', 'error');
                return;
            }
            if (featuredArtistIds.has(userId)) {
                showNotice('artistNotice', 'This artist is already featured!', 'info');
                return;
            }
            const btn = document.getElementById('addArtistBtn');
            btn.disabled = true; btn.textContent = 'Savingâ€¦';
            try {
                const { error } = await s.from('featured_content').insert({ content_type: type, content_id: userId });
                if (error) throw error;
                showNotice('artistNotice', 'â­ Artist added to Owner Picks!', 'success');
                await loadFeatured();
                await populateArtistDropdown();
            } catch (err) {
                showNotice('artistNotice', 'Error: ' + err.message, 'error');
            } finally {
                btn.disabled = false; btn.textContent = 'â­ Add to Owner Picks';
            }
        }

        // â”€â”€ LOAD FEATURED â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        async function loadFeatured() {
            await loadFeaturedArtists();
            await loadFeaturedSongs();
            await loadFeaturedPosts();
        }

        async function loadFeaturedArtists() {
            const el = document.getElementById('featuredArtists');
            try {
                const { data: rows, error } = await s
                    .from('featured_content')
                    .select('id, content_id')
                    .eq('content_type', 'artist')
                    .order('created_at', { ascending: false });

                if (error) throw error;

                featuredArtistIds.clear();
                if (!rows || rows.length === 0) {
                    el.innerHTML = '<div class="empty-state">No featured artists yet.</div>';
                    return;
                }

                const ids = rows.map(r => r.content_id).filter(Boolean);
                const { data: profiles } = await s
                    .from('profiles')
                    .select('user_id, username, display_name, avatar_url, role, badges, verified_artist')
                    .in('user_id', ids);

                const profileMap = {};
                (profiles || []).forEach(p => { profileMap[p.user_id] = p; featuredArtistIds.add(p.user_id); });

                el.innerHTML = rows.map(row => {
                    const p = profileMap[row.content_id];
                    const name = p ? (p.display_name || p.username || 'Unknown') : 'Unknown (ID: ' + (row.content_id?.substring(0,8) || '?') + 'â€¦)';
                    const badge = p?.badges?.includes('beatmaker') ? 'ğŸšï¸ Beatmaker' : p?.badges?.includes('artist') ? 'ğŸ¤ Artist' : p?.role || '';
                    const avatarSrc = p?.avatar_url || '';
                    const avatarInner = avatarSrc
                        ? '<img src="' + avatarSrc + '" alt="' + name + '" onerror="this.parentNode.textContent=\'ğŸµ\'">'
                        : 'ğŸµ';
                    return `
                    <div class="featured-item">
                        <div class="featured-item-info">
                            <div class="featured-avatar">${avatarInner}</div>
                            <div>
                                <div class="featured-name">${name}</div>
                                <div class="featured-meta">${badge}</div>
                            </div>
                            <span class="owner-pick-badge">â­ Owner Pick</span>
                        </div>
                        <button class="btn btn-danger" onclick="removeFeatured('${row.id}', 'artist')">Remove</button>
                    </div>`;
                }).join('');
            } catch (err) {
                el.innerHTML = '<div class="empty-state" style="color:#ef4444;">Error: ' + err.message + '</div>';
            }
        }

        async function loadFeaturedSongs() {
            const el = document.getElementById('featuredSongs');
            try {
                const { data: rows, error } = await s
                    .from('featured_content')
                    .select('id, content_id')
                    .eq('content_type', 'song')
                    .order('created_at', { ascending: false });

                if (error) throw error;
                if (!rows || rows.length === 0) {
                    el.innerHTML = '<div class="empty-state">No featured songs yet.</div>';
                    return;
                }

                const ids = rows.map(r => r.content_id).filter(Boolean);
                const { data: posts } = await s.from('posts').select('id, title, artist_name').in('id', ids);
                const postMap = {};
                (posts || []).forEach(p => { postMap[p.id] = p; });

                el.innerHTML = rows.map(row => {
                    const p = postMap[row.content_id];
                    const title = p?.title || 'Untitled';
                    const artist = p?.artist_name || '';
                    return `
                    <div class="featured-item">
                        <div class="featured-item-info">
                            <div class="featured-avatar">ğŸµ</div>
                            <div>
                                <div class="featured-name">${title}</div>
                                <div class="featured-meta">${artist}</div>
                            </div>
                            <span class="owner-pick-badge">â­ Owner Pick</span>
                        </div>
                        <button class="btn btn-danger" onclick="removeFeatured('${row.id}', 'song')">Remove</button>
                    </div>`;
                }).join('');
            } catch (err) {
                el.innerHTML = '<div class="empty-state" style="color:#ef4444;">Error: ' + err.message + '</div>';
            }
        }

        async function loadFeaturedPosts() {
            const el = document.getElementById('featuredPosts');
            try {
                const { data: rows, error } = await s
                    .from('featured_content')
                    .select('id, content_id')
                    .eq('content_type', 'post')
                    .order('created_at', { ascending: false });

                if (error) throw error;
                if (!rows || rows.length === 0) {
                    el.innerHTML = '<div class="empty-state">No featured posts yet.</div>';
                    return;
                }

                const ids = rows.map(r => r.content_id).filter(Boolean);
                const { data: posts } = await s.from('posts').select('id, content, title').in('id', ids);
                const postMap = {};
                (posts || []).forEach(p => { postMap[p.id] = p; });

                el.innerHTML = rows.map(row => {
                    const p = postMap[row.content_id];
                    const preview = p?.content ? p.content.substring(0, 80) + (p.content.length > 80 ? 'â€¦' : '') : (p?.title || 'Post ID: ' + row.content_id?.substring(0,8) + 'â€¦');
                    return `
                    <div class="featured-item">
                        <div class="featured-item-info">
                            <div class="featured-avatar">ğŸ“</div>
                            <div>
                                <div class="featured-name" style="font-size:0.85rem;white-space:normal;">${preview}</div>
                            </div>
                            <span class="owner-pick-badge">â­ Owner Pick</span>
                        </div>
                        <button class="btn btn-danger" onclick="removeFeatured('${row.id}', 'post')">Remove</button>
                    </div>`;
                }).join('');
            } catch (err) {
                el.innerHTML = '<div class="empty-state" style="color:#ef4444;">Error: ' + err.message + '</div>';
            }
        }

        // â”€â”€ REMOVE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        async function removeFeatured(id, type) {
            if (!confirm('Remove this ' + type + ' from Owner Picks?')) return;
            try {
                const { error } = await s.from('featured_content').delete().eq('id', id);
                if (error) throw error;
                await loadFeatured();
                await populateArtistDropdown();
            } catch (err) {
                alert('Error removing: ' + err.message);
            }
        }

        // â”€â”€ SONG SEARCH â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        async function searchSongs() {
            const query = document.getElementById('searchSongs').value.trim();
            const el = document.getElementById('songResults');
            if (!query) { el.innerHTML = '<span style="color:rgba(168,85,247,0.5);font-size:0.9rem;">Type to searchâ€¦</span>'; return; }
            el.innerHTML = '<span style="color:rgba(168,85,247,0.5);font-size:0.9rem;">Searchingâ€¦</span>';
            try {
                const { data, error } = await s.from('posts').select('id, title, artist_name').or('title.ilike.%' + query + '%,artist_name.ilike.%' + query + '%').limit(20);
                if (error) throw error;
                if (!data || data.length === 0) { el.innerHTML = '<span style="color:rgba(168,85,247,0.5);font-size:0.9rem;">No songs found for "' + query + '"</span>'; return; }
                el.innerHTML = '<div style="display:flex;flex-direction:column;gap:0.5rem;margin-top:0.5rem;">' + data.map(p => `
                    <div onclick="toggleSong('${p.id}')" style="background:var(--dark);border:1px solid ${selectedSongs.has(p.id) ? '#00ff88' : 'var(--border)'};background:${selectedSongs.has(p.id) ? 'rgba(0,255,136,0.08)' : 'var(--dark)'};border-radius:8px;padding:0.75rem;cursor:pointer;display:flex;justify-content:space-between;align-items:center;">
                        <div><strong>${p.title || 'Untitled'}</strong><br><small style="color:rgba(168,85,247,0.7);">${p.artist_name || ''}</small></div>
                        ${selectedSongs.has(p.id) ? '<span style="color:#00ff88;font-weight:700;">âœ“ Selected</span>' : ''}
                    </div>`).join('') + '</div>';
            } catch (err) {
                el.innerHTML = '<span style="color:#ef4444;">Error: ' + err.message + '</span>';
            }
        }

        function toggleSong(id) {
            if (selectedSongs.has(id)) selectedSongs.delete(id); else selectedSongs.add(id);
            searchSongs();
        }

        // â”€â”€ POST SEARCH â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        async function searchPosts() {
            const query = document.getElementById('searchPosts').value.trim();
            const el = document.getElementById('postResults');
            if (!query) { el.innerHTML = '<span style="color:rgba(168,85,247,0.5);font-size:0.9rem;">Type to searchâ€¦</span>'; return; }
            el.innerHTML = '<span style="color:rgba(168,85,247,0.5);font-size:0.9rem;">Searchingâ€¦</span>';
            try {
                const { data, error } = await s.from('posts').select('id, content, title').ilike('content', '%' + query + '%').limit(20);
                if (error) throw error;
                if (!data || data.length === 0) { el.innerHTML = '<span style="color:rgba(168,85,247,0.5);font-size:0.9rem;">No posts found</span>'; return; }
                el.innerHTML = '<div style="display:flex;flex-direction:column;gap:0.5rem;margin-top:0.5rem;">' + data.map(p => {
                    const preview = p.content ? p.content.substring(0, 120) + (p.content.length > 120 ? 'â€¦' : '') : (p.title || 'Untitled');
                    return `<div onclick="togglePost('${p.id}')" style="background:${selectedPosts.has(p.id) ? 'rgba(0,255,136,0.08)' : 'var(--dark)'};border:1px solid ${selectedPosts.has(p.id) ? '#00ff88' : 'var(--border)'};border-radius:8px;padding:0.75rem;cursor:pointer;display:flex;justify-content:space-between;align-items:center;gap:0.5rem;">
                        <small style="line-height:1.5;">${preview}</small>
                        ${selectedPosts.has(p.id) ? '<span style="color:#00ff88;font-weight:700;flex-shrink:0;">âœ“</span>' : ''}
                    </div>`;
                }).join('') + '</div>';
            } catch (err) {
                el.innerHTML = '<span style="color:#ef4444;">Error: ' + err.message + '</span>';
            }
        }

        function togglePost(id) {
            if (selectedPosts.has(id)) selectedPosts.delete(id); else selectedPosts.add(id);
            searchPosts();
        }

        // â”€â”€ ADD SELECTED (songs/posts) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        async function addSelectedToFeatured(type) {
            const set = type === 'song' ? selectedSongs : selectedPosts;
            const noticeId = type === 'song' ? 'songNotice' : 'postNotice';
            if (set.size === 0) { showNotice(noticeId, 'Select at least one item first.', 'error'); return; }
            try {
                const items = Array.from(set).map(id => ({ content_type: type, content_id: id }));
                const { error } = await s.from('featured_content').insert(items);
                if (error) throw error;
                showNotice(noticeId, 'â­ Added ' + set.size + ' ' + type + '(s) to Owner Picks!', 'success');
                set.clear();
                await loadFeatured();
            } catch (err) {
                showNotice(noticeId, 'Error: ' + err.message, 'error');
            }
        }

        // â”€â”€ START â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', init);
        } else {
            init();
        }
    </script>

    <!-- Avatar & Bubble Toggle -->
    <script>
    (function() {
        const toggleBtn = document.createElement('button');
        toggleBtn.id = 'avatarToggle';
        toggleBtn.innerHTML = 'ğŸ‘ï¸';
        toggleBtn.title = 'Toggle Avatar/Bubbles';
        toggleBtn.style.cssText = 'position:fixed;top:80px;right:20px;z-index:9999;background:rgba(124,58,237,0.9);border:2px solid rgba(124,58,237,1);color:white;width:50px;height:50px;border-radius:50%;cursor:pointer;font-size:24px;display:flex;align-items:center;justify-content:center;box-shadow:0 4px 12px rgba(124,58,237,0.5);transition:all 0.3s ease;';
        toggleBtn.addEventListener('mouseenter', function() { this.style.transform = 'scale(1.1)'; });
        toggleBtn.addEventListener('mouseleave', function() { this.style.transform = 'scale(1)'; });
        document.body.appendChild(toggleBtn);

        let isHidden = localStorage.getItem('hideAvatarBubbles') === 'true';

        function updateVisibility() {
            const els = [
                document.getElementById('homeAvatarSwitcher'),
                ...document.querySelectorAll('[id*="bubble"],[class*="bubble"],[id*="avatar"][id*="switcher"]')
            ];
            els.forEach(el => { if (el) el.style.display = isHidden ? 'none' : ''; });
            toggleBtn.innerHTML = isHidden ? 'ğŸ‘ï¸â€ğŸ—¨ï¸' : 'ğŸ‘ï¸';
            toggleBtn.title = isHidden ? 'Show Avatar/Bubbles' : 'Hide Avatar/Bubbles';
        }

        toggleBtn.addEventListener('click', function() {
            isHidden = !isHidden;
            localStorage.setItem('hideAvatarBubbles', isHidden);
            updateVisibility();
        });

        updateVisibility();
    })();
    </script>

</body>
</html>
