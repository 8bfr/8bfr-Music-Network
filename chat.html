<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Community Chat ‚Äî 8BFR</title>
<link rel="icon" href="assets/images/favicon.png">
<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Work+Sans:wght@300;400;600;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
:root{--primary:#7c3aed;--dark:#0b0014;--card:#0c0618;--text:#eae6ff;--dim:#a855f7;--border:rgba(124,58,237,.35);--danger:#ef4444;--success:#22c55e;--warn:#f59e0b;}
*{margin:0;padding:0;box-sizing:border-box;}
body{font-family:'Work Sans',sans-serif;background:linear-gradient(#0b0014,#000);color:var(--text);min-height:100vh;display:flex;flex-direction:column;}
.header{background:rgba(15,0,30,.95);border-bottom:2px solid var(--primary);padding:1rem 1.5rem;display:flex;justify-content:space-between;align-items:center;position:sticky;top:0;z-index:100;flex-wrap:wrap;gap:.5rem;}
.header h1{font-family:'Bebas Neue',cursive;font-size:1.5rem;color:var(--primary);}
.container{flex:1;max-width:900px;width:100%;margin:0 auto;display:flex;flex-direction:column;height:calc(100vh - 60px);}
.online-bar{padding:.5rem 1rem;background:rgba(124,58,237,.08);border-bottom:1px solid var(--border);font-size:.8rem;color:var(--dim);display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:.5rem;}
.messages{flex:1;overflow-y:auto;padding:1rem;display:flex;flex-direction:column;gap:.5rem;}
.msg{display:flex;gap:.6rem;align-items:flex-start;padding:.5rem .75rem;border-radius:10px;transition:background .15s;position:relative;}
.msg:hover{background:rgba(124,58,237,.06);}
.msg.hidden-msg{opacity:.4;border-left:3px solid var(--warn);}
.msg-avatar{width:36px;height:36px;border-radius:50%;background:var(--primary);display:flex;align-items:center;justify-content:center;font-weight:700;font-size:.85rem;flex-shrink:0;overflow:hidden;}
.msg-avatar img{width:100%;height:100%;object-fit:cover;}
.msg-body{flex:1;min-width:0;}
.msg-header{display:flex;align-items:center;gap:.5rem;margin-bottom:.15rem;}
.msg-name{font-weight:600;font-size:.85rem;color:var(--primary);}
.msg-name.owner-name{color:#00d9ff;}
.msg-name.anon-name{color:#666;font-style:italic;}
.msg-time{font-size:.65rem;color:rgba(234,230,255,.35);}
.msg-text{font-size:.9rem;line-height:1.5;word-wrap:break-word;}
.msg-actions{display:none;position:absolute;right:8px;top:8px;gap:.3rem;}
.msg:hover .msg-actions{display:flex;}
.msg-action-btn{background:rgba(124,58,237,.2);border:1px solid var(--border);color:var(--text);padding:.15rem .4rem;border-radius:4px;cursor:pointer;font-size:.65rem;transition:all .15s;}
.msg-action-btn:hover{background:rgba(124,58,237,.4);}
.msg-action-btn.danger{border-color:rgba(239,68,68,.4);color:var(--danger);}
.msg-action-btn.danger:hover{background:rgba(239,68,68,.2);}
.input-area{padding:1rem;background:rgba(15,0,30,.95);border-top:1px solid var(--border);}
.input-row{display:flex;gap:.5rem;max-width:900px;margin:0 auto;}
.input-row input{flex:1;padding:.7rem 1rem;background:var(--dark);border:1px solid var(--border);border-radius:12px;color:var(--text);font-family:inherit;font-size:.95rem;}
.input-row input:focus{outline:none;border-color:var(--primary);}
.send-btn{background:var(--primary);color:#fff;border:none;padding:0 1.25rem;border-radius:12px;cursor:pointer;font-size:1.1rem;font-weight:700;transition:all .2s;flex-shrink:0;}
.send-btn:hover{background:#6d28d9;}
.send-btn:disabled{opacity:.5;cursor:not-allowed;}
.banned-bar{padding:1rem;background:rgba(239,68,68,.1);border:1px solid rgba(239,68,68,.3);text-align:center;color:var(--danger);font-weight:600;}
.mod-panel{background:rgba(15,0,30,.95);border-bottom:1px solid var(--border);padding:.5rem 1rem;display:flex;gap:.5rem;flex-wrap:wrap;align-items:center;font-size:.75rem;}
.mod-btn{background:rgba(124,58,237,.15);border:1px solid var(--border);color:var(--dim);padding:.3rem .6rem;border-radius:6px;cursor:pointer;font-size:.7rem;transition:all .15s;}
.mod-btn:hover{background:rgba(124,58,237,.3);}
.mod-btn.active{background:var(--primary);color:#fff;border-color:var(--primary);}
.system-msg{text-align:center;padding:.4rem;font-size:.8rem;color:var(--dim);font-style:italic;}
.report-modal{position:fixed;inset:0;background:rgba(0,0,0,.85);z-index:9999;display:flex;align-items:center;justify-content:center;padding:1rem;}
.report-box{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:1.5rem;max-width:450px;width:100%;}
.report-box h3{color:var(--primary);font-family:'Bebas Neue',cursive;font-size:1.3rem;margin-bottom:.75rem;}
.report-box textarea{width:100%;min-height:80px;padding:.6rem;background:var(--dark);border:1px solid var(--border);border-radius:8px;color:var(--text);font-family:inherit;font-size:.9rem;resize:vertical;margin:.5rem 0;}
.report-box .quote{background:rgba(124,58,237,.08);border-left:3px solid var(--primary);padding:.5rem .75rem;border-radius:0 8px 8px 0;margin-bottom:.75rem;font-size:.85rem;color:var(--dim);}
.btn-sm{padding:.4rem .8rem;border-radius:8px;border:none;cursor:pointer;font-size:.85rem;font-weight:600;transition:all .15s;}
.btn-primary{background:var(--primary);color:#fff;}.btn-primary:hover{background:#6d28d9;}
.btn-outline{background:rgba(124,58,237,.1);border:1px solid var(--border);color:var(--text);}.btn-outline:hover{background:rgba(124,58,237,.2);}
.btn-danger{background:rgba(239,68,68,.8);color:#fff;}.btn-danger:hover{background:rgba(239,68,68,1);}
@media(max-width:600px){.msg-actions{display:flex !important;position:static;margin-top:.3rem;}}
</style>
</head>
<body>
<div class="header">
  <a href="index.html" style="color:var(--dim);text-decoration:none;font-weight:600;">‚Üê Home</a>
  <h1>üí¨ Community Chat</h1>
  <div style="display:flex;gap:.5rem;align-items:center;">
    <span id="userCount" style="font-size:.75rem;color:var(--dim);">0 online</span>
  </div>
</div>

<!-- Owner Mod Panel -->
<div class="mod-panel" id="modPanel" style="display:none;">
  <span style="color:var(--primary);font-weight:700;">üõ°Ô∏è MOD:</span>
  <button class="mod-btn" id="toggleAnon" onclick="toggleAnonymous()">üëª Anonymous</button>
  <button class="mod-btn" id="toggleHidden" onclick="toggleShowHidden()">üëÅÔ∏è Show Hidden</button>
  <button class="mod-btn" onclick="openBanList()">üö´ Ban List</button>
  <button class="mod-btn danger" style="border-color:rgba(239,68,68,.4);color:var(--danger);" onclick="clearAllMessages()">üóëÔ∏è Clear All</button>
</div>

<!-- Banned notice -->
<div class="banned-bar" id="bannedBar" style="display:none;">
  üö´ You have been banned from the community chat.
</div>

<div class="container">
  <div class="messages" id="messages">
    <div class="system-msg">Welcome to the 8BFR Community Chat! Be respectful and have fun. üíú</div>
  </div>
  <div class="input-area" id="inputArea">
    <div class="input-row">
      <input type="text" id="chatInput" placeholder="Type a message..." maxlength="1000" autocomplete="off" onkeydown="if(event.key==='Enter')sendMessage();">
      <button class="send-btn" id="sendBtn" onclick="sendMessage()">‚û§</button>
    </div>
  </div>
</div>

<!-- Report Modal -->
<div class="report-modal" id="reportModal" style="display:none;">
  <div class="report-box">
    <h3>üö© Report Message</h3>
    <div class="quote" id="reportQuote"></div>
    <label style="font-size:.8rem;color:var(--dim);">Why are you reporting this?</label>
    <textarea id="reportReason" placeholder="Describe the issue..."></textarea>
    <div style="display:flex;gap:.5rem;justify-content:flex-end;margin-top:.5rem;">
      <button class="btn-sm btn-outline" onclick="closeReport()">Cancel</button>
      <button class="btn-sm btn-danger" onclick="submitReport()">Submit Report</button>
    </div>
  </div>
</div>

<!-- Ban List Modal -->
<div class="report-modal" id="banListModal" style="display:none;">
  <div class="report-box" style="max-width:550px;">
    <h3>üö´ Banned Users</h3>
    <div id="banListContent" style="max-height:400px;overflow-y:auto;"></div>
    <div style="margin-top:1rem;text-align:right;">
      <button class="btn-sm btn-outline" onclick="closeBanList()">Close</button>
    </div>
  </div>
</div>

<script src="scripts.js" defer></script>
<script>
const SUPABASE_URL='https://novbuvwpjnxwwvdekjhr.supabase.co';
const SUPABASE_ANON='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5vdmJ1dndwam54d3d2ZGVramhyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjExODkxODUsImV4cCI6MjA3Njc2NTE4NX0.1UUkdGafh6ZplAX8hi7Bvj94D2gvFQZUl0an1RvcSA0';
const db=window.supabase.createClient(SUPABASE_URL,SUPABASE_ANON);
const OWNER_ID='cb556180-f032-4b21-9470-1d786f2664ab';

let currentUser=null;
let currentProfile=null;
let isOwner=false;
let isAnonymous=false;
let showHidden=false;
let isBanned=false;
let reportTarget=null;

// INIT
async function init(){
  const{data:{session}}=await db.auth.getSession();
  if(!session){location.href='login.html?return=chatroom.html';return;}
  currentUser=session.user;
  isOwner=currentUser.id===OWNER_ID;

  const{data:profile}=await db.from('profiles').select('username,display_name,avatar_url,role').eq('user_id',currentUser.id).single();
  currentProfile=profile||{username:'user',display_name:'User'};
  if(profile&&profile.role==='owner')isOwner=true;

  // Check ban
  const{data:ban}=await db.from('chatroom_bans').select('*').eq('user_id',currentUser.id).order('created_at',{ascending:false}).limit(1).single();
  if(ban){
    if(ban.ban_type==='permanent'||(ban.ban_type==='kick'&&new Date(ban.expires_at)>new Date())){
      isBanned=true;
      document.getElementById('bannedBar').style.display='block';
      document.getElementById('inputArea').style.display='none';
      if(ban.ban_type==='kick'){
        const mins=Math.ceil((new Date(ban.expires_at)-new Date())/60000);
        document.getElementById('bannedBar').textContent='‚è≥ You have been kicked. You can chat again in '+mins+' minute(s).';
      }
    }
  }

  if(isOwner)document.getElementById('modPanel').style.display='flex';

  await loadMessages();
  subscribeRealtime();
}

// LOAD MESSAGES
async function loadMessages(){
  let q=db.from('chatroom_messages').select('*').order('created_at',{ascending:true}).limit(200);
  if(!showHidden&&!isOwner)q=q.eq('is_hidden',false);
  const{data,error}=await q;
  if(error){console.error('Load error:',error);return;}
  const box=document.getElementById('messages');
  box.innerHTML='<div class="system-msg">Welcome to the 8BFR Community Chat! Be respectful and have fun. üíú</div>';
  if(data)data.forEach(m=>renderMessage(m));
  box.scrollTop=box.scrollHeight;
}

// RENDER MESSAGE
function renderMessage(m){
  if(m.is_hidden&&!isOwner&&!showHidden)return;
  const box=document.getElementById('messages');
  const div=document.createElement('div');
  div.className='msg'+(m.is_hidden?' hidden-msg':'');
  div.id='msg-'+m.id;
  div.dataset.userId=m.user_id;
  div.dataset.msgId=m.id;

  const isMe=currentUser&&m.user_id===currentUser.id;
  const isMsgOwner=m.user_id===OWNER_ID;
  const initial=(m.display_name||m.username||'?')[0].toUpperCase();
  const avatarHtml=m.avatar_url?'<img src="'+m.avatar_url+'" alt="">':initial;
  const nameClass=isMsgOwner?'msg-name owner-name':'msg-name';
  const ownerBadge=isMsgOwner?' <span style="font-size:.6rem;background:rgba(0,217,255,.2);color:#00d9ff;padding:.1rem .3rem;border-radius:3px;">OWNER</span>':'';
  const hiddenBadge=m.is_hidden?' <span style="font-size:.6rem;background:rgba(245,158,11,.2);color:#f59e0b;padding:.1rem .3rem;border-radius:3px;">HIDDEN</span>':'';

  const time=new Date(m.created_at);
  const timeStr=time.toLocaleTimeString([],{hour:'numeric',minute:'2-digit'});

  // Actions
  let actions='';
  if(!isMe){
    actions+='<button class="msg-action-btn" onclick="openReport(\''+m.id+'\',\''+escHtml(m.username)+'\',\''+escHtml(m.message.substring(0,200))+'\',\''+m.user_id+'\')">üö©</button>';
  }
  if(isOwner){
    if(!m.is_hidden)actions+='<button class="msg-action-btn" onclick="hideMessage(\''+m.id+'\')">üôà Hide</button>';
    else actions+='<button class="msg-action-btn" onclick="unhideMessage(\''+m.id+'\')">üëÅÔ∏è Show</button>';
    actions+='<button class="msg-action-btn danger" onclick="deleteMessage(\''+m.id+'\')">üóëÔ∏è</button>';
    if(!isMsgOwner){
      actions+='<button class="msg-action-btn" onclick="kickUser(\''+m.user_id+'\',\''+escHtml(m.username)+'\')">üë¢ Kick</button>';
      actions+='<button class="msg-action-btn danger" onclick="banUser(\''+m.user_id+'\',\''+escHtml(m.username)+'\')">üö´ Ban</button>';
    }
  }

  div.innerHTML=
    '<div class="msg-avatar" style="background:hsl('+(hashStr(m.user_id)*137%360)+',55%,45%);">'+avatarHtml+'</div>'+
    '<div class="msg-body">'+
      '<div class="msg-header">'+
        '<span class="'+nameClass+'">'+(m.display_name||m.username)+ownerBadge+hiddenBadge+'</span>'+
        '<span class="msg-time">'+timeStr+'</span>'+
      '</div>'+
      '<div class="msg-text">'+escHtml(m.message)+'</div>'+
    '</div>'+
    '<div class="msg-actions">'+actions+'</div>';

  box.appendChild(div);
}

// SEND MESSAGE
async function sendMessage(){
  if(isBanned)return;
  const input=document.getElementById('chatInput');
  const text=input.value.trim();
  if(!text)return;
  input.value='';
  document.getElementById('sendBtn').disabled=true;

  const displayName=isAnonymous?'Moderator':((currentProfile.display_name||currentProfile.username));
  const username=isAnonymous?'mod':(currentProfile.username||'user');

  const{error}=await db.from('chatroom_messages').insert({
    user_id:currentUser.id,
    username:username,
    display_name:displayName,
    avatar_url:isAnonymous?null:(currentProfile.avatar_url||null),
    message:text
  });

  if(error)console.error('Send error:',error);
  document.getElementById('sendBtn').disabled=false;
  input.focus();
}

// REALTIME SUBSCRIPTION
function subscribeRealtime(){
  db.channel('chatroom')
    .on('postgres_changes',{event:'INSERT',schema:'public',table:'chatroom_messages'},payload=>{
      renderMessage(payload.new);
      const box=document.getElementById('messages');
      box.scrollTop=box.scrollHeight;
    })
    .on('postgres_changes',{event:'DELETE',schema:'public',table:'chatroom_messages'},payload=>{
      const el=document.getElementById('msg-'+payload.old.id);
      if(el)el.remove();
    })
    .on('postgres_changes',{event:'UPDATE',schema:'public',table:'chatroom_messages'},payload=>{
      const el=document.getElementById('msg-'+payload.old.id);
      if(el)el.remove();
      if(!payload.new.is_hidden||isOwner)renderMessage(payload.new);
    })
    .subscribe();
}

// === OWNER MODERATION ===

function toggleAnonymous(){
  isAnonymous=!isAnonymous;
  const btn=document.getElementById('toggleAnon');
  btn.classList.toggle('active',isAnonymous);
  btn.textContent=isAnonymous?'üëª Anon ON':'üëª Anonymous';
}

function toggleShowHidden(){
  showHidden=!showHidden;
  const btn=document.getElementById('toggleHidden');
  btn.classList.toggle('active',showHidden);
  loadMessages();
}

async function hideMessage(msgId){
  await db.from('chatroom_messages').update({is_hidden:true,hidden_by:currentUser.id}).eq('id',msgId);
}

async function unhideMessage(msgId){
  await db.from('chatroom_messages').update({is_hidden:false}).eq('id',msgId);
}

async function deleteMessage(msgId){
  if(!confirm('Delete this message permanently?'))return;
  await db.from('chatroom_messages').delete().eq('id',msgId);
}

async function clearAllMessages(){
  if(!confirm('Delete ALL chat messages? This cannot be undone.'))return;
  if(!confirm('Are you really sure? This removes everything.'))return;
  const{error}=await db.from('chatroom_messages').delete().neq('id','00000000-0000-0000-0000-000000000000');
  if(!error)loadMessages();
}

async function kickUser(userId,username){
  const mins=prompt('Kick '+username+' for how many minutes?','15');
  if(!mins)return;
  const expires=new Date(Date.now()+parseInt(mins)*60000).toISOString();
  await db.from('chatroom_bans').insert({user_id:userId,banned_by:currentUser.id,reason:'Kicked by owner',ban_type:'kick',expires_at:expires});
  alert(username+' kicked for '+mins+' minutes.');
}

async function banUser(userId,username){
  if(!confirm('Permanently ban '+username+'? They will not be able to chat.'))return;
  const reason=prompt('Ban reason (optional):','');
  await db.from('chatroom_bans').insert({user_id:userId,banned_by:currentUser.id,reason:reason||'Banned by owner',ban_type:'permanent'});
  alert(username+' has been permanently banned.');
}

async function openBanList(){
  document.getElementById('banListModal').style.display='flex';
  const{data}=await db.from('chatroom_bans').select('*').order('created_at',{ascending:false});
  const box=document.getElementById('banListContent');
  if(!data||data.length===0){box.innerHTML='<p style="color:var(--dim);text-align:center;padding:1rem;">No banned users.</p>';return;}

  // Get usernames
  const userIds=[...new Set(data.map(b=>b.user_id))];
  const{data:profiles}=await db.from('profiles').select('user_id,username,display_name').in('user_id',userIds);
  const pMap={};
  if(profiles)profiles.forEach(p=>pMap[p.user_id]=p);

  box.innerHTML=data.map(b=>{
    const p=pMap[b.user_id]||{username:'unknown'};
    const type=b.ban_type==='kick'?'üë¢ Kick':'üö´ Ban';
    const expires=b.expires_at?new Date(b.expires_at).toLocaleString():'Never';
    return '<div style="display:flex;justify-content:space-between;align-items:center;padding:.6rem;border-bottom:1px solid var(--border);">'+
      '<div><strong style="color:var(--primary);">'+(p.display_name||p.username)+'</strong> <span style="font-size:.7rem;color:var(--dim);">'+type+'</span>'+
      '<br><span style="font-size:.75rem;color:var(--dim);">'+b.reason+'</span>'+
      (b.ban_type==='kick'?'<br><span style="font-size:.7rem;">Expires: '+expires+'</span>':'')+
      '</div>'+
      '<button class="btn-sm btn-outline" onclick="unban(\''+b.id+'\')">Unban</button></div>';
  }).join('');
}

async function unban(banId){
  await db.from('chatroom_bans').delete().eq('id',banId);
  openBanList();
}

function closeBanList(){document.getElementById('banListModal').style.display='none';}

// === REPORT SYSTEM ===

function openReport(msgId,username,text,userId){
  reportTarget={msgId,username,text,userId};
  document.getElementById('reportQuote').textContent=username+': '+text;
  document.getElementById('reportReason').value='';
  document.getElementById('reportModal').style.display='flex';
}

function closeReport(){
  document.getElementById('reportModal').style.display='none';
  reportTarget=null;
}

async function submitReport(){
  if(!reportTarget)return;
  const reason=document.getElementById('reportReason').value.trim();
  const{error}=await db.from('message_reports').insert({
    reporter_id:currentUser.id,
    reported_user_id:reportTarget.userId,
    message_text:reportTarget.text,
    message_source:'chatroom',
    source_message_id:reportTarget.msgId,
    reason:reason
  });
  if(error){alert('Error submitting report.');console.error(error);}
  else alert('‚úÖ Report submitted. The owner will review it.');
  closeReport();
}

// HELPERS
function escHtml(s){const d=document.createElement('div');d.textContent=s;return d.innerHTML;}
function hashStr(s){let h=0;for(let i=0;i<s.length;i++)h=((h<<5)-h)+s.charCodeAt(i);return Math.abs(h);}

// SCROLL DETECTION
document.addEventListener('DOMContentLoaded',()=>{
  const box=document.getElementById('messages');
  let autoScroll=true;
  box.addEventListener('scroll',()=>{
    autoScroll=box.scrollTop+box.clientHeight>=box.scrollHeight-100;
  });
  const orig=renderMessage;
  // Auto-scroll on new messages
});

init();
</script>

<!-- Safe avatar toggle -->
<script>
(function(){var b=document.createElement('button');b.innerHTML='üëÅÔ∏è';b.style.cssText='position:fixed;top:80px;right:20px;z-index:9999;background:rgba(124,58,237,0.9);border:2px solid rgba(124,58,237,1);color:white;width:50px;height:50px;border-radius:50%;cursor:pointer;font-size:24px;display:flex;align-items:center;justify-content:center;box-shadow:0 4px 12px rgba(124,58,237,0.5);';document.body.appendChild(b);var h=localStorage.getItem('hideAvatarBubbles')==='true';function u(){document.querySelectorAll('[id*="bubble"],[class*="bubble"],[id*="avatar"][id*="switcher"]').forEach(function(el){if(el)el.style.display=h?'none':'';});b.innerHTML=h?'üëÅÔ∏è‚Äçüó®Ô∏è':'üëÅÔ∏è';}b.addEventListener('click',function(){h=!h;localStorage.setItem('hideAvatarBubbles',h);u();});u();})();
</script>
</body>
</html>
