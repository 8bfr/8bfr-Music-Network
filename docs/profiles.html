<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Profiles ‚Äî Directory</title>
  <style>
    :root{
      --bg:#0b0215; --card:#12051c; --muted:#9b89b8; --accent:#a855f7; --text:#eae6ff;
    }
    body{background:linear-gradient(180deg,#05010a, #0b0215); color:var(--text); font-family:Inter,system-ui,Arial; margin:0; padding:24px;}
    .container{max-width:1100px;margin:0 auto;}
    header{display:flex;justify-content:space-between;align-items:center;margin-bottom:18px}
    h1{font-size:1.4rem;margin:0}
    .filters{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:18px}
    .filter-btn{background:transparent;border:1px solid rgba(168,85,247,0.14);color:var(--muted);padding:8px 12px;border-radius:999px;cursor:pointer;font-weight:600}
    .filter-btn.active{background:linear-gradient(90deg,#a855f7, #7c3aed); color:#fff; border-color:transparent}
    #profileCount{color:var(--muted); font-size:0.95rem}
    #profilesGrid{display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:12px;margin-top:12px}
    .profile-card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); border:1px solid rgba(168,85,247,0.07); padding:12px;border-radius:12px; cursor:pointer; transition:transform .12s}
    .profile-card:hover{transform:translateY(-4px)}
    .profile-avatar{width:48px;height:48px;border-radius:10px;background:#2b0636;display:inline-flex;align-items:center;justify-content:center;font-size:20px;margin-bottom:6px}
    .badge{display:inline-block;padding:4px 8px;border-radius:8px;background:rgba(168,85,247,0.08);color:var(--accent);font-size:12px;margin-right:6px;margin-top:6px}
    .founder{background:linear-gradient(90deg,#f59e0b33,#ef444433);color:#ffedd5}
    .empty-state{text-align:center;padding:48px 12px;color:var(--muted);border:1px dashed rgba(168,85,247,0.06); border-radius:12px}
    .search-inline{display:flex;gap:8px;align-items:center}
    input[type="search"]{padding:8px 12px;border-radius:999px;border:1px solid rgba(255,255,255,0.04);background:rgba(255,255,255,0.02);color:var(--text);outline:none}
    small{color:var(--muted)}
  </style>
  <!-- Supabase JS (CDN) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/bundle.js"></script>
</head>
<body>
  <div class="container">
    <header>
      <div>
        <h1>Profiles</h1>
        <div id="profileCount"><small>Loading...</small></div>
      </div>
      <div class="search-inline">
        <input id="profilesSearchInput" type="search" placeholder="Search usernames or bio..." />
      </div>
    </header>

    <div class="filters" id="filtersContainer" aria-hidden="false">
      <!-- category buttons injected here -->
    </div>

    <main>
      <div id="profilesGrid" aria-live="polite">
        <div class="empty-state">Loading profiles‚Ä¶</div>
      </div>
    </main>
  </div>

  <script>
    // Replace these with your project's info if necessary
    const SUPABASE_URL = 'https://novbuvwpjnxwwvdekjhr.supabase.co';
    const SUPABASE_KEY = 'REPLACE_WITH_ANON_KEY_IF_DIFFERENT';
    const supabase = supabaseJs.createClient(SUPABASE_URL, SUPABASE_KEY);

    let allProfiles = [];
    let categories = ['all'];
    let currentCategory = 'all';

    async function loadProfilesForUI() {
      const grid = document.getElementById('profilesGrid');
      grid.innerHTML = '<div class="empty-state">Loading profiles‚Ä¶</div>';
      const { data, error } = await supabase.from('profiles_search_view').select('*').order('created_at', { ascending: false });
      if (error) {
        console.error('Failed to load profiles:', error);
        grid.innerHTML = '<div class="empty-state">Error loading profiles</div>';
        document.getElementById('profileCount').innerHTML = '<small>Error</small>';
        return;
      }
      allProfiles = data || [];
      buildCategories();
      renderCategoryButtons();
      displayProfiles(allProfiles);
    }

    function buildCategories() {
      const set = new Set(['all']);
      allProfiles.forEach(p => {
        let roles = [];
        if (Array.isArray(p.roles_array)) roles = roles.concat(p.roles_array);
        else if (p.roles_array && typeof p.roles_array === 'string') {
          try { roles = roles.concat(JSON.parse(p.roles_array)); } catch(e){}
        }
        if (Array.isArray(p.tags)) roles = roles.concat(p.tags);
        if (p.role) roles.push(p.role);
        roles.forEach(r => { if (r && String(r).trim()) set.add(String(r)); });
      });
      categories = Array.from(set);
    }

    function renderCategoryButtons() {
      const wrapper = document.getElementById('filtersContainer');
      wrapper.innerHTML = '';
      categories.forEach(cat => {
        const btn = document.createElement('button');
        btn.className = 'filter-btn' + (cat === 'all' ? ' active' : '');
        btn.dataset.filter = cat;
        btn.innerText = cat === 'all' ? 'All' : cat.charAt(0).toUpperCase() + cat.slice(1);
        btn.onclick = () => {
          wrapper.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          currentCategory = cat;
          applyCategoryFilter();
        };
        wrapper.appendChild(btn);
      });
    }

    function applyCategoryFilter() {
      let filtered = allProfiles;
      if (currentCategory && currentCategory !== 'all') {
        filtered = allProfiles.filter(p => {
          let roles = [];
          if (Array.isArray(p.roles_array)) roles = roles.concat(p.roles_array);
          else if (p.roles_array && typeof p.roles_array === 'string') {
            try { roles = roles.concat(JSON.parse(p.roles_array)); } catch(e){}
          }
          if (Array.isArray(p.tags)) roles = roles.concat(p.tags);
          if (p.role) roles.push(p.role);
          return roles.map(String).includes(currentCategory);
        });
      }
      displayProfiles(filtered);
    }

    function displayProfiles(profiles) {
      const grid = document.getElementById('profilesGrid');
      document.getElementById('profileCount').textContent = `${profiles.length} profiles found`;
      if (!profiles || profiles.length === 0) {
        grid.innerHTML = '<div class="empty-state">No profiles found</div>';
        return;
      }

      const badgeIcons = {
        'artist': 'üé§', 'beatmaker': 'üéöÔ∏è', 'producer': 'üéß', 'verified': 'üõ°Ô∏è',
        'founder': '‚ö°', 'owner': 'üëë', 'admin': '‚öôÔ∏è', 'mod': 'üí¨'
      };

      grid.innerHTML = profiles.map(p => {
        let roles = [];
        if (Array.isArray(p.roles_array)) roles = roles.concat(p.roles_array);
        else if (p.roles_array && typeof p.roles_array === 'string') {
          try { roles = roles.concat(JSON.parse(p.roles_array)); } catch(e){}
        }
        if (Array.isArray(p.tags)) roles = roles.concat(p.tags);
        if (p.role) roles.push(p.role);

        const primaryRole = (roles[0] || 'user').toString();
        const badgesHtml = roles.slice(0,5).map(role => {
          const css = (role === 'founder') ? 'founder' : '';
          const icon = badgeIcons[role] || 'üè∑Ô∏è';
          return `<span class="badge ${css}">${escapeHtml(icon + ' ' + role)}</span>`;
        }).join('');

        return `
          <div class="profile-card" role="button" onclick="location.href='profile.html?id=${encodeURIComponent(p.user_id || p.id)}'">
            <div class="profile-avatar">${escapeHtml(badgeIcons[primaryRole] || 'üë§')}</div>
            <h3 style="margin:6px 0 4px 0">${escapeHtml(p.username || p.display_name || 'Unknown')}</h3>
            <div style="color:var(--muted); font-size:0.9rem; margin-bottom:8px">${escapeHtml(primaryRole.toUpperCase())}${p.verified_artist ? ' üõ°Ô∏è' : ''}</div>
            ${p.bio ? `<div style="color:var(--muted); font-size:0.9rem; margin-bottom:10px">${escapeHtml((p.bio||'').substring(0,120))}${(p.bio||'').length>120 ? '...' : ''}</div>` : ''}
            <div>${badgesHtml}</div>
            <div style="font-size:0.8rem;color:var(--muted);margin-top:10px">Joined ${p.created_at ? new Date(p.created_at).toLocaleDateString() : '‚Äî'}</div>
          </div>
        `;
      }).join('');
    }

    // search within loaded profiles (client-side)
    const profilesSearchInput = document.getElementById('profilesSearchInput');
    if (profilesSearchInput) {
      profilesSearchInput.addEventListener('input', (e) => {
        const q = e.target.value.trim().toLowerCase();
        if (!q) { applyCategoryFilter(); return; }
        const filtered = (allProfiles || []).filter(p => {
          const username = (p.username||'').toLowerCase();
          const display = (p.display_name||'').toLowerCase();
          const bio = (p.bio||'').toLowerCase();
          return username.includes(q) || display.includes(q) || bio.includes(q);
        });
        displayProfiles(filtered);
      });
    }

    function escapeHtml(s) {
      if (!s) return '';
      return String(s)
        .replaceAll('&', '&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;')
        .replaceAll('"','&quot;').replaceAll("'",'&#039;');
    }

    // Load on start
    loadProfilesForUI();
  </script>
</body>
</html>
