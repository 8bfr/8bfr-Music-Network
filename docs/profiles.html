<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Profiles — Debug</title>
  <style>
    body{font-family:system-ui,Arial;background:#0b0215;color:#eae6ff;margin:0;padding:16px}
    .container{max-width:980px;margin:0 auto}
    header{display:flex;justify-content:space-between;align-items:center}
    h1{margin:0;font-size:1.2rem}
    #profilesGrid{margin-top:12px;display:grid;grid-template-columns:1fr;gap:8px}
    .card{background:#12051c;padding:12px;border-radius:10px;border:1px solid rgba(255,255,255,0.03)}
    .empty{padding:28px;text-align:center;color:#bca9e6;border:1px dashed rgba(168,85,247,0.06);border-radius:10px}
    pre.debug{white-space:pre-wrap;background:#060014;color:#d8c8ff;padding:10px;border-radius:8px;overflow:auto;max-height:360px}
    button.small{padding:6px 10px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:#eae6ff}
    .error{background:#4a1328;color:#ffd7e6;padding:8px;border-radius:8px;margin-top:8px}
  </style>

  <!-- supabase bundle -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/bundle.js"></script>
</head>
<body>
  <div class="container">
    <header>
      <div>
        <h1>Profiles — Debug Build</h1>
        <div><small id="statusLine">Initializing…</small></div>
      </div>
      <div>
        <button id="reloadBtn" class="small">Reload</button>
      </div>
    </header>

    <div id="debugWrap" class="card" style="margin-top:12px">
      <strong>Runtime debug</strong>
      <pre id="debugPre" class="debug">Starting checks…</pre>
      <div style="margin-top:8px">
        <button id="runChecks" class="small">Run checks</button>
      </div>
    </div>

    <div id="profilesGrid" aria-live="polite">
      <div class="empty">Loading profiles…</div>
    </div>
  </div>

  <script>
    (function(){
      const SUPABASE_URL = 'https://novbuvwpjnxwwvdekjhr.supabase.co';
      const SUPABASE_KEY = 'REPLACE_WITH_ANON_KEY_IF_DIFFERENT'; // set if available

      const debugPre = document.getElementById('debugPre');
      const statusLine = document.getElementById('statusLine');
      const profilesGrid = document.getElementById('profilesGrid');
      const runChecksBtn = document.getElementById('runChecks');
      const reloadBtn = document.getElementById('reloadBtn');

      function logDebug(...parts){
        const time = new Date().toLocaleTimeString();
        debugPre.textContent += `\n[${time}] ` + parts.map(p => {
          try { return typeof p === 'string' ? p : JSON.stringify(p); } catch(e){ return String(p); }
        }).join(' ');
        debugPre.scrollTop = debugPre.scrollHeight;
      }

      function setStatus(msg){ statusLine.textContent = msg; }

      // global error capture
      window.addEventListener('error', (ev) => {
        logDebug('Uncaught error:', ev.message || ev.error || ev);
        showUIError('Uncaught JS error: ' + (ev.message || JSON.stringify(ev.error || ev)));
      });
      window.addEventListener('unhandledrejection', (ev) => {
        logDebug('Unhandled rejection:', ev.reason);
        showUIError('Unhandled promise rejection: ' + JSON.stringify(ev.reason));
      });

      function showUIError(msg){
        let el = document.getElementById('uiError');
        if (!el) {
          el = document.createElement('div');
          el.id = 'uiError';
          el.className = 'error';
          document.querySelector('.container').insertBefore(el, document.getElementById('profilesGrid'));
        }
        el.textContent = msg;
      }

      // Try multiple client init strategies and report diagnostics
      async function runChecks(){
        debugPre.textContent = '';
        setStatus('Running checks...');
        logDebug('Check: CDN presence');
        logDebug('window.createClient:', typeof window.createClient);
        logDebug('window.supabase:', typeof window.supabase);
        logDebug('window._profiles_debug exists?:', !!window._profiles_debug);

        // attempt client init
        let client = null;
        try {
          if (typeof createClient === 'function') {
            logDebug('Found createClient global — calling createClient(url, key)');
            client = createClient(SUPABASE_URL, SUPABASE_KEY);
            logDebug('createClient returned object with keys:', Object.keys(client || {}));
          } else if (window.supabase && typeof window.supabase.createClient === 'function') {
            logDebug('Found window.supabase.createClient — using it');
            client = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
            logDebug('client keys:', Object.keys(client || {}));
          } else if (window.supabase && typeof window.supabase === 'object') {
            logDebug('Found window.supabase object — using as client');
            client = window.supabase;
          } else {
            logDebug('No known supabase global found.');
          }
        } catch(err){
          logDebug('Client init threw:', String(err));
        }

        if (!client) {
          setStatus('Client init failed');
          showUIError('Supabase client could not be initialized. CDN may not have loaded or global names differ.');
          profilesGrid.innerHTML = '<div class="empty">Error: client init failed — see debug panel above.</div>';
          return;
        }

        // expose short debug object
        window._profiles_debug = { client };

        // Test a simple RPC/refetch via client REST (using from().select)
        try {
          setStatus('Querying view via supabase-js client...');
          logDebug('Querying profiles_search_view via supabase client .from().select(*)');
          const { data, error, status } = await client.from('profiles_search_view').select('*').limit(50);
          logDebug('client query returned status:', status, 'error:', error ? (error.message || error) : 'none');
          if (error) {
            showUIError('Client query error: ' + (error.message || JSON.stringify(error)));
            profilesGrid.innerHTML = `<div class="empty">Query error: ${escapeHtml(error.message || JSON.stringify(error))}</div>`;
          } else if (!Array.isArray(data) || data.length === 0) {
            profilesGrid.innerHTML = '<div class="empty">No profiles returned (0 rows). If you expect rows, verify RLS/anon key and view contents.</div>';
            setStatus('Query completed — 0 rows');
            logDebug('Query data preview:', JSON.stringify(data && data.slice(0,5) || []));
          } else {
            profilesGrid.innerHTML = '<div class="card"><strong>Profiles loaded:</strong> ' + data.length + ' rows (showing up to 10)</div>';
            const list = data.slice(0,10).map(p => `<div class="card"><strong>${escapeHtml(p.username||p.display_name||p.id)}</strong><div style="color:#bca9e6">${escapeHtml((p.bio||'').slice(0,120))}</div></div>`).join('');
            profilesGrid.innerHTML += list;
            setStatus('Loaded ' + data.length + ' rows');
            logDebug('Data sample:', JSON.stringify(data.slice(0,5)));
          }
        } catch (e) {
          logDebug('Client query threw:', String(e));
          showUIError('Client query threw an exception. See debug panel.');
          profilesGrid.innerHTML = `<div class="empty">Client query exception: ${escapeHtml(String(e))}</div>`;
        }

        // Also try a direct fetch to the REST endpoint (useful if supabase client can't authenticate)
        try {
          setStatus('Fetching REST endpoint directly...');
          const headers = { Accept: 'application/json' };
          if (SUPABASE_KEY && SUPABASE_KEY !== 'REPLACE_WITH_ANON_KEY_IF_DIFFERENT') headers['apikey'] = SUPABASE_KEY;
          const url = SUPABASE_URL + '/rest/v1/profiles_search_view?select=*';
          logDebug('Direct fetch to', url, 'headers:', Object.keys(headers));
          const r = await fetch(url, { method:'GET', headers });
          const text = await r.text();
          logDebug('REST fetch status:', r.status, 'bodyPreview:', text.slice(0,1000));
          if (r.status === 200) {
            setStatus('REST fetch succeeded');
            logDebug('REST body length', text.length);
          } else {
            setStatus('REST fetch returned ' + r.status);
            showUIError('REST fetch status ' + r.status + '. Check anon key and CORS / RLS settings.');
          }
        } catch (e) {
          logDebug('REST fetch threw:', String(e));
          showUIError('REST fetch failed: ' + String(e));
        }

        setStatus('Checks complete');
      }

      // utilities
      function escapeHtml(s){ if (!s) return ''; return String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;').replaceAll("'",'&#039;'); }

      runChecksBtn.addEventListener('click', runChecks);
      reloadBtn.addEventListener('click', () => location.reload());

      // run checks automatically once on load after a short delay so the CDN has time to load
      setTimeout(() => runChecks().catch(e => logDebug('runChecks top-level thrown:', String(e))), 400);
    })();
  </script>
</body>
</html>
