<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Site Search</title>
  <style>
    :root{--bg:#040014; --card:#12051c; --accent:#a855f7; --muted:#b7a7dc; --text:#f4eeff}
    body{background:linear-gradient(180deg,#03000a,#070016); color:var(--text); font-family:Inter,system-ui,Arial; margin:0;padding:20px}
    .container{max-width:980px;margin:0 auto}
    header{display:flex;flex-direction:column; gap:8px; margin-bottom:18px}
    h1{margin:0;font-size:1.3rem}
    .search-row{display:flex; gap:8px; align-items:center}
    input[type="search"]{flex:1;padding:10px 14px;border-radius:10px;border:1px solid rgba(255,255,255,0.06);background:rgba(255,255,255,0.02); color:var(--text)}
    button{padding:10px 12px;border-radius:10px;background:linear-gradient(90deg,var(--accent),#7c3aed);border:none;color:#fff;cursor:pointer}
    .filters{display:flex;gap:8px;margin-top:10px;flex-wrap:wrap}
    .chip{padding:6px 10px;border-radius:999px;background:rgba(255,255,255,0.03);border:1px solid rgba(168,85,247,0.06);cursor:pointer;color:var(--muted)}
    #searchResults{margin-top:18px}
    .result-card{background:rgba(255,255,255,0.02);border:1px solid rgba(168,85,247,0.04);padding:12px;border-radius:10px;margin-bottom:10px;display:flex;justify-content:space-between}
    .result-info{flex:1;margin-left:10px}
    .result-name{font-weight:700;color:#fff}
    .result-snippet{color:var(--muted);margin-top:6px}
    .empty-state{text-align:center;padding:36px;border:1px dashed rgba(168,85,247,0.06); border-radius:12px;color:var(--muted)}
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/bundle.js"></script>
</head>
<body>
  <div class="container">
    <header>
      <h1>Search the site</h1>
      <div class="search-row">
        <input id="searchInput" type="search" placeholder="Search profiles, songs, posts, pages, content..." />
        <button id="searchBtn">Search</button>
      </div>
      <div class="filters" id="sourceFilters" aria-hidden="true">
        <div class="chip" data-src="all">All</div>
        <div class="chip" data-src="profiles">Profiles</div>
        <div class="chip" data-src="songs">Songs</div>
        <div class="chip" data-src="posts">Posts</div>
        <div class="chip" data-src="pages">Pages</div>
        <div class="chip" data-src="content">Content</div>
      </div>
    </header>

    <main>
      <div id="searchResults">
        <div class="empty-state">
          <div style="font-size:3rem">ðŸ”Ž</div>
          <div style="font-weight:700;margin-top:8px">Start typing to search the site</div>
          <div style="margin-top:6px;color:var(--muted)">Searching profiles, songs, posts, pages and content</div>
        </div>
      </div>
    </main>
  </div>

  <script>
    const SUPABASE_URL = 'https://novbuvwpjnxwwvdekjhr.supabase.co';
    const SUPABASE_KEY = ''eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5vdmJ1dndwam54d3d2ZGVramhyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjExODkxODUsImV4cCI6MjA3Njc2NTE4NX0.1UUkdGafh6ZplAX8hi7Bvj94D2gvFQZUl0an1RvcSA0';';
    const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

    const input = document.getElementById('searchInput');
    const btn = document.getElementById('searchBtn');
    const resultsEl = document.getElementById('searchResults');
    const chips = Array.from(document.querySelectorAll('.chip'));
    let activeSource = 'all';

    chips.forEach(c => {
      c.addEventListener('click', () => {
        chips.forEach(x => x.classList.remove('active'));
        c.classList.add('active');
        activeSource = c.dataset.src || 'all';
        // optionally re-run search with filter
        if (input.value && input.value.trim()) doSiteSearch(input.value.trim());
      });
    });

    btn.addEventListener('click', () => {
      const q = input.value.trim();
      doSiteSearch(q);
    });

    // support Enter
    input.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        doSiteSearch(input.value.trim());
      }
    });

    async function doSiteSearch(q) {
      if (!q) {
        renderEmpty();
        return;
      }
      resultsEl.innerHTML = '<div class="empty-state">Searchingâ€¦</div>';
      try {
        const { data, error } = await supabase.rpc('site_search', { q: q, limit_rows: 200 });
        if (error) throw error;
        const items = data || [];
        renderCombinedResults(items);
      } catch (err) {
        console.error('Search error', err);
        resultsEl.innerHTML = `<div class="empty-state">Error: ${escapeHtml(err.message || String(err))}</div>`;
      }
    }

    function renderEmpty() {
      resultsEl.innerHTML = `
        <div class="empty-state">
          <div style="font-size:3rem">ðŸ”Ž</div>
          <div style="font-weight:700;margin-top:8px">Start typing to search the site</div>
          <div style="margin-top:6px;color:var(--muted)">Searching profiles, songs, posts, pages and content</div>
        </div>
      `;
    }

    function renderCombinedResults(items) {
      if (!items || items.length === 0) {
        resultsEl.innerHTML = '<div class="empty-state">No results</div>';
        return;
      }

      // Apply source filter if required
      let filtered = items;
      if (activeSource && activeSource !== 'all') {
        filtered = items.filter(it => it.source === activeSource);
      }

      if (filtered.length === 0) {
        resultsEl.innerHTML = '<div class="empty-state">No results for selected source</div>';
        return;
      }

      const labelMap = { profiles: 'Profiles', songs: 'Songs', posts: 'Posts', pages: 'Pages', content: 'Content' };
      const iconMap = { profiles: 'ðŸ‘¤', songs: 'ðŸŽµ', posts: 'ðŸ“', pages: 'ðŸ“„', content: 'ðŸ“š' };

      // Build HTML
      const html = filtered.map(it => {
        const title = escapeHtml(it.title || (it.source === 'profiles' ? 'Profile' : it.source));
        const snippet = escapeHtml((it.snippet || '').toString()).replace(/\n/g, ' ');
        const created = it.created_at ? new Date(it.created_at).toLocaleString() : '';
        let href = '#';
        if (it.source === 'profiles') href = `profile.html?id=${encodeURIComponent(it.id)}`;
        else if (it.source === 'songs') href = `song.html?id=${encodeURIComponent(it.id)}`;
        else if (it.source === 'posts') href = `post.html?id=${encodeURIComponent(it.id)}`;
        else if (it.source === 'pages') href = `page.html?id=${encodeURIComponent(it.id)}`;
        else if (it.source === 'content') href = `content.html?id=${encodeURIComponent(it.id)}`;

        return `
          <div class="result-card">
            <div style="display:flex;align-items:center">
              <div style="font-size:22px">${iconMap[it.source] || 'ðŸ“Œ'}</div>
              <div class="result-info">
                <div class="result-name"><a href="${href}" style="color:inherit;text-decoration:none">${title}</a> <small style="color:var(--muted);font-weight:600;margin-left:8px">${labelMap[it.source] || it.source}</small></div>
                <div class="result-snippet">${snippet}</div>
              </div>
            </div>
            <div style="text-align:right;min-width:120px;color:var(--muted);font-size:12px">${created}</div>
          </div>
        `;
      }).join('');
      resultsEl.innerHTML = html;
    }

    function escapeHtml(s) {
      if (!s) return '';
      return String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;').replaceAll("'",'&#039;');
    }

    // initial state
    renderEmpty();
  </script>
</body>
</html>
