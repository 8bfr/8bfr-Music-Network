<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Set new password â€” 8BFR</title>
  <meta name="description" content="Set a new password." />
  <style>
    :root{ --glass: rgba(12,6,24,.88); --accent:#7c3aed; }
    html,body{ height:100%; margin:0; font-family:system-ui, -apple-system, "Segoe UI", Roboto, Arial; background:
      radial-gradient(1200px 600px at 10% -10%, rgba(124,58,237,.35), transparent 60%),
      linear-gradient(#0b0014,#000); color:#eae6ff;}
    .wrap{ max-width:640px; margin:7vh auto; padding:22px; background:var(--glass); border-radius:12px; border:1px solid rgba(124,58,237,.18);}
    input{ width:100%; padding:10px; border-radius:8px; border:1px solid rgba(255,255,255,.06); background:rgba(255,255,255,.02); color:inherit; }
    button{ margin-top:12px; padding:10px; background:linear-gradient(90deg,var(--accent),#00d9ff); border:0; color:#040014; border-radius:8px; cursor:pointer; font-weight:600; }
    .muted{ color:#cfc7ff; font-size:13px; margin-top:8px;}
    .error{ color:#ffb4b4; background: rgba(255,80,80,0.06); padding:8px; border-radius:8px; margin-top:12px; }
  </style>
</head>
<body>
  <div class="wrap">
    <h2>Choose a new password</h2>
    <p class="muted">This page reads the token from the link you received. If you do not have a valid link, use the Reset Password page.</p>

    <form id="changeForm" novalidate>
      <label for="password">New password</label>
      <input id="password" type="password" minlength="6" required />
      <div id="error" class="error" style="display:none;"></div>
      <button id="saveBtn" type="submit">Save new password</button>
      <div id="message" class="muted" style="display:none;"></div>
    </form>
  </div>

  <script>
    (function(){
      // This page expects an access_token in the URL (sent by Supabase auth reset link)
      // Example: change-password.html#access_token=xyz&...
      const saveBtn = document.getElementById('saveBtn');
      const pwd = document.getElementById('password');
      const err = document.getElementById('error');
      const msg = document.getElementById('message');

      function showError(t){ err.style.display='block'; err.textContent=t; msg.style.display='none'; }
      function showMsg(t){ msg.style.display='block'; msg.textContent=t; err.style.display='none'; }

      // parse fragment for access_token
      const hash = location.hash.replace(/^#/, '');
      const params = new URLSearchParams(hash);
      const accessToken = params.get('access_token');

      if (!accessToken) {
        showError('No token found in URL. Use the reset password flow and click the link in your email.');
      }

      async function callSetPassword(token, newPassword){
        // Use Supabase auth endpoint to update the user password using the token
        // This endpoint is public but requires the token in the Authorization header as Bearer.
        // We do not need anon key for this because the token represents the user's session.
        try {
          const resp = await fetch('https://xyz.supabase.co/auth/v1/user', {
            method: 'PUT',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': 'Bearer ' + token
            },
            body: JSON.stringify({ password: newPassword })
          });
          if (!resp.ok) {
            const txt = await resp.text();
            throw new Error('Failed to change password: ' + txt);
          }
          return await resp.json();
        } catch (e) {
          throw e;
        }
      }

      document.getElementById('changeForm').addEventListener('submit', async (ev) => {
        ev.preventDefault();
        err.style.display='none';
        msg.style.display='none';
        const newPassword = pwd.value.trim();
        if (!newPassword || newPassword.length < 6) {
          showError('Please provide a password of at least 6 characters.');
          return;
        }
        if (!accessToken) {
          showError('No access token (link invalid).');
          return;
        }
        saveBtn.disabled = true;
        saveBtn.textContent = 'Saving...';
        try {
          // IMPORTANT: Replace the example supabase URL with your actual project URL below
          // or leave as-is if you prefer to initialize supabase client instead.
          const SUPABASE_URL = 'https://YOUR-PROJECT.supabase.co'; // <-- REPLACE
          // call REST endpoint
          const resp = await fetch(`${SUPABASE_URL}/auth/v1/user`, {
            method: 'PUT',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': 'Bearer ' + accessToken
            },
            body: JSON.stringify({ password: newPassword })
          });
          if (!resp.ok) {
            const txt = await resp.text();
            throw new Error(txt || 'Unable to set new password.');
          }
          showMsg('Password changed successfully. You can now sign in.');
          saveBtn.textContent = 'Done';
          // Optionally redirect after a short delay
          setTimeout(() => location.href = '/index.html', 1700);
        } catch (e) {
          console.error(e);
          showError(e.message || 'An error occurred while changing password.');
        } finally {
          saveBtn.disabled = false;
        }
      });
    })();
  </script>
</body>
</html>
