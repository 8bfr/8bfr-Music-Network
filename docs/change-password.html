<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Choose a new password — 8BFR Music Network</title>
  <meta name="description" content="Set a new password for your 8BFR account." />
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    :root{
      --ring: rgba(124,58,237,.65);
      --glass: rgba(12,6,24,.88);
    }
    html,body{ scroll-behavior:smooth; }
    body{
      font-family: system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial;
      background:
        radial-gradient(1200px 600px at 10% -10%, rgba(124,58,237,.35), transparent 60%),
        radial-gradient(900px 400px at 110% 10%, rgba(0,217,255,.22), transparent 60%),
        linear-gradient(#0b0014,#000);
      color:#eae6ff;
      margin:0;
      min-height:100vh;
      display:flex;
      flex-direction:column;
      align-items:center;
    }
    header{
      position:relative;
      z-index:5;
      background:rgba(15,0,30,.9);
      border-bottom:1px solid rgba(124,58,237,.5);
      width:100%;
    }
    .section-card{
      border:1px solid rgba(124,58,237,.35);
      background:#0c0618;
      border-radius:16px;
      box-shadow:0 0 24px rgba(124,58,237,.25);
    }
    .btn{
      display:inline-flex;
      justify-content:center;
      align-items:center;
      gap:.4rem;
      background:#120327;
      border:1px solid rgba(124,58,237,.6);
      color:#eae6ff;
      padding:.6rem .95rem;
      border-radius:.75rem;
      text-decoration:none;
      font-size:.9rem;
      cursor:pointer;
    }
    .btn-primary{
      background:#7c3aed;
      border-color:#7c3aed;
      color:#fff;
    }
    .error-text{
      font-size:.9rem;
      color:#fecaca;
    }
    .success-text{
      font-size:.9rem;
      color:#bbf7d0;
    }
    main{ width:100%; padding:2rem 1rem; display:flex; justify-content:center; }
    .card-inner{ max-width:520px; width:100%; padding:20px; }
    input[type="password"], input[type="email"], input[type="text"], button[type="button"], button[type="submit"]{
      width:100%;
      border-radius:10px;
      padding:10px 12px;
      border:1px solid rgba(124,58,237,.25);
      background:rgba(0,0,0,.45);
      color:inherit;
      outline:none;
      margin-top:8px;
    }
    small{ color:#cfc0ff; display:block; margin-top:6px; }
    footer{
      border-top:1px solid rgba(124,58,237,.35);
      background:#050013cc;
      margin-top:auto;
      width:100%;
      padding:10px 0;
      text-align:center;
      font-size:11px;
      color:rgba(221,214,255,.7);
    }
  </style>
</head>
<body data-no-global-carrie="true">
  <header class="px-4 py-4">
    <div class="max-w-4xl mx-auto flex items-end justify-between gap-3" style="display:flex;align-items:flex-end;justify-content:space-between;">
      <div style="display:flex;align-items:center;gap:12px;">
        <img src="assets/images/logo_8bfr.svg" alt="8BFR logo" class="h-10 w-auto"
             onerror="this.onerror=null;this.src='assets/images/8bfr.png'">
        <div>
          <h1 style="font-size:1.2rem;margin:0;font-weight:700">8BFR <span style="color:#00d9ff">Music</span> Network</h1>
          <p style="font-size:10px;color:#9ee6b0;font-family:monospace;margin-top:-6px">CHANGE PASSWORD</p>
        </div>
      </div>
      <a href="index.html" class="text-[#00d9ff] underline/50 hover:underline" style="position:relative;z-index:6">← Back home</a>
    </div>
  </header>

  <main>
    <div class="section-card card-inner">
      <h2 style="font-size:1.125rem;margin:0 0 8px 0">Choose a new password</h2>
      <p id="info" style="margin:0 0 12px 0;color:#d7cfff">Follow the link in your email or enter the 6-digit code from the email below.</p>

      <form id="pwForm" novalidate style="display:none">
        <label for="password" style="display:block;margin-top:8px;color:#ddd;font-size:0.9rem">New password</label>
        <input id="password" type="password" placeholder="New password (min 8 chars)" required />
        <label for="confirm" style="display:block;margin-top:8px;color:#ddd;font-size:0.9rem">Confirm password</label>
        <input id="confirm" type="password" placeholder="Confirm new password" required />
        <button id="setBtn" type="submit" class="btn btn-primary" style="margin-top:12px">Set new password</button>
        <p id="msg" class="error-text" aria-live="polite" style="margin-top:10px;display:none"></p>
        <p id="ok" class="success-text" aria-live="polite" style="margin-top:10px;display:none"></p>
      </form>

      <div id="fallback" style="display:none; margin-top:12px;">
        <p style="color:#cfbfff;margin:0 0 8px 0">If your reset email contained a 6-digit code instead of a link, enter it here.</p>
        <input id="fallbackEmail" type="email" placeholder="Your email" />
        <input id="fallbackToken" type="text" placeholder="6-digit code from email" />
        <button id="fallbackVerify" type="button" class="btn" style="margin-top:8px">Verify code and continue</button>
      </div>
    </div>
  </main>

  <footer>© 2025 8BFR Music Network — “Empowering creators, connecting the world.”</footer>

  <script>
    (function(){
      const SUPABASE_URL = "https://novbuvwpjnxwwvdekjhr.supabase.co";
      const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5vdmJ1dndwam54d3d2ZGVramhyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjExODkxODUsImV4cCI6MjA3Njc2NTE4NX0.1UUkdGafh6ZplAX8hi7Bvj94D2gvFQZUl0an1RvcSA0";

      if (!window.supabase || !window.supabase.createClient) {
        const msgEl = document.getElementById('msg');
        msgEl.style.display = 'block';
        msgEl.textContent = 'Login system unavailable. Please try again later.';
        return;
      }

      const { createClient } = supabase;
      const client = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

      const info = document.getElementById('info');
      const form = document.getElementById('pwForm');
      const msg = document.getElementById('msg');
      const ok = document.getElementById('ok');
      const fallback = document.getElementById('fallback');

      // Parse search params and hash for tokens
      const url = new URL(window.location.href);
      const params = new URLSearchParams(url.search);
      const token_hash = params.get('token_hash');
      const type = params.get('type'); // usually 'recovery'
      const hash = new URLSearchParams(window.location.hash.replace('#',''));
      const access_token = hash.get('access_token');

      // Show form if we have a token or session, otherwise show fallback
      if (token_hash || access_token || type === 'recovery') {
        info.textContent = 'Enter a new password below.';
        form.style.display = 'block';
      } else {
        info.textContent = 'No reset token found in the URL. Use the fallback to enter the 6-digit code from your email.';
        fallback.style.display = 'block';
      }

      // Helper to show messages
      function showMsg(text,type='error') {
        if (type === 'error') {
          msg.style.display = 'block'; ok.style.display = 'none';
          msg.textContent = text;
        } else {
          ok.style.display = 'block'; msg.style.display = 'none';
          ok.textContent = text;
        }
      }

      // Password form submit
      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        msg.style.display = 'none'; ok.style.display = 'none';
        const pw = document.getElementById('password').value || '';
        const confirm = document.getElementById('confirm').value || '';
        if (pw !== confirm) { showMsg('Passwords do not match'); return; }
        if (pw.length < 8) { showMsg('Use at least 8 characters'); return; }

        const setBtn = document.getElementById('setBtn');
        setBtn.disabled = true;
        setBtn.textContent = 'Updating…';

        try {
          // If access_token present, set the session and update user
          if (access_token) {
            await client.auth.setSession({ access_token });
            const { error: updErr } = await client.auth.updateUser({ password: pw });
            if (updErr) { showMsg(updErr.message || 'Unable to update password'); return; }
            showMsg('Password updated — redirecting to home…','success');
            setTimeout(()=>window.location.href='index.html',900);
            return;
          }

          // If token_hash present, verify OTP (recovery) then update password
          if (token_hash) {
            const { data, error: verErr } = await client.auth.verifyOtp({ token_hash, type: 'recovery' });
            if (verErr) { showMsg(verErr.message || 'Token verification failed'); return; }
            // After verification the user is signed in in the returned session; set it if provided
            if (data && data.session && data.session.access_token) {
              await client.auth.setSession({ access_token: data.session.access_token });
            }
            const { error: updErr } = await client.auth.updateUser({ password: pw });
            if (updErr) { showMsg(updErr.message || 'Unable to update password'); return; }
            showMsg('Password updated — redirecting to home…','success');
            setTimeout(()=>window.location.href='index.html',900);
            return;
          }

          showMsg('No token available to verify. Use the fallback.');
        } catch (err) {
          console.error(err);
          showMsg('Unexpected error — check console.');
        } finally {
          setBtn.disabled = false;
          setBtn.textContent = 'Set new password';
        }
      });

      // Fallback: verify OTP code (6-digit) then show password form
      document.getElementById('fallbackVerify').addEventListener('click', async () => {
        msg.style.display = 'none'; ok.style.display = 'none';
        const email = (document.getElementById('fallbackEmail').value || '').trim();
        const token = (document.getElementById('fallbackToken').value || '').trim();
        if (!email || !token) { showMsg('Email and code required'); return; }

        try {
          // type 'email' is used for OTP email sign-ins/verification
          const { data, error } = await client.auth.verifyOtp({ email, token, type: 'email' });
          if (error) { showMsg(error.message || 'Verification failed'); return; }
          // On success the user is signed in — show password form to update password
          showMsg('Code verified — enter a new password below.','success');
          fallback.style.display = 'none';
          form.style.display = 'block';
          // If Supabase returned a session (data), set it
          if (data && data.session && data.session.access_token) {
            await client.auth.setSession({ access_token: data.session.access_token });
          }
        } catch (err) {
          console.error(err);
          showMsg('Unexpected error during verification');
        }
      });
    })();
  </script>
</body>
</html>
