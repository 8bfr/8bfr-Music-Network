<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Reset password â€” 8BFR Music Network</title>
  <meta name="description" content="Reset your 8BFR password." />
  <link rel="icon" href="assets/images/favicon.png" />
  <!-- Supabase JS (optional fallback) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.31.0/dist/supabase.min.js" defer></script>
  <style>
    :root{ --bg1: #0b0014; --accent: #7c3aed; --glass: rgba(12,6,24,.88); }
    html,body{ height:100%; margin:0; font-family:system-ui, -apple-system, "Segoe UI", Roboto, Arial; background:
      radial-gradient(1200px 600px at 10% -10%, rgba(124,58,237,.35), transparent 60%),
      radial-gradient(900px 400px at 110% 10%, rgba(0,217,255,.22), transparent 60%),
      linear-gradient(#0b0014,#000); color:#eae6ff; }
    .container{ max-width:680px; width:94%; margin:6vh auto; }
    .card{ background:var(--glass); border:1px solid rgba(124,58,237,.18); padding:28px; border-radius:12px; box-shadow:0 8px 40px rgba(0,0,0,.6); }
    h1{ margin:0 0 10px 0; font-size:20px; letter-spacing:.2px; }
    p.lead{ margin:0 0 18px 0; color:#cfc7ff; }
    label{ display:block; margin-bottom:6px; font-size:13px; color:#ded7ff; }
    input[type="email"], input[type="password"]{ width:100%; padding:10px 12px; border-radius:8px; border:1px solid rgba(255,255,255,.06); background:rgba(255,255,255,.02); color:inherit; box-sizing:border-box; }
    button{ margin-top:12px; padding:10px 14px; background:linear-gradient(90deg,var(--accent),#00d9ff); color:#040014; border:0; border-radius:8px; cursor:pointer; font-weight:600; }
    .muted{ color:#bfb6ff; font-size:13px; margin-top:10px; }
    .hidden{ display:none !important; }
    .error{ color:#ffb4b4; background: rgba(255,80,80,0.06); padding:8px 10px; border-radius:8px; margin-top:12px; }
    a.small{ color:#cfc7ff; text-decoration:underline; font-size:13px; }
    .row{ display:flex; gap:10px; align-items:center; }
    .row .flex{ flex:1; }
  </style>
</head>
<body>
  <div class="container">
    <div class="card" id="card">
      <h1>Reset your password</h1>
      <p class="lead">Enter your account email and we'll send a link to reset your password.</p>

      <form id="resetForm" novalidate>
        <label for="email">Email</label>
        <input id="email" name="email" type="email" placeholder="you@domain.com" required />
        <div class="row">
          <div class="flex">
            <button id="sendBtn" type="submit">Send reset email</button>
          </div>
        </div>
        <div id="msg" class="muted hidden" role="status" aria-live="polite"></div>
        <div id="error" class="error hidden"></div>

        <p class="muted" style="margin-top:18px">
          If you followed a reset link, use the change-password page after clicking the link.
        </p>
        <p style="margin-top:6px"><a class="small" href="change-password.html">I already have a link</a></p>
      </form>
    </div>
  </div>

  <script>
    (function(){
      const baseUrl = 'https://8bfr.github.io/8bfr-Music-Network';
      const card = document.getElementById('card');
      const form = document.getElementById('resetForm');
      const emailInput = document.getElementById('email');
      const msg = document.getElementById('msg');
      const err = document.getElementById('error');
      const sendBtn = document.getElementById('sendBtn');

      function showMsg(text){
        err.classList.add('hidden');
        msg.textContent = text;
        msg.classList.remove('hidden');
      }
      function showError(text){
        msg.classList.add('hidden');
        err.textContent = text;
        err.classList.remove('hidden');
      }

      // If Supabase JS didn't load, still show the form (so page isn't blank on mobile)
      const hasSupabase = typeof window.supabase !== 'undefined' && typeof window.supabase.createClient === 'function';

      // Optional: a lightweight fetch-based fallback that calls your Supabase project's auth/v1/reset endpoint.
      // Replace /project-ref and endpoint as needed if you prefer.
      async function sendResetEmailFallback(email){
        // NOTE: This endpoint requires your project's anon key for the REST call.
        // To avoid exposing keys, prefer using Supabase JS on the client or trigger from your server.
        // Here we attempt to call the public endpoint if you configure it. If you don't have anon key available,
        // the user will see an error and can use manual signup flow.
        const supabaseUrl = ''; // OPTIONAL: set to your Supabase URL (e.g., https://xyz.supabase.co)
        const anonKey = '';     // OPTIONAL: set to your anon key if you want the fallback to work
        if (!supabaseUrl || !anonKey) {
          throw new Error('Reset email cannot be sent from this host. Please use the in-app reset or contact support.');
        }
        const resp = await fetch(`${supabaseUrl}/auth/v1/recover`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            apiKey: anonKey
          },
          body: JSON.stringify({ email })
        });
        if (!resp.ok) {
          const txt = await resp.text();
          throw new Error('Reset request failed: ' + txt);
        }
        return await resp.json();
      }

      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        const email = (emailInput.value || '').trim();
        if (!email) {
          showError('Please enter your email address.');
          return;
        }
        sendBtn.disabled = true;
        sendBtn.textContent = 'Sending...';
        try {
          if (hasSupabase) {
            // Use Supabase JS if available (recommended)
            // supabaseClient must be initialized in your main app before this page loads.
            const client = window.supabase.createClient?.();
            if (!client) {
              // Try to initialize with environmental placeholders only if you set them (not provided here)
              throw new Error('Supabase client not configured on this page.');
            }
            const { error } = await client.auth.resetPasswordForEmail(email, {
              redirectTo: baseUrl + '/change-password.html'
            });
            if (error) throw error;
            showMsg('If that email exists, we sent a password reset link. Check your inbox.');
          } else {
            // Try fallback (will fail unless you configured supabaseUrl+anonKey above)
            await sendResetEmailFallback(email);
            showMsg('If that email exists, we sent a password reset link. Check your inbox.');
          }
        } catch (e) {
          console.error(e);
          showError(e.message || 'An unexpected error occurred. Try again later.');
        } finally {
          sendBtn.disabled = false;
          sendBtn.textContent = 'Send reset email';
        }
      });

      // Small UX: prefill email if provided via query param
      const params = new URLSearchParams(location.search);
      if (params.get('email')) emailInput.value = params.get('email');
    })();
  </script>
</body>
</html>
