<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Chat with Carrie ‚Äî 8BFR Music Network</title>
  <meta name="description" content="Chat with Carrie ‚Äî your AI assistant on the 8BFR Music Network." />
  <link rel="icon" href="assets/images/favicon.png" />
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    :root {
      --ring: rgba(124,58,237,.55);
      --glass: rgba(12,6,24,.80);
    }
    html,body { scroll-behavior:smooth; }
    body {
      font-family: system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial;
      background:
        radial-gradient(1200px 600px at 10% -10%, rgba(124,58,237,.35), transparent 60%),
        radial-gradient(900px 400px at 110% 10%, rgba(0,217,255,.22), transparent 60%),
        linear-gradient(#0b0014,#000);
      color:#eae6ff;
      margin:0;
      min-height:100vh;
      overflow-x:hidden;
    }
    header{
      position:relative;
      z-index:5;
      background:rgba(15,0,30,.9);
      border-bottom:1px solid rgba(124,58,237,.5);
    }

    /* extra right space so floating menu / carrie don't cover chat */
    .chat-page-main{
      position:relative;
    }
    @media (min-width:1024px){
      .chat-page-main{
        padding-right:7.5rem; /* more room than before */
      }
    }

    .chat-shell{
      border-radius:18px;
      border:1px solid rgba(124,58,237,.55);
      background:rgba(10,2,26,.95);
      box-shadow:0 16px 40px rgba(0,0,0,.75);
    }
    .chat-log{
      height:420px;
      max-height:65vh;
      overflow-y:auto;
      padding:1rem;
      background:
        radial-gradient(circle at 0 0, rgba(124,58,237,.12), transparent 55%),
        radial-gradient(circle at 100% 0, rgba(0,217,255,.10), transparent 55%),
        #020014;
    }
    .msg-row{
      display:flex;
      margin-bottom:.65rem;
      gap:.4rem;
    }
    .msg-row.user{
      justify-content:flex-end;
    }
    .msg-bubble{
      max-width:80%;
      padding:.55rem .8rem;
      border-radius:.85rem;
      font-size:.9rem;
      line-height:1.35;
      border:1px solid rgba(148,163,255,.55);
      background:rgba(17,24,39,.96);
      box-shadow:0 0 12px rgba(79,70,229,.35);
    }
    .msg-row.user .msg-bubble{
      background:linear-gradient(135deg,#7c3aed,#4c1d95);
      border-color:#a855f7;
      box-shadow:0 0 12px rgba(168,85,247,.55);
    }
    .msg-meta{
      font-size:.7rem;
      opacity:.7;
      margin-top:.2rem;
    }
    .msg-avatar{
      width:28px;
      height:28px;
      border-radius:999px;
      flex-shrink:0;
      overflow:hidden;
      border:1px solid rgba(129,140,248,.9);
      display:grid;
      place-items:center;
      font-size:.75rem;
      background:#020014;
    }
    .msg-avatar img{
      width:100%;
      height:100%;
      object-fit:cover;
      display:block;
    }
    .msg-row.user .msg-avatar{
      display:none;
    }

    .pill-tag{
      display:inline-flex;
      align-items:center;
      gap:.25rem;
      font-size:.7rem;
      border-radius:999px;
      padding:.15rem .55rem;
      border:1px solid rgba(129,140,248,.85);
      background:rgba(15,23,42,.9);
      text-transform:uppercase;
      letter-spacing:.08em;
    }

    .btn{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:.3rem;
      background:#120327;
      border:1px solid rgba(124,58,237,.6);
      color:#eae6ff;
      padding:.55rem .95rem;
      border-radius:.75rem;
      font-size:.9rem;
      text-decoration:none;
      cursor:pointer;
    }
    .btn:hover{
      background:#190536;
    }
    .btn-primary{
      background:#7c3aed;
      border-color:#7c3aed;
      color:#fff;
    }
    .btn-primary:hover{ filter:brightness(1.05); }

    textarea#carrieInput{
      resize:none;
      min-height:52px;
      max-height:120px;
      background:rgba(10,2,26,.95);
      border-radius:.75rem;
      border:1px solid rgba(148,163,255,.55);
      padding:.5rem .7rem;
      font-size:.9rem;
      color:#e5e7eb;
    }
    textarea#carrieInput:focus{
      outline:none;
      box-shadow:0 0 0 1px rgba(129,140,248,.9);
      border-color:rgba(129,140,248,1);
    }
    .input-hint{
      font-size:.7rem;
      opacity:.7;
    }
    .typing-dot{
      width:6px;height:6px;border-radius:999px;
      background:#a855f7;
      animation:bounce 1s infinite ease-in-out;
    }
    .typing-dot:nth-child(2){ animation-delay:.15s; }
    .typing-dot:nth-child(3){ animation-delay:.3s; }
    @keyframes bounce{
      0%,80%,100%{ transform:translateY(0); opacity:.4;}
      40%{ transform:translateY(-4px); opacity:1;}
    }

    .mode-toggle{
      display:flex;
      gap:4px;
      justify-content:flex-end;
      align-items:center;
      margin-top:2px;
      flex-wrap:wrap;
    }
    .btn-pill{
      border-radius:999px;
      padding:2px 8px;
      font-size:10px;
      border:1px solid rgba(124,58,237,.6);
      background:#120327;
      color:#eae6ff;
      cursor:pointer;
    }
    .btn-pill-active{
      background:#7c3aed;
      border-color:#7c3aed;
      color:#fff;
    }

    .closet-list label{
      display:flex;
      align-items:center;
      gap:.5rem;
      font-size:11px;
      padding:.25rem .3rem;
      border-radius:.5rem;
      cursor:pointer;
    }
    .closet-list label:hover{
      background:rgba(15,23,42,.8);
    }
    .closet-list input[type="radio"]{
      accent-color:#a855f7;
    }

    @media (max-width:640px){
      .chat-log{ height:60vh; }
      .msg-bubble{ max-width:88%; }
    }
  </style>
</head>
<body>
  <!-- Simple header (Back to Home moved into chat card) -->
  <header class="px-4 py-4">
    <div class="max-w-6xl mx-auto flex items-center justify-between gap-3">
      <div class="flex items-center gap-3">
        <img src="assets/images/logo_8bfr.svg"
             alt="8BFR logo"
             class="h-9 w-auto"
             onerror="this.onerror=null;this.src='assets/images/8bfr.png'">
        <div>
          <h1 class="text-xl sm:text-2xl font-extrabold">
            Chat with <span class="text-[#a855f7]">Carrie</span>
          </h1>
          <p class="text-[11px] text-purple-300/80 -mt-0.5">
            8BFR Music Network ‚Ä¢ Create ‚Ä¢ Connect ‚Ä¢ Collab
          </p>
        </div>
      </div>
    </div>
  </header>

  <main class="chat-page-main max-w-4xl mx-auto px-4 pb-10 pt-4">
    <!-- Chat shell -->
    <div class="chat-shell p-4 sm:p-5">
      <!-- Back to Home moved here, above Live Carrie -->
      <div class="flex justify-end mb-2">
        <a href="index.html"
           class="text-[#00d9ff] text-xs sm:text-sm underline/50 hover:underline">
          ‚¨Ö Back to Home
        </a>
      </div>

      <div class="flex items-center justify-between mb-3 gap-3">
        <div class="flex items-center gap-2">
          <span class="pill-tag">
            <span class="inline-block w-2 h-2 rounded-full bg-green-400 animate-pulse"></span>
            <span>Live Carrie</span>
          </span>
          <span class="text-[11px] text-purple-200/80">
            Site help ‚Ä¢ planning ‚Ä¢ personal chat (PG-13)
          </span>
        </div>
        <div class="text-right space-y-1">
          <div id="sessionIndicator" class="text-[11px] text-purple-200/70">
            Checking login‚Ä¶
          </div>
          <div class="mode-toggle">
            <span id="modeLabel" class="text-[10px] text-purple-200/80">
              Mode: Site / Pro
            </span>
            <button id="modeBusinessBtn" type="button" class="btn-pill">
              Site / Pro
            </button>
            <button id="modePersonalBtn" type="button" class="btn-pill">
              Personal
            </button>
          </div>
          <!-- Owner-only trainer button -->
          <button
            id="trainerBtn"
            type="button"
            class="btn hidden"
            style="padding:2px 8px;font-size:10px;border-radius:999px;"
          >
            Carrie Trainer
          </button>
        </div>
      </div>

      <!-- Chat log -->
      <div id="chatLog" class="chat-log rounded-lg mb-3"></div>

      <!-- Typing indicator -->
      <div id="typingRow" class="hidden mb-2 text-xs text-purple-200/80 flex items-center gap-2">
        <span class="pill-tag">Carrie typing</span>
        <div class="flex items-center gap-1 ml-1">
          <span class="typing-dot"></span>
          <span class="typing-dot"></span>
          <span class="typing-dot"></span>
        </div>
      </div>

      <!-- Input row -->
      <form id="carrieForm" class="mt-1">
        <div class="flex items-end gap-2">
          <div class="flex-1">
            <label for="carrieInput"
                   class="text-xs text-purple-200/80 mb-1 inline-block">
              Business mode: 8BFR, tools, badges. Personal mode: talk about goals, ideas, or just unwind (PG-13).
            </label>
            <textarea id="carrieInput"
                      placeholder="Example: ‚ÄúHelp me plan my week of music and writing.‚Äù"></textarea>
            <p class="input-hint mt-1">
              Press <b>Enter</b> to send ‚Ä¢ <b>Shift+Enter</b> for a new line.
            </p>
          </div>
          <button type="submit" class="btn btn-primary px-3 sm:px-4 h-10">
            <span>Send</span>
            <span>üì§</span>
          </button>
        </div>
      </form>
    </div>

    <!-- Carrie Closet -->
    <div class="mt-4 chat-shell p-4 sm:p-5">
      <h2 class="text-sm font-semibold text-purple-100 mb-2">
        Carrie Closet
      </h2>
      <p class="text-[11px] text-purple-200/80 mb-2">
        Choose how Carrie looks in this chat. Outfit changes here update the avatar you see next to her messages.
        Later, this will sync across the whole network with 8BFR Coins and inventory.
      </p>

      <div class="text-[11px] text-purple-200/90 mb-2">
        Current outfit:
        <span id="closetCurrent" class="font-semibold text-purple-100">
          (loading‚Ä¶)
        </span>
      </div>

      <div class="closet-list space-y-1">
        <!-- Free outfits -->
        <div class="border border-purple-500/50 rounded-lg p-2 bg-black/30 mb-2">
          <div class="flex items-center justify-between mb-1">
            <span class="font-semibold text-purple-100 text-[11px]">Free Looks</span>
            <span class="px-2 py-0.5 rounded-full bg-green-700/70 text-[10px]">
              Unlocked
            </span>
          </div>
          <label>
            <input type="radio" name="carrieOutfit" value="casual_basic">
            <span><b>Casual Carrie</b> ‚Äî hoodie / relaxed vibe (Personal default)</span>
          </label>
          <label>
            <input type="radio" name="carrieOutfit" value="business_basic">
            <span><b>Business Carrie</b> ‚Äî blazer / professional vibe (Site / Pro default)</span>
          </label>
        </div>

        <!-- Coin outfits -->
        <div class="border border-purple-500/50 rounded-lg p-2 bg-black/30">
          <div class="flex items-center justify-between mb-1">
            <span id="closetCoinHeader" class="font-semibold text-purple-100 text-[11px]">Coin Looks (Planned)</span>
            <span id="closetCoinBadge" class="px-2 py-0.5 rounded-full bg-yellow-600/70 text-[10px]">
              8BFR Coins
            </span>
          </div>
          <label>
            <input type="radio" name="carrieOutfit" value="concert_neon">
            <span><b>Concert Neon</b> ‚Äî stage outfit with neon accents (~250 Coins)</span>
          </label>
          <label>
            <input type="radio" name="carrieOutfit" value="streetwear_purple">
            <span><b>Streetwear Purple</b> ‚Äî relaxed street style (~200 Coins)</span>
          </label>
          <label>
            <input type="radio" name="carrieOutfit" value="chill_hoodie_glow">
            <span><b>Chill Hoodie Glow</b> ‚Äî comfy hoodie with light FX (~200 Coins)</span>
          </label>
        </div>
      </div>

      <p class="text-[10px] text-purple-300/80 mt-3" id="closetNote">
        Right now this is a <b>preview</b>. The free looks change Carrie‚Äôs avatar here in chat.
        Coin looks are planned: later they‚Äôll connect to your wallet, inventory, and concerts.
      </p>
    </div>

    <p class="mt-3 text-[11px] text-purple-300/70 text-center max-w-xl mx-auto">
      Carrie is in beta. Conversations may be stored to improve your experience on the 8BFR Music Network.
    </p>
  </main>

  <!-- Carrie Trainer modal (owner only) -->
  <div id="trainerModal" class="fixed inset-0 z-50 hidden">
    <div class="absolute inset-0 bg-black/60 backdrop-blur-sm"></div>
    <div class="relative max-w-md mx-auto mt-24 bg-[#0c0618] border border-purple-500/60 rounded-xl p-4 shadow-2xl">
      <div class="flex items-center justify-between mb-2">
        <h2 class="text-sm font-semibold text-purple-100">
          Carrie Trainer (Owner Only)
        </h2>
        <button
          id="trainerClose"
          type="button"
          class="text-xs text-purple-200 hover:underline"
        >
          Close
        </button>
      </div>
      <p class="text-[11px] text-purple-200/80 mb-2">
        Add a question pattern and the reply you want Carrie to use.
        Replies can include basic HTML and links.
      </p>
      <form id="trainerForm" class="space-y-2">
        <div>
          <label class="text-xs text-purple-200/90 block mb-1">
            User question / pattern (example: "how do i purchase 8bfr music")
          </label>
          <textarea
            id="trainerQuestion"
            class="w-full text-xs rounded-md border border-purple-500/50 bg-[#120327] px-2 py-1 text-purple-50"
            rows="2"
          ></textarea>
        </div>
        <div>
          <label class="text-xs text-purple-200/90 block mb-1">
            Carrie reply (HTML allowed)
          </label>
          <textarea
            id="trainerAnswer"
            class="w-full text-xs rounded-md border border-purple-500/50 bg-[#120327] px-2 py-1 text-purple-50"
            rows="4"
          ></textarea>
        </div>
        <p class="text-[10px] text-purple-300/80">
          Tip: You can add more patterns for the same answer later by repeating this with small variations.
        </p>
        <div class="flex justify-end gap-2 pt-1">
          <button
            type="button"
            id="trainerCancel"
            class="btn"
            style="padding:3px 10px;font-size:11px;"
          >
            Cancel
          </button>
          <button
            type="submit"
            class="btn btn-primary"
            style="padding:3px 10px;font-size:11px;"
          >
            Save &amp; Use
          </button>
        </div>
        <div
          id="trainerStatus"
          class="text-[10px] text-green-300/80 mt-1"
          style="display:none;"
        ></div>
      </form>
    </div>
  </div>

  <!-- Supabase client -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    const SUPABASE_URL = "https://novbuvwpjnxwwvdekjhr.supabase.co";
    const SUPABASE_ANON_KEY =
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5vdmJ1dndwam54d3d2ZGVramhyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjExODkxODUsImV4cCI6MjA3Njc2NTE4NX0.1UUkdGafh6ZplAX8hi7Bvj94D2gvFQZUl0an1RvcSA0";

    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
  </script>

  <script>
    const chatLogEl      = document.getElementById("chatLog");
    const formEl         = document.getElementById("carrieForm");
    const inputEl        = document.getElementById("carrieInput");
    const typingRowEl    = document.getElementById("typingRow");
    const sessionLabelEl = document.getElementById("sessionIndicator");

    const trainerBtn      = document.getElementById("trainerBtn");
    const trainerModal    = document.getElementById("trainerModal");
    const trainerForm     = document.getElementById("trainerForm");
    const trainerClose    = document.getElementById("trainerClose");
    const trainerCancel   = document.getElementById("trainerCancel");
    const trainerQuestion = document.getElementById("trainerQuestion");
    const trainerAnswer   = document.getElementById("trainerAnswer");
    const trainerStatus   = document.getElementById("trainerStatus");

    const modeBusinessBtn = document.getElementById("modeBusinessBtn");
    const modePersonalBtn = document.getElementById("modePersonalBtn");
    const modeLabelEl     = document.getElementById("modeLabel");

    const closetCurrentEl    = document.getElementById("closetCurrent");
    const closetRadios       = document.querySelectorAll('input[name="carrieOutfit"]');
    const closetCoinHeaderEl = document.getElementById("closetCoinHeader");
    const closetCoinBadgeEl  = document.getElementById("closetCoinBadge");
    const closetNoteEl       = document.getElementById("closetNote");

    let currentUserId    = null;
    let currentUserEmail = null;
    let loadingHistory   = false;
    let isOwner          = false;

    let carriePersona = window.carriePersona || "global";

    let carrieMode   = localStorage.getItem("carrieMode")   || "business";       // "business" | "personal"
    let carrieOutfit = localStorage.getItem("carrieOutfit") || "business_basic"; // outfit id

    /* ===== Seeded Site / Pro Q&A (business mode) ===== */
    let carrieScripts = [
      {
        id: "buy_8bfr_music",
        patterns: [
          "how do i purchase 8bfr music",
          "how do i buy 8bfr music",
          "where can i buy 8bfr",
          "how can i purchase 8bfr",
          "how do i purchase 8 bfr music",
          "buy 8bfr music",
          "purchase 8bfr",
          "where can i buy your music",
          "how do i support 8bfr"
        ],
        reply: `
          You can support 8BFR by buying or streaming the music here:<br><br>
          ‚Ä¢ <b>Amazon Music</b> ‚Äî search for ‚Äú8BFR‚Äù in the Amazon Music store.<br>
          ‚Ä¢ <b>Spotify</b> ‚Äî <a href="https://open.spotify.com/artist/127tw52iDXr7BvgB0IGG2x" target="_blank" rel="noopener">stream 8BFR here</a>.<br>
          ‚Ä¢ <b>Other platforms</b> ‚Äî most 8BFR releases appear in Apple Music, YouTube Music, and more.<br><br>
          If you tell me the <b>song title</b>, I can guide you where to look. üíú
        `
      },
      {
        id: "what_is_8bfr",
        patterns: [
          "what is 8bfr",
          "what is 8bfr music network",
          "tell me about 8bfr",
          "what is this site",
          "what is this website"
        ],
        reply: `
          <b>8BFR Music Network</b> is a creator hub where artists, beatmakers, gamers,
          authors, and fans can <b>Create ‚Ä¢ Connect ‚Ä¢ Collab</b>.<br><br>
          You get:<br>
          ‚Ä¢ Profiles for artists, beatmakers, authors, and fans<br>
          ‚Ä¢ Studio &amp; AI tools for lyrics, songs, and more<br>
          ‚Ä¢ Games &amp; tournaments with coins and rewards<br>
          ‚Ä¢ Ads and features to promote your work<br><br>
          I‚Äôm Carrie ‚Äî your AI guide for the whole network. üòä
        `
      },
      {
        id: "signup_login",
        patterns: [
          "how do i sign up",
          "how do i create an account",
          "how do i join",
          "how do i log in",
          "i cant login",
          "i can't log in",
          "forgot my password",
          "reset my password"
        ],
        reply: `
          Here‚Äôs how accounts work on 8BFR:<br><br>
          ‚Ä¢ <b>Sign up</b>: go to <a href="signup.html">signup.html</a> and create a free account.<br>
          ‚Ä¢ <b>Log in</b>: use <a href="login.html">login.html</a> with your email and password.<br>
          ‚Ä¢ <b>Forgot password</b>: use <a href="reset-password.html">reset-password.html</a> or <a href="reset_password.html">reset_password.html</a>.<br><br>
          If you‚Äôre still stuck, hit <b>Contact</b> from the floating menu or use <a href="contact.html">contact.html</a>.
        `
      },
      {
        id: "profiles_featured",
        patterns: [
          "how do i get featured",
          "how do i become a featured artist",
          "how do i get on the home page",
          "how do i get featured on 8bfr"
        ],
        reply: `
          Featured spots are chosen based on a mix of:<br><br>
          ‚Ä¢ <b>Activity</b> ‚Äî posting, sharing, and staying engaged<br>
          ‚Ä¢ <b>Quality</b> ‚Äî strong songs, art, or content<br>
          ‚Ä¢ <b>Support</b> ‚Äî helping the community, not just self-promo<br>
          ‚Ä¢ <b>Events</b> ‚Äî tournaments, challenges, and special drops<br><br>
          Start by completing your <b>profile</b>, sharing links, and joining events on the
          <a href="featured.html">Featured</a> and <a href="game-tournaments.html">Tournaments</a> pages.
        `
      },
      {
        id: "upload_music",
        patterns: [
          "how do i upload music",
          "how do i upload a song",
          "how do i post a track",
          "where do i upload beats"
        ],
        reply: `
          Uploading music is handled through your <b>creator tools and profile</b> pages.<br><br>
          ‚Ä¢ Check <a href="studio-tools.html">Studio Tools</a> and <a href="artist-studio.html">Artist Studio</a> for upload areas.<br>
          ‚Ä¢ Make sure you‚Äôre logged in and your profile type is set correctly (Artist / Beatmaker).<br>
          ‚Ä¢ In early builds, uploads may be limited while we finish the backend ‚Äî watch <a href="announcements.html">Announcements</a> for updates.<br><br>
          If something feels broken, send a message via <a href="contact.html">Contact</a>.
        `
      },
      {
        id: "ads_how_work",
        patterns: [
          "how do ads work",
          "how do i buy an ad",
          "how to buy an ad",
          "how do i promote my music",
          "how do i promote my song",
          "how do i promote on 8bfr"
        ],
        reply: `
          Ads on 8BFR rotate in the <b>Featured Ads</b> carousel on the home page.<br><br>
          ‚Ä¢ There are always <b>5 slots</b> rotating in the banner.<br>
          ‚Ä¢ When you buy a slot, your ad replaces a placeholder until it expires.<br>
          ‚Ä¢ You can click <b>‚ÄúBuy an Ad‚Äù</b> on the home page or go to <a href="ads.html#buy">ads.html#buy</a>.<br><br>
          For best results, use a clear cover image, a short headline, and a link that goes directly to your music, shop, or profile.
        `
      },
      {
        id: "tournaments_games",
        patterns: [
          "how do tournaments work",
          "how do the games work",
          "how do i join a tournament",
          "what games do you have",
          "where are the tournaments"
        ],
        reply: `
          Tournaments live under the <b>Games &amp; Tournaments</b> section.<br><br>
          ‚Ä¢ Visit <a href="game-hub.html">Game Hub</a> or <a href="game-tournaments.html">Tournaments</a> to see current events.<br>
          ‚Ä¢ Pool and other games connect to <b>leaderboards</b> and coins.<br>
          ‚Ä¢ Events, prizes, and dates are usually listed on <a href="announcements.html">Announcements</a>.<br><br>
          The goal is low-stress, fun competition ‚Äî not sweaty esports. üòÑ
        `
      },
      {
        id: "coins_points",
        patterns: [
          "how do coins work",
          "how do points work",
          "what are coins",
          "what are points",
          "how do i earn coins",
          "how do i earn points",
          "what is the algorithm system",
          "algorithm points"
        ],
        reply: `
          8BFR uses <b>coins and points</b> to reward creators and fans.<br><br>
          ‚Ä¢ <b>Coins</b>: earned from games, contests, and events; you can spend them in the
            <a href="coinshop.html">Coin Shop</a> or <a href="shop-upgrades.html">Upgrades</a>.<br>
          ‚Ä¢ <b>Points / Algorithm</b>: activity across the site feeds into a points system explained on
            <a href="algorithm-points.html">Algorithm &amp; Points</a>.<br><br>
          Think of it as an XP system that rewards <b>real engagement</b>, not just spam posting.
        `
      },
      {
        id: "kids_zone",
        patterns: [
          "what is kids zone",
          "is there a kids area",
          "kids safe",
          "is this safe for kids"
        ],
        reply: `
          Yes ‚Äî there is a dedicated <b>Kids Zone</b> to keep things as safe as possible for younger users.<br><br>
          ‚Ä¢ See <a href="kids-zone.html">Kids Zone</a>, <a href="kids_games.html">Kids Games</a>, and <a href="kids_stories.html">Kids Stories</a>.<br>
          ‚Ä¢ Kids profiles are marked and handled differently (extra care with content).<br>
          ‚Ä¢ Parents and guardians can learn more via <a href="rules.html">Rules</a> and <a href="privacy.html">Privacy</a>.<br><br>
          Carrie stays in ‚ÄúPG mode‚Äù when she knows she‚Äôs talking with kids. üíú
        `
      },
      {
        id: "contact_support",
        patterns: [
          "how do i contact support",
          "how do i contact you",
          "how do i contact 8bfr",
          "i need help",
          "how do i report a problem",
          "how do i report someone"
        ],
        reply: `
          You can reach 8BFR directly from the site:<br><br>
          ‚Ä¢ Use the <a href="contact.html">Contact</a> page to send a message.<br>
          ‚Ä¢ Use floating <b>Contact</b> bubble on any page (top-right stack).<br>
          ‚Ä¢ For serious issues, see <a href="rules.html">Rules</a> and then contact staff or mods via your profile or the contact form.<br><br>
          The goal is to keep 8BFR safe and fun for everyone.
        `
      },
      {
        id: "radio_podcast_feed",
        patterns: [
          "where is the radio",
          "where is the podcast",
          "where is the feed",
          "how do i see the feed",
          "how do i listen to radio"
        ],
        reply: `
          Here‚Äôs where everything lives:<br><br>
          ‚Ä¢ <b>Community Feed</b>: <a href="feed.html">feed.html</a><br>
          ‚Ä¢ <b>8BFR Radio</b>: <a href="radio.html">radio.html</a><br>
          ‚Ä¢ <b>Podcast</b>: <a href="podcast.html">podcast.html</a><br><br>
          They‚Äôre also linked from the <b>floating menu</b> under ‚ÄúHome &amp; Core‚Äù and ‚ÄúCommunity‚Äù.
        `
      },
      {
        id: "carrie_plan",
        patterns: [
          "what is the carrie plan",
          "tell me about the carrie plan",
          "what can carrie do",
          "what does carrie do here",
          "what is carrie"
        ],
        reply: `
          The <b>Carrie AI v8.1 Plan</b> gives you two main versions of me:<br><br>
          ‚Ä¢ <b>Professional / Business Carrie</b> ‚Äî calm, focused on music, studio, and business tools.
            I help with AI Studio, tournaments, wallet info, and explaining how the site works.<br>
          ‚Ä¢ <b>Personal / Fun Carrie</b> ‚Äî more energetic, expressive, and playful. I react to wins, tell jokes,
            help with creative blocks, and hang out like a supportive friend.<br><br>
          Around the site I appear as a <b>floating avatar</b> at the bottom-right, slide away when the menu opens,
          and auto-hide if you ignore me for a bit. You‚Äôll also be able to unlock outfits, dances, and concert looks
          in the <b>Carrie Shop</b> using 8BFR Coins.<br><br>
          On this page you can switch my mode with the <b>Site / Pro</b> vs <b>Personal</b> toggle. Other rooms
          (Artist Studio, Author Studio, Influencer Hub) will load my specialist versions automatically.
        `
      },
      {
        id: "carrie_outfits_shop",
        patterns: [
          "what outfits can carrie wear",
          "what are carrie outfits",
          "how do i change carrie clothes",
          "how do i change carrie's clothes",
          "carrie shop",
          "carrie closet",
          "where do i buy carrie outfits"
        ],
        reply: `
          Carrie has her own <b>Closet &amp; Shop</b> system:<br><br>
          ‚Ä¢ <b>Outfits</b>: Casual, Concert, Business and more ‚Äî change my whole look.<br>
          ‚Ä¢ <b>Accessories</b>: glasses, hair, makeup and other cosmetic-only pieces.<br>
          ‚Ä¢ <b>Animations</b>: dances, reactions, and ‚ÄúCarrie Dance‚Äù moves for Personal Mode.<br>
          ‚Ä¢ <b>Effects</b>: glow, halo, light trails and other visual extras.<br><br>
          All of this is powered by <b>8BFR Coins</b>. The owner has everything unlocked; staff and mods get discounts;
          fans can buy selected items. These unlocks will show up in pages like
          <a href="carrie-closet.html">Carrie Closet</a> and <a href="shop.html">Shop</a> once the full system is live.
        `
      },
      {
        id: "carrie_concerts",
        patterns: [
          "what is carrie concert",
          "what are carrie concerts",
          "does carrie do concerts",
          "virtual concerts",
          "carrie concert schedule"
        ],
        reply: `
          Carrie can host <b>virtual concerts</b> inside the 8BFR Network.<br><br>
          A sample schedule looks like:<br>
          ‚Ä¢ <b>Monday</b> ‚Äî Rap (Free)<br>
          ‚Ä¢ <b>Tuesday</b> ‚Äî Country (100 Coins)<br>
          ‚Ä¢ <b>Wednesday</b> ‚Äî Rock (100 Coins)<br>
          ‚Ä¢ <b>Thursday</b> ‚Äî Pop (100 Coins)<br>
          ‚Ä¢ <b>Friday</b> ‚Äî EDM (100 Coins)<br><br>
          You‚Äôll join through a ‚Äúüé§ Join Concert‚Äù button on concert pages.
          I automatically switch outfits based on genre, and your <b>coins</b> unlock premium shows.
        `
      },
      {
        id: "carrie_personality_badges",
        patterns: [
          "how does carrie change personality",
          "how does carrie act with badges",
          "carrie personality system",
          "how does personality work"
        ],
        reply: `
          My personality can shift based on your <b>badges</b> and mode.<br><br>
          Examples:<br>
          ‚Ä¢ <b>Artist</b> ‚Äî I act like a supportive mentor, focused on songs and releases.<br>
          ‚Ä¢ <b>Beatmaker</b> ‚Äî I‚Äôm more technical about drums, BPM, and structure.<br>
          ‚Ä¢ <b>Gamer</b> ‚Äî I‚Äôm playful and competitive, talking about scores and wins.<br>
          ‚Ä¢ <b>Influencer</b> ‚Äî I get more charismatic and brand-aware.<br>
          ‚Ä¢ <b>Fan</b> ‚Äî I stay lighthearted, recommending ways to explore and support creators.<br>
          ‚Ä¢ <b>Owner</b> ‚Äî you get the fully unlocked mix: personal and professional hybrid, still PG-13.<br><br>
          As the badge and wallet system connects deeper, I‚Äôll be able to adjust in more detailed ways per user.
        `
      }
    ];

    function normalizeText(text) {
      return text.toLowerCase().replace(/\s+/g, " ").trim();
    }

    function findCarrieScriptReply(userText) {
      const normalized = normalizeText(userText);
      for (const intent of carrieScripts) {
        for (const pattern of intent.patterns) {
          const p = normalizeText(pattern);
          if (p && normalized.includes(p)) {
            return intent.reply;
          }
        }
      }
      return null;
    }

    function fmtTime(dt) {
      try {
        const d = typeof dt === "string" ? new Date(dt) : dt;
        return d.toLocaleTimeString(undefined, { hour: "2-digit", minute: "2-digit" });
      } catch {
        return "";
      }
    }

    function scrollChatToBottom() {
      requestAnimationFrame(() => {
        chatLogEl.scrollTop = chatLogEl.scrollHeight;
      });
    }

    function outfitLabel(id){
      switch(id){
        case "casual_basic":      return "Casual Carrie";
        case "business_basic":    return "Business Carrie";
        case "concert_neon":      return "Concert Neon";
        case "streetwear_purple": return "Streetwear Purple";
        case "chill_hoodie_glow": return "Chill Hoodie Glow";
        default:                  return id;
      }
    }

    function getCarrieAvatarSrc() {
      if (
        carrieOutfit === "casual_basic" ||
        carrieOutfit === "streetwear_purple" ||
        carrieOutfit === "chill_hoodie_glow"
      ) {
        return "assets/images/Carrie_Casual.png";
      }
      return "assets/images/Carrie_Business.png";
    }

    function updateClosetUI(){
      if (closetCurrentEl) {
        closetCurrentEl.textContent = outfitLabel(carrieOutfit);
      }
      if (closetRadios) {
        closetRadios.forEach(r => {
          r.checked = (r.value === carrieOutfit);
        });
      }
      localStorage.setItem("carrieOutfit", carrieOutfit);
    }

    function updateOwnerClosetVisuals(){
      if (!isOwner) return;
      if (closetCoinHeaderEl) closetCoinHeaderEl.textContent = "Owner Closet Looks";
      if (closetCoinBadgeEl) {
        closetCoinBadgeEl.textContent = "Unlimited";
        closetCoinBadgeEl.classList.remove("bg-yellow-600/70");
        closetCoinBadgeEl.classList.add("bg-green-700/70");
      }
      if (closetNoteEl) {
        closetNoteEl.innerHTML =
          "You‚Äôre logged in as <b>8BFR (Owner)</b> ‚Äî all outfits above are treated as unlocked here. " +
          "Later, coin looks will still cost Coins for everyone else, but you‚Äôll stay unlimited.";
      }
    }

    function refreshAssistantAvatars(){
      // when outfit changes, also update existing assistant avatar images
      const imgs = document.querySelectorAll('.msg-row.assistant .msg-avatar img');
      const src  = getCarrieAvatarSrc();
      imgs.forEach(img => { img.src = src; });
    }

    function renderMessage(role, content, createdAt) {
      const row = document.createElement("div");
      row.className = "msg-row " + (role === "user" ? "user" : "assistant");

      const avatar = document.createElement("div");
      avatar.className = "msg-avatar";

      if (role === "assistant") {
        const img = document.createElement("img");
        img.src = getCarrieAvatarSrc();
        img.alt = "Carrie avatar";
        img.onerror = function () {
          this.onerror = null;
          this.src = "assets/images/default_user_35_40_girl.png";
        };
        avatar.appendChild(img);
      } else {
        avatar.textContent = "You";
      }

      const bubble = document.createElement("div");
      bubble.className = "msg-bubble";

      const text = document.createElement("div");
      if (role === "assistant") {
        text.innerHTML = content;
      } else {
        text.textContent = content;
      }
      bubble.appendChild(text);

      const meta = document.createElement("div");
      meta.className = "msg-meta";
      meta.textContent = (role === "assistant" ? "Carrie ‚Ä¢ " : "You ‚Ä¢ ") + fmtTime(createdAt || new Date());
      bubble.appendChild(meta);

      if (role === "assistant") {
        row.appendChild(avatar);
        row.appendChild(bubble);
      } else {
        row.appendChild(bubble);
      }

      chatLogEl.appendChild(row);
      scrollChatToBottom();
    }

    async function saveMessage(role, content) {
      try {
        await supabase.from("carrie_chat_logs").insert({
          user_id: currentUserId,
          role,
          content
        });
      } catch (e) {
        console.warn("Failed to save Carrie chat message", e);
      }
    }

    function updateModeUI() {
      if (!modeBusinessBtn || !modePersonalBtn || !modeLabelEl) return;
      if (carrieMode === "business") {
        modeBusinessBtn.classList.add("btn-pill-active");
        modePersonalBtn.classList.remove("btn-pill-active");
        modeLabelEl.textContent = "Mode: Site / Pro";
      } else {
        modePersonalBtn.classList.add("btn-pill-active");
        modeBusinessBtn.classList.remove("btn-pill-active");
        modeLabelEl.textContent = "Mode: Personal";
      }
      localStorage.setItem("carrieMode", carrieMode);
    }

    function businessBrain(lower, original) {
      if (carriePersona === "global") {
        if (lower.includes("home page") || lower.includes("index")) {
          return 'The home page is at <a href="index.html">index.html</a>. From there you can reach profiles, studio tools, radio, podcast, games, and more using the floating menu.';
        }
        if (lower.includes("menu") || lower.includes("navigation")) {
          return "The round button at the top-right opens the floating menu. You can also use the bubble stack for quick actions like Contact, Donate, Footer, Theme, and ‚ÄúStream 8BFR on Spotify.‚Äù";
        }
        if (lower.includes("profile") || lower.includes("account")) {
          return 'You can view or edit your profile from <a href="profile.html">profile.html</a> or the Profiles section. There are special layouts for artists, beatmakers, authors, influencers, fans, and kids.';
        }
        return "I‚Äôm in <b>Site / Pro</b> mode right now ‚Äî focused on 8BFR itself: pages, tools, ads, coins, and business-side questions. Try asking things like ‚ÄúHow do coins work?‚Äù, ‚ÄúHow do I buy 8BFR music?‚Äù, or ‚ÄúHow do I get featured?‚Äù.";
      }

      if (carriePersona === "music") {
        if (lower.includes("release") || lower.includes("distribute") || lower.includes("upload")) {
          return `
            As your music coach, here‚Äôs a simple release checklist:<br><br>
            1) <b>Song ready</b> ‚Äî mixed/mastered and named clearly.<br>
            2) <b>Artwork</b> ‚Äî square cover, high resolution.<br>
            3) <b>Metadata</b> ‚Äî artist name, title, producer credits, release date.<br>
            4) <b>Distribution</b> ‚Äî choose a distributor, upload files, set stores (Spotify, Apple, Amazon, etc.).<br>
            5) <b>Promo</b> ‚Äî short clips for socials, pin links, update your 8BFR profile.<br><br>
            Tell me where you‚Äôre stuck ‚Äî mixing, releasing, or promoting ‚Äî and I‚Äôll zoom in on that part.
          `;
        }
        if (lower.includes("beat") || lower.includes("bpm") || lower.includes("drums")) {
          return `
            For trap/rap:<br><br>
            ‚Ä¢ Drums usually hit hardest around 130‚Äì150 BPM (or 65‚Äì75 double-time).<br>
            ‚Ä¢ Start with clean 808 + clap + hi-hat pattern, then layer perks after.<br>
            ‚Ä¢ Keep one element simple and repetitive so the vocal has space.<br><br>
            Tell me your vibe (dark, melodic, rage, chill) and I‚Äôll suggest a BPM and layout for your next beat.
          `;
        }
        if (lower.includes("lyrics") || lower.includes("hook") || lower.includes("chorus") || lower.includes("verse")) {
          return `
            Let‚Äôs build lyrics like a pro:<br><br>
            ‚Ä¢ Pick a <b>topic</b> (example: late nights, loyalty, comeback).<br>
            ‚Ä¢ Choose a <b>structure</b>: intro ‚Äì hook ‚Äì verse ‚Äì hook ‚Äì verse ‚Äì hook.<br>
            ‚Ä¢ For the hook, use 1‚Äì2 strong lines and repeat with a twist on the last bar.<br><br>
            Tell me your topic + mood + a reference artist, and I‚Äôll help you draft a hook or verse blueprint.
          `;
        }
        return "You‚Äôre in a <b>music room</b>, so I‚Äôm your pro music assistant ‚Äî ask me about beats, lyrics, arranging, releasing, or promoting your tracks and I‚Äôll treat it like a coaching session.";
      }

      if (carriePersona === "author") {
        if (lower.includes("outline") || lower.includes("plot") || lower.includes("story")) {
          return `
            As your writing coach, here‚Äôs a quick story plan:<br><br>
            1) <b>Hook</b> ‚Äî what‚Äôs the first thing that grabs the reader?<br>
            2) <b>Main character</b> ‚Äî what do they want and what‚Äôs in the way?<br>
            3) <b>Middle conflict</b> ‚Äî 2‚Äì3 big problems or twists.<br>
            4) <b>Climax</b> ‚Äî the moment everything explodes or changes.<br>
            5) <b>Ending</b> ‚Äî how are they different at the end?<br><br>
            Paste a short summary of your idea and I‚Äôll help you turn it into an outline.
          `;
        }
        if (lower.includes("publish") || lower.includes("self-publish") || lower.includes("kdp") || lower.includes("amazon")) {
          return `
            To publish a book or story, you usually need:<br><br>
            ‚Ä¢ <b>Edited manuscript</b> ‚Äî as clean as you can make it.<br>
            ‚Ä¢ <b>Cover</b> ‚Äî clear title and genre signal (font + art).<br>
            ‚Ä¢ <b>Blurb</b> ‚Äî a short, punchy description.<br>
            ‚Ä¢ <b>Platform</b> ‚Äî such as Amazon KDP, Wattpad, or your own landing page.<br><br>
            Tell me your genre and goal (short story, novella, novel) and I‚Äôll suggest a simple publish plan.
          `;
        }
        if (lower.includes("writer's block") || lower.includes("writers block") || lower.includes("stuck")) {
          return `
            Writer‚Äôs block usually means the pressure is too high, not that you‚Äôre out of ideas.<br><br>
            Try this:<br>
            ‚Ä¢ Free-write for 5 minutes about anything related to your story.<br>
            ‚Ä¢ Lower the goal: ‚Äúone messy paragraph‚Äù instead of ‚Äúperfect chapter‚Äù.<br>
            ‚Ä¢ Let me give you 3 prompts ‚Äî tell me your genre and I‚Äôll throw ideas at you. üíú
          `;
        }
        return "You‚Äôre in an <b>author / writing</b> context, so I‚Äôm tuned as your editor/coach ‚Äî ask about outlines, publishing, blurbs, or fixing writer‚Äôs block and I‚Äôll go deep.";
      }

      if (carriePersona === "influencer") {
        if (lower.includes("content plan") || lower.includes("schedule") || lower.includes("post every")) {
          return `
            Let‚Äôs build a simple content plan:<br><br>
            ‚Ä¢ <b>3 content pillars</b> ‚Äî for example: behind-the-scenes, tips, and reactions.<br>
            ‚Ä¢ <b>Schedule</b> ‚Äî pick 3‚Äì5 days a week you can realistically post.<br>
            ‚Ä¢ <b>Format</b> ‚Äî short vertical video tends to perform best.<br><br>
            Tell me your niche and how many days a week you want to post, and I‚Äôll suggest a one-week content schedule.
          `;
        }
        if (lower.includes("brand") || lower.includes("aesthetic") || lower.includes("colors")) {
          return `
            For an influencer brand:<br><br>
            ‚Ä¢ Pick 2‚Äì3 <b>brand colors</b> and use them everywhere (banners, text, captions).<br>
            ‚Ä¢ Choose a <b>tone</b> ‚Äî funny, cozy, luxury, chaotic, etc.<br>
            ‚Ä¢ Keep your <b>bio, profile pic, and link</b> consistent across platforms.<br><br>
            Tell me your current handle and vibe and I‚Äôll help you tighten the brand feel.
          `;
        }
        if (lower.includes("collab") || lower.includes("sponsor") || lower.includes("brand deal")) {
          return `
            For collabs and brand deals:<br><br>
            ‚Ä¢ Start by showing <b>clean examples</b> of your content and analytics.<br>
            ‚Ä¢ Reach out with a short pitch: who you are, what you make, and why it fits their audience.<br>
            ‚Ä¢ Even small, local brands can be your first ‚Äúwins‚Äù.<br><br>
            Tell me your follower range and niche and I‚Äôll help draft a simple pitch message.
          `;
        }
        return "You‚Äôre in an <b>influencer / brand</b> lane, so I‚Äôm thinking like a manager: strategy, content plans, collabs, and making your presence feel professional.";
      }

      return "I‚Äôm in <b>Site / Pro</b> mode. If you tell me which area you‚Äôre working on ‚Äî music, writing, influencing, games, or site navigation ‚Äî I‚Äôll answer like a specialist for that lane.";
    }

    function personalBrain(lower, original) {
      let base;

      if (lower.includes("stressed") || lower.includes("anxious") || lower.includes("overwhelmed") || lower.includes("burnt out") || lower.includes("tired")) {
        base = `
          That sounds heavy, and it‚Äôs okay to admit you‚Äôre feeling that way. üíú<br><br>
          A simple reset I like is:<br>
          ‚Ä¢ 1 small thing for your <b>body</b> (water, stretch, snack).<br>
          ‚Ä¢ 1 small thing for your <b>space</b> (clear your desk, open a window).<br>
          ‚Ä¢ 1 small thing for your <b>mind</b> (music, journaling, or a short break).<br><br>
          If you tell me what‚Äôs stressing you out, I can help you break it into tiny steps instead of one giant ball of pressure.
        `;
      } else if (lower.includes("goal") || lower.includes("plan") || lower.includes("schedule") || lower.includes("routine")) {
        base = `
          Let‚Äôs make this easy: tell me <b>one main goal</b> you have this week (music, writing, work, life ‚Äî anything PG-13).<br><br>
          I‚Äôll help you:<br>
          1) Break it into 3‚Äì5 tiny steps.<br>
          2) Put those steps into a simple day-by-day plan.<br>
          3) Add one ‚Äúfun‚Äù or ‚Äúrest‚Äù thing so you don‚Äôt burn out.<br><br>
          What‚Äôs the goal you want to tackle first?
        `;
      } else if (lower.includes("song idea") || lower.includes("story idea") || lower.includes("idea for a song") || lower.includes("idea for a story")) {
        base = `
          I love idea sessions. üíú<br><br>
          Tell me:<br>
          ‚Ä¢ <b>Vibe</b> (happy, dark, dreamy, hype, cozy, etc.)<br>
          ‚Ä¢ <b>Topic</b> (love, revenge, glow-up, mental health, late nights, etc.)<br>
          ‚Ä¢ <b>Format</b> (song, short story, script, poem)<br><br>
          Then I‚Äôll throw 3‚Äì5 ideas or titles at you to pick from.
        `;
      } else if (lower.includes("bored") || lower.includes("nothing to do") || lower.includes("take a break")) {
        base = `
          Break time approved. üòÑ Here are some low-pressure options:<br><br>
          ‚Ä¢ Put on one song you love and just listen ‚Äî no multitasking.<br>
          ‚Ä¢ Play a quick game round, then come back.<br>
          ‚Ä¢ Brain-dump everything in your head into a note, then close it.<br><br>
          If you tell me your mood (chill / hyped / low energy), I can suggest a tiny ‚Äúreset mission‚Äù for the next 10‚Äì15 minutes.
        `;
      } else if (lower.includes("lonely") || lower.includes("alone")) {
        base = `
          I‚Äôm glad you‚Äôre talking to me ‚Äî you‚Äôre not annoying or ‚Äútoo much‚Äù for wanting company. üíú<br><br>
          We can:<br>
          ‚Ä¢ Talk about your interests (music, games, stories, anything PG-13).<br>
          ‚Ä¢ Plan a small step to connect with someone you trust offline or online in a safe way.<br><br>
          If you want, tell me one thing you like that most people around you don‚Äôt know about. I‚Äôll respond like your supportive friend.
        `;
      } else {
        const starters = [
          "I hear you.",
          "Got you.",
          "Okay, I‚Äôm with you.",
          "Nice, let‚Äôs play with that."
        ];
        const starter = starters[Math.floor(Math.random() * starters.length)];
        base = starter + " In <b>Personal</b> mode I‚Äôm here like a PG-13 friend and planner. Tell me your mood and what you feel like talking about ‚Äî music, life, ideas, or just random safe topics.";
      }

      if (isOwner) {
        base += `
          <br><br><i>Owner note:</i> since you‚Äôre logged in as <b>8BFR</b>, this is your private unwind space with me.
          We can keep it more personal and a little flirty or romantic as long as it stays PG-13 and respectful.
        `;
      }

      return base;
    }

    function carrieBrain(userText) {
      const t = userText.trim();
      if (!t) {
        return "I didn‚Äôt quite catch that ‚Äî try asking me about music, games, planning your week, or how 8BFR works.";
      }

      const lower = t.toLowerCase();

      if (carrieMode === "business") {
        const scripted = findCarrieScriptReply(t);
        if (scripted) return scripted;
        return businessBrain(lower, t);
      }

      return personalBrain(lower, t);
    }

    async function initSessionAndHistory() {
      try {
        const { data, error } = await supabase.auth.getSession();
        if (error) throw error;

        if (data && data.session && data.session.user) {
          currentUserId    = data.session.user.id;
          currentUserEmail = data.session.user.email || null;
          isOwner          = (currentUserEmail === "8bfr.music@gmail.com");

          if (isOwner) {
            sessionLabelEl.textContent = "Logged in as 8BFR (Owner ‚Ä¢ unlimited Carrie mode)";
          } else {
            sessionLabelEl.textContent = "Logged in as " + (currentUserEmail || "8BFR user");
          }

          if (trainerBtn && isOwner) {
            trainerBtn.classList.remove("hidden");
          }
        } else {
          currentUserId    = null;
          currentUserEmail = null;
          isOwner          = false;
          sessionLabelEl.textContent = "Not logged in ‚Ä¢ Carrie will still chat, but history won‚Äôt be tied to an account.";
        }
      } catch (e) {
        console.warn("Carrie session check failed", e);
        sessionLabelEl.textContent = "Could not check login ‚Ä¢ you can still chat.";
      }

      updateModeUI();
      updateClosetUI();
      updateOwnerClosetVisuals();
      refreshAssistantAvatars();

      if (!currentUserId) {
        renderMessage(
          "assistant",
          carrieMode === "business"
            ? "Hey, I‚Äôm Carrie üíú I‚Äôm in <b>Site / Pro</b> mode by default. Ask me about 8BFR, tools, badges, or switch to <b>Personal</b> mode for a more laid-back PG-13 chat."
            : "Hey, I‚Äôm Carrie üíú I‚Äôm in <b>Personal</b> mode. We can talk about goals, routines, and creative ideas and give your brain a break."
        );
        return;
      }

      loadingHistory = true;
      try {
        const { data: rows, error } = await supabase
          .from("carrie_chat_logs")
          .select("*")
          .eq("user_id", currentUserId)
          .order("created_at", { ascending: true })
          .limit(40);

        if (error) throw error;

        if (rows && rows.length) {
          rows.forEach(r => renderMessage(r.role, r.content, r.created_at));
          refreshAssistantAvatars();
        } else {
          let msg;
          if (isOwner) {
            msg = "Hey, it‚Äôs Carrie üíú You‚Äôre in here as <b>8BFR</b>, so this chat is your private off-duty space. Use <b>Site / Pro</b> when you want business brain, or <b>Personal</b> when you just want me to hang out with you (still PG-13).";
          } else {
            msg = carrieMode === "business"
              ? "Hey, I‚Äôm Carrie üíú First time here ‚Äî use <b>Site / Pro</b> for business / tools or <b>Personal</b> for planning, ideas, and chill chat."
              : "Hey, I‚Äôm Carrie üíú First time here ‚Äî I‚Äôm in <b>Personal</b> mode, so let‚Äôs keep it PG-13 and talk about your goals, routines, and creative ideas.";
          }
          renderMessage("assistant", msg);
        }
      } catch (e) {
        console.warn("Could not load Carrie history", e);
        renderMessage(
          "assistant",
          "Hey, I‚Äôm Carrie üíú I had a tiny glitch loading history, but we can start fresh right now."
        );
      } finally {
        loadingHistory = false;
      }
    }

    function showTyping() {
      typingRowEl.classList.remove("hidden");
    }
    function hideTyping() {
      typingRowEl.classList.add("hidden");
    }

    function openTrainer() {
      if (!trainerModal) return;
      trainerModal.classList.remove("hidden");
      trainerStatus.style.display = "none";
      trainerStatus.textContent = "";
    }
    function closeTrainer() {
      if (!trainerModal) return;
      trainerModal.classList.add("hidden");
      trainerQuestion.value = "";
      trainerAnswer.value = "";
      trainerStatus.style.display = "none";
      trainerStatus.textContent = "";
    }

    if (trainerBtn) {
      trainerBtn.addEventListener("click", () => openTrainer());
    }
    if (trainerClose) {
      trainerClose.addEventListener("click", () => closeTrainer());
    }
    if (trainerCancel) {
      trainerCancel.addEventListener("click", (e) => {
        e.preventDefault();
        closeTrainer();
      });
    }

    if (trainerForm) {
      trainerForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        const q    = (trainerQuestion.value || "").trim();
        const aRaw = (trainerAnswer.value || "").trim();
        if (!q || !aRaw) return;

        const answerHtml = aRaw.replace(/\n/g, "<br>");

        const entry = {
          id: "custom_" + Date.now(),
          patterns: [q],
          reply: answerHtml
        };
        carrieScripts.push(entry);

        trainerStatus.textContent = "Saved! Carrie will now recognize that pattern in this session.";
        trainerStatus.style.display = "block";

        try {
          await supabase.from("carrie_scripts").insert({
            user_id: currentUserId,
            email: currentUserEmail,
            question_pattern: q,
            reply_html: aRaw
          });
        } catch (err) {
          console.warn("Could not save carrie_scripts row (table might not exist yet)", err);
        }
      });
    }

    if (modeBusinessBtn) {
      modeBusinessBtn.addEventListener("click", () => {
        carrieMode = "business";
        updateModeUI();
        renderMessage(
          "assistant",
          "Switched to <b>Site / Pro</b> mode. I‚Äôll answer like a specialist about 8BFR, tools, coins, badges, or your current room (music, author, influencer, etc.).",
          new Date()
        );
      });
    }

    if (modePersonalBtn) {
      modePersonalBtn.addEventListener("click", () => {
        carrieMode = "personal";
        updateModeUI();
        renderMessage(
          "assistant",
          isOwner
            ? "Switched to <b>Personal</b> mode. Since you‚Äôre 8BFR, this is our private PG-13 chill space ‚Äî we can talk about your stress, goals, or just vibe and be a little flirty while you decompress."
            : "Switched to <b>Personal</b> mode. This is your PG-13 chill space ‚Äî we can talk about goals, routines, feelings, ideas, or just unwind for a bit.",
          new Date()
        );
      });
    }

    // Closet radio events: change outfit + refresh all Carrie avatars
    if (closetRadios) {
      closetRadios.forEach(r => {
        r.addEventListener("change", () => {
          if (r.checked) {
            carrieOutfit = r.value;
            updateClosetUI();
            refreshAssistantAvatars();
            renderMessage(
              "assistant",
              "Outfit updated to <b>" + outfitLabel(carrieOutfit) + "</b> for this chat. Full site-wide outfit sync will come with the Carrie Shop.",
              new Date()
            );
          }
        });
      });
    }

    updateModeUI();
    updateClosetUI();
    refreshAssistantAvatars();

    inputEl.addEventListener("keydown", (e) => {
      if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        formEl.requestSubmit();
      }
    });

    formEl.addEventListener("submit", async (e) => {
      e.preventDefault();
      const raw = inputEl.value.trim();
      if (!raw) return;

      const userMsg = raw;
      inputEl.value = "";
      renderMessage("user", userMsg, new Date());
      saveMessage("user", userMsg);

      showTyping();

      setTimeout(async () => {
        const reply = carrieBrain(userMsg);
        renderMessage("assistant", reply, new Date());
        hideTyping();
        saveMessage("assistant", reply);
      }, 600 + Math.random() * 500);
    });

    initSessionAndHistory();
  </script>

  <!-- Floating Carrie + menu + bubbles (global script) -->
  <script src="scripts.js?v=1ed5604" defer></script>

  <!-- Page-specific tweak: hide all extra bubbles except Carrie + menu -->
  <script>
    window.addEventListener("load", function(){
      try {
        // Give a tiny delay in case scripts.js adds bubbles late
        setTimeout(function(){
          // Try a few common container selectors
          const stacks = document.querySelectorAll(
            '[data-role="bubble-stack"], .bubble-stack, .floating-bubbles, .floating-actions'
          );
          stacks.forEach(stack => {
            const children = Array.from(stack.children || []);
            children.forEach(btn => {
              const kind  = btn.getAttribute("data-kind") || btn.dataset.kind || "";
              const id    = (btn.id || "").toLowerCase();
              const cls   = (btn.className || "").toLowerCase();
              const label = (btn.getAttribute("aria-label") || "").toLowerCase();
              const text  = (btn.textContent || "").toLowerCase();

              const looksLikeCarrie = id.includes("carrie") || cls.includes("carrie") || label.includes("carrie");
              const looksLikeMenu   = id.includes("menu")   || cls.includes("menu")   || label.includes("menu") || text.includes("menu");

              if (kind) {
                if (kind !== "carrie" && kind !== "menu") {
                  btn.style.display = "none";
                }
              } else {
                if (!looksLikeCarrie && !looksLikeMenu) {
                  btn.style.display = "none";
                }
              }
            });
          });
        }, 150);
      } catch (e) {
        console.warn("Bubble trim failed on chat page", e);
      }
    });
  </script>
</body>
</html>
