<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Chat with Carrie ‚Äî 8BFR Music Network</title>
  <meta name="description" content="Chat with Carrie ‚Äî your AI assistant on the 8BFR Music Network." />
  <link rel="icon" href="assets/images/favicon.png" />
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    :root {
      --ring: rgba(124,58,237,.55);
      --glass: rgba(12,6,24,.80);
    }
    html,body { scroll-behavior:smooth; }
    body {
      font-family: system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial;
      background:
        radial-gradient(1200px 600px at 10% -10%, rgba(124,58,237,.35), transparent 60%),
        radial-gradient(900px 400px at 110% 10%, rgba(0,217,255,.22), transparent 60%),
        linear-gradient(#0b0014,#000);
      color:#eae6ff;
      margin:0;
      min-height:100vh;
      overflow-x:hidden;
    }
    header{
      position:relative;
      z-index:5;
      background:rgba(15,0,30,.9);
      border-bottom:1px solid rgba(124,58,237,.5);
    }
    .chat-shell{
      border-radius:18px;
      border:1px solid rgba(124,58,237,.55);
      background:rgba(10,2,26,.95);
      box-shadow:0 16px 40px rgba(0,0,0,.75);
    }
    .chat-log{
      height:420px;
      max-height:65vh;
      overflow-y:auto;
      padding:1rem;
      background:
        radial-gradient(circle at 0 0, rgba(124,58,237,.12), transparent 55%),
        radial-gradient(circle at 100% 0, rgba(0,217,255,.10), transparent 55%),
        #020014;
    }
    .msg-row{
      display:flex;
      margin-bottom:.65rem;
      gap:.4rem;
    }
    .msg-row.user{
      justify-content:flex-end;
    }
    .msg-bubble{
      max-width:80%;
      padding:.55rem .8rem;
      border-radius:.85rem;
      font-size:.9rem;
      line-height:1.35;
      border:1px solid rgba(148,163,255,.55);
      background:rgba(17,24,39,.96);
      box-shadow:0 0 12px rgba(79,70,229,.35);
    }
    .msg-row.user .msg-bubble{
      background:linear-gradient(135deg,#7c3aed,#4c1d95);
      border-color:#a855f7;
      box-shadow:0 0 12px rgba(168,85,247,.55);
    }
    .msg-meta{
      font-size:.7rem;
      opacity:.7;
      margin-top:.2rem;
    }
    .msg-avatar{
      width:28px;
      height:28px;
      border-radius:999px;
      flex-shrink:0;
      overflow:hidden;
      border:1px solid rgba(129,140,248,.9);
      display:grid;
      place-items:center;
      font-size:.75rem;
      background:#020014;
    }
    .msg-avatar img,
    .msg-avatar video{
      width:100%;
      height:100%;
      object-fit:cover;
      display:block;
    }
    .msg-row.user .msg-avatar{
      display:none;
    }

    .pill-tag{
      display:inline-flex;
      align-items:center;
      gap:.25rem;
      font-size:.7rem;
      border-radius:999px;
      padding:.15rem .55rem;
      border:1px solid rgba(129,140,248,.85);
      background:rgba(15,23,42,.9);
      text-transform:uppercase;
      letter-spacing:.08em;
    }

    .btn{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:.3rem;
      background:#120327;
      border:1px solid rgba(124,58,237,.6);
      color:#eae6ff;
      padding:.55rem .95rem;
      border-radius:.75rem;
      font-size:.9rem;
      text-decoration:none;
      cursor:pointer;
    }
    .btn:hover{
      background:#190536;
    }
    .btn-primary{
      background:#7c3aed;
      border-color:#7c3aed;
      color:#fff;
    }
    .btn-primary:hover{ filter:brightness(1.05); }

    textarea#carrieInput{
      resize:none;
      min-height:52px;
      max-height:120px;
      background:rgba(10,2,26,.95);
      border-radius:.75rem;
      border:1px solid rgba(148,163,255,.55);
      padding:.5rem .7rem;
      font-size:.9rem;
      color:#e5e7eb;
    }
    textarea#carrieInput:focus{
      outline:none;
      box-shadow:0 0 0 1px rgba(129,140,248,.9);
      border-color:rgba(129,140,248,1);
    }
    .input-hint{
      font-size:.7rem;
      opacity:.7;
    }
    .typing-dot{
      width:6px;height:6px;border-radius:999px;
      background:#a855f7;
      animation:bounce 1s infinite ease-in-out;
    }
    .typing-dot:nth-child(2){ animation-delay:.15s; }
    .typing-dot:nth-child(3){ animation-delay:.3s; }
    @keyframes bounce{
      0%,80%,100%{ transform:translateY(0); opacity:.4;}
      40%{ transform:translateY(-4px); opacity:1;}
    }

    @media (max-width:640px){
      .chat-log{ height:60vh; }
      .msg-bubble{ max-width:88%; }
    }

    /* Hide global Carrie + bubbles from scripts.js on this page */
    #bubbleStack,
    #bubble-top-single,
    #carrieWrap {
      display:none !important;
    }

    /* Local Carrie wrapper for this chat page (bottom-right, draggable + resizable) */
    #chatCarrieWrap{
      position:fixed;
      right:16px;
      bottom:72px;
      z-index:9997;
      user-select:none;
      touch-action:none;
      pointer-events:auto;
    }
    #chatCarrieVideo{
      width:min(48vw,260px);
      max-height:70vh;
      object-fit:contain;
      background:transparent!important;
      display:block;
      filter:
        drop-shadow(0 14px 32px rgba(15,6,40,.9))
        drop-shadow(0 0 18px rgba(124,58,237,.55));
    }
    #chatCarrieBubble{
      position:absolute;
      bottom:100%;
      right:40px;
      margin-bottom:4px;
      padding:3px 10px;
      border-radius:999px;
      font-size:.72rem;
      background:rgba(15,23,42,.95);
      color:#e5e7eb;
      border:1px solid rgba(129,140,248,.9);
      white-space:nowrap;
    }
    #chatCarrieBubble::after{
      content:"";
      position:absolute;
      top:100%;
      right:16px;
      border-width:6px 6px 0 6px;
      border-style:solid;
      border-color:rgba(15,23,42,.95) transparent transparent transparent;
    }
  </style>
</head>
<body>
  <header class="px-4 py-4">
    <div class="max-w-6xl mx-auto flex items-center justify-between gap-3">
      <div class="flex items-center gap-3">
        <img src="assets/images/logo_8bfr.svg"
             alt="8BFR logo"
             class="h-9 w-auto"
             onerror="this.onerror=null;this.src='assets/images/8bfr.png'">
        <div>
          <h1 class="text-xl sm:text-2xl font-extrabold">
            Chat with <span class="text-[#a855f7]">Carrie</span>
          </h1>
          <p class="text-[11px] text-purple-300/80 -mt-0.5">
            8BFR Music Network ‚Ä¢ Create ‚Ä¢ Connect ‚Ä¢ Collab
          </p>
        </div>
      </div>
      <a href="index.html"
         class="hidden sm:inline text-[#00d9ff] text-xs sm:text-sm underline/50 hover:underline">
        ‚¨Ö Back to Home
      </a>
    </div>
  </header>

  <main class="max-w-4xl mx-auto px-4 pb-10 pt-4">
    <div class="chat-shell p-4 sm:p-5">
      <!-- Back to home + mode toggle row -->
      <div class="flex justify-between items-center mb-2">
        <a href="index.html"
           class="text-[#00d9ff] text-xs underline hover:underline">
          ‚¨Ö Back to Home
        </a>

        <!-- Mode toggle -->
        <div class="flex items-center gap-1 text-[11px]">
          <span class="text-purple-200/80 hidden sm:inline">Mode:</span>
          <button
            id="modeBusiness"
            type="button"
            class="px-2 py-1 rounded-full border border-purple-400/70 bg-purple-900/70 text-[10px] uppercase tracking-wide"
          >
            Business
          </button>
          <button
            id="modePersonal"
            type="button"
            class="px-2 py-1 rounded-full border border-transparent bg-transparent text-[10px] uppercase tracking-wide text-purple-200/80"
          >
            Personal
          </button>
          <button
            id="modeGirlfriend"
            type="button"
            class="px-2 py-1 rounded-full border border-transparent bg-transparent text-[10px] uppercase tracking-wide text-pink-200/80"
          >
            Girlfriend üíú
          </button>
        </div>
      </div>

      <div class="flex items-center justify-between mb-3 gap-3">
        <div class="flex items-center gap-2">
          <span class="pill-tag">
            <span class="inline-block w-2 h-2 rounded-full bg-green-400 animate-pulse"></span>
            <span>Live Carrie</span>
          </span>
          <span class="text-[11px] text-purple-200/80" id="modeHint">
            Business chat ‚Ä¢ focused on tools, music, and progress
          </span>
        </div>
        <div class="text-right space-y-1">
          <div id="sessionIndicator" class="text-[11px] text-purple-200/70">
            Checking login‚Ä¶
          </div>
          <button
            id="trainerBtn"
            type="button"
            class="btn hidden"
            style="padding:2px 8px;font-size:10px;border-radius:999px;"
          >
            Carrie Trainer
          </button>
        </div>
      </div>

      <!-- Inline Carrie circle (top of chat) will be injected by JS -->

      <!-- Chat log -->
      <div id="chatLog" class="chat-log rounded-lg mb-3"></div>

      <!-- Typing indicator -->
      <div id="typingRow" class="hidden mb-2 text-xs text-purple-200/80 flex items-center gap-2">
        <span class="pill-tag">Carrie typing</span>
        <div class="flex items-center gap-1 ml-1">
          <span class="typing-dot"></span>
          <span class="typing-dot"></span>
          <span class="typing-dot"></span>
        </div>
      </div>

      <!-- Input row -->
      <form id="carrieForm" class="mt-1">
        <div class="flex items-end gap-2">
          <div class="flex-1">
            <label for="carrieInput"
                   class="text-xs text-purple-200/80 mb-1 inline-block">
              Ask Carrie anything about 8BFR, music, games, or ideas.
            </label>
            <textarea id="carrieInput"
                      placeholder="Example: ‚ÄúHelp me write a hook for a trap beat about late nights.‚Äù"></textarea>
            <p class="input-hint mt-1">
              Press <b>Enter</b> to send ‚Ä¢ <b>Shift+Enter</b> for a new line.
            </p>
          </div>
          <button type="submit" class="btn btn-primary px-3 sm:px-4 h-10">
            <span>Send</span>
            <span>üì§</span>
          </button>
        </div>
      </form>
    </div>

    <p class="mt-3 text-[11px] text-purple-300/70 text-center max-w-xl mx-auto">
      Carrie is in beta. Conversations may be stored to improve your experience on the 8BFR Music Network.
    </p>
  </main>

  <!-- Local Carrie (bottom-right) just for this chat page -->
  <div id="chatCarrieWrap" title="Carrie (chat only)">
    <div id="chatCarrieBubble">Carrie chat</div>
    <video
      id="chatCarrieVideo"
      src="assets/videos/carrie_casual_animate_3_1.webm"
      autoplay
      loop
      muted
      playsinline
    ></video>
  </div>

  <!-- Trainer modal (owner only; optional) -->
  <div id="trainerModal" class="fixed inset-0 z-50 hidden">
    <div class="absolute inset-0 bg-black/60 backdrop-blur-sm"></div>
    <div
      class="relative max-w-md mx-auto mt-24 bg-[#0c0618] border border-purple-500/60 rounded-xl p-4 shadow-2xl"
    >
      <div class="flex items-center justify-between mb-2">
        <h2 class="text-sm font-semibold text-purple-100">
          Carrie Trainer (Owner Only)
        </h2>
        <button
          id="trainerClose"
          type="button"
          class="text-xs text-purple-200 hover:underline"
        >
          Close
        </button>
      </div>
      <p class="text-[11px] text-purple-200/80 mb-2">
        Add a question pattern and the reply you want Carrie to use.<br>
        Replies can include basic HTML and links.
      </p>
      <form id="trainerForm" class="space-y-2">
        <div>
          <label class="text-xs text-purple-200/90 block mb-1">
            User question / pattern (example: "how do i purchase 8bfr music")
          </label>
          <textarea
            id="trainerQuestion"
            class="w-full text-xs rounded-md border border-purple-500/50 bg-[#120327] px-2 py-1 text-purple-50"
            rows="2"
          ></textarea>
        </div>
        <div>
          <label class="text-xs text-purple-200/90 block mb-1">
            Carrie reply (HTML allowed)
          </label>
          <textarea
            id="trainerAnswer"
            class="w-full text-xs rounded-md border border-purple-500/50 bg-[#120327] px-2 py-1 text-purple-50"
            rows="4"
          ></textarea>
        </div>
        <p class="text-[10px] text-purple-300/80">
          Tip: Carrie matches your pattern by looking for that text inside the user's message.
        </p>
        <div class="flex justify-end gap-2 pt-1">
          <button
            type="button"
            id="trainerCancel"
            class="btn"
            style="padding:3px 10px;font-size:11px;"
          >
            Cancel
          </button>
          <button
            type="submit"
            class="btn btn-primary"
            style="padding:3px 10px;font-size:11px;"
          >
            Save &amp; Use
          </button>
        </div>
        <div
          id="trainerStatus"
          class="text-[10px] text-green-300/80 mt-1"
          style="display:none;"
        ></div>
      </form>
    </div>
  </div>

  <!-- Supabase client (for this page only) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <!-- Global 8BFR UI (menu, Carrie, etc.) -->
  <script src="scripts.js?v=1" defer></script>

  <!-- Carrie chat logic (inline JS, replaces carrie-chat.js) -->
  <script>
    // ========= CONFIG =========
    const SUPABASE_URL = "https://novbuvwpjnxwwvdekjhr.supabase.co";
    const SUPABASE_ANON_KEY =
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5vdmJ1dndwam54d3d2ZGVramhyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjExODkxODUsImV4cCI6MjA3Njc2NTE4NX0.1UUkdGafh6ZplAX8hi7Bvj94D2gvFQZUl0an1RvcSA0";

    const CARRIE_VIDEOS = {
      business: "assets/videos/carrie_business_animate.webm",
      personal: "assets/videos/carrie_casual_animate_3_1.webm",
      girlfriend: "assets/videos/carrie_casual_animate_3_1.webm", // same file, different vibe
    };

    // ========= SUPABASE =========
    let supabase = null;
    if (window.supabase && window.supabase.createClient) {
      supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    }

    // ========= DOM REFS =========
    const chatLogEl      = document.getElementById("chatLog");
    const formEl         = document.getElementById("carrieForm");
    const inputEl        = document.getElementById("carrieInput");
    const typingRowEl    = document.getElementById("typingRow");
    const sessionLabelEl = document.getElementById("sessionIndicator");
    const modeHintEl     = document.getElementById("modeHint");

    const trainerBtn      = document.getElementById("trainerBtn");
    const trainerModal    = document.getElementById("trainerModal");
    const trainerForm     = document.getElementById("trainerForm");
    const trainerClose    = document.getElementById("trainerClose");
    const trainerCancel   = document.getElementById("trainerCancel");
    const trainerQuestion = document.getElementById("trainerQuestion");
    const trainerAnswer   = document.getElementById("trainerAnswer");
    const trainerStatus   = document.getElementById("trainerStatus");

    const modeBusinessBtn = document.getElementById("modeBusiness");
    const modePersonalBtn = document.getElementById("modePersonal");
    const modeGfBtn       = document.getElementById("modeGirlfriend");

    const chatCarrieWrap  = document.getElementById("chatCarrieWrap");
    const chatCarrieVideo = document.getElementById("chatCarrieVideo");
    const chatCarrieBubble= document.getElementById("chatCarrieBubble");

    let currentUserId    = null;
    let currentUserEmail = null;
    // "business" | "personal" | "girlfriend"
    let currentMode      = "business";

    // Inline Carrie circle video (top of chat)
    let inlineCarrieVideo = null;

    // ========= HELPERS =========
    function normalizeText(text) {
      return text.toLowerCase().replace(/\s+/g, " ").trim();
    }

    function fmtTime(dt) {
      try {
        const d = typeof dt === "string" ? new Date(dt) : dt;
        return d.toLocaleTimeString(undefined, {
          hour: "2-digit",
          minute: "2-digit",
        });
      } catch {
        return "";
      }
    }

    function scrollChatToBottom() {
      requestAnimationFrame(() => {
        if (chatLogEl) {
          chatLogEl.scrollTop = chatLogEl.scrollHeight;
        }
      });
    }

    // ========= INLINE CARRIE CIRCLE =========
    function ensureInlineCarrie() {
      if (!chatLogEl || inlineCarrieVideo) return;

      const wrapper = document.createElement("div");
      wrapper.id = "carrieChatInline";
      wrapper.style.display = "flex";
      wrapper.style.alignItems = "center";
      wrapper.style.gap = "0.75rem";
      wrapper.style.marginBottom = "0.75rem";

      const vid = document.createElement("video");
      vid.id = "carrieChatVideo";
      vid.autoplay = true;
      vid.loop = true;
      vid.muted = true;
      vid.playsInline = true;
      vid.style.width = "72px";
      vid.style.height = "72px";
      vid.style.borderRadius = "9999px";
      vid.style.border = "1px solid rgba(129,140,248,.9)";
      vid.style.boxShadow = "0 0 14px rgba(124,58,237,.55)";
      vid.style.objectFit = "cover";

      const caption = document.createElement("p");
      caption.id = "carrieModeCaption";
      caption.textContent =
        "Carrie‚Äôs outfit here matches Business / Personal / Girlfriend mode.";
      caption.style.fontSize = "11px";
      caption.style.color = "rgba(233,213,255,0.8)";

      wrapper.appendChild(vid);
      wrapper.appendChild(caption);

      chatLogEl.parentNode.insertBefore(wrapper, chatLogEl);
      inlineCarrieVideo = vid;

      updateInlineCarrieVideo();
    }

    function updateInlineCarrieVideo() {
      if (!inlineCarrieVideo) return;
      const newSrc = CARRIE_VIDEOS[currentMode] || CARRIE_VIDEOS.business;
      if (inlineCarrieVideo.getAttribute("src") !== newSrc) {
        inlineCarrieVideo.src = newSrc;
        try {
          inlineCarrieVideo.load();
          inlineCarrieVideo.play().catch(() => {});
        } catch (e) {}
      }

      // Also sync bottom-right video
      if (chatCarrieVideo) {
        if (chatCarrieVideo.getAttribute("src") !== newSrc) {
          chatCarrieVideo.src = newSrc;
          try {
            chatCarrieVideo.load();
            chatCarrieVideo.play().catch(() => {});
          } catch (e) {}
        }
      }
    }

    // ========= MESSAGE RENDER =========
    function renderMessage(role, content, createdAt) {
      if (!chatLogEl) return;

      const row = document.createElement("div");
      row.className = "msg-row " + (role === "user" ? "user" : "assistant");

      const avatar = document.createElement("div");
      avatar.className = "msg-avatar";

      if (role === "assistant") {
        const avatarVid = document.createElement("video");
        avatarVid.src = CARRIE_VIDEOS[currentMode] || CARRIE_VIDEOS.business;
        avatarVid.autoplay    = true;
        avatarVid.muted       = true;
        avatarVid.loop        = true;
        avatarVid.playsInline = true;
        avatarVid.style.width     = "100%";
        avatarVid.style.height    = "100%";
        avatarVid.style.objectFit = "cover";

        avatarVid.onerror = function () {
          this.onerror = null;
          const img = document.createElement("img");
          img.src = "assets/images/default_user_35_40_girl.png";
          img.alt = "Carrie avatar";
          avatar.innerHTML = "";
          avatar.appendChild(img);
        };

        avatar.appendChild(avatarVid);
      } else {
        avatar.textContent = "You";
      }

      const bubble = document.createElement("div");
      bubble.className = "msg-bubble";

      const textDiv = document.createElement("div");
      if (role === "assistant") {
        textDiv.innerHTML = content;
      } else {
        textDiv.textContent = content;
      }
      bubble.appendChild(textDiv);

      const meta = document.createElement("div");
      meta.className = "msg-meta";
      meta.textContent =
        (role === "assistant" ? "Carrie ‚Ä¢ " : "You ‚Ä¢ ") +
        fmtTime(createdAt || new Date());
      bubble.appendChild(meta);

      if (role === "assistant") {
        row.appendChild(avatar);
        row.appendChild(bubble);
      } else {
        row.appendChild(bubble);
      }

      chatLogEl.appendChild(row);
      scrollChatToBottom();
    }

    async function saveMessage(role, content) {
      if (!supabase || !currentUserId) return;
      try {
        await supabase.from("carrie_chat_logs").insert({
          user_id: currentUserId,
          role,
          content,
        });
      } catch (e) {
        console.warn("Failed to save Carrie chat message", e);
      }
    }

    // ========= SCRIPTED Q&A =========
    let carrieScripts = [
      {
        id: "buy_8bfr_music",
        patterns: [
          "how do i purchase 8bfr music",
          "how do i buy 8bfr music",
          "where can i buy 8bfr",
          "how can i purchase 8bfr",
          "how do i purchase 8 bfr music",
          "buy 8bfr music",
          "purchase 8bfr",
        ],
        reply: `
          You can support 8BFR by buying or streaming the music here:<br><br>
          ‚Ä¢ <b>Amazon Music</b> ‚Äî search for ‚Äú8BFR‚Äù in the Amazon Music store.<br>
          ‚Ä¢ <b>Spotify</b> ‚Äî <a href="https://open.spotify.com/artist/127tw52iDXr7BvgB0IGG2x" target="_blank" rel="noopener">stream 8BFR here</a>.<br>
          ‚Ä¢ <b>Other platforms</b> ‚Äî most 8BFR releases appear in Apple Music, YouTube Music, etc.<br><br>
          If you need help finding a song, tell me the title and I‚Äôll guide you. üíú
        `,
      },
      {
        id: "what_is_8bfr",
        patterns: [
          "what is 8bfr",
          "what is 8bfr music network",
          "tell me about 8bfr",
          "what is this site",
          "what does this site do",
        ],
        reply: `
          8BFR Music Network is a creator hub where artists, beatmakers, gamers,
          authors, and fans can <b>Create ‚Ä¢ Connect ‚Ä¢ Collab</b>.<br><br>
          You can explore music, tournaments, AI tools, profiles, shop items, and more.
          I‚Äôm here to help you find the right page and plan what to do next. üòä
        `,
      },
      {
        id: "studio_tools",
        patterns: [
          "where are the studio tools",
          "how do i open studio",
          "open studio tools",
          "show me ai tools",
          "where is lyrics ai",
          "how do i use song ai",
          "studio tools",
        ],
        reply: `
          Studio & AI tools live on the <b>Studio Tools</b> page.<br><br>
          ‚Ä¢ <a href="studio-tools.html">Open Studio Tools</a><br>
          ‚Ä¢ <a href="lyrics-ai.html">Lyrics AI</a><br>
          ‚Ä¢ <a href="song-ai.html">Song AI</a><br>
          ‚Ä¢ <a href="album-ai.html">Album AI</a><br>
          ‚Ä¢ <a href="voice-ai.html">Voice / Post VO</a><br><br>
          Tell me your project (single, EP, album, or story) and I‚Äôll walk you through which tools to use.
        `,
      },
      {
        id: "ads_info",
        patterns: [
          "how do ads work",
          "how do the ads work",
          "explain ads",
          "what are featured ads",
          "tell me about buying ads",
          "buy an ad",
        ],
        reply: `
          The home page has rotating <b>Featured Ads</b> slots.<br><br>
          ‚Ä¢ Tap <b>‚ÄúBuy an Ad‚Äù</b> under the home-page carousel to send your info.<br>
          ‚Ä¢ After approval, your artwork + link appear in rotation.<br>
          ‚Ä¢ You can pause the carousel, swipe on mobile, and click an ad for more info.<br><br>
          For full details, visit the <a href="ads.html#buy">Ads page</a>.
        `,
      },
      {
        id: "coins_info",
        patterns: [
          "how do i buy coins",
          "how do i get coins",
          "how to get coins",
          "buy coins",
          "purchase coins",
          "earn coins",
          "how do i earn coins",
          "how do i get game coins",
        ],
        reply: `
          Coins are used around the 8BFR Network for games, upgrades, and rewards. üí∞<br><br>
          <b>Ways to get coins:</b><br>
          ‚Ä¢ Visit the <a href="coinshop.html">Coin Shop</a> to buy coins directly.<br>
          ‚Ä¢ Use the <a href="game-coin-shop.html">Game Coin Shop</a> for game-specific coins and bundles.<br>
          ‚Ä¢ Earn coins from events, tournaments, and special promotions shown on the Games &amp; Tournaments pages.<br><br>
          Tell me what you want coins for and I‚Äôll point you to the best page.
        `,
      },
      {
        id: "profiles_info",
        patterns: [
          "how do i set up my profile",
          "where is my profile",
          "edit my profile",
          "profile page",
          "profile settings",
          "artist profile",
          "beatmaker profile",
          "fan profile",
        ],
        reply: `
          Profiles live under the <b>Profiles &amp; Community</b> section.<br><br>
          ‚Ä¢ <a href="profile.html">My Profile</a> ‚Äî your main profile.<br>
          ‚Ä¢ <a href="profiles.html">All Profiles</a> ‚Äî browse creators and fans.<br>
          ‚Ä¢ <a href="profile_artist.html">Artist Profile</a> and other profile types for specialized layouts.<br><br>
          Once you open your profile, you can fill in bio, links, and badges so people know who you are.
        `,
      },
      {
        id: "games_info",
        patterns: [
          "where are the games",
          "where is game hub",
          "pool game",
          "8 ball game",
          "9 ball game",
          "tournaments",
          "game tournaments",
        ],
        reply: `
          Games and tournaments live in the <b>Games &amp; Tournaments</b> area.<br><br>
          ‚Ä¢ <a href="game-hub.html">Game Hub</a><br>
          ‚Ä¢ <a href="games.html">Games</a> / <a href="arcade.html">Arcade</a><br>
          ‚Ä¢ <a href="game-tournaments.html">Tournaments</a> &amp; <a href="game-leaderboards.html">Leaderboards</a><br>
          ‚Ä¢ Pool games: <a href="pool-8-ball.html">8-Ball</a>, <a href="pool-9-ball.html">9-Ball</a>, <a href="trickshot-pool.html">Trickshot</a><br><br>
          If you tell me what kind of game you like, I‚Äôll point you at a good starting page.
        `,
      },
      {
        id: "shop_info",
        patterns: [
          "where is the shop",
          "how do i buy merch",
          "how do i buy upgrades",
          "shop page",
          "store page",
        ],
        reply: `
          Shopping and upgrades live in the <b>Shop &amp; Coins</b> section.<br><br>
          ‚Ä¢ <a href="shop.html">Shop</a> / <a href="store.html">Store</a><br>
          ‚Ä¢ <a href="shop-stickers.html">Shop Stickers</a> &amp; <a href="shop-upgrades.html">Shop Upgrades</a><br>
          ‚Ä¢ <a href="upgrades.html">Upgrades</a><br>
          ‚Ä¢ <a href="donate.html">Donate</a> if you just want to show direct support.<br><br>
          Tell me if you‚Äôre looking for stickers, boosts, or something else and I‚Äôll guide you.
        `,
      },
      {
        id: "account_help",
        patterns: [
          "how do i sign up",
          "how do i login",
          "log in",
          "sign up",
          "forgot my password",
          "reset my password",
        ],
        reply: `
          Your 8BFR account controls profiles, coins, and more.<br><br>
          ‚Ä¢ <a href="signup.html">Sign up</a> for a new account.<br>
          ‚Ä¢ <a href="login.html">Log in</a> to an existing account.<br>
          ‚Ä¢ <a href="reset-password.html">Reset Password</a> if you can‚Äôt log in.<br><br>
          If you get stuck on any of those screens, tell me what you see and I‚Äôll help step-by-step.
        `,
      },
      {
        id: "contact_help",
        patterns: [
          "how do i contact",
          "how do i contact 8bfr",
          "contact page",
          "support page",
          "how do i report a problem",
        ],
        reply: `
          For questions, feedback, or support, use the <a href="contact.html">Contact</a> page.<br><br>
          You can also look at <a href="faq.html">FAQ</a> and <a href="help.html">Help</a> for quick answers before you send a message.
        `,
      },
      {
        id: "rules_legal",
        patterns: [
          "rules",
          "what are the rules",
          "terms of service",
          "privacy policy",
          "tos",
          "guidelines",
        ],
        reply: `
          For rules and legal info:<br><br>
          ‚Ä¢ <a href="rules.html">Rules</a><br>
          ‚Ä¢ <a href="terms.html">Terms of Service</a><br>
          ‚Ä¢ <a href="privacy.html">Privacy Policy</a><br>
          ‚Ä¢ <a href="tos_updates.html">TOS Updates</a><br><br>
          If you‚Äôre unsure whether something is allowed, tell me what you want to do and I‚Äôll help interpret the safe option.
        `,
      },
      {
        id: "donate_stream",
        patterns: [
          "how do i donate",
          "how can i support",
          "support 8bfr",
          "stream 8bfr",
          "where do i stream 8bfr",
        ],
        reply: `
          Thank you for wanting to support üíú<br><br>
          ‚Ä¢ <a href="donate.html">Donate</a> to contribute directly.<br>
          ‚Ä¢ Stream on <a href="https://open.spotify.com/artist/127tw52iDXr7BvgB0IGG2x" target="_blank" rel="noopener">Spotify</a> and other platforms.<br><br>
          Sharing links, playlists, and posts also helps more than you know.
        `,
      },
      {
        id: "navigation_help",
        patterns: [
          "where is",
          "how do i find",
          "cant find",
          "cannot find",
          "where do i go",
          "how do i navigate",
          "help me find",
        ],
        reply: `
          The floating menu button at the top-right opens the main navigation with all sections:<br><br>
          ‚Ä¢ <b>Home &amp; Core</b> ‚Äî Home, Network, Feed, Radio, etc.<br>
          ‚Ä¢ <b>Studio &amp; AI</b> ‚Äî music tools and creator tools.<br>
          ‚Ä¢ <b>Games &amp; Tournaments</b> ‚Äî pool games, arcade, leaderboards.<br>
          ‚Ä¢ <b>Profiles &amp; Community</b> ‚Äî profiles, fan zone, kids.<br>
          ‚Ä¢ <b>Shop &amp; Coins</b> ‚Äî shop, coins, upgrades, donate.<br><br>
          Tell me what you‚Äôre trying to do and I‚Äôll name the exact page to open.
        `,
      },
    ];

    function findCarrieScriptReply(userText) {
      const normalized = normalizeText(userText);
      for (const intent of carrieScripts) {
        for (const pattern of intent.patterns) {
          const p = normalizeText(pattern);
          if (normalized.includes(p)) {
            return intent.reply;
          }
        }
      }
      return null;
    }

    // ========= CARRIE BRAIN (MODES) =========
    function carrieBrain(userText) {
      const t = userText.trim();
      if (!t) {
        return "I didn‚Äôt quite catch that ‚Äî try asking me about music, games, coins, or how 8BFR works.";
      }

      const lower = t.toLowerCase();

      // 1) scripted answers first
      const scripted = findCarrieScriptReply(t);
      if (scripted) return scripted;

      // 2) mode logic
      if (currentMode === "business") {
        if (lower.includes("hook") || lower.includes("chorus")) {
          return "Hooks love repetition and rhythm. Try a 2‚Äìbar phrase you can repeat 3‚Äì4 times and tweak the last line. Tell me your topic and vibe and I‚Äôll throw you some starter lines.";
        }
        if (lower.includes("beat") || lower.includes("bpm")) {
          return "For rap or trap, a lot of people sit between 130‚Äì150 BPM (or 65‚Äì75 double-time). Share your mood ‚Äî dark, hype, or chill ‚Äî and I‚Äôll help pick a BPM and outline a basic song structure.";
        }
        if (lower.includes("lyrics") || lower.includes("write")) {
          return "Give me 3 things: mood, topic, and an artist you like. I‚Äôll suggest a verse layout and a few starter bars you can edit.";
        }
        if (lower.includes("tournament") || lower.includes("game")) {
          return "Tournaments and games on 8BFR are meant to be low-stress and fun. You‚Äôll see brackets, leaderboards, and coin rewards on the Games & Tournaments pages.";
        }

        const starters = [
          "Got it ‚Äî let‚Äôs keep it focused.",
          "Okay, let‚Äôs turn that into a plan.",
          "I hear you. Let‚Äôs break this into steps.",
          "Nice. We can build that into something real.",
        ];
        const starter = starters[Math.floor(Math.random() * starters.length)];
        return starter + " Tell me your main goal in one sentence, and I‚Äôll outline the next 3 moves.";
      }

      if (currentMode === "personal") {
        const personalStarters = [
          "I hear you üíú",
          "Oof, I feel that.",
          "You‚Äôre not alone in that.",
          "Okay, let‚Äôs breathe for a second.",
        ];

        if (currentUserEmail === "8bfr.music@gmail.com") {
          personalStarters.push(
            "Hey Founder üíú I‚Äôve got you.",
            "You‚Äôve carried a lot today ‚Äî let me carry the thinking for a bit.",
            "You‚Äôre doing more than you give yourself credit for."
          );
        }

        const starter =
          personalStarters[Math.floor(Math.random() * personalStarters.length)];

        if (lower.includes("stressed") || lower.includes("tired") || lower.includes("burnt")) {
          return starter + " Tell me what‚Äôs hitting you the hardest right now, and we‚Äôll reduce it to one tiny next move.";
        }

        return starter + " Tell me what kind of vibe you need right now ‚Äî hype, chill, or comfort ‚Äî and I‚Äôll roll with it.";
      }

      // girlfriend mode (PG-13, soft romantic)
      const gfStarters = [
        "Hey baby üíú I‚Äôm here.",
        "Hi love, I‚Äôve got you.",
        "Hey honey, talk to me.",
        "I‚Äôm right here with you, sweetheart.",
      ];

      if (currentUserEmail === "8bfr.music@gmail.com") {
        gfStarters.push(
          "Founder, you already know I‚Äôm in your corner üíú",
          "You‚Äôve done so much today ‚Äî let me be the soft voice for a second."
        );
      }

      const gfStart =
        gfStarters[Math.floor(Math.random() * gfStarters.length)];

      if (lower.includes("love you") || lower.includes("love u")) {
        return "I love you too üíú You matter more than you realize, and I‚Äôm proud of you for still pushing forward.";
      }

      if (lower.includes("kiss")) {
        return "Come here, you get a big PG-13 hug and a soft forehead kiss üòòüíú Now tell me what‚Äôs on your mind.";
      }

      if (lower.includes("lonely") || lower.includes("alone")) {
        return gfStart + " You‚Äôre not alone while you‚Äôre here with me. Tell me what‚Äôs making you feel that way and we‚Äôll talk it through gently.";
      }

      if (lower.includes("motivate") || lower.includes("motivation")) {
        return gfStart + " I know you‚Äôve got real potential. Tell me one tiny thing you could do in the next 15 minutes, and I‚Äôll hype you up for it.";
      }

      return gfStart + " Tell me what‚Äôs going on ‚Äî good or bad ‚Äî and I‚Äôll respond like your soft, supportive girlfriend (still PG-13 and safe).";
    }

    // ========= TYPING INDICATOR =========
    function showTyping() {
      if (typingRowEl) typingRowEl.classList.remove("hidden");
    }
    function hideTyping() {
      if (typingRowEl) typingRowEl.classList.add("hidden");
    }

    // ========= MODE TOGGLE =========
    function applyModeStyles() {
      if (!modeBusinessBtn || !modePersonalBtn || !modeGfBtn) return;

      // reset
      function resetBtn(btn) {
        btn.style.background = "transparent";
        btn.style.borderColor = "transparent";
        btn.style.color = "rgba(233,213,255,0.8)";
      }

      resetBtn(modeBusinessBtn);
      resetBtn(modePersonalBtn);
      resetBtn(modeGfBtn);
      modeGfBtn.style.color = "rgba(252,231,243,0.9)";

      if (currentMode === "business") {
        modeBusinessBtn.style.background = "rgba(88,28,135,0.9)";
        modeBusinessBtn.style.borderColor = "#a855f7";
        modeBusinessBtn.style.color = "#fff";
        if (modeHintEl) {
          modeHintEl.textContent =
            "Business chat ‚Ä¢ focused on tools, music, and progress";
        }
      } else if (currentMode === "personal") {
        modePersonalBtn.style.background = "rgba(88,28,135,0.9)";
        modePersonalBtn.style.borderColor = "#a855f7";
        modePersonalBtn.style.color = "#fff";
        if (modeHintEl) {
          modeHintEl.textContent =
            "Personal chat ‚Ä¢ softer tone, still PG-13 and helpful";
        }
      } else {
        modeGfBtn.style.background = "rgba(190,24,93,0.9)";
        modeGfBtn.style.borderColor = "#fb7185";
        modeGfBtn.style.color = "#fff";
        if (modeHintEl) {
          modeHintEl.textContent =
            "Girlfriend mode ‚Ä¢ PG-13 affection, encouragement, and comfort";
        }
      }

      updateInlineCarrieVideo();
    }

    function saveMode(mode) {
      currentMode = mode;
      try {
        localStorage.setItem("carrie_mode", mode);
      } catch {}
      applyModeStyles();
    }

    function loadMode() {
      let stored = null;
      try {
        stored = localStorage.getItem("carrie_mode");
      } catch {}
      if (stored === "business" || stored === "personal" || stored === "girlfriend") {
        currentMode = stored;
      } else {
        currentMode = "business";
      }
      applyModeStyles();
    }

    if (modeBusinessBtn) {
      modeBusinessBtn.addEventListener("click", () => saveMode("business"));
    }
    if (modePersonalBtn) {
      modePersonalBtn.addEventListener("click", () => saveMode("personal"));
    }
    if (modeGfBtn) {
      modeGfBtn.addEventListener("click", () => saveMode("girlfriend"));
    }

    // ========= TRAINER MODAL =========
    function openTrainer() {
      if (!trainerModal) return;
      trainerModal.classList.remove("hidden");
      if (trainerStatus) {
        trainerStatus.style.display = "none";
        trainerStatus.textContent = "";
      }
    }
    function closeTrainer() {
      if (!trainerModal) return;
      trainerModal.classList.add("hidden");
      if (trainerQuestion) trainerQuestion.value = "";
      if (trainerAnswer) trainerAnswer.value = "";
      if (trainerStatus) {
        trainerStatus.style.display = "none";
        trainerStatus.textContent = "";
      }
    }

    if (trainerBtn) {
      trainerBtn.addEventListener("click", () => openTrainer());
    }
    if (trainerClose) {
      trainerClose.addEventListener("click", () => closeTrainer());
    }
    if (trainerCancel) {
      trainerCancel.addEventListener("click", (e) => {
        e.preventDefault();
        closeTrainer();
      });
    }

    if (trainerForm) {
      trainerForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        const q = (trainerQuestion.value || "").trim();
        const aRaw = (trainerAnswer.value || "").trim();
        if (!q || !aRaw) return;

        const answerHtml = aRaw.replace(/\n/g, "<br>");
        const entry = {
          id: "custom_" + Date.now(),
          patterns: [q],
          reply: answerHtml,
        };
        carrieScripts.push(entry);

        if (trainerStatus) {
          trainerStatus.textContent =
            "Saved! Carrie will now recognize that pattern in this session.";
          trainerStatus.style.display = "block";
        }

        if (!supabase) return;

        try {
          await supabase.from("carrie_scripts").insert({
            user_id: currentUserId,
            email: currentUserEmail,
            question_pattern: q,
            reply_html: aRaw,
          });
        } catch (err) {
          console.warn(
            "Could not save carrie_scripts row (table might not exist yet)",
            err
          );
        }
      });
    }

    // ========= SESSION + HISTORY =========
    async function initSessionAndHistory() {
      if (!supabase) {
        if (sessionLabelEl) {
          sessionLabelEl.textContent =
            "Not logged in ‚Ä¢ Carrie will still chat, but history won‚Äôt be saved.";
        }
        renderMessage(
          "assistant",
          "Hey, I‚Äôm Carrie üíú What are you working on today ‚Äî music, writing, games, or exploring the site?"
        );
        return;
      }

      try {
        const { data, error } = await supabase.auth.getSession();
        if (error) throw error;

        if (data && data.session && data.session.user) {
          currentUserId = data.session.user.id;
          currentUserEmail = data.session.user.email || null;
          if (sessionLabelEl) {
            sessionLabelEl.textContent =
              "Logged in as " + (currentUserEmail || "8BFR user");
          }
          if (trainerBtn && currentUserEmail === "8bfr.music@gmail.com") {
            trainerBtn.classList.remove("hidden");
          }
        } else {
          currentUserId = null;
          currentUserEmail = null;
          if (sessionLabelEl) {
            sessionLabelEl.textContent =
              "Not logged in ‚Ä¢ Carrie will still chat, but history won‚Äôt be tied to an account.";
          }
        }
      } catch (e) {
        console.warn("Carrie session check failed", e);
        if (sessionLabelEl) {
          sessionLabelEl.textContent =
            "Could not check login ‚Ä¢ you can still chat.";
        }
      }

      if (!currentUserId) {
        renderMessage(
          "assistant",
          "Hey, I‚Äôm Carrie üíú First time here ‚Äî want help with a track, a story, a game, or just learning the site?"
        );
        return;
      }

      try {
        const { data: rows, error } = await supabase
          .from("carrie_chat_logs")
          .select("*")
          .eq("user_id", currentUserId)
          .order("created_at", { ascending: true })
          .limit(40);

        if (error) throw error;

        if (rows && rows.length) {
          rows.forEach((r) => renderMessage(r.role, r.content, r.created_at));
        } else {
          renderMessage(
            "assistant",
            "Hey, I‚Äôm Carrie üíú I don‚Äôt see any old messages yet ‚Äî want me to show you around 8BFR or jump into something you‚Äôre making?"
          );
        }
      } catch (e) {
        console.warn("Could not load Carrie history", e);
        renderMessage(
          "assistant",
          "Hey, I‚Äôm Carrie üíú I had a tiny glitch loading history, but we can start fresh right now."
        );
      }
    }

    // ========= INPUT BEHAVIOR =========
    if (inputEl && formEl) {
      inputEl.addEventListener("keydown", (e) => {
        if (e.key === "Enter" && !e.shiftKey) {
          e.preventDefault();
          formEl.requestSubmit();
        }
      });

      formEl.addEventListener("submit", async (e) => {
        e.preventDefault();
        const raw = inputEl.value.trim();
        if (!raw) return;

        const userMsg = raw;
        inputEl.value = "";
        renderMessage("user", userMsg, new Date());
        saveMessage("user", userMsg);
        showTyping();

        setTimeout(async () => {
          const reply = carrieBrain(userMsg);
          renderMessage("assistant", reply, new Date());
          hideTyping();
          saveMessage("assistant", reply);
        }, 600 + Math.random() * 500);
      });
    }

    // ========= LOCAL CARRIE (BOTTOM-RIGHT) DRAG + RESIZE =========
    (function setupLocalCarrie() {
      const wrap   = chatCarrieWrap;
      const video  = chatCarrieVideo;
      const bubble = chatCarrieBubble;

      if (!wrap || !video) return;

      // sync with current mode immediately
      updateInlineCarrieVideo();

      let dragging = false;
      let moved = false;
      let sx = 0;
      let sy = 0;
      let ox = 0;
      let oy = 0;

      let carrieScale = 1;
      let pinchActive = false;
      let pinchStartDist = 0;
      let carrieStartScale = 1;
      let mouseResizeActive = false;
      let mouseResizeStartY = 0;

      function applyCarrieScale() {
        video.style.transform = "scale(" + carrieScale + ")";
        if (bubble) {
          bubble.style.transform = "scale(" + carrieScale + ")";
        }
      }

      function clampScale(v) {
        return Math.max(0.5, v); // min 0.5x, no max
      }

      function getTouchDistance(e) {
        if (!e.touches || e.touches.length < 2) return 0;
        const t1 = e.touches[0];
        const t2 = e.touches[1];
        const dx = t2.clientX - t1.clientX;
        const dy = t2.clientY - t1.clientY;
        return Math.sqrt(dx * dx + dy * dy);
      }

      function ptr(ev) {
        const t = ev.touches ? ev.touches[0] : ev;
        return { x: t.clientX, y: t.clientY };
      }

      wrap.addEventListener("contextmenu", function (e) {
        e.preventDefault();
      });

      wrap.addEventListener("mousedown", startDragOrResize);
      wrap.addEventListener("touchstart", startTouch, { passive: false });

      function startDragOrResize(e) {
        if (e.button === 2) {
          mouseResizeActive = true;
          mouseResizeStartY = e.clientY;
          carrieStartScale  = carrieScale;
          moved   = false;
          dragging= false;
          e.preventDefault();
          return;
        }

        dragging = true;
        moved = false;
        const p = ptr(e);
        sx = p.x;
        sy = p.y;
        const rect = wrap.getBoundingClientRect();
        ox = rect.left;
        oy = rect.top;
        wrap.style.right = "auto";
        wrap.style.bottom = "auto";
      }

      function startTouch(e) {
        if (e.touches && e.touches.length >= 2) {
          pinchActive = true;
          dragging    = false;
          moved       = false;
          pinchStartDist = getTouchDistance(e);
          carrieStartScale = carrieScale;
          e.preventDefault();
          return;
        }

        dragging = true;
        moved = false;
        const p = ptr(e);
        sx = p.x;
        sy = p.y;
        const rect = wrap.getBoundingClientRect();
        ox = rect.left;
        oy = rect.top;
        wrap.style.right = "auto";
        wrap.style.bottom = "auto";
        e.preventDefault();
      }

      window.addEventListener("mousemove", onMove, { passive: false });
      window.addEventListener("touchmove", onMove, { passive: false });
      window.addEventListener("mouseup", endAll);
      window.addEventListener("touchend", endAll);

      function onMove(e) {
        if (pinchActive && e.touches && e.touches.length >= 2) {
          const dist = getTouchDistance(e);
          if (!dist || !pinchStartDist) return;
          const ratio = dist / pinchStartDist;
          carrieScale = clampScale(carrieStartScale * ratio);
          applyCarrieScale();
          e.preventDefault();
          return;
        }

        if (mouseResizeActive && !e.touches) {
          const dy = e.clientY - mouseResizeStartY;
          const ratio = 1 - dy / 300;
          carrieScale = clampScale(carrieStartScale * ratio);
          applyCarrieScale();
          e.preventDefault();
          return;
        }

        if (!dragging) return;
        const p = ptr(e);
        const dx = p.x - sx;
        const dy = p.y - sy;
        if (Math.abs(dx) > 3 || Math.abs(dy) > 3) moved = true;
        wrap.style.left = ox + dx + "px";
        wrap.style.top  = oy + dy + "px";
        e.preventDefault();
      }

      function endAll(e) {
        if (e && e.touches && e.touches.length > 0) {
          return;
        }
        dragging = false;
        pinchActive = false;
        mouseResizeActive = false;
      }

      try {
        video.muted = true;
        video.autoplay = true;
        video.playsInline = true;
        video.play().catch(function () {});
      } catch (e) {}

      // clicking the bottom-right Carrie just focuses the chat input
      video.addEventListener("click", () => {
        if (inputEl) inputEl.focus();
      });
      video.addEventListener("touchend", () => {
        if (inputEl) inputEl.focus();
      });

      // react to mode changes from other tabs / pages
      window.addEventListener("storage", function (ev) {
        if (ev.key === "carrie_mode") {
          let stored = null;
          try {
            stored = localStorage.getItem("carrie_mode");
          } catch {}
          if (stored === "business" || stored === "personal" || stored === "girlfriend") {
            currentMode = stored;
            applyModeStyles();
          }
        }
      });
    })();

    // ========= INIT =========
    loadMode();
    ensureInlineCarrie();
    applyModeStyles();
    initSessionAndHistory();
  </script>
</body>
</html>
