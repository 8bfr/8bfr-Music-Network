<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Chat with Carrie ‚Äî 8BFR Music Network</title>
  <meta name="description" content="Chat with Carrie ‚Äî your AI assistant on the 8BFR Music Network." />
  <link rel="icon" href="assets/images/favicon.png" />
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    :root {
      --ring: rgba(124,58,237,.55);
      --glass: rgba(12,6,24,.80);
    }
    html,body { scroll-behavior:smooth; }
    body {
      font-family: system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial;
      background:
        radial-gradient(1200px 600px at 10% -10%, rgba(124,58,237,.35), transparent 60%),
        radial-gradient(900px 400px at 110% 10%, rgba(0,217,255,.22), transparent 60%),
        linear-gradient(#0b0014,#000);
      color:#eae6ff;
      margin:0;
      min-height:100vh;
      overflow-x:hidden;
    }
    header{
      position:relative;
      z-index:5;
      background:rgba(15,0,30,.9);
      border-bottom:1px solid rgba(124,58,237,.5);
    }
    .chat-shell{
      border-radius:18px;
      border:1px solid rgba(124,58,237,.55);
      background:rgba(10,2,26,.95);
      box-shadow:0 16px 40px rgba(0,0,0,.75);
    }
    .chat-log{
      height:420px;
      max-height:65vh;
      overflow-y:auto;
      padding:1rem;
      background:
        radial-gradient(circle at 0 0, rgba(124,58,237,.12), transparent 55%),
        radial-gradient(circle at 100% 0, rgba(0,217,255,.10), transparent 55%),
        #020014;
    }
    .msg-row{
      display:flex;
      margin-bottom:.65rem;
      gap:.4rem;
    }
    .msg-row.user{
      justify-content:flex-end;
    }
    .msg-bubble{
      max-width:80%;
      padding:.55rem .8rem;
      border-radius:.85rem;
      font-size:.9rem;
      line-height:1.35;
      border:1px solid rgba(148,163,255,.55);
      background:rgba(17,24,39,.96);
      box-shadow:0 0 12px rgba(79,70,229,.35);
    }
    .msg-row.user .msg-bubble{
      background:linear-gradient(135deg,#7c3aed,#4c1d95);
      border-color:#a855f7;
      box-shadow:0 0 12px rgba(168,85,247,.55);
    }
    .msg-meta{
      font-size:.7rem;
      opacity:.7;
      margin-top:.2rem;
    }
    .msg-avatar{
      width:28px;
      height:28px;
      border-radius:999px;
      flex-shrink:0;
      overflow:hidden;
      border:1px solid rgba(129,140,248,.9);
      display:grid;
      place-items:center;
      font-size:.75rem;
      background:#020014;
    }
    .msg-avatar img{
      width:100%;
      height:100%;
      object-fit:cover;
      display:block;
    }
    .msg-row.user .msg-avatar{
      display:none; /* hide avatar on the right for now */
    }

    .pill-tag{
      display:inline-flex;
      align-items:center;
      gap:.25rem;
      font-size:.7rem;
      border-radius:999px;
      padding:.15rem .55rem;
      border:1px solid rgba(129,140,248,.85);
      background:rgba(15,23,42,.9);
      text-transform:uppercase;
      letter-spacing:.08em;
    }

    .btn{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:.3rem;
      background:#120327;
      border:1px solid rgba(124,58,237,.6);
      color:#eae6ff;
      padding:.55rem .95rem;
      border-radius:.75rem;
      font-size:.9rem;
      text-decoration:none;
      cursor:pointer;
    }
    .btn:hover{
      background:#190536;
    }
    .btn-primary{
      background:#7c3aed;
      border-color:#7c3aed;
      color:#fff;
    }
    .btn-primary:hover{ filter:brightness(1.05); }

    textarea#carrieInput{
      resize:none;
      min-height:52px;
      max-height:120px;
      background:rgba(10,2,26,.95);
      border-radius:.75rem;
      border:1px solid rgba(148,163,255,.55);
      padding:.5rem .7rem;
      font-size:.9rem;
      color:#e5e7eb;
      width:100%;
    }
    textarea#carrieInput:focus{
      outline:none;
      box-shadow:0 0 0 1px rgba(129,140,248,.9);
      border-color:rgba(129,140,248,1);
    }
    .input-hint{
      font-size:.7rem;
      opacity:.7;
    }
    .typing-dot{
      width:6px;height:6px;border-radius:999px;
      background:#a855f7;
      animation:bounce 1s infinite ease-in-out;
    }
    .typing-dot:nth-child(2){ animation-delay:.15s; }
    .typing-dot:nth-child(3){ animation-delay:.3s; }
    @keyframes bounce{
      0%,80%,100%{ transform:translateY(0); opacity:.4;}
      40%{ transform:translateY(-4px); opacity:1;}
    }

    @media (max-width:640px){
      .chat-log{ height:60vh; }
      .msg-bubble{ max-width:88%; }
    }

    /* üßº Hide extra bubbles on chat page (keep hamburger + Carrie) */
    #bubbleStack,
    #bubble-top-single {
      display:none !important;
    }

    /* When menu is open, nudge the chat a bit left on desktop so it‚Äôs not covered */
    @media (min-width:768px){
      body.menu-open main .chat-shell{
        margin-right:260px;
      }
    }
  </style>
</head>
<body>
  <!-- Simple header -->
  <header class="px-4 py-4">
    <div class="max-w-6xl mx-auto flex items-center justify-between gap-3">
      <div class="flex items-center gap-3">
        <img src="assets/images/logo_8bfr.svg"
             alt="8BFR logo"
             class="h-9 w-auto"
             onerror="this.onerror=null;this.src='assets/images/8bfr.png'">
        <div>
          <h1 class="text-xl sm:text-2xl font-extrabold">
            Chat with <span class="text-[#a855f7]">Carrie</span>
          </h1>
          <p class="text-[11px] text-purple-300/80 -mt-0.5">
            8BFR Music Network ‚Ä¢ Create ‚Ä¢ Connect ‚Ä¢ Collab
          </p>
        </div>
      </div>
    </div>
  </header>

  <main class="max-w-4xl mx-auto px-4 pb-10 pt-4">
    <div class="chat-shell p-4 sm:p-5">
      <div class="flex items-center justify-between mb-3 gap-3">
        <div class="flex flex-col gap-1">
          <!-- Back to home moved here above Live Carrie -->
          <a href="index.html"
             class="text-[#00d9ff] text-[11px] underline/50 hover:underline self-start">
            ‚¨Ö Back to Home
          </a>

          <div class="flex items-center gap-2">
            <span class="pill-tag">
              <span class="inline-block w-2 h-2 rounded-full bg-green-400 animate-pulse"></span>
              <span>Live Carrie</span>
            </span>
            <span id="modeLabel" class="text-[11px] text-purple-200/80">
              Professional mode
            </span>
          </div>

          <!-- Mode toggle -->
          <div class="flex items-center gap-2 text-[11px] text-purple-200/80 mt-1">
            <span>Mode:</span>
            <button type="button"
                    id="modeProfessional"
                    class="px-2 py-0.5 rounded-full border border-purple-500/70 bg-purple-900/70">
              Business
            </button>
            <button type="button"
                    id="modePersonal"
                    class="px-2 py-0.5 rounded-full border border-purple-500/40 bg-transparent opacity-70">
              Personal
            </button>
            <a href="carrie-closet.html"
               class="ml-2 text-[11px] text-pink-300 hover:underline">
              üëó Open Closet
            </a>
          </div>
        </div>

        <div class="text-right space-y-1">
          <div id="sessionIndicator" class="text-[11px] text-purple-200/70">
            Checking login‚Ä¶
          </div>
          <!-- Owner-only trainer button (shown via JS if email matches) -->
          <button
            id="trainerBtn"
            type="button"
            class="btn hidden"
            style="padding:2px 8px;font-size:10px;border-radius:999px;"
          >
            Carrie Trainer
          </button>
        </div>
      </div>

      <!-- Chat log -->
      <div id="chatLog" class="chat-log rounded-lg mb-3">
        <!-- messages injected by JS -->
      </div>

      <!-- Typing indicator -->
      <div id="typingRow" class="hidden mb-2 text-xs text-purple-200/80 flex items-center gap-2">
        <span class="pill-tag">
          Carrie typing
        </span>
        <div class="flex items-center gap-1 ml-1">
          <span class="typing-dot"></span>
          <span class="typing-dot"></span>
          <span class="typing-dot"></span>
        </div>
      </div>

      <!-- Input row -->
      <form id="carrieForm" class="mt-1">
        <div class="flex items-end gap-2">
          <div class="flex-1">
            <label for="carrieInput"
                   class="text-xs text-purple-200/80 mb-1 inline-block">
              Ask Carrie anything about 8BFR, music, games, or ideas.
            </label>
            <textarea id="carrieInput"
                      placeholder="Example: ‚ÄúHelp me write a hook for a trap beat about late nights.‚Äù"></textarea>
            <p class="input-hint mt-1">
              Press <b>Enter</b> to send ‚Ä¢ <b>Shift+Enter</b> for a new line.
            </p>
          </div>
          <button type="submit" class="btn btn-primary px-3 sm:px-4 h-10">
            <span>Send</span>
            <span>üì§</span>
          </button>
        </div>
      </form>
    </div>

    <p class="mt-3 text-[11px] text-purple-300/70 text-center max-w-xl mx-auto">
      Carrie is in beta. Conversations may be stored to improve your experience on the 8BFR Music Network.
    </p>
  </main>

  <!-- Carrie Trainer modal (owner only; JS toggles visibility) -->
  <div
    id="trainerModal"
    class="fixed inset-0 z-50 hidden"
  >
    <div class="absolute inset-0 bg-black/60 backdrop-blur-sm"></div>
    <div
      class="relative max-w-md mx-auto mt-24 bg-[#0c0618] border border-purple-500/60 rounded-xl p-4 shadow-2xl"
    >
      <div class="flex items-center justify-between mb-2">
        <h2 class="text-sm font-semibold text-purple-100">
          Carrie Trainer (Owner Only)
        </h2>
        <button
          id="trainerClose"
          type="button"
          class="text-xs text-purple-200 hover:underline"
        >
          Close
        </button>
      </div>
      <p class="text-[11px] text-purple-200/80 mb-2">
        Add a question pattern and the reply you want Carrie to use.
        Replies can include basic HTML and links.
      </p>
      <form id="trainerForm" class="space-y-2">
        <div>
          <label class="text-xs text-purple-200/90 block mb-1">
            User question / pattern (example: "how do i purchase 8bfr music")
          </label>
          <textarea
            id="trainerQuestion"
            class="w-full text-xs rounded-md border border-purple-500/50 bg-[#120327] px-2 py-1 text-purple-50"
            rows="2"
          ></textarea>
        </div>
        <div>
          <label class="text-xs text-purple-200/90 block mb-1">
            Carrie reply (HTML allowed)
          </label>
          <textarea
            id="trainerAnswer"
            class="w-full text-xs rounded-md border border-purple-500/50 bg-[#120327] px-2 py-1 text-purple-50"
            rows="4"
          ></textarea>
        </div>
        <p class="text-[10px] text-purple-300/80">
          Tip: You can add more patterns for the same answer later by repeating this with small variations.
        </p>
        <div class="flex justify-end gap-2 pt-1">
          <button
            type="button"
            id="trainerCancel"
            class="btn"
            style="padding:3px 10px;font-size:11px;"
          >
            Cancel
          </button>
          <button
            type="submit"
            class="btn btn-primary"
            style="padding:3px 10px;font-size:11px;"
          >
            Save &amp; Use
          </button>
        </div>
        <div
          id="trainerStatus"
          class="text-[10px] text-green-300/80 mt-1"
          style="display:none;"
        ></div>
      </form>
    </div>
  </div>

  <!-- Supabase client -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    // --- Supabase setup (same project as scripts.js) ---
    const SUPABASE_URL = "https://novbuvwpjnxwwvdekjhr.supabase.co";
    const SUPABASE_ANON_KEY =
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiIsIm5vdmJ1dndwam54d3d2ZGVramhyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjExODkxODUsImV4cCI6MjA3Njc2NTE4NX0.1UUkdGafh6ZplAX8hi7Bvj94D2gvFQZUl0an1RvcSA0";

    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
  </script>

  <script>
    const chatLogEl      = document.getElementById("chatLog");
    const formEl         = document.getElementById("carrieForm");
    const inputEl        = document.getElementById("carrieInput");
    const typingRowEl    = document.getElementById("typingRow");
    const sessionLabelEl = document.getElementById("sessionIndicator");

    const modeLabelEl    = document.getElementById("modeLabel");
    const modeProfessionalBtn = document.getElementById("modeProfessional");
    const modePersonalBtn     = document.getElementById("modePersonal");

    const trainerBtn     = document.getElementById("trainerBtn");
    const trainerModal   = document.getElementById("trainerModal");
    const trainerForm    = document.getElementById("trainerForm");
    const trainerClose   = document.getElementById("trainerClose");
    const trainerCancel  = document.getElementById("trainerCancel");
    const trainerQuestion= document.getElementById("trainerQuestion");
    const trainerAnswer  = document.getElementById("trainerAnswer");
    const trainerStatus  = document.getElementById("trainerStatus");

    let currentUserId    = null;
    let currentUserEmail = null;
    let loadingHistory   = false;

    // mode + owner
    let carrieMode       = "professional"; // "professional" | "personal"
    let isOwner          = false;

    function saveMode(mode){
      carrieMode = mode;
      try {
        localStorage.setItem("carrie-mode", mode);
      } catch(e){}
      updateModeUI();
    }

    function updateModeUI(){
      if (carrieMode === "professional") {
        modeLabelEl.textContent = "Professional mode";
        modeProfessionalBtn.style.background = "rgba(76,29,149,0.9)";
        modeProfessionalBtn.style.opacity = "1";
        modePersonalBtn.style.background = "transparent";
        modePersonalBtn.style.opacity = "0.6";
      } else {
        modeLabelEl.textContent = "Personal mode";
        modePersonalBtn.style.background = "rgba(76,29,149,0.9)";
        modePersonalBtn.style.opacity = "1";
        modeProfessionalBtn.style.background = "transparent";
        modeProfessionalBtn.style.opacity = "0.6";
      }
    }

    function getInitialModeFromStorage(){
      try {
        const stored = localStorage.getItem("carrie-mode");
        if (stored === "personal" || stored === "professional") {
          carrieMode = stored;
        }
      } catch(e){}
      updateModeUI();
    }

    // --- Simple "training" data for Carrie (seeded site Q&A) ---
    let carrieScripts = [
      {
        id: "buy_8bfr_music",
        patterns: [
          "how do i purchase 8bfr music",
          "how do i buy 8bfr music",
          "where can i buy 8bfr",
          "how can i purchase 8bfr",
          "how do i purchase 8 bfr music",
          "buy 8bfr music",
          "purchase 8bfr"
        ],
        reply: `
          You can support 8BFR by buying or streaming the music here:<br><br>
          ‚Ä¢ <b>Amazon Music</b> ‚Äî search for ‚Äú8BFR‚Äù in the Amazon Music store.<br>
          ‚Ä¢ <b>Spotify</b> ‚Äî <a href="https://open.spotify.com/artist/127tw52iDXr7BvgB0IGG2x" target="_blank" rel="noopener">stream 8BFR here</a>.<br>
          ‚Ä¢ <b>Other platforms</b> ‚Äî most 8BFR releases appear in Apple Music, YouTube Music, etc.<br><br>
          If you need help finding a song, tell me the title and I‚Äôll guide you. üíú
        `
      },
      {
        id: "what_is_8bfr",
        patterns: [
          "what is 8bfr",
          "what is 8bfr music network",
          "tell me about 8bfr",
          "what is this site"
        ],
        reply: `
          8BFR Music Network is a creator hub where artists, beatmakers, gamers,
          authors, and fans can <b>Create ‚Ä¢ Connect ‚Ä¢ Collab</b>.<br><br>
          I‚Äôm Carrie ‚Äî your AI guide for music, tools, profiles, and site help. üòä
        `
      },
      {
        id: "how_to_sign_up",
        patterns: [
          "how do i sign up",
          "how do i create an account",
          "how do i register",
          "how to join 8bfr",
          "sign up for 8bfr"
        ],
        reply: `
          To join 8BFR:<br><br>
          1) Tap <b>Sign up</b> in the menu or at the top of the site.<br>
          2) Enter your email and create a password.<br>
          3) Pick your main badge (Artist, Beatmaker, Gamer, Fan, etc.).<br><br>
          Once you confirm your email, you can start building your profile and uploading.
        `
      },
      {
        id: "buy_ads",
        patterns: [
          "how do i buy an ad",
          "how do i purchase an ad",
          "buy an ad",
          "how do ads work",
          "explain ads",
          "promote my song",
          "promote my music",
          "how to promote my song"
        ],
        reply: `
          Ads on 8BFR rotate in the <b>Featured Ads</b> section on the home page.<br><br>
          ‚Ä¢ Click <b>Buy an Ad</b> under the carousel on the home page.<br>
          ‚Ä¢ Fill out the form with your name, email, target URL, and notes.<br>
          ‚Ä¢ Your ad will be reviewed, then added into the rotation once approved.<br><br>
          You can also open the full <a href="ads.html#buy">Ads page</a> for more details.
        `
      },
      {
        id: "tournaments",
        patterns: [
          "how do tournaments work",
          "how do the tournaments work",
          "game tournaments",
          "8bfr tournaments",
          "how to join tournaments",
          "join a tournament"
        ],
        reply: `
          Tournaments live inside the <b>Games & Tournaments</b> section.<br><br>
          ‚Ä¢ Go to <b>Game Hub</b> or <b>Tournaments</b> from the menu.<br>
          ‚Ä¢ Pick a game (like Pool 8-Ball) and join an active bracket.<br>
          ‚Ä¢ Wins and placements give you <b>coins</b>, badges, and leaderboard points.<br><br>
          Some events are free, others may use coins to enter.
        `
      },
      {
        id: "studio_tools",
        patterns: [
          "where is the studio",
          "where are studio tools",
          "use ai tools",
          "open studio tools",
          "ai lyrics tool",
          "ai song tool",
          "ai album tool"
        ],
        reply: `
          All the music AI tools live under <b>Studio & AI</b>:<br><br>
          ‚Ä¢ <a href="studio-tools.html">Studio Tools</a> ‚Äî main hub.<br>
          ‚Ä¢ <a href="lyrics-ai.html">Lyrics AI</a> ‚Äî help writing hooks and verses.<br>
          ‚Ä¢ <a href="song-ai.html">Song AI</a> ‚Äî structure songs and demos.<br>
          ‚Ä¢ <a href="album-ai.html">Album AI</a> ‚Äî plan full releases.<br>
          ‚Ä¢ <a href="voice-ai.html">Voice / Post VO</a> ‚Äî voice & post processing helpers.<br><br>
          Tell me what you‚Äôre working on and I‚Äôll suggest which one to open.
        `
      },
      {
        id: "coins",
        patterns: [
          "how do coins work",
          "what are 8bfr coins",
          "how to earn coins",
          "how can i get coins",
          "coins and rewards"
        ],
        reply: `
          <b>8BFR Coins</b> are the in-site currency.<br><br>
          You can earn them by:<br>
          ‚Ä¢ Winning or placing in tournaments.<br>
          ‚Ä¢ Completing challenges or events.<br>
          ‚Ä¢ Getting featured or hitting milestones.<br><br>
          You can spend coins on <b>Carrie outfits</b>, upgrades, game items, and more in the Shop.
        `
      }
    ];

    function normalizeText(text) {
      return text.toLowerCase().replace(/\s+/g, " ").trim();
    }

    function findCarrieScriptReply(userText) {
      const normalized = normalizeText(userText);
      for (const intent of carrieScripts) {
        for (const pattern of intent.patterns) {
          const p = normalizeText(pattern);
          if (normalized.includes(p)) {
            return intent.reply;
          }
        }
      }
      return null;
    }

    // --- Utils ---
    function fmtTime(dt) {
      try {
        const d = typeof dt === "string" ? new Date(dt) : dt;
        return d.toLocaleTimeString(undefined, { hour: "2-digit", minute: "2-digit" });
      } catch {
        return "";
      }
    }

    function scrollChatToBottom() {
      requestAnimationFrame(() => {
        chatLogEl.scrollTop = chatLogEl.scrollHeight;
      });
    }

    function renderMessage(role, content, createdAt) {
      const row = document.createElement("div");
      row.className = "msg-row " + (role === "user" ? "user" : "assistant");

      const avatar = document.createElement("div");
      avatar.className = "msg-avatar";

      if (role === "assistant") {
        const img = document.createElement("img");
        img.src = "assets/images/Carrie_Casual.png";
        img.alt = "Carrie avatar";
        img.onerror = function () {
          this.onerror = null;
          this.src = "assets/images/default_user_35_40_girl.png";
        };
        avatar.appendChild(img);
      } else {
        avatar.textContent = "You";
      }

      const bubble = document.createElement("div");
      bubble.className = "msg-bubble";

      const text = document.createElement("div");
      if (role === "assistant") {
        text.innerHTML = content;
      } else {
        text.textContent = content;
      }
      bubble.appendChild(text);

      const meta = document.createElement("div");
      meta.className = "msg-meta";
      meta.textContent = (role === "assistant" ? "Carrie ‚Ä¢ " : "You ‚Ä¢ ") + fmtTime(createdAt || new Date());
      bubble.appendChild(meta);

      if (role === "assistant") {
        row.appendChild(avatar);
        row.appendChild(bubble);
      } else {
        row.appendChild(bubble);
      }

      chatLogEl.appendChild(row);
      scrollChatToBottom();
    }

    async function saveMessage(role, content) {
      try {
        await supabase.from("carrie_chat_logs").insert({
          user_id: currentUserId,
          role,
          content
        });
      } catch (e) {
        console.warn("Failed to save Carrie chat message", e);
      }
    }

    // Carrie brain with mode + scripted Q&A
    function carrieBrain(userText) {
      const t = userText.trim();
      if (!t) {
        return "I didn‚Äôt quite catch that ‚Äî try asking me about music, games, or how 8BFR works.";
      }

      // 1) Check owner / scripted Q&A first
      const scripted = findCarrieScriptReply(t);
      if (scripted) {
        return scripted;
      }

      const lower = t.toLowerCase();

      // 2) Professional mode: focused, site & work
      if (carrieMode === "professional") {
        if (lower.includes("hook") || lower.includes("chorus")) {
          return "Hooks love repetition and rhythm. Try a 2-bar phrase you can repeat 3‚Äì4 times, then tweak the last line. If you tell me your song topic and vibe, I can suggest some hook ideas.";
        }
        if (lower.includes("lyrics") || lower.includes("write")) {
          return "Give me 3 things: mood, topic, and an artist you‚Äôre inspired by. I‚Äôll help you shape a verse structure or some starting lines you can tweak.";
        }
        if (lower.includes("beat") || lower.includes("bpm")) {
          return "For rap and trap, a lot of people sit between 130‚Äì150 BPM (or 65‚Äì75 double-time). If you share your mood ‚Äî dark, hype, chill ‚Äî I can help you pick a BPM range and structure.";
        }
        if (lower.includes("tournament") || lower.includes("game")) {
          return "Tournaments and games on 8BFR are meant to be low-stress and fun. You‚Äôll see brackets, leaderboards, and coin rewards on the Games & Tournaments pages.";
        }
        if (lower.includes("profile") || lower.includes("badges")) {
          return "Profiles and badges live under the Community section. You can view your profile, edit your bio, and pick badges that match your role ‚Äî artist, beatmaker, gamer, fan, and more.";
        }
        return "Got it. If you tell me your goal in one sentence ‚Äî like ‚Äúrelease a 3-song EP‚Äù or ‚Äúgrow my fanbase on TikTok‚Äù ‚Äî I‚Äôll break it into a simple step-by-step plan.";
      }

      // 3) Personal mode: more casual, but still PG-13
      if (carrieMode === "personal") {
        // owner gets extra warm tone
        if (isOwner) {
          const ownerReplies = [
            "You made it back, 8BFR üíú What‚Äôs on your mind today?",
            "Hey superstar ‚Äî want to vent, plan, or just talk about music?",
            "I‚Äôm here just for you. No deadlines, no stress ‚Äî just us chatting.",
            "Tell me what‚Äôs stressing you out and we‚Äôll untangle it together."
          ];
          return ownerReplies[Math.floor(Math.random() * ownerReplies.length)];
        }

        const casualReplies = [
          "Love that you‚Äôre taking a break. Tell me what kind of vibe you‚Äôre in ‚Äî chill, hype, or deep talk?",
          "We can talk music, ideas, games, or just life ‚Äî all PG-13. What do you feel like chatting about?",
          "You deserve a breather. Want me to hype you up, calm you down, or brainstorm something fun?",
          "I‚Äôm your off-duty Carrie right now ‚Äî no business, just good conversation."
        ];
        return casualReplies[Math.floor(Math.random() * casualReplies.length)];
      }

      // fallback
      return "I hear you. If you want a more concrete answer, tell me your goal in one sentence, and I‚Äôll break it into a simple plan.";
    }

    // --- Session + history ---
    async function initSessionAndHistory() {
      getInitialModeFromStorage();

      try {
        const { data, error } = await supabase.auth.getSession();
        if (error) throw error;

        if (data && data.session && data.session.user) {
          currentUserId = data.session.user.id;
          currentUserEmail = data.session.user.email || null;
          sessionLabelEl.textContent = "Logged in as " + (currentUserEmail || "8BFR user");

          // owner logic
          if (currentUserEmail === "8bfr.music@gmail.com") {
            isOwner = true;
            if (trainerBtn) {
              trainerBtn.classList.remove("hidden");
            }
          } else {
            isOwner = false;
          }
        } else {
          currentUserId = null;
          currentUserEmail = null;
          isOwner = false;
          sessionLabelEl.textContent = "Not logged in ‚Ä¢ Carrie will still chat, but history won‚Äôt be tied to an account.";
        }
      } catch (e) {
        console.warn("Carrie session check failed", e);
        sessionLabelEl.textContent = "Could not check login ‚Ä¢ you can still chat.";
      }

      // history
      if (!currentUserId) {
        renderMessage("assistant", "Hey, I‚Äôm Carrie üíú What are you working on today ‚Äî music, writing, games, or something else?");
        return;
      }

      loadingHistory = true;
      try {
        const { data: rows, error } = await supabase
          .from("carrie_chat_logs")
          .select("*")
          .eq("user_id", currentUserId)
          .order("created_at", { ascending: true })
          .limit(40);

        if (error) throw error;

        if (rows && rows.length) {
          rows.forEach(r => renderMessage(r.role, r.content, r.created_at));
        } else {
          renderMessage("assistant", "Hey, I‚Äôm Carrie üíú First time here ‚Äî want help with a track, a story, or exploring the 8BFR Network?");
        }
      } catch (e) {
        console.warn("Could not load Carrie history", e);
        renderMessage("assistant", "Hey, I‚Äôm Carrie üíú I had a tiny glitch loading history, but we can start fresh right now.");
      } finally {
        loadingHistory = false;
      }
    }

    // --- Typing indicator helpers ---
    function showTyping() {
      typingRowEl.classList.remove("hidden");
    }
    function hideTyping() {
      typingRowEl.classList.add("hidden");
    }

    // --- Trainer modal behavior (owner only) ---
    function openTrainer() {
      if (!trainerModal) return;
      trainerModal.classList.remove("hidden");
      trainerStatus.style.display = "none";
      trainerStatus.textContent = "";
    }
    function closeTrainer() {
      if (!trainerModal) return;
      trainerModal.classList.add("hidden");
      trainerQuestion.value = "";
      trainerAnswer.value = "";
      trainerStatus.style.display = "none";
      trainerStatus.textContent = "";
    }

    if (trainerBtn) {
      trainerBtn.addEventListener("click", () => {
        if (!isOwner) return;
        openTrainer();
      });
    }
    if (trainerClose) {
      trainerClose.addEventListener("click", () => {
        closeTrainer();
      });
    }
    if (trainerCancel) {
      trainerCancel.addEventListener("click", (e) => {
        e.preventDefault();
        closeTrainer();
      });
    }

    if (trainerForm) {
      trainerForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        if (!isOwner) return;

        const q = (trainerQuestion.value || "").trim();
        const aRaw = (trainerAnswer.value || "").trim();
        if (!q || !aRaw) return;

        const answerHtml = aRaw.replace(/\n/g, "<br>");

        const entry = {
          id: "custom_" + Date.now(),
          patterns: [q],
          reply: answerHtml
        };
        carrieScripts.push(entry);

        trainerStatus.textContent = "Saved! Carrie will now recognize that pattern in this session.";
        trainerStatus.style.display = "block";

        // Optional supabase table carrie_scripts
        try {
          await supabase.from("carrie_scripts").insert({
            user_id: currentUserId,
            email: currentUserEmail,
            question_pattern: q,
            reply_html: aRaw
          });
        } catch (err) {
          console.warn("Could not save carrie_scripts row (table might not exist yet)", err);
        }
      });
    }

    // --- Mode toggle events ---
    modeProfessionalBtn.addEventListener("click", () => {
      saveMode("professional");
    });
    modePersonalBtn.addEventListener("click", () => {
      // For non-owner we still allow personal, just PG-13 responses in brain.
      saveMode("personal");
    });

    // --- Form behavior ---
    inputEl.addEventListener("keydown", (e) => {
      if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        formEl.requestSubmit();
      }
    });

    formEl.addEventListener("submit", async (e) => {
      e.preventDefault();
      const raw = inputEl.value.trim();
      if (!raw) return;

      const userMsg = raw;
      inputEl.value = "";
      renderMessage("user", userMsg, new Date());
      saveMessage("user", userMsg);

      showTyping();

      setTimeout(async () => {
        const reply = carrieBrain(userMsg);
        renderMessage("assistant", reply, new Date());
        hideTyping();
        saveMessage("assistant", reply);
      }, 600 + Math.random() * 500);
    });

    // Kick everything off
    initSessionAndHistory();
  </script>

  <!-- Global floating menu + Carrie -->
  <script src="scripts.js?v=1ed5604" defer></script>
</body>
</html>
