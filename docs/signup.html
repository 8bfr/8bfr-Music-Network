<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Sign up - 8BFR Music Network</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body { background:#0a0a0a;color:#fff;font-family:Inter,system-ui; padding:1rem; }
    .card{max-width:760px;margin:0 auto;background:#111;padding:1.5rem;border-radius:8px;border:1px solid #222;}
    label{display:block;margin:.5rem 0;color:#ccc;font-weight:600;}
    input, textarea, select{width:100%;padding:.6rem;border-radius:6px;border:1px solid #333;background:#070707;color:#fff}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:1rem}
    .btn{background:#ff0066;color:#fff;padding:.8rem 1rem;border:none;border-radius:6px;cursor:pointer;margin-top:1rem;width:100%;font-weight:600;}
    .btn:disabled{background:#666;cursor:not-allowed;}
    .muted{color:#999;font-size:.9rem}
    .error{color:#ff4444;background:rgba(255,68,68,0.1);padding:.5rem;border-radius:4px;margin:.5rem 0;}
    .success{color:#44ff88;background:rgba(68,255,136,0.1);padding:.5rem;border-radius:4px;margin:.5rem 0;}
    .badge-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(150px,1fr));gap:.5rem;max-height:200px;overflow-y:auto;padding:.5rem;background:#0a0a0a;border-radius:4px;margin-top:.5rem;}
    .badge-item{display:flex;align-items:center;gap:.5rem;}
    .badge-item input{width:auto;}
  </style>
</head>
<body>
  <div class="card">
    <h2>Create Account - 8BFR Music Network</h2>
    <p class="muted">Fill out the form below to create your account. All fields marked with * are required.</p>

    <div class="form">
      <label>Email *</label>
      <input id="email" type="email" required placeholder="your.email@example.com" />

      <label>Password * (min 6 characters)</label>
      <input id="password" type="password" required minlength="6" placeholder="Enter secure password" />

      <label>Username * (unique, no spaces)</label>
      <input id="username" type="text" required placeholder="yourusername" />

      <label>Display Name</label>
      <input id="display_name" type="text" placeholder="Your Display Name" />

      <label>Bio</label>
      <textarea id="bio" rows="3" placeholder="Tell us about yourself..."></textarea>

      <label>Primary Role *</label>
      <select id="role">
        <option value="fan">Fan</option>
        <option value="artist">Artist</option>
        <option value="beatmaker">Beatmaker</option>
        <option value="producer">Producer</option>
        <option value="singer">Singer</option>
        <option value="musician">Musician</option>
        <option value="engineer">Engineer</option>
        <option value="songwriter">Songwriter</option>
        <option value="dj">DJ</option>
        <option value="label">Label</option>
        <option value="promoter">Promoter</option>
        <option value="videographer">Videographer</option>
        <option value="photographer">Photographer</option>
        <option value="filmmaker">Filmmaker</option>
        <option value="podcaster">Podcaster</option>
        <option value="distributor">Distributor</option>
        <option value="rapper">Rapper</option>
        <option value="designer">Designer</option>
        <option value="author">Author</option>
        <option value="blogger">Blogger</option>
        <option value="game_creator">Game Creator</option>
        <option value="developer">Developer</option>
        <option value="streamer">Streamer</option>
        <option value="gamer">Gamer</option>
        <option value="influencer">Influencer</option>
        <option value="brand_ambassador">Brand Ambassador</option>
        <option value="community_leader">Community Leader</option>
        <option value="parent">Parent</option>
        <option value="student">Student</option>
        <option value="educator">Educator</option>
        <option value="supporter">Supporter</option>
        <option value="collector">Collector</option>
        <option value="mentor">Mentor</option>
        <option value="kids">Kids</option>
        <option value="mod">Moderator</option>
        <option value="admin">Admin</option>
        <option value="owner">Owner</option>
      </select>

      <div id="verificationSection" style="display:none;margin-top:1rem;">
        <label>Verification Link (Required for Artist/Beatmaker/Producer)</label>
        <input id="verification_link" type="url" placeholder="https://spotify.com/artist/... or similar proof" />
        <p class="muted">Provide a link to verify your professional status (Spotify, SoundCloud, etc)</p>
      </div>

      <label>Badges (optional - select all that apply)</label>
      <div class="badge-grid" id="badgeContainer">
        <!-- Badges will be added here by JavaScript -->
      </div>

      <div id="message"></div>

      <button id="signupBtn" class="btn">Create Account</button>
      
      <p class="muted" style="text-align:center;margin-top:1rem;">
        Already have an account? <a href="login.html" style="color:#ff0066;">Login here</a>
      </p>
    </div>
  </div>

  <script>
    const SUPABASE_URL = 'https://novbuvwpjnxwwvdekjhr.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5vdmJ1dndwam54d3d2ZGVramhyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjExODkxODUsImV4cCI6MjA3Njc2NTE4NX0.1UUkdGafh6ZplAX8hi7Bvj94D2gvFQZUl0an1RvcSA0';

    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // All available badges - COMPLETE LIST
    const allBadges = [
      'artist','beatmaker','producer','singer','musician','engineer','songwriter','dj',
      'label','promoter','videographer','photographer','filmmaker','podcaster','distributor',
      'rapper','designer','author','blogger','game_creator','developer','streamer','gamer',
      'influencer','brand_ambassador','community_leader','fan','parent','student','educator',
      'supporter','collector','mentor','kids','8bfrfan','fyp','g7','mod','admin','owner',
      'donor','sponsor','contest_winner','tournament_champion','event_participant',
      'early_supporter','top_creator','trending','vip_member','beta_tester','founder','verified',
      'carrie_ai_assistant','carrie_performer','carrie_concert_vip','carrie_fashionista','carrie_voice_clone'
    ];

    // Render badge checkboxes
    const badgeContainer = document.getElementById('badgeContainer');
    allBadges.forEach(badge => {
      const div = document.createElement('div');
      div.className = 'badge-item';
      div.innerHTML = `
        <input type="checkbox" id="badge_${badge}" value="${badge}">
        <label for="badge_${badge}" style="margin:0;cursor:pointer;font-size:.85rem;">${badge}</label>
      `;
      badgeContainer.appendChild(div);
    });

    // Show verification section for certain roles
    const roleSelect = document.getElementById('role');
    const verificationSection = document.getElementById('verificationSection');
    
    roleSelect.addEventListener('change', () => {
      const needsVerification = ['artist', 'beatmaker', 'producer', 'singer', 'musician', 'engineer', 'songwriter', 'dj', 'rapper'];
      if (needsVerification.includes(roleSelect.value)) {
        verificationSection.style.display = 'block';
      } else {
        verificationSection.style.display = 'none';
      }
    });

    // Signup function
    document.getElementById('signupBtn').addEventListener('click', async () => {
      alert('Button clicked! Starting signup process...');
      
      const email = document.getElementById('email').value.trim();
      const password = document.getElementById('password').value;
      const username = document.getElementById('username').value.trim();
      const display_name = document.getElementById('display_name').value.trim();
      const bio = document.getElementById('bio').value.trim();
      const role = document.getElementById('role').value;
      const verification_link = document.getElementById('verification_link').value.trim();

      const messageEl = document.getElementById('message');
      const signupBtn = document.getElementById('signupBtn');
      
      messageEl.innerHTML = '';

      // Validation
      if (!email || !password || !username) {
        messageEl.innerHTML = '<div class="error">Email, password, and username are required.</div>';
        return;
      }

      if (password.length < 6) {
        messageEl.innerHTML = '<div class="error">Password must be at least 6 characters.</div>';
        return;
      }

      if (username.includes(' ')) {
        messageEl.innerHTML = '<div class="error">Username cannot contain spaces.</div>';
        return;
      }

      const needsVerification = ['artist', 'beatmaker', 'producer', 'singer', 'musician', 'engineer', 'songwriter', 'dj', 'rapper'];
      if (needsVerification.includes(role) && !verification_link) {
        messageEl.innerHTML = '<div class="error">Verification link is required for ' + role + ' role.</div>';
        return;
      }

      // Get selected badges
      const selectedBadges = [];
      document.querySelectorAll('#badgeContainer input:checked').forEach(cb => {
        selectedBadges.push(cb.value);
      });

      signupBtn.disabled = true;
      signupBtn.textContent = 'Creating account...';
      messageEl.innerHTML = '<div class="muted">Creating your account...</div>';

      try {
        // 1. Sign up user
        const { data: signUpData, error: signUpError } = await supabase.auth.signUp({
          email: email,
          password: password,
          options: {
            data: {
              username: username
            }
          }
        });

        if (signUpError) {
          throw new Error('Signup error: ' + signUpError.message);
        }

        const user = signUpData.user;
        
        if (!user) {
          messageEl.innerHTML = '<div class="success">Account created! Check your email to confirm your account before logging in.</div>';
          signupBtn.textContent = 'Account Created';
          return;
        }

        messageEl.innerHTML = '<div class="muted">Creating profile...</div>';

        // 2. Create profile
        const { error: profileError } = await supabase
          .from('profiles')
          .insert({
            user_id: user.id,
            email: email,
            username: username,
            display_name: display_name || username,
            role: role,
            bio: bio,
            badges: selectedBadges,
            verify_url: verification_link || null,
            verified_artist: false,
            created_at: new Date().toISOString()
          });

        if (profileError) {
          console.error('Profile error:', profileError);
          messageEl.innerHTML = '<div class="error">Account created but profile setup failed: ' + profileError.message + '</div>';
          signupBtn.textContent = 'Profile Error';
          return;
        }

        // 3. Create verification request if needed
        if (needsVerification.includes(role) && verification_link) {
          const { error: vrError } = await supabase
            .from('verification_requests')
            .insert({
              user_id: user.id,
              username: username,
              requested_role: role,
              proof_link: verification_link,
              status: 'pending',
              created_at: new Date().toISOString()
            });

          if (vrError) {
            console.warn('Verification request error:', vrError);
          }
        }

        messageEl.innerHTML = '<div class="success">âœ… Account created successfully! Check your email to confirm your account, then you can log in.</div>';
        signupBtn.textContent = 'Success!';
        
        // Redirect after 2 seconds
        setTimeout(() => {
          window.location.href = 'login.html';
        }, 2000);

      } catch (error) {
        console.error('Signup error:', error);
        messageEl.innerHTML = '<div class="error">' + error.message + '</div>';
        signupBtn.disabled = false;
        signupBtn.textContent = 'Create Account';
      }
    });
  </script>
</body>
</html>
