<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Owner Panel - 8BFR Music Network</title>
  <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Work+Sans:wght@300;400;600;700&display=swap" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    :root{
      --primary:#ff0066; --secondary:#00ccff; --dark:#0a0a0a; --dark-card:#1a1a1a;
      --success:#00ff88; --warning:#ffaa00; --danger:#ff0044; --text:#ffffff; --text-dim:#999999;
      --border:#333333;
    }
    *{box-sizing:border-box;margin:0;padding:0}
    body{font-family:"Work Sans",sans-serif;background:var(--dark);color:var(--text);line-height:1.6}
    .header{background:linear-gradient(135deg,var(--dark-card) 0%,#000 100%);border-bottom:2px solid var(--primary);padding:1.25rem 1.5rem;display:flex;justify-content:space-between;align-items:center;position:sticky;top:0;z-index:100}
    .header h1{font-family:"Bebas Neue",sans-serif;font-size:1.6rem;letter-spacing:1px;color:var(--primary)}
    .user-info{display:flex;align-items:center;gap:.75rem}
    .logout-btn{background:var(--danger);color:#fff;border:0;padding:.45rem .9rem;border-radius:6px;cursor:pointer}
    .container{max-width:1200px;margin:1.25rem auto;padding:0 1rem}
    .tabs{display:flex;gap:.5rem;margin-bottom:1rem;border-bottom:1px solid rgba(255,255,255,0.04);overflow:auto}
    .tab{background:transparent;color:var(--text-dim);border:0;padding:.6rem 1rem;cursor:pointer}
    .tab.active{color:var(--primary);border-bottom:3px solid var(--primary)}
    .tab-content{display:none;padding-top:1rem}
    .tab-content.active{display:block}
    .card{background:var(--dark-card);border:1px solid var(--border);border-radius:8px;padding:1rem;margin-bottom:1rem}
    .grid-2{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:1rem}
    .grid-3{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:1rem}
    .search-box{width:100%;padding:.6rem;border-radius:6px;border:1px solid var(--border);background:transparent;color:inherit}
    .btn{background:var(--primary);color:#fff;border:0;padding:.6rem .9rem;border-radius:6px;cursor:pointer}
    .btn.secondary{background:var(--secondary)}
    .btn.danger{background:var(--danger)}
    .form-group{margin-bottom:.75rem}
    label{display:block;margin-bottom:.25rem;color:var(--text-dim);font-size:.9rem}
    input[type="text"],input[type="email"],input[type="password"],select,textarea{width:100%;padding:.6rem;border-radius:6px;border:1px solid var(--border);background:transparent;color:inherit}
    .item-list{max-height:420px;overflow:auto}
    .item{display:flex;justify-content:space-between;align-items:center;padding:.6rem;border-radius:6px;border:1px solid rgba(255,255,255,0.02);margin-bottom:.5rem}
    .checkbox-group{display:flex;gap:.5rem;align-items:center}
    .pill{padding:.25rem .5rem;border-radius:999px;background:rgba(255,255,255,0.03);font-size:.85rem}
    .muted{color:var(--text-dim);font-size:.9rem}
    pre.codeblock{white-space:pre-wrap;word-break:break-word;background:#0b0b0b;border:1px solid rgba(255,255,255,0.03);padding:.75rem;border-radius:6px;color:#ddd}
  </style>
</head>
<body>
    <div class="header">
    <h1>ðŸ‘‘ OWNER PANEL</h1>
    <div class="user-info">
      <span id="ownerName" class="pill">Loading...</span>
      <button class="logout-btn" id="logoutBtn">Logout</button>
    </div>
  </div>

  <div class="container">
    <div class="tabs" role="tablist" aria-label="Owner tabs">
      <button class="tab active" data-tab="dashboard">Dashboard</button>
      <button class="tab" data-tab="verification">Verification</button>
      <button class="tab" data-tab="content">Content</button>
      <button class="tab" data-tab="users">Users</button>
      <button class="tab" data-tab="ads">Ads</button>
      <button class="tab" data-tab="moderation">Moderation</button>
      <button class="tab" data-tab="community">Community</button>
      <button class="tab" data-tab="system">System</button>
    </div>

    <section id="dashboard" class="tab-content active">
      <div class="grid-3">
        <div class="card"><h3 class="muted">Total Users</h3><div id="totalUsers" class="pill">0</div></div>
        <div class="card"><h3 class="muted">Total Posts</h3><div id="totalPosts" class="pill">0</div></div>
        <div class="card"><h3 class="muted">Active Ads</h3><div id="activeAds" class="pill">0</div></div>
      </div>

      <div class="card" style="margin-top:1rem">
        <h3>Quick Actions</h3>
        <div style="display:flex;gap:.5rem;flex-wrap:wrap;margin-top:.5rem">
          <button class="btn" data-goto="verification">Verifications</button>
          <button class="btn" data-goto="users">Manage Users</button>
          <button class="btn secondary" data-goto="content">Content</button>
          <button class="btn danger" data-goto="moderation">Moderation</button>
        </div>
      </div>
    </section>
    <section id="verification" class="tab-content">
      <div class="card">
        <h3>Verification Requests</h3>
        <div class="form-group">
          <label for="verificationFilter">Filter</label>
          <select id="verificationFilter" class="search-box">
            <option value="pending">Pending</option>
            <option value="approved">Approved</option>
            <option value="denied">Denied</option>
            <option value="all">All</option>
          </select>
        </div>
        <div class="item-list" id="verificationRequestsList"><div class="muted">Loading...</div></div>
      </div>

      <div class="card" id="verificationReviewSection" style="display:none">
        <h3>Review Request</h3>
        <div class="grid-2">
          <div>
            <div class="form-group"><label>Username</label><input id="reviewUsername" readonly></div>
            <div class="form-group"><label>Requested Role</label><input id="reviewRole" readonly></div>
            <div class="form-group"><label>Proof Link</label><input id="reviewLink" readonly></div>
          </div>
          <div id="userProfileInfo" class="muted"></div>
        </div>
        <div class="form-group"><label>Notes</label><textarea id="verificationNotes"></textarea></div>
        <div style="display:flex;gap:.5rem">
          <button class="btn" id="approvalBtn">Approve</button>
          <button class="btn danger" id="denyBtn">Deny</button>
          <button class="btn secondary" id="cancelReviewBtn">Cancel</button>
        </div>
      </div>
    </section>

    <section id="content" class="tab-content">
      <div class="card">
        <h3>Content Management</h3>
        <input id="contentSearch" class="search-box" placeholder="Search posts or comments">
        <div class="grid-2" style="margin-top:.75rem">
          <div>
            <h4>Posts</h4>
            <div class="item-list" id="postsList"></div>
          </div>
          <div>
            <h4>Comments</h4>
            <div class="item-list" id="commentsList"></div>
          </div>
        </div>
      </div>
    </section>
    <section id="users" class="tab-content">
      <div class="card">
        <h3>User Management</h3>
        <input id="userSearch" class="search-box" placeholder="Search users by username or email">
        <div class="item-list" id="usersList" style="margin-top:.5rem"></div>
      </div>

      <div class="card">
        <h3>Edit / Create User</h3>
        <div class="grid-2">
          <div>
            <div class="form-group"><label>Select user</label>
              <select id="selectedUser"><option value="">-- new user --</option></select>
            </div>

            <div class="form-group"><label>Email</label><input id="editEmail" type="email" /></div>
            <div class="form-group"><label>Username</label><input id="editUsername" type="text" /></div>
            <div class="form-group"><label>Display name</label><input id="editDisplayName" type="text" /></div>
            <div class="form-group"><label>Role</label>
              <select id="editRole"><option value="fan">fan</option><option value="member">member</option><option value="admin">admin</option><option value="owner">owner</option></select>
            </div>

            <div style="margin-top:.5rem;display:flex;gap:.5rem;flex-wrap:wrap">
              <button class="btn" id="saveProfileBtn">Save Profile</button>
              <button class="btn secondary" id="createUserBtn">Create User (admin)</button>
            </div>
          </div>

          <div>
            <h4>Security / Password</h4>
            <div class="form-group"><label>Set temporary password (admin)</label><input id="tempPassword" type="password" placeholder="New temporary password"></div>
            <div style="display:flex;gap:.5rem">
              <button class="btn" id="changePasswordBtn">Change Password (admin)</button>
              <button class="btn danger" id="revokeSessionsBtn">Revoke Sessions</button>
            </div>

            <hr style="margin:.75rem 0;border:none;border-top:1px solid rgba(255,255,255,0.03)">

            <h4>Badges / Roles</h4>
            <div id="badgeContainer" style="max-height:220px;overflow:auto;padding:.5rem;border:1px solid rgba(255,255,255,0.02);border-radius:6px">
              <!-- checkboxes rendered by JS -->
            </div>

            <div style="margin-top:.5rem;display:flex;gap:.5rem">
              <button class="btn" id="saveTagsBtn">Save Roles/Badges</button>
              <button class="btn warning" id="clearSelectionBtn">Clear</button>
            </div>
          </div>
        </div>
      </div>
    </section>
   <section id="ads" class="tab-content">
      <div class="card"><h3>Ads</h3><div class="item-list" id="allAdsList"></div></div>
    </section>

    <section id="moderation" class="tab-content">
      <div class="card"><h3>Reports</h3><div class="item-list" id="reportsList"></div></div>
      <div class="card"><h3>Ban Management</h3>
        <div class="form-group"><label>User ID</label><input id="banUserId"></div>
        <div class="form-group"><label>Reason</label><textarea id="banReason"></textarea></div>
        <div style="display:flex;gap:.5rem">
          <button class="btn danger" id="banBtn">Ban</button>
          <button class="btn" id="unbanBtn">Unban</button>
        </div>
      </div>
    </section>

    <section id="community" class="tab-content">
      <div class="card"><h3>Groups</h3><div class="item-list" id="groupsList"></div></div>
    </section>

    <section id="system" class="tab-content">
      <div class="card"><h3>Banned Words</h3>
        <div style="display:flex;gap:.5rem">
          <input id="bannedWordInput" class="search-box" placeholder="Add banned word">
          <button class="btn" id="addBannedWordBtn">Add</button>
        </div>
        <div class="item-list" id="bannedWordsList" style="margin-top:.5rem"></div>
      </div>
    </section>
  </div>

  <!-- Admin endpoints base (edit to your admin API base) -->
  <script>
    const ADMIN_ENDPOINT_BASE = ''; // e.g. https://api.example.com/admin
    function adminUrl(path){ return (ADMIN_ENDPOINT_BASE || '') + path; }
  </script>
   <script>
    // Do NOT put a service_role key here. This client should use anon key only.
    const SUPABASE_URL = window.SUPABASE_URL || 'https://novbuvwpjnxwwvdekjhr.supabase.co';
    const SUPABASE_ANON_KEY = window.SUPABASE_ANON_KEY || ''; // set as global before loading or inject via server-rendered page
    if (!SUPABASE_ANON_KEY) console.warn('No anon key provided. Set window.SUPABASE_ANON_KEY before loading this file.');

    const supabase = supabaseJs.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, { global: { fetch } });

    let currentUser = null;
    const badgeList = [
      'artist','beatmaker','producer','singer','musician','engineer','songwriter','dj','label','promoter',
      'videographer','photographer','filmmaker','podcaster','distributor','rapper','designer',
      'author','blogger','game_creator','developer','streamer','gamer',
      'influencer','brand_ambassador','community_leader','fan','parent','student','educator','supporter','collector','mentor','kids',
      '8bfrfan','fyp','g7','mod','admin','owner',
      'donor','sponsor','contest_winner','tournament_champion','event_participant','early_supporter','top_creator','trending','vip_member','beta_tester','founder','verified',
      'carrie_ai_assistant','carrie_performer','carrie_concert_vip','carrie_fashionista','carrie_voice_clone'
    ];

    // Tab handling
    document.querySelectorAll('.tab').forEach(btn=>{
      btn.addEventListener('click', (e)=>{
        document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c=>c.classList.remove('active'));
        btn.classList.add('active');
        const name = btn.getAttribute('data-tab') || btn.dataset.tab;
        const target = document.getElementById(name);
        if (target) target.classList.add('active');

        // lazy-load actions
        if (name === 'verification') loadVerificationRequests();
        if (name === 'content') { loadPosts(); loadComments(); }
        if (name === 'users') loadUsers();
        if (name === 'ads') loadAds();
        if (name === 'moderation') { loadReports(); loadBans(); }
        if (name === 'community') loadGroups();
        if (name === 'system') { loadBannedWords(); refreshStats(); }
      });
    });

    // quick action goto
    document.querySelectorAll('[data-goto]').forEach(b=>{
      b.addEventListener('click', ()=> {
        const name = b.dataset.goto;
        document.querySelector(`.tab[data-tab="${name}"]`)?.click();
      });
    });

    // Init on DOM ready
    async function init(){
  try {
    const { data: { session } } = await supabase.auth.getSession();
    if (!session){
      window.location.href = '/login.html';
      return;
    }
    const { data: { user } } = await supabase.auth.getUser();
    currentUser = user;
    
    // Load profile with roles_ordered
    const { data: profile, error: profileErr } = await supabase.from('profiles').select('user_id,username,role,roles_ordered').eq('user_id', user.id).single();
    
    // Check if owner using roles_ordered array OR old role column
    const isOwner = (profile?.roles_ordered && profile.roles_ordered.includes('owner')) || profile?.role === 'owner';
    
    if (profileErr || !profile || !isOwner){
      alert('Access denied: owner only');
      window.location.href = '/';
      return;
    }
    
    document.getElementById('ownerName').textContent = profile.username || user.email.split('@')[0];
    renderBadgeCheckboxes();
    await loadDashboardStats();
    loadAllData();
  } catch (err){
    console.error(err);
    alert('Init error: ' + (err.message || err));
  }
    }

    document.getElementById('logoutBtn').addEventListener('click', async ()=>{
      await supabase.auth.signOut();
      window.location.href = '/login.html';
    });
       // Verification
    async function loadVerificationRequests(){
      const filter = document.getElementById('verificationFilter').value;
      let q = supabase.from('verification_requests').select('*').order('created_at',{ascending:false});
      if (filter !== 'all') q = q.eq('status', filter);
      const { data: requests } = await q;
      const container = document.getElementById('verificationRequestsList');
      if (!requests || !requests.length){ container.innerHTML = '<div class="muted">No requests</div>'; return; }
      // batch load profiles for display
      const userIds = [...new Set(requests.map(r=>r.user_id))];
      const { data: profiles } = await supabase.from('profiles').select('user_id,username').in('user_id', userIds);
      const map = {}; profiles?.forEach(p=>map[p.user_id]=p);
      container.innerHTML = requests.map(req=>{
        const p = map[req.user_id]||{};
        return `<div class="item"><div><strong>${escapeHtml(p.username||'Unknown')}</strong><div class="muted">${escapeHtml(req.role_requested)} â€¢ ${new Date(req.created_at).toLocaleString()}</div></div><div style="display:flex;gap:.5rem">${req.status==='pending'?`<button class="btn" onclick="reviewVerification('${req.id}')">Review</button>`:''}</div></div>`;
      }).join('');
    }

    function reviewVerification(id){
      return (async ()=>{
        const { data: request } = await supabase.from('verification_requests').select('*').eq('id', id).single();
        const { data: profile } = await supabase.from('profiles').select('*').eq('user_id', request.user_id).single();
        document.getElementById('reviewUsername').value = profile?.username || '';
        document.getElementById('reviewRole').value = request.role_requested;
        document.getElementById('reviewLink').value = request.verification_link || '';
        document.getElementById('userProfileInfo').innerHTML = `<div class="muted">Email: ${escapeHtml(profile?.email||'')}</div><div class="muted">Joined: ${profile?.created_at?new Date(profile.created_at).toLocaleDateString():''}</div>`;
        document.getElementById('verificationReviewSection').style.display = 'block';
        // attach actions
        document.getElementById('approvalBtn').onclick = ()=>approveVerification(request.id, request.user_id);
        document.getElementById('denyBtn').onclick = ()=>denyVerification(request.id);
        document.getElementById('cancelReviewBtn').onclick = ()=>{ document.getElementById('verificationReviewSection').style.display='none' };
      })();
    }

    async function approveVerification(rid, uid){
      if (!confirm('Approve this verification?')) return;
      const { data: profile } = await supabase.from('profiles').select('tags').eq('user_id', uid).single();
      const tags = profile?.tags || [];
      const role = document.getElementById('reviewRole').value;
      if (!tags.includes(role)) tags.push(role);
      if (!tags.includes('verified')) tags.push('verified');
      await supabase.from('verification_requests').update({ status:'approved', reviewed_by: currentUser.id, reviewed_at: new Date().toISOString() }).eq('id', rid);
      await supabase.from('profiles').update({ tags, role, verified_artist: true }).eq('user_id', uid);
      alert('Approved');
      document.getElementById('verificationReviewSection').style.display = 'none';
      loadVerificationRequests();
    }

    async function denyVerification(rid){
      const notes = document.getElementById('verificationNotes').value.trim();
      if (!notes) { alert('Provide denial reason'); return; }
      await supabase.from('verification_requests').update({ status:'denied', reviewed_by: currentUser.id, reviewed_at: new Date().toISOString(), denial_reason: notes }).eq('id', rid);
      alert('Denied');
      document.getElementById('verificationReviewSection').style.display = 'none';
      loadVerificationRequests();
    }

    // Posts & comments
    async function loadPosts(){
      const { data } = await supabase.from('posts').select('*').order('created_at',{ascending:false}).limit(50);
      const el = document.getElementById('postsList');
      el.innerHTML = (data && data.length) ? data.map(p=>`<div class="item"><div>${escapeHtml(p.content?.slice(0,120) || '')}</div><div style="display:flex;gap:.4rem"><button class="btn" onclick="hidePost('${p.id}')">Hide</button><button class="btn danger" onclick="deletePost('${p.id}')">Delete</button></div></div>`).join('') : '<div class="muted">No posts</div>';
    }
    async function loadComments(){
      const { data } = await supabase.from('comments').select('*').order('created_at',{ascending:false}).limit(50);
      const el = document.getElementById('commentsList');
      el.innerHTML = (data && data.length) ? data.map(c=>`<div class="item"><div>${escapeHtml(c.content?.slice(0,120)||'')}</div><div style="display:flex;gap:.4rem"><button class="btn" onclick="hideComment('${c.id}')">Hide</button><button class="btn danger" onclick="deleteComment('${c.id}')">Delete</button></div></div>`).join('') : '<div class="muted">No comments</div>';
    }

    async function hidePost(id){ if(!confirm('Hide post?')) return; await supabase.from('posts').update({ is_hidden:true }).eq('id', id); loadPosts(); }
    async function deletePost(id){ if(!confirm('Delete post permanently?')) return; await supabase.from('posts').delete().eq('id', id); loadPosts(); }
    async function hideComment(id){ if(!confirm('Hide comment?')) return; await supabase.from('comments').update({ is_hidden:true }).eq('id', id); loadComments(); }
    async function deleteComment(id){ if(!confirm('Delete comment permanently?')) return; await supabase.from('comments').delete().eq('id', id); loadComments(); }
       // Users list & edit
    async function loadUsers(){
      const q = document.getElementById('userSearch').value || '';
      let res;
      if (q) res = await supabase.from('profiles').select('*').or(`username.ilike.%${q}%,display_name.ilike.%${q}%,email.ilike.%${q}%`).limit(100);
      else res = await supabase.from('profiles').select('*').order('created_at',{ascending:false}).limit(200);
      const users = res.data || [];
      const list = document.getElementById('usersList');
      list.innerHTML = users.length ? users.map(u=>`<div class="item"><div><strong>${escapeHtml(u.username||u.display_name||u.email||'user')}</strong><div class="muted">${escapeHtml(u.role||'')}</div></div><div style="display:flex;gap:.4rem"><button class="btn" onclick="selectUser('${u.user_id}')">Edit</button><button class="btn danger" onclick="deleteUser('${u.user_id}')">Delete</button></div></div>`).join('') : '<div class="muted">No users</div>';
      // populate dropdown
      const sel = document.getElementById('selectedUser');
      sel.innerHTML = `<option value="">-- new user --</option>` + users.map(u=>`<option value="${u.user_id}">${escapeHtml(u.username||u.display_name||u.email)}</option>`).join('');
    }

    async function selectUser(uid){
      if (!uid){ // new user
        document.getElementById('selectedUser').value='';
        document.getElementById('editEmail').value='';
        document.getElementById('editUsername').value='';
        document.getElementById('editDisplayName').value='';
        document.getElementById('editRole').value='fan';
        clearAllSelections();
        displayCurrentBadges([]);
        return;
      }
      document.getElementById('selectedUser').value = uid;
      const { data: profile } = await supabase.from('profiles').select('*').eq('user_id', uid).single();
      if (!profile) return alert('Profile not found');
      document.getElementById('editEmail').value = profile.email||'';
      document.getElementById('editUsername').value = profile.username||'';
      document.getElementById('editDisplayName').value = profile.display_name||'';
      document.getElementById('editRole').value = profile.role||'fan';
      clearAllSelections();
      const tags = profile.tags || [];
      tags.forEach(t=>{
        const cb = document.querySelector(`input[value="${t}"]`);
        if (cb) cb.checked = true;
      });
      displayCurrentBadges(tags);
    }

    document.getElementById('selectedUser').addEventListener('change', loadUserDetails);
    async function loadUserDetails(){ const uid = document.getElementById('selectedUser').value; await selectUser(uid); }

    document.getElementById('saveProfileBtn').addEventListener('click', async ()=>{
      const uid = document.getElementById('selectedUser').value;
      const email = document.getElementById('editEmail').value.trim();
      const username = document.getElementById('editUsername').value.trim();
      const display_name = document.getElementById('editDisplayName').value.trim();
      const role = document.getElementById('editRole').value;
      if (!username) return alert('Username required');
      if (!uid){
        return alert('To create a new auth user use Create User (admin). Use this to edit profiles only.');
      }
      const { error } = await supabase.from('profiles').update({ email, username, display_name, role }).eq('user_id', uid);
      if (error) return alert('Save failed: '+error.message);
      alert('Profile updated');
      loadUsers();
    });

    // Create user (calls admin endpoint on your server which uses service_role)
    document.getElementById('createUserBtn').addEventListener('click', async ()=>{
      const email = document.getElementById('editEmail').value.trim();
      const username = document.getElementById('editUsername').value.trim();
      const tempPassword = document.getElementById('tempPassword').value.trim();
      if (!email || !tempPassword) return alert('Email and temp password required');
      // call server admin endpoint
      const resp = await fetch(adminUrl('/create-user'), {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ email, password: tempPassword, username })
      });
      if (!resp.ok) {
        const txt = await resp.text();
        return alert('Create failed: ' + resp.status + ' ' + txt);
      }
      alert('Created (server-side). Refreshing list.');
      loadUsers();
    });

    // Change password (admin endpoint)
    document.getElementById('changePasswordBtn').addEventListener('click', async ()=>{
      const uid = document.getElementById('selectedUser').value;
      const newPassword = document.getElementById('tempPassword').value.trim();
      if (!uid || !newPassword) return alert('Select user and provide new password');
      const resp = await fetch(adminUrl('/change-password'), {
        method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ user_id: uid, new_password: newPassword })
      });
      if (!resp.ok) { const txt = await resp.text(); return alert('Password change failed: '+txt); }
      alert('Password changed (server-side).');
    });

    document.getElementById('revokeSessionsBtn').addEventListener('click', async ()=>{
      const uid = document.getElementById('selectedUser').value;
      if (!uid) return alert('Select user first');
      if (!confirm('Revoke all sessions for this user?')) return;
      const resp = await fetch(adminUrl('/revoke-sessions'), { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ user_id: uid })});
      if (!resp.ok) { const txt = await resp.text(); return alert('Failed: '+txt); }
      alert('Sessions revoked');
    });

    async function deleteUser(uid){
      if (!confirm('Delete profile? This does not delete auth user.')) return;
      await supabase.from('profiles').delete().eq('user_id', uid);
      alert('Profile deleted');
      loadUsers();
    }
       // badges UI
    function renderBadgeCheckboxes(){
      const cont = document.getElementById('badgeContainer');
      cont.innerHTML = badgeList.map(b=>`<label class="checkbox-group"><input type="checkbox" value="${b}"> <span style="margin-left:.4rem">${b}</span></label>`).join('');
    }
    function displayCurrentBadges(tags){
      // show as pills under currentBadgesDisplay (reuse same area)
      const container = document.getElementById('currentBadgesDisplay') || null;
      if (!container) return;
      if (!tags || !tags.length) container.innerHTML = '<div class="muted">No badges</div>';
      else container.innerHTML = tags.map(t=>`<span class="pill">${t}</span>`).join(' ');
    }
    function clearAllSelections(){ document.querySelectorAll('#badgeContainer input[type="checkbox"]').forEach(cb=>cb.checked=false); }

    document.getElementById('clearSelectionBtn').addEventListener('click', clearAllSelections);

    document.getElementById('saveTagsBtn').addEventListener('click', async ()=>{
      const uid = document.getElementById('selectedUser').value;
      if (!uid) return alert('Select user');
      const tags = Array.from(document.querySelectorAll('#badgeContainer input:checked')).map(i=>i.value);
      // Decide primary role â€” first role checkbox that is one of the role set, fallback to existing role
      const roleCandidates = ['owner','admin','mod','artist','beatmaker','producer','fan','member'];
      const primary = roleCandidates.find(r=>tags.includes(r)) || 'fan';
      const { error } = await supabase.from('profiles').update({ tags, role: primary }).eq('user_id', uid);
      if (error) return alert('Save failed: '+error.message);
      alert('Tags saved');
      displayCurrentBadges(tags);
      loadUsers();
    });

    async function confirmRemoveAllUserBadges(){
      if (!confirm('Remove all roles/badges from selected user?')) return;
      await removeAllUserBadges();
    }

    async function removeAllUserBadges(){
      const uid = document.getElementById('selectedUser').value;
      if (!uid) return alert('Select user');
      const { error } = await supabase.from('profiles').update({ tags: [], role: 'fan' }).eq('user_id', uid);
      if (error) return alert('Failed: '+error.message);
      clearAllSelections();
      displayCurrentBadges([]);
      alert('All badges removed');
      loadUsers();
    }

    // Ads, reports, groups simple loaders
    async function loadAds(){ const { data } = await supabase.from('ads').select('*').order('created_at',{ascending:false}); document.getElementById('allAdsList').innerHTML = (data||[]).map(a=>`<div class="item"><div><strong>${escapeHtml(a.title||'Untitled')}</strong><div class="muted">${escapeHtml(a.status||'')}</div></div><div><button class="btn danger" onclick="deleteAd('${a.id}')">Delete</button></div></div>`).join('') || '<div class="muted">No ads</div>'; }
    async function deleteAd(id){ if(!confirm('Delete ad?')) return; await supabase.from('ads').delete().eq('id', id); loadAds(); }
    async function loadReports(){ const { data } = await supabase.from('reports').select('*').order('created_at',{ascending:false}); document.getElementById('reportsList').innerHTML = (data||[]).map(r=>`<div class="item"><div><strong>${escapeHtml(r.reason||'Report')}</strong><div class="muted">${escapeHtml(r.status||'')}</div></div><div><button class="btn" onclick="resolveReport('${r.id}')">Resolve</button></div></div>`).join('') || '<div class="muted">No reports</div>'; }
    async function resolveReport(id){ await supabase.from('reports').update({ status:'resolved' }).eq('id', id); loadReports(); }
    async function loadGroups(){ const { data } = await supabase.from('groups').select('*').order('created_at',{ascending:false}); document.getElementById('groupsList').innerHTML = (data||[]).map(g=>`<div class="item"><div><strong>${escapeHtml(g.name)}</strong></div><div><button class="btn danger" onclick="deleteGroup('${g.id}')">Delete</button></div></div>`).join('') || '<div class="muted">No groups</div>'; }
    async function deleteGroup(id){ if(!confirm('Delete group?')) return; await supabase.from('groups').delete().eq('id', id); loadGroups(); }

    // bans
    document.getElementById('banBtn').addEventListener('click', async ()=>{
      const uid = document.getElementById('banUserId').value.trim();
      const reason = document.getElementById('banReason').value.trim();
      if (!uid || !reason) return alert('Fill fields');
      await supabase.from('bans').insert({ user_id: uid, reason, banned_by: currentUser.id });
      alert('User banned');
      loadBans();
    });
    async function loadBans(){ const { data } = await supabase.from('bans').select('*').order('created_at',{ascending:false}); document.getElementById('activeBansList')?.innerHTML = (data||[]).map(b=>`<div class="item"><div><strong>${escapeHtml(b.user_id)}</strong><div class="muted">${escapeHtml(b.reason||'')}</div></div><div><button class="btn" onclick="unbanUser('${b.id}')">Unban</button></div></div>`).join('') || '<div class="muted">No bans</div>'; }
    async function unbanUser(id){ if(!confirm('Unban?')) return; await supabase.from('bans').delete().eq('id', id); loadBans(); }

    // banned words
    document.getElementById('addBannedWordBtn').addEventListener('click', async ()=>{
      const w = document.getElementById('bannedWordInput').value.trim(); if(!w) return;
      await supabase.from('banned_words').insert({ word: w }); document.getElementById('bannedWordInput').value=''; loadBannedWords();
    });
    async function loadBannedWords(){ const { data } = await supabase.from('banned_words').select('*').order('created_at',{ascending:false}); document.getElementById('bannedWordsList').innerHTML = (data||[]).map(d=>`<div class="item"><div>${escapeHtml(d.word)}</div><div><button class="btn danger" onclick="removeBannedWord('${d.id}')">Remove</button></div></div>`).join('') || '<div class="muted">No banned words</div>'; }
    async function removeBannedWord(id){ if(!confirm('Remove word?')) return; await supabase.from('banned_words').delete().eq('id', id); loadBannedWords(); }

    // stats
    async function loadDashboardStats(){
      const [{ count: users },{ count: posts },{ count: ads }] = await Promise.all([
        supabase.from('profiles').select('*',{ count:'exact', head:true }),
        supabase.from('posts').select('*',{ count:'exact', head:true }),
        supabase.from('ads').select('*',{ count:'exact', head:true })
      ]);
      document.getElementById('totalUsers').textContent = users||0;
      document.getElementById('totalPosts').textContent = posts||0;
      document.getElementById('activeAds').textContent = ads||0;
    }

    function loadAllData(){ loadVerificationRequests(); loadUsers(); loadPosts(); loadComments(); loadAds(); loadReports(); loadGroups(); loadBannedWords(); }

    // utilities
    function escapeHtml(s){ if (!s && s !== 0) return ''; return String(s).replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
       // search handlers
    document.getElementById('userSearch').addEventListener('input', () => { loadUsers(); });
    document.getElementById('contentSearch').addEventListener('input', () => { searchContent(); });

    async function searchContent() {
      const q = document.getElementById('contentSearch').value.trim();
      if (!q) { loadPosts(); loadComments(); return; }
      const [{ data: posts }, { data: comments }] = await Promise.all([
        supabase.from('posts').select('*').ilike('content', `%${q}%`).limit(50),
        supabase.from('comments').select('*').ilike('content', `%${q}%`).limit(50),
      ]);
      document.getElementById('postsList').innerHTML = (posts || []).map(p => `<div class="item"><div>${escapeHtml(p.content?.slice(0,120) || '')}</div><div style="display:flex;gap:.4rem"><button class="btn" onclick="hidePost('${p.id}')">Hide</button><button class="btn danger" onclick="deletePost('${p.id}')">Delete</button></div></div>`).join('') || '<div class="muted">No posts</div>';
      document.getElementById('commentsList').innerHTML = (comments || []).map(c => `<div class="item"><div>${escapeHtml(c.content?.slice(0,120) || '')}</div><div style="display:flex;gap:.4rem"><button class="btn" onclick="hideComment('${c.id}')">Hide</button><button class="btn danger" onclick="deleteComment('${c.id}')">Delete</button></div></div>`).join('') || '<div class="muted">No comments</div>';
    }

    // wire buttons that were created earlier
    document.getElementById('saveProfileBtn').addEventListener('click', async (e) => { /* already attached above - safe double attach */ });
    document.getElementById('saveTagsBtn').addEventListener('click', async (e) => { /* already attached above - safe double attach */ });

    // small helper to call admin endpoints with JSON and handle errors
    async function callAdmin(path, body){
      const url = adminUrl(path);
      const res = await fetch(url, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(body || {})
      });
      if (!res.ok) {
        const txt = await res.text().catch(()=>String(res.status));
        throw new Error(txt || `Admin request failed: ${res.status}`);
      }
      return res.json().catch(()=>null);
    }

    // examples for admin calls (not used directly if you prefer fetch inline)
    async function adminCreateUser(payload){ return callAdmin('/create-user', payload); }
    async function adminChangePassword(payload){ return callAdmin('/change-password', payload); }
    async function adminRevokeSessions(payload){ return callAdmin('/revoke-sessions', payload); }

    // final initialization
    (function(){
      // Attach init after small delay to ensure global SUPABASE_ANON_KEY set if used
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', init);
      } else {
        init();
      }
    })();

  </script>

  <!-- End body and html -->
</body>
</html>
