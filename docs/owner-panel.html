<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Owner Panel - 8BFR Music Network</title>
  <style>
    :root{--primary:#ff0066;--secondary:#00ccff;--dark:#0a0a0a;--dark-card:#1a1a1a;--success:#00ff88;--warning:#ffaa00;--danger:#ff0044;--text:#ffffff;--text-dim:#999999;--border:#333333}
    *{box-sizing:border-box;margin:0;padding:0}
    body{font-family:system-ui,sans-serif;background:var(--dark);color:var(--text);line-height:1.6}
    .header{background:linear-gradient(135deg,var(--dark-card) 0%,#000 100%);border-bottom:2px solid var(--primary);padding:1rem 1.5rem;display:flex;justify-content:space-between;align-items:center;position:sticky;top:0;z-index:100}
    .header h1{font-size:1.4rem;letter-spacing:1px;color:var(--primary)}
    .user-info{display:flex;align-items:center;gap:.75rem}
    .logout-btn{background:var(--danger);color:#fff;border:0;padding:.4rem .8rem;border-radius:6px;cursor:pointer}
    .container{max-width:1200px;margin:1rem auto;padding:0 1rem}
    .card{background:var(--dark-card);border:1px solid var(--border);border-radius:8px;padding:1rem;margin-bottom:1rem}
    .card h2{color:var(--primary);margin-bottom:1rem;font-size:1.2rem}
    .form-group{margin-bottom:.75rem}
    label{display:block;margin-bottom:.25rem;color:var(--text-dim);font-size:.9rem}
    input,select,textarea{width:100%;padding:.6rem;border-radius:6px;border:1px solid var(--border);background:var(--dark);color:inherit}
    .btn{background:var(--primary);color:#fff;border:0;padding:.6rem .9rem;border-radius:6px;cursor:pointer;margin:.25rem}
    .btn:disabled{background:#666;cursor:not-allowed}
    .btn.secondary{background:var(--secondary)}
    .btn.danger{background:var(--danger)}
    .btn.success{background:var(--success);color:#000}
    .item-list{max-height:400px;overflow:auto}
    .item{display:flex;justify-content:space-between;align-items:center;padding:.6rem;border-radius:6px;border:1px solid var(--border);margin-bottom:.5rem;background:rgba(255,255,255,0.02)}
    .item-actions{display:flex;gap:.4rem;flex-wrap:wrap}
    .item-actions .btn{padding:.4rem .6rem;font-size:.85rem;margin:0}
    .pill{padding:.25rem .5rem;border-radius:999px;background:rgba(255,255,255,0.03);font-size:.85rem}
    .muted{color:var(--text-dim);font-size:.9rem}
    .error{color:#ff4444;background:rgba(255,68,68,0.1);padding:.5rem;border-radius:4px;margin:.5rem 0}
    .success-msg{color:#44ff88;background:rgba(68,255,136,0.1);padding:.5rem;border-radius:4px;margin:.5rem 0}
    .grid-2{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:1rem}
    .search-box{width:100%;padding:.6rem;border-radius:6px;border:1px solid var(--border);background:var(--dark);color:inherit;margin-bottom:.5rem}
    .tabs{display:flex;gap:.5rem;margin-bottom:1rem;border-bottom:1px solid var(--border);overflow:auto}
    .tab{background:transparent;color:var(--text-dim);border:0;padding:.6rem 1rem;cursor:pointer;border-bottom:3px solid transparent}
    .tab.active{color:var(--primary);border-bottom-color:var(--primary)}
    .tab-content{display:none}
    .tab-content.active{display:block}
  </style>
</head>
<body>
  <div class="header">
    <h1>ðŸ‘‘ OWNER PANEL</h1>
    <div class="user-info">
      <span id="ownerName" class="pill">Loading...</span>
      <button class="logout-btn" onclick="logout()">Logout</button>
    </div>
  </div>

  <div class="container">
    <div class="tabs">
      <button class="tab active" onclick="switchTab('users')">Users</button>
      <button class="tab" onclick="switchTab('create')">Create User</button>
      <button class="tab" onclick="switchTab('dummy')">Create Dummy</button>
    </div>

    <div id="users" class="tab-content active">
      <div class="card">
        <h2>All Users</h2>
        <input type="text" id="userSearch" class="search-box" placeholder="Search users..." oninput="loadUsers()">
        <div class="item-list" id="usersList"><div class="muted">Loading users...</div></div>
      </div>
    </div>

    <div id="create" class="tab-content">
      <div class="card">
        <h2>Create New User Account</h2>
        <p class="muted">User will receive email to confirm and set password</p>
        
        <div class="form-group">
          <label>Email *</label>
          <input type="email" id="newEmail" placeholder="user@example.com">
        </div>
        
        <div class="form-group">
          <label>Username *</label>
          <input type="text" id="newUsername" placeholder="username">
        </div>
        
        <div class="form-group">
          <label>Display Name</label>
          <input type="text" id="newDisplayName" placeholder="Display Name">
        </div>
        
        <div class="form-group">
          <label>Role</label>
          <select id="newRole">
            <option value="fan">Fan</option>
            <option value="artist">Artist</option>
            <option value="beatmaker">Beatmaker</option>
            <option value="producer">Producer</option>
            <option value="mod">Moderator</option>
            <option value="admin">Admin</option>
            <option value="owner">Owner</option>
          </select>
        </div>
        
        <div id="createMessage"></div>
        <button class="btn" onclick="createUser()">Create User & Send Email</button>
      </div>
    </div>

    <div id="dummy" class="tab-content">
      <div class="card">
        <h2>Create Dummy Profile (Testing Only)</h2>
        <p class="muted">Creates profile without auth account - for testing purposes</p>
        
        <div class="form-group">
          <label>Username *</label>
          <input type="text" id="dummyUsername" placeholder="test_user_123">
        </div>
        
        <div class="form-group">
          <label>Display Name</label>
          <input type="text" id="dummyDisplayName" placeholder="Test User">
        </div>
        
        <div class="form-group">
          <label>Role</label>
          <select id="dummyRole">
            <option value="fan">Fan</option>
            <option value="artist">Artist</option>
            <option value="beatmaker">Beatmaker</option>
            <option value="producer">Producer</option>
          </select>
        </div>
        
        <div id="dummyMessage"></div>
        <button class="btn secondary" onclick="createDummy()">Create Dummy Profile</button>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    const SUPABASE_URL = 'https://novbuvwpjnxwwvdekjhr.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5vdmJ1dndwam54d3d2ZGVramhyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjExODkxODUsImV4cCI6MjA3Njc2NTE4NX0.1UUkdGafh6ZplAX8hi7Bvj94D2gvFQZUl0an1RvcSA0';
    
    let supabase;
    let currentUser = null;

    // Check if Supabase loaded
    setTimeout(() => {
      if (typeof window.supabase === 'undefined') {
        document.getElementById('ownerName').textContent = 'Supabase failed to load';
        document.body.innerHTML += '<div style="text-align:center;color:red;padding:2rem;">ERROR: Supabase library did not load. Your browser may be blocking CDN. Try a different browser.</div>';
        return;
      }
      
      init();
    }, 1000);

    async function init() {
      try {
        supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        
        const { data: { session } } = await supabase.auth.getSession();
        if (!session) {
          alert('Not logged in');
          window.location.href = 'login.html';
          return;
        }
        
        const { data: { user } } = await supabase.auth.getUser();
        currentUser = user;
        
        const { data: profile } = await supabase.from('profiles').select('*').eq('user_id', user.id).single();
        
        if (!profile || profile.role !== 'owner') {
          alert('Access Denied: Owner only. Your role: ' + (profile?.role || 'none'));
          window.location.href = 'index.html';
          return;
        }
        
        document.getElementById('ownerName').textContent = profile.username || user.email.split('@')[0];
        loadUsers();
        
      } catch (error) {
        document.getElementById('ownerName').textContent = 'Error: ' + error.message;
      }
    }

    function switchTab(tabName) {
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
      event.target.classList.add('active');
      document.getElementById(tabName).classList.add('active');
    }

    async function loadUsers() {
      const search = document.getElementById('userSearch').value.toLowerCase();
      
      let query = supabase.from('profiles').select('*').order('created_at', { ascending: false }).limit(100);
      
      const { data: users } = await query;
      
      const filtered = search ? users.filter(u => 
        (u.username && u.username.toLowerCase().includes(search)) ||
        (u.email && u.email.toLowerCase().includes(search)) ||
        (u.display_name && u.display_name.toLowerCase().includes(search))
      ) : users;
      
      const list = document.getElementById('usersList');
      
      if (!filtered || filtered.length === 0) {
        list.innerHTML = '<div class="muted">No users found</div>';
        return;
      }
      
      list.innerHTML = filtered.map(u => `
        <div class="item">
          <div>
            <strong>${escapeHtml(u.username || u.display_name || u.email || 'user')}</strong>
            <div class="muted">${escapeHtml(u.email || '')}</div>
            <div class="pill">${escapeHtml(u.role || 'fan')}</div>
          </div>
          <div class="item-actions">
            <button class="btn" onclick="sendPasswordReset('${escapeHtml(u.email)}')">Reset Password</button>
            <button class="btn danger" onclick="deleteUser('${u.user_id}')">Delete</button>
          </div>
        </div>
      `).join('');
    }

    async function sendPasswordReset(email) {
      if (!email) {
        alert('User has no email address');
        return;
      }
      
      if (!confirm(`Send password reset email to ${email}?`)) return;
      
      try {
        const { error } = await supabase.auth.resetPasswordForEmail(email, {
          redirectTo: 'https://8bfr.github.io/8bfr-Music-Network/change-password.html'
        });
        
        if (error) throw error;
        
        alert(`âœ… Password reset email sent to ${email}`);
        
      } catch (error) {
        alert('Error: ' + error.message);
      }
    }

    async function deleteUser(userId) {
      if (!confirm('Delete this user? This cannot be undone!')) return;
      
      try {
        await supabase.from('profiles').delete().eq('user_id', userId);
        alert('User deleted');
        loadUsers();
      } catch (error) {
        alert('Error: ' + error.message);
      }
    }

    async function createUser() {
      const email = document.getElementById('newEmail').value.trim();
      const username = document.getElementById('newUsername').value.trim();
      const displayName = document.getElementById('newDisplayName').value.trim();
      const role = document.getElementById('newRole').value;
      
      const msg = document.getElementById('createMessage');
      
      if (!email || !username) {
        msg.innerHTML = '<div class="error">Email and username are required</div>';
        return;
      }
      
      msg.innerHTML = '<div class="muted">Creating user...</div>';
      
      try {
        // Create auth user - Supabase will send confirmation email automatically
        const { data, error } = await supabase.auth.admin.createUser({
          email: email,
          email_confirm: false // User must confirm via email
        });
        
        if (error) throw error;
        
        // Create profile
        await supabase.from('profiles').insert({
          user_id: data.user.id,
          email: email,
          username: username,
          display_name: displayName || username,
          role: role,
          created_at: new Date().toISOString()
        });
        
        msg.innerHTML = '<div class="success-msg">âœ… User created! Confirmation email sent to ' + email + '</div>';
        
        // Clear form
        document.getElementById('newEmail').value = '';
        document.getElementById('newUsername').value = '';
        document.getElementById('newDisplayName').value = '';
        
        loadUsers();
        
      } catch (error) {
        msg.innerHTML = '<div class="error">Error: ' + error.message + '</div>';
      }
    }

    async function createDummy() {
      const username = document.getElementById('dummyUsername').value.trim();
      const displayName = document.getElementById('dummyDisplayName').value.trim();
      const role = document.getElementById('dummyRole').value;
      
      const msg = document.getElementById('dummyMessage');
      
      if (!username) {
        msg.innerHTML = '<div class="error">Username is required</div>';
        return;
      }
      
      msg.innerHTML = '<div class="muted">Creating dummy profile...</div>';
      
      try {
        // Generate fake user_id for dummy
        const dummyId = 'dummy_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        
        await supabase.from('profiles').insert({
          user_id: dummyId,
          username: username,
          display_name: displayName || username,
          role: role,
          email: null,
          created_at: new Date().toISOString()
        });
        
        msg.innerHTML = '<div class="success-msg">âœ… Dummy profile created: ' + username + '</div>';
        
        // Clear form
        document.getElementById('dummyUsername').value = '';
        document.getElementById('dummyDisplayName').value = '';
        
        loadUsers();
        
      } catch (error) {
        msg.innerHTML = '<div class="error">Error: ' + error.message + '</div>';
      }
    }

    function logout() {
      supabase.auth.signOut().then(() => {
        window.location.href = 'login.html';
      });
    }

    function escapeHtml(text) {
      if (!text) return '';
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
  </script>
</body>
</html>
