<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Chat with Carrie ‚Äî 8BFR Music Network</title>
  <meta name="description" content="Chat with Carrie ‚Äî your AI assistant on the 8BFR Music Network." />
  <link rel="icon" href="assets/images/favicon.png" />
  
  <!-- Load Closet Data First -->
  <script src="carrie-closet-data.js?v=3"></script>
  <script src="carrie-memory.js?v=2"></script>
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Link to external closet CSS -->
  <link rel="stylesheet" href="carrie-closet.css?v=3" />

  <style>
    /* Chat-specific styles */
    body {
      font-family: system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial;
      background:
        radial-gradient(1200px 600px at 10% -10%, rgba(124,58,237,.35), transparent 60%),
        radial-gradient(900px 400px at 110% 10%, rgba(0,217,255,.22), transparent 60%),
        linear-gradient(#0b0014,#000);
      color:#eae6ff;
      min-height:100vh;
      overflow-x:hidden;
    }
    
    header{
      position:relative;
      z-index:5;
      background:rgba(15,0,30,.9);
      border-bottom:1px solid rgba(124,58,237,.5);
    }

    .chat-shell{
      border-radius:18px;
      border:1px solid rgba(124,58,237,.55);
      background:rgba(10,2,26,.95);
      box-shadow:0 16px 40px rgba(0,0,0,.75);
    }
    
    .chat-log{
      height:420px;
      max-height:65vh;
      overflow-y:auto;
      padding:1rem;
      background:
        radial-gradient(circle at 0 0, rgba(124,58,237,.12), transparent 55%),
        radial-gradient(circle at 100% 0, rgba(0,217,255,.10), transparent 55%),
        #020014;
      border-radius:12px;
    }
    
    .msg-row{
      display:flex;
      margin-bottom:.65rem;
      gap:.4rem;
    }
    
    .msg-row.user{
      justify-content:flex-end;
    }
    
    .msg-bubble{
      max-width:80%;
      padding:.55rem .8rem;
      border-radius:.85rem;
      font-size:.9rem;
      line-height:1.35;
      border:1px solid rgba(148,163,255,.55);
      background:rgba(17,24,39,.96);
      box-shadow:0 0 12px rgba(79,70,229,.35);
    }
    
    .msg-row.user .msg-bubble{
      background:linear-gradient(135deg,#7c3aed,#4c1d95);
      border-color:#a855f7;
      box-shadow:0 0 12px rgba(168,85,247,.55);
    }
    
    .msg-meta{
      font-size:.7rem;
      opacity:.7;
      margin-top:.2rem;
    }
    
    .msg-avatar{
      width:32px;
      height:32px;
      border-radius:999px;
      flex-shrink:0;
      overflow:hidden;
      border:1px solid rgba(129,140,248,.9);
      display:grid;
      place-items:center;
      font-size:.75rem;
      background:#020014;
    }
    
    .msg-avatar img{
      width:100%;
      height:100%;
      object-fit:cover;
      display:block;
    }

    .pill-tag{
      display:inline-flex;
      align-items:center;
      gap:.25rem;
      font-size:.7rem;
      border-radius:999px;
      padding:.15rem .55rem;
      border:1px solid rgba(129,140,248,.85);
      background:rgba(15,23,42,.9);
      text-transform:uppercase;
      letter-spacing:.08em;
    }

    .btn{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:.3rem;
      background:#120327;
      border:1px solid rgba(124,58,237,.6);
      color:#eae6ff;
      padding:.55rem .95rem;
      border-radius:.75rem;
      font-size:.9rem;
      text-decoration:none;
      cursor:pointer;
      transition: all .15s ease;
    }
    
    .btn:hover{
      background:#190536;
      transform: translateY(-1px);
    }
    
    .btn-primary{
      background:#7c3aed;
      border-color:#7c3aed;
      color:#fff;
    }
    
    .btn-primary:hover{ 
      filter:brightness(1.1);
    }
    
    .btn-small{
      padding:.3rem .6rem;
      font-size:.75rem;
    }

    textarea#carrieInput{
      resize:none;
      min-height:60px;
      max-height:120px;
      background:rgba(10,2,26,.95);
      border-radius:.75rem;
      border:1px solid rgba(148,163,255,.55);
      padding:.5rem .7rem;
      font-size:.9rem;
      color:#e5e7eb;
      width: 100%;
    }
    
    textarea#carrieInput:focus{
      outline:none;
      box-shadow:0 0 0 2px rgba(129,140,248,.9);
      border-color:rgba(129,140,248,1);
    }
    
    .typing-dot{
      width:6px;
      height:6px;
      border-radius:999px;
      background:#a855f7;
      animation:bounce 1s infinite ease-in-out;
    }
    
    .typing-dot:nth-child(2){ animation-delay:.15s; }
    .typing-dot:nth-child(3){ animation-delay:.3s; }
    
    @keyframes bounce{
      0%,80%,100%{ transform:translateY(0); opacity:.4;}
      40%{ transform:translateY(-4px); opacity:1;}
    }

    .mode-btn{
      padding:.3rem .7rem;
      font-size:.75rem;
      border-radius:999px;
      border:1px solid rgba(124,58,237,.6);
      background:rgba(15,23,42,.85);
      cursor:pointer;
      color:#e5e7eb;
      transition:all .15s ease;
    }
    
    .mode-btn:hover{
      background:rgba(30,64,175,.85);
    }
    
    .mode-btn.active{
      border-color:#a855f7;
      background:linear-gradient(135deg,#7c3aed,#a855f7);
      color:#fff;
      box-shadow:0 0 0 1px rgba(129,140,248,.7),0 0 16px rgba(168,85,247,.65);
    }

    .mode-btn:disabled{
      opacity: 0.4;
      cursor: not-allowed;
      background: rgba(15,23,42,.5);
    }

    .mode-btn:disabled:hover{
      background: rgba(15,23,42,.5);
      transform: none;
    }

    .control-panel{
      background: rgba(15,23,42,.6);
      border: 1px solid rgba(124,58,237,.4);
      border-radius: 12px;
      padding: .75rem;
      margin-bottom: 1rem;
    }

    /* Avatar Section Layout */
    .avatar-items-layout{
      display: grid;
      grid-template-columns: 400px 1fr;
      gap: 1.5rem;
      margin-bottom: 2rem;
    }

    @media (max-width: 968px) {
      .avatar-items-layout{
        grid-template-columns: 1fr;
      }
    }

    /* Mini Preview Frame */
    #miniPreviewFrame {
      width: 100%;
      max-width: 400px;
      border-radius: 18px;
      border: 2px solid rgba(148,163,255,0.55);
      overflow: hidden;
      height: 500px;
      display: flex;
      align-items: center;
      justify-content: center;
      background-image: url("assets/images/closet/dressingroom.png?v=15");
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
      position: relative;
    }

    #miniPreviewInner {
      position: relative;
      width: 100%;
      max-width: 300px;
      height: 100%;
      transform: translateY(20px);
    }

    #miniBaseImg {
      position: absolute;
      inset: 0;
      height: 100%;
      width: auto;
      object-fit: cover;
      display: block;
      z-index: 1;
      left: 50%;
      transform: translateX(-50%);
      filter: drop-shadow(0 0 3px #000);
    }

    #miniOverlayHost {
      position:absolute;
      inset:0;
      pointer-events:none;
      z-index:2;
    }

    #miniOverlayHost img {
      filter: drop-shadow(0 0 2px #000);
    }

    .avatar-controls-box{
      background: rgba(15,23,42,.8);
      border: 1px solid rgba(124,58,237,.4);
      border-radius: 12px;
      padding: 1rem;
      margin-top: 1rem;
    }

    /* Items Panel */
    .items-section{
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }

    .item-category-box{
      background: rgba(15,23,42,.6);
      border: 1px solid rgba(124,58,237,.4);
      border-radius: 12px;
      padding: 1rem;
    }

    .category-header{
      font-size: 0.9rem;
      font-weight: 600;
      color: #a855f7;
      margin-bottom: 0.75rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .mini-items-grid{
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(70px, 1fr));
      gap: 0.5rem;
      max-height: 200px;
      overflow-y: auto;
    }

    .mini-item{
      cursor: pointer;
      background: rgba(30,27,75,.6);
      border: 2px solid rgba(124,58,237,.4);
      border-radius: 8px;
      padding: 0.4rem;
      transition: all .2s ease;
      position: relative;
      text-align: center;
    }

    .mini-item:hover{
      transform: translateY(-2px);
      border-color: #a855f7;
      box-shadow: 0 4px 16px rgba(168,85,247,.4);
    }

    .mini-item.active{
      border-color: #10b981;
      background: rgba(16,185,129,.15);
      box-shadow: 0 0 20px rgba(16,185,129,.3);
    }

    .mini-item.locked{
      opacity: 0.5;
      cursor: not-allowed;
    }

    .mini-item-img{
      width: 100%;
      aspect-ratio: 1;
      background: rgba(0,0,0,.4);
      border-radius: 4px;
      overflow: hidden;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 0.3rem;
      position: relative;
    }

    .mini-item-img img{
      max-width: 100%;
      max-height: 100%;
      object-fit: contain;
    }

    .mini-item-name{
      font-size: 0.6rem;
      color: #e5e7eb;
      font-weight: 500;
      line-height: 1.2;
    }

    .item-badge{
      position: absolute;
      top: 2px;
      right: 2px;
      font-size: 0.5rem;
      padding: 1px 4px;
      border-radius: 3px;
      font-weight: 600;
    }

    .badge-owned{
      background: linear-gradient(135deg, #10b981, #059669);
      color: white;
      box-shadow: 0 2px 6px rgba(16,185,129,.4);
    }

    .badge-active{
      background: linear-gradient(135deg, #10b981, #059669);
      color: white;
      box-shadow: 0 0 10px rgba(16,185,129,.6);
    }

    .lock-icon-mini{
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 24px;
      height: 24px;
      z-index: 10;
      pointer-events: none;
    }

    .item-price-mini{
      font-size: 0.6rem;
      color: #fbbf24;
      font-weight: 600;
      margin-top: 0.2rem;
    }

    /* ========== AVATAR BASE SCALING ========== */
    body[data-gender="female"][data-skin="light"]{
      --base-width: .89;
      --base-height: .99;
    }

    body[data-gender="female"][data-skin="dark"]{
      --base-width: .63;
      --base-height: .96;
    }

    body[data-gender="male"][data-skin="light"]{
      --base-width: 1.00;
      --base-height: 1.00;
    }

    body[data-gender="male"][data-skin="dark"]{
      --base-width: 0.96;
      --base-height: 1.00;
    }

    body[data-skin] #miniBaseImg{
      transform: translateX(-50%) scaleX(var(--base-width, 1)) scaleY(var(--base-height, 1));
    }

    body[data-skin="light"] .layer-overlay{
      --scale-use: var(--scale-light);
      --offset-x-use: var(--offset-x-light);
      --offset-y-use: var(--offset-y-light);
      --rotate-use: var(--rotate-light);
    }

    body[data-skin="dark"] .layer-overlay{
      --scale-use: var(--scale-dark);
      --offset-x-use: var(--offset-x-dark);
      --offset-y-use: var(--offset-y-dark);
      --rotate-use: var(--rotate-dark);
    }

    .layer-overlay {
      position:absolute;
      inset:0;
      width:100%;
      height:100%;
      object-fit:contain;
      pointer-events:none;
      image-rendering:auto;
      --scale: 1;
      --offset-x: 0%;
      --offset-y: 0%;
      --rotate: 0deg;
      --scale-light: var(--scale);
      --offset-x-light: var(--offset-x);
      --offset-y-light: var(--offset-y);
      --rotate-light: var(--rotate);
      --scale-dark: var(--scale);
      --offset-x-dark: var(--offset-x);
      --offset-y-dark: var(--offset-y);
      --rotate-dark: var(--rotate);
      --scale-use: var(--scale);
      --offset-x-use: var(--offset-x);
      --offset-y-use: var(--offset-y);
      --rotate-use: var(--rotate);
      transform: scale(var(--scale-use)) translateX(var(--offset-x-use)) translateY(var(--offset-y-use)) rotate(var(--rotate-use));
    }

    /* ========== FEMALE HAIR ‚Äì STRAIGHT ========== */
    body[data-gender="female"][data-skin="light"] .layer-overlay.item-f_hair_straight_blonde{
      transform-origin:center top; --scale:0.50; --offset-x:0%; --offset-y:-12%;
    }
    body[data-gender="female"][data-skin="dark"] .layer-overlay.item-f_hair_straight_blonde{
      transform-origin:center top; --scale:0.50; --offset-x:0%; --offset-y:-12%;
    }

    body[data-gender="female"][data-skin="light"] .layer-overlay.item-f_hair_straight_brown{
      transform-origin:center top; --scale:0.60; --offset-x:0%; --offset-y:-20%;
    }
    body[data-gender="female"][data-skin="dark"] .layer-overlay.item-f_hair_straight_brown{
      transform-origin:center top; --scale:0.60; --offset-x:0%; --offset-y:-20%;
    }

    body[data-gender="female"][data-skin="light"] .layer-overlay.item-f_hair_straight_copper{
      transform-origin:center top; --scale:0.60; --offset-x:0%; --offset-y:-22%;
    }
    body[data-gender="female"][data-skin="dark"] .layer-overlay.item-f_hair_straight_copper{
      transform-origin:center top; --scale:0.60; --offset-x:0%; --offset-y:-22%;
    }

    body[data-gender="female"][data-skin="light"] .layer-overlay.item-f_hair_straight_ginger{
      transform-origin:center top; --scale:0.60; --offset-x:0%; --offset-y:-20%;
    }
    body[data-gender="female"][data-skin="dark"] .layer-overlay.item-f_hair_straight_ginger{
      transform-origin:center top; --scale:0.60; --offset-x:0%; --offset-y:-20%;
    }

    body[data-gender="female"][data-skin="light"] .layer-overlay.item-f_hair_straight_pastel_blue{
      transform-origin:center top; --scale:0.60; --offset-x:0%; --offset-y:-21%;
    }
    body[data-gender="female"][data-skin="dark"] .layer-overlay.item-f_hair_straight_pastel_blue{
      transform-origin:center top; --scale:0.60; --offset-x:0%; --offset-y:-21%;
    }

    body[data-gender="female"][data-skin="light"] .layer-overlay.item-f_hair_straight_pastel_pink{
      transform-origin:center top; --scale:0.60; --offset-x:0%; --offset-y:-20%;
    }
    body[data-gender="female"][data-skin="dark"] .layer-overlay.item-f_hair_straight_pastel_pink{
      transform-origin:center top; --scale:0.60; --offset-x:0%; --offset-y:-20%;
    }

    body[data-gender="female"][data-skin="light"] .layer-overlay.item-f_hair_straight_pastel_purple{
      transform-origin:center top; --scale:0.60; --offset-x:0%; --offset-y:-20%;
    }
    body[data-gender="female"][data-skin="dark"] .layer-overlay.item-f_hair_straight_pastel_purple{
      transform-origin:center top; --scale:0.60; --offset-x:0%; --offset-y:-20%;
    }

    /* ========== FEMALE HAIR ‚Äì WAVY ========== */
    body[data-gender="female"][data-skin="light"] .layer-overlay.item-f_hair_wavy_blonde{
      transform-origin:center top; --scale:0.60; --offset-x:-1%; --offset-y:-20%;
    }
    body[data-gender="female"][data-skin="dark"] .layer-overlay.item-f_hair_wavy_blonde{
      transform-origin:center top; --scale:0.60; --offset-x:-1%; --offset-y:-20%;
    }

    body[data-gender="female"][data-skin="light"] .layer-overlay.item-f_hair_wavy_brown{
      transform-origin:center top; --scale:0.99; --offset-x:1%; --offset-y:-36%;
    }
    body[data-gender="female"][data-skin="dark"] .layer-overlay.item-f_hair_wavy_brown{
      transform-origin:center top; --scale:0.99; --offset-x:1%; --offset-y:-36%;
    }

    body[data-gender="female"][data-skin="light"] .layer-overlay.item-f_hair_wavy_copper{
      transform-origin:center top; --scale:0.60; --offset-x:-1%; --offset-y:-20%;
    }
    body[data-gender="female"][data-skin="dark"] .layer-overlay.item-f_hair_wavy_copper{
      transform-origin:center top; --scale:0.60; --offset-x:-1%; --offset-y:-20%;
    }

    body[data-gender="female"][data-skin="light"] .layer-overlay.item-f_hair_wavy_ginger{
      transform-origin:center top; --scale:0.60; --offset-x:-1%; --offset-y:-20%;
    }
    body[data-gender="female"][data-skin="dark"] .layer-overlay.item-f_hair_wavy_ginger{
      transform-origin:center top; --scale:0.60; --offset-x:-1%; --offset-y:-20%;
    }

    body[data-gender="female"][data-skin="light"] .layer-overlay.item-f_hair_wavy_pastel_blue{
      transform-origin:center top; --scale:0.60; --offset-x:-1%; --offset-y:-20%;
    }
    body[data-gender="female"][data-skin="dark"] .layer-overlay.item-f_hair_wavy_pastel_blue{
      transform-origin:center top; --scale:0.60; --offset-x:-1%; --offset-y:-20%;
    }

    body[data-gender="female"][data-skin="light"] .layer-overlay.item-f_hair_wavy_pastel_pink{
      transform-origin:center top; --scale:0.60; --offset-x:-1%; --offset-y:-21%;
    }
    body[data-gender="female"][data-skin="dark"] .layer-overlay.item-f_hair_wavy_pastel_pink{
      transform-origin:center top; --scale:0.60; --offset-x:-1%; --offset-y:-21%;
    }

    body[data-gender="female"][data-skin="light"] .layer-overlay.item-f_hair_wavy_pastel_purple{
      transform-origin:center top; --scale:0.60; --offset-x:-1%; --offset-y:-20%;
    }
    body[data-gender="female"][data-skin="dark"] .layer-overlay.item-f_hair_wavy_pastel_purple{
      transform-origin:center top; --scale:0.60; --offset-x:-1%; --offset-y:-20%;
    }

    /* STRAIGHT BLACK HAIR */
    body[data-gender="female"][data-skin="light"] .layer-overlay.item-f_hair_straight_black{
      transform-origin:center top; --scale:0.46; --offset-x:0%; --offset-y:-15%;
    }
    body[data-gender="female"][data-skin="dark"] .layer-overlay.item-f_hair_straight_black{
      transform-origin:center top; --scale:0.38; --offset-x:0%; --offset-y:-15%;
    }

    /* ========== TOPS ========== */
    body[data-gender="female"][data-skin="light"] .layer-overlay.item-u_top_tank{
      transform-origin:center top; --scale:0.75; --offset-x:0%; --offset-y:-12%;
    }
    body[data-gender="female"][data-skin="dark"] .layer-overlay.item-u_top_tank{
      transform-origin:center top; --scale:0.65; --offset-x:0%; --offset-y:-6%;
    }

    body[data-gender="female"][data-skin="light"] .layer-overlay.item-u_top_tee{
      transform-origin:center top; --scale:0.67; --offset-x:-1%; --offset-y:0%;
    }
    body[data-gender="female"][data-skin="dark"] .layer-overlay.item-u_top_tee{
      transform-origin:center top; --scale:0.60; --offset-x:0%; --offset-y:4.8%;
    }

    body[data-gender="female"][data-skin="light"] .layer-overlay.item-f_top_bikini_red{
      transform-origin:center top; --scale:0.37; --offset-x:-1%; --offset-y:38%;
    }
    body[data-gender="female"][data-skin="dark"] .layer-overlay.item-f_top_bikini_red{
      transform-origin:center top; --scale:0.35; --offset-x:0%; --offset-y:41%;
    }

    body[data-gender="male"][data-skin="light"] .layer-overlay.item-u_top_tank{
      transform-origin:center top; --scale:0.85; --offset-x:0%; --offset-y:-15%;
    }
    body[data-gender="male"][data-skin="dark"] .layer-overlay.item-u_top_tank{
      transform-origin:center top; --scale:0.85; --offset-x:0%; --offset-y:-15%;
    }

    body[data-gender="male"][data-skin="light"] .layer-overlay.item-u_top_tee{
      transform-origin:center top; --scale:0.90; --offset-x:0%; --offset-y:-7%;
    }
    body[data-gender="male"][data-skin="dark"] .layer-overlay.item-u_top_tee{
      transform-origin:center top; --scale:0.90; --offset-x:0%; --offset-y:-4%;
    }

    /* ========== BOTTOMS ========== */
    body[data-gender="female"][data-skin="light"] .layer-overlay.item-f_bottom_shorts{
      transform-origin:center top; --scale:.58; --offset-x:-1%; --offset-y:44%;
    }
    body[data-gender="female"][data-skin="dark"] .layer-overlay.item-f_bottom_shorts{
      transform-origin:center top; --scale:.48; --offset-x:-0%; --offset-y:56%;
    }

    body[data-gender="female"][data-skin="light"] .layer-overlay.item-f_bottom_skirt{
      transform-origin:center top; --scale:.60; --offset-x:-0%; --offset-y:30%;
    }
    body[data-gender="female"][data-skin="dark"] .layer-overlay.item-f_bottom_skirt{
      transform-origin:center top; --scale:.55; --offset-x:-0%; --offset-y:36%;
    }

    body[data-gender="female"][data-skin="light"] .layer-overlay.item-f_bottom_bikini_red{
      transform-origin:center top; --scale:.83; --offset-x:-1%; --offset-y:10%;
    }
    body[data-gender="female"][data-skin="dark"] .layer-overlay.item-f_bottom_bikini_red{
      transform-origin:center top; --scale:.75; --offset-x:-0%; --offset-y:16%;
    }

    /* ========== JEWELRY ========== */
    body[data-gender="female"][data-skin="light"] .layer-overlay.item-f_jewel_necklace{
      transform-origin:center top; --scale:.35; --offset-x:0%; --offset-y:07%;
    }
    body[data-gender="female"][data-skin="dark"] .layer-overlay.item-f_jewel_necklace{
      transform-origin:center top; --scale:.35; --offset-x:0%; --offset-y:09%;
    }

    body[data-gender="female"][data-skin="light"] .layer-overlay.item-f_jewel_belly{
      transform-origin:center top; --scale:.15; --offset-x:0%; --offset-y:250%;
    }
    body[data-gender="female"][data-skin="dark"] .layer-overlay.item-f_jewel_belly{
      transform-origin:center top; --scale:.15; --offset-x:0%; --offset-y:250%;
    }

    body[data-gender="female"][data-skin="light"] .layer-overlay.item-f_jewel_ears.layer-left{
      transform-origin:center top; --scale:0.20; --offset-x: -46%; --offset-y: 29%;
    }
    body[data-gender="female"][data-skin="light"] .layer-overlay.item-f_jewel_ears.layer-right{
      transform-origin:center top; --scale:0.20; --offset-x: 46%; --offset-y: 29%;
    }
    body[data-gender="female"][data-skin="dark"] .layer-overlay.item-f_jewel_ears.layer-left{
      transform-origin:center top; --scale:0.20; --offset-x:-46%; --offset-y:32%;
    }
    body[data-gender="female"][data-skin="dark"] .layer-overlay.item-f_jewel_ears.layer-right{
      transform-origin:center top; --scale:0.20; --offset-x:46%; --offset-y:32%;
    }

    body[data-gender="male"][data-skin="light"] .layer-overlay.item-m_jewel_necklace{
      transform-origin:center top; --scale:1; --offset-x:0%; --offset-y:0%;
    }
    body[data-gender="male"][data-skin="dark"] .layer-overlay.item-m_jewel_necklace{
      transform-origin:center top; --scale:1; --offset-x:0%; --offset-y:0%;
    }

    /* ========== SHOES ========== */
    /* FEMALE LIGHT - LEFT SHOE */
    body[data-gender="female"][data-skin="light"] .layer-overlay.layer-shoes-left {
      transform-origin: center center;
      --scale-light: 0.36;
      --offset-x-light: -18%;
      --offset-y-light: 120%;
      --rotate-light: 0deg;
    }

    /* FEMALE LIGHT - RIGHT SHOE */
    body[data-gender="female"][data-skin="light"] .layer-overlay.layer-shoes-right {
      transform-origin: center center;
      --scale-light: 0.36;
      --offset-x-light: 13%;
      --offset-y-light: 120%;
      --rotate-light: 0deg;
    }

    /* FEMALE DARK - LEFT SHOE */
    body[data-gender="female"][data-skin="dark"] .layer-overlay.layer-shoes-left {
      transform-origin: center center;
      --scale-dark: 0.34;
      --offset-x-dark: -20%;
      --offset-y-dark: 122%;
      --rotate-dark: 0deg;
    }

    /* FEMALE DARK - RIGHT SHOE */
    body[data-gender="female"][data-skin="dark"] .layer-overlay.layer-shoes-right {
      transform-origin: center center;
      --scale-dark: 0.34;
      --offset-x-dark: 15%;
      --offset-y-dark: 122%;
      --rotate-dark: 0deg;
    }

    /* MALE LIGHT - LEFT SHOE */
    body[data-gender="male"][data-skin="light"] .layer-overlay.layer-shoes-left {
      transform-origin: center center;
      --scale-light: 0.52;
      --offset-x-light: -25%;
      --offset-y-light: 86%;
      --rotate-light: 0deg;
    }

    /* MALE LIGHT - RIGHT SHOE */
    body[data-gender="male"][data-skin="light"] .layer-overlay.layer-shoes-right {
      transform-origin: center center;
      --scale-light: 0.52;
      --offset-x-light: 22%;
      --offset-y-light: 86%;
      --rotate-light: 0deg;
    }

    /* MALE DARK - LEFT SHOE */
    body[data-gender="male"][data-skin="dark"] .layer-overlay.layer-shoes-left {
      transform-origin: center center;
      --scale-dark: 0.52;
      --offset-x-dark: -25%;
      --offset-y-dark: 86%;
      --rotate-dark: 0deg;
    }

    /* MALE DARK - RIGHT SHOE */
    body[data-gender="male"][data-skin="dark"] .layer-overlay.layer-shoes-right {
      transform-origin: center center;
      --scale-dark: 0.52;
      --offset-x-dark: 25%;
      --offset-y-dark: 86%;
      --rotate-dark: 0deg;
    }

    /* ========== EYES ========== */
    /* FEMALE LIGHT - LEFT EYE */
    body[data-gender="female"][data-skin="light"] .layer-overlay.item-u_eyes_blue.layer-left,
    body[data-gender="female"][data-skin="light"] .layer-overlay.item-u_eyes_green.layer-left,
    body[data-gender="female"][data-skin="light"] .layer-overlay.item-u_eyes_brown.layer-left {
      transform-origin: center top;
      --scale-light: 0.01;
      --offset-x-light: -375%;
      --offset-y-light: 1018%;
    }

    /* FEMALE LIGHT - RIGHT EYE */
    body[data-gender="female"][data-skin="light"] .layer-overlay.item-u_eyes_blue.layer-right,
    body[data-gender="female"][data-skin="light"] .layer-overlay.item-u_eyes_green.layer-right,
    body[data-gender="female"][data-skin="light"] .layer-overlay.item-u_eyes_brown.layer-right {
      transform-origin: center top;
      --scale-light: 0.01;
      --offset-x-light: 323%;
      --offset-y-light: 1020%;
    }

    /* FEMALE DARK - LEFT EYE */
    body[data-gender="female"][data-skin="dark"] .layer-overlay.item-u_eyes_blue.layer-left,
    body[data-gender="female"][data-skin="dark"] .layer-overlay.item-u_eyes_green.layer-left,
    body[data-gender="female"][data-skin="dark"] .layer-overlay.item-u_eyes_brown.layer-left {
      transform-origin: center top;
      --scale-dark: 0.01;
      --offset-x-dark: -265%;
      --offset-y-dark: 1108%;
    }

    /* FEMALE DARK - RIGHT EYE */
    body[data-gender="female"][data-skin="dark"] .layer-overlay.item-u_eyes_blue.layer-right,
    body[data-gender="female"][data-skin="dark"] .layer-overlay.item-u_eyes_green.layer-right,
    body[data-gender="female"][data-skin="dark"] .layer-overlay.item-u_eyes_brown.layer-right {
      transform-origin: center top;
      --scale-dark: 0.01;
      --offset-x-dark: 383%;
      --offset-y-dark: 1108%;
    }

    /* MALE LIGHT - LEFT EYE */
    body[data-gender="male"][data-skin="light"] .layer-overlay.item-u_eyes_blue.layer-left,
    body[data-gender="male"][data-skin="light"] .layer-overlay.item-u_eyes_green.layer-left,
    body[data-gender="male"][data-skin="light"] .layer-overlay.item-u_eyes_brown.layer-left {
      transform-origin: center top;
      --scale-light: 0.01;
      --offset-x-light: -405%;
      --offset-y-light: 968%;
    }

    /* MALE LIGHT - RIGHT EYE */
    body[data-gender="male"][data-skin="light"] .layer-overlay.item-u_eyes_blue.layer-right,
    body[data-gender="male"][data-skin="light"] .layer-overlay.item-u_eyes_green.layer-right,
    body[data-gender="male"][data-skin="light"] .layer-overlay.item-u_eyes_brown.layer-right {
      transform-origin: center top;
      --scale-light: 0.01;
      --offset-x-light: 393%;
      --offset-y-light: 970%;
    }

    /* MALE DARK - LEFT EYE */
    body[data-gender="male"][data-skin="dark"] .layer-overlay.item-u_eyes_blue.layer-left,
    body[data-gender="male"][data-skin="dark"] .layer-overlay.item-u_eyes_green.layer-left,
    body[data-gender="male"][data-skin="dark"] .layer-overlay.item-u_eyes_brown.layer-left {
      transform-origin: center top;
      --scale-dark: 0.01;
      --offset-x-dark: -295%;
      --offset-y-dark: 978%;
    }

    /* MALE DARK - RIGHT EYE */
    body[data-gender="male"][data-skin="dark"] .layer-overlay.item-u_eyes_blue.layer-right,
    body[data-gender="male"][data-skin="dark"] .layer-overlay.item-u_eyes_green.layer-right,
    body[data-gender="male"][data-skin="dark"] .layer-overlay.item-u_eyes_brown.layer-right {
      transform-origin: center top;
      --scale-dark: 0.01;
      --offset-x-dark: 523%;
      --offset-y-dark: 978%;
    }

  </style>
</head>
<body data-gender="female" data-skin="light">

  <!-- Header -->
  <header class="py-3">
    <div style="max-width:1200px; margin:0 auto; padding:0 1.5rem; display:flex; align-items:center; justify-content:space-between; flex-wrap:wrap; gap:0.75rem;">
      <a href="index.html" style="display:flex; align-items:center; gap:0.5rem; text-decoration:none;">
        <img src="assets/images/8bfr-logo-v3.png" alt="8BFR Music Network" style="width:36px; height:36px; border-radius:4px;">
        <span style="font-weight:600; font-size:1rem; color:#fff;">8BFR Music Network</span>
      </a>
      
      <nav style="display:flex; align-items:center; gap:1rem; flex-wrap:wrap;">
        <a href="index.html" class="btn btn-small">Home</a>
        <a href="carrie-closet.html" class="btn btn-small">Full Closet</a>
        <a href="about.html" class="btn btn-small">About</a>
        <a href="coinshop.html" class="pill-tag" style="font-size:.65rem; text-decoration:none; cursor:pointer;">ü™ô Coin Shop</a>
      </nav>
    </div>
  </header>

  <!-- Main -->
  <main style="max-width:1200px; margin:2rem auto; padding:0 1.5rem;">
    
    <!-- Control Panel -->
    <div class="control-panel">
      <div style="display:flex; flex-wrap:wrap; gap:1rem; align-items:center; justify-content:space-between;">
        <div style="display:flex; align-items:center; gap:.5rem;">
          <span style="font-size:1.2rem;">üí∞</span>
          <span id="coinDisplay" style="font-weight:600; color:#fbbf24; font-size:.95rem;">999,999 coins</span>
        </div>

        <div style="display:flex; gap:.5rem; flex-wrap:wrap;">
          <button id="btnSite" class="mode-btn active">Site/Pro</button>
          <button id="btnPersonal" class="mode-btn">Personal</button>
          <button id="btnBFGF" class="mode-btn">BF/GF</button>
        </div>

        <div id="ownerControls" style="display:flex; gap:.5rem;">
          <button id="trainerBtn" class="btn btn-small">üß† Train</button>
          <button id="clearLogBtn" class="btn btn-small">üóë Clear</button>
        </div>
      </div>
    </div>

    <!-- Avatar & Items Layout -->
    <div class="avatar-items-layout">
      <!-- Left: Mini Avatar Preview -->
      <div>
        <div id="miniPreviewFrame">
          <div id="miniPreviewInner">
            <img id="miniBaseImg" src="assets/images/base/female/base_female_light.png?v=15" alt="Carrie Base">
            <div id="miniOverlayHost"></div>
          </div>
        </div>
        
        <div class="avatar-controls-box">
          <div style="margin-bottom:0.75rem;">
            <div style="font-size:0.75rem; color:#a855f7; font-weight:600; margin-bottom:0.4rem;">GENDER</div>
            <div style="display:flex; gap:0.5rem;">
              <button class="seg-btn active" data-gender="female">üë© Female</button>
              <button class="seg-btn" data-gender="male">üë® Male</button>
            </div>
          </div>
          
          <div>
            <div style="font-size:0.75rem; color:#a855f7; font-weight:600; margin-bottom:0.4rem;">SKIN TONE</div>
            <div style="display:flex; gap:0.5rem;">
              <button class="seg-btn active" data-skin="light">‚òÄÔ∏è Light</button>
              <button class="seg-btn" data-skin="dark">üåô Dark</button>
            </div>
          </div>

          <a href="carrie-closet.html" class="btn btn-primary" style="margin-top:1rem; width:100%;">
            Open Full Closet
          </a>
        </div>
      </div>

      <!-- Right: Items Panel -->
      <div class="items-section">
        <div class="item-category-box">
          <div class="category-header">
            <span>üëó</span>
            <span>Owned Items</span>
          </div>
          <div id="ownedItemsGrid" class="mini-items-grid"></div>
        </div>
      </div>
    </div>

    <!-- Chat Shell -->
    <div class="chat-shell" style="padding:1rem;">
      <div style="margin-bottom:.75rem;">
        <div style="font-weight:600; font-size:.95rem; margin-bottom:.25rem;">üí¨ Chat with Carrie</div>
        <div style="font-size:.7rem; opacity:.7;">Ask anything or customize my look!</div>
      </div>

      <div id="chatLog" class="chat-log">
        <!-- Messages will be dynamically inserted here -->
      </div>

      <div id="typingRow" class="msg-row" style="display:none; margin-top:.5rem;">
        <div class="msg-avatar">
          <img src="assets/images/carrie-avatar.png" alt="assistant" />
        </div>
        <div style="display:flex; gap:4px; align-items:center; padding:8px 12px; background:rgba(17,24,39,.96); border-radius:12px;">
          <div class="typing-dot"></div>
          <div class="typing-dot"></div>
          <div class="typing-dot"></div>
        </div>
      </div>

      <form id="carrieForm" style="margin-top:1rem; display:flex; gap:.5rem; flex-direction:column;">
        <textarea id="carrieInput" placeholder="Type a message..." rows="2"></textarea>
        <div style="display:flex; gap:.5rem; justify-content:flex-end;">
          <button type="submit" class="btn btn-primary">Send üíú</button>
        </div>
      </form>
    </div>

  </main>

  <!-- Trainer Modal -->
  <div id="trainerBackdrop" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,.85); z-index:9999; align-items:center; justify-content:center; padding:1rem;">
    <div style="background:rgba(10,2,26,.98); border:1px solid rgba(124,58,237,.6); border-radius:18px; max-width:500px; width:100%; padding:1.5rem; position:relative;">
      <button id="trainerClose" type="button" style="position:absolute; top:10px; right:10px; background:rgba(124,58,237,.5); border:1px solid rgba(124,58,237,.7); color:#fff; width:28px; height:28px; border-radius:50%; cursor:pointer; display:flex; align-items:center; justify-content:center; font-size:16px;">√ó</button>
      <div style="font-size:1.2rem; font-weight:600; margin-bottom:1rem; color:#a855f7;">üß† Train Carrie</div>
      <div style="font-size:.8rem; opacity:.8; margin-bottom:1rem;">Teach Carrie new responses!</div>
      
      <form id="trainerForm">
        <div style="margin-bottom:1rem;">
          <label style="display:block; font-size:.75rem; margin-bottom:.3rem; color:#a855f7;">QUESTION / PATTERN</label>
          <input id="trainerQuestion" type="text" placeholder="e.g., 'tell me a joke'" style="width:100%; background:rgba(15,23,42,.9); border:1px solid rgba(124,58,237,.5); border-radius:8px; padding:.5rem; color:#e5e7eb; font-size:.85rem;" />
        </div>
        
        <div style="margin-bottom:1rem;">
          <label style="display:block; font-size:.75rem; margin-bottom:.3rem; color:#a855f7;">ANSWER</label>
          <textarea id="trainerAnswer" placeholder="Carrie's reply..." rows="3" style="width:100%; background:rgba(15,23,42,.9); border:1px solid rgba(124,58,237,.5); border-radius:8px; padding:.5rem; color:#e5e7eb; font-size:.85rem; resize:none;"></textarea>
        </div>
        
        <div id="trainerStatus" style="display:none; padding:.5rem; border-radius:8px; background:rgba(16,185,129,.15); border:1px solid rgba(16,185,129,.5); color:#10b981; font-size:.75rem; margin-bottom:1rem;"></div>
        
        <div style="display:flex; gap:.5rem; justify-content:flex-end;">
          <button id="trainerCancel" type="button" class="btn">Cancel</button>
          <button type="submit" class="btn btn-primary">Save</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      // Elements
      const chatLog = document.getElementById("chatLog");
      const carrieForm = document.getElementById("carrieForm");
      const carrieInput = document.getElementById("carrieInput");
      const typingRow = document.getElementById("typingRow");
      const btnSite = document.getElementById("btnSite");
      const btnPersonal = document.getElementById("btnPersonal");
      const btnBFGF = document.getElementById("btnBFGF");
      const clearLogBtn = document.getElementById("clearLogBtn");
      const miniBaseImg = document.getElementById("miniBaseImg");
      const miniOverlayHost = document.getElementById("miniOverlayHost");
      const ownedItemsGrid = document.getElementById("ownedItemsGrid");
      const trainerBtn = document.getElementById("trainerBtn");
      const trainerModal = document.getElementById("trainerBackdrop");
      const trainerClose = document.getElementById("trainerClose");
      const trainerCancel = document.getElementById("trainerCancel");
      const trainerBackdrop = document.getElementById("trainerBackdrop");
      const trainerForm = document.getElementById("trainerForm");
      const trainerQuestion = document.getElementById("trainerQuestion");
      const trainerAnswer = document.getElementById("trainerAnswer");
      const trainerStatus = document.getElementById("trainerStatus");

      // State
      let carrieMode = localStorage.getItem("carrieMode") || "site";
      let currentGender = localStorage.getItem("carrieGender") || "female";
      let currentSkin = localStorage.getItem("carrieSkinTone") || "light";
      let ownedItems = [];

      const equipped = {
        hair: null,
        top: null,
        bottom: null,
        shoes: null,
        necklace: null,
        eyes: null,
        ears: null,
        belly: null
      };

      const zBySlot = { shoes: 10, bottom: 30, belly: 35, top: 40, necklace: 45, eyes: 50, ears: 55, hair: 60 };

      // Get items from window.CARRIE_CLOSET_ITEMS
      function getItems() {
        return window.CARRIE_CLOSET_ITEMS || [];
      }

      // Filter items by gender
      function filterByGender(items) {
        return items.filter(it => {
          return it.gender === "unisex" || it.gender === currentGender;
        });
      }

      // Update base image
      function updateBaseImage() {
        if (miniBaseImg) {
          miniBaseImg.src = `assets/images/base/${currentGender}/base_${currentGender}_${currentSkin}.png?v=15`;
        }
        document.body.dataset.gender = currentGender;
        document.body.dataset.skin = currentSkin;
      }

      // Render avatar overlays
      function renderAvatarOverlays() {
        if (!miniOverlayHost) return;
        miniOverlayHost.innerHTML = "";

        Object.keys(equipped).forEach(slot => {
          const itemObj = equipped[slot];
          if (!itemObj) return;

          // Handle dual items (eyes, ears, shoes)
          if (slot === "eyes" || slot === "ears") {
            const left = document.createElement("img");
            left.src = itemObj.imgLeft || itemObj.img;
            left.className = `layer-overlay layer-left item-${itemObj.id}`;
            left.style.zIndex = zBySlot[slot];

            const right = document.createElement("img");
            right.src = itemObj.imgRight || itemObj.img;
            right.className = `layer-overlay layer-right item-${itemObj.id}`;
            right.style.zIndex = zBySlot[slot];

            miniOverlayHost.appendChild(left);
            miniOverlayHost.appendChild(right);
          } else if (slot === "shoes") {
            const left = document.createElement("img");
            left.src = itemObj.imgLeft || itemObj.img;
            left.className = `layer-overlay layer-shoes-left item-${itemObj.id}`;
            left.style.zIndex = zBySlot.shoes;

            const right = document.createElement("img");
            right.src = itemObj.imgRight || itemObj.img;
            right.className = `layer-overlay layer-shoes-right item-${itemObj.id}`;
            right.style.zIndex = zBySlot.shoes;

            miniOverlayHost.appendChild(left);
            miniOverlayHost.appendChild(right);
          } else {
            // Single item
            const overlay = document.createElement("img");
            overlay.src = itemObj.img;
            overlay.className = `layer-overlay item-${itemObj.id}`;
            overlay.style.zIndex = zBySlot[slot] || 20;
            miniOverlayHost.appendChild(overlay);
          }
        });
      }

      // Render owned items
      function renderOwnedItems() {
        if (!ownedItemsGrid) return;
        ownedItemsGrid.innerHTML = "";

        const items = getItems();
        const filtered = filterByGender(items);

        ownedItems.forEach(itemId => {
          const item = filtered.find(it => it.id === itemId);
          if (!item) return;

          const div = document.createElement("div");
          div.className = "mini-item";
          if (equipped[item.slot] && equipped[item.slot].id === item.id) {
            div.classList.add("active");
          }

          const badge = equipped[item.slot] && equipped[item.slot].id === item.id ?
            '<div class="item-badge badge-active">ACTIVE</div>' :
            '<div class="item-badge badge-owned">OWNED</div>';

          div.innerHTML = `
            <div class="mini-item-img">
              <img src="${item.img}" alt="${item.name}">
              ${badge}
            </div>
            <div class="mini-item-name">${item.name}</div>
          `;

          div.addEventListener("click", () => {
            if (equipped[item.slot] && equipped[item.slot].id === item.id) {
              equipped[item.slot] = null;
            } else {
              equipped[item.slot] = item;
            }
            renderOwnedItems();
            renderAvatarOverlays();
          });

          ownedItemsGrid.appendChild(div);
        });
      }

      // Gender/Skin controls
      document.querySelectorAll('[data-gender]').forEach(btn => {
        btn.addEventListener('click', function() {
          document.querySelectorAll('[data-gender]').forEach(b => b.classList.remove('active'));
          this.classList.add('active');
          currentGender = this.dataset.gender;
          localStorage.setItem("carrieGender", currentGender);
          updateBaseImage();
          renderOwnedItems();
          renderAvatarOverlays();
        });
      });

      document.querySelectorAll('[data-skin]').forEach(btn => {
        btn.addEventListener('click', function() {
          document.querySelectorAll('[data-skin]').forEach(b => b.classList.remove('active'));
          this.classList.add('active');
          currentSkin = this.dataset.skin;
          localStorage.setItem("carrieSkinTone", currentSkin);
          updateBaseImage();
          renderAvatarOverlays();
        });
      });

      // Auto-unlock all items for owner
      function unlockAllItems() {
        const items = getItems();
        ownedItems = items.map(it => it.id);
        console.log("‚úÖ All items unlocked:", ownedItems.length);
        renderOwnedItems();
      }

      // Mode switching
      function switchMode(newMode) {
        carrieMode = newMode;
        localStorage.setItem("carrieMode", newMode);
        updateModeUI();
        
        const greeting = getModeGreeting();
        renderMessage("assistant", greeting, new Date());
      }

      function updateModeUI() {
        btnSite.classList.toggle("active", carrieMode === "site");
        btnPersonal.classList.toggle("active", carrieMode === "personal");
        btnBFGF.classList.toggle("active", carrieMode === "bfgf");
      }

      btnSite.addEventListener("click", () => switchMode("site"));
      btnPersonal.addEventListener("click", () => switchMode("personal"));
      btnBFGF.addEventListener("click", () => switchMode("bfgf"));

      if (clearLogBtn) {
        clearLogBtn.addEventListener("click", async () => {
          if (!confirm("Clear all chat history?")) return;
          chatLog.innerHTML = "";
          renderMessage("assistant", getModeGreeting());
        });
      }

      // Chat functions
      function renderMessage(role, content, timestamp = new Date()) {
        const row = document.createElement("div");
        row.className = `msg-row ${role}`;

        const avatarSrc = role === "user"
          ? "assets/images/user-avatar.png"
          : "assets/images/carrie-avatar.png";

        const avatarHTML = `<div class="msg-avatar"><img src="${avatarSrc}" alt="${role}" /></div>`;
        const time = new Date(timestamp).toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" });
        const bubbleHTML = `<div><div class="msg-bubble">${content}</div><div class="msg-meta">${time}</div></div>`;

        if (role === "user") {
          row.innerHTML = bubbleHTML + avatarHTML;
        } else {
          row.innerHTML = avatarHTML + bubbleHTML;
        }

        chatLog.appendChild(row);
        chatLog.scrollTop = chatLog.scrollHeight;
      }

      function carrieBrain(msg) {
        const lower = msg.toLowerCase();
        
        if (typeof carrieScripts !== 'undefined') {
          for (const script of carrieScripts) {
            if (script.patterns && script.patterns.some(p => lower.includes(p.toLowerCase()))) {
              return script.reply;
            }
          }
        }

        if (carrieMode === "site") {
          if (lower.includes("8bfr") || lower.includes("network")) {
            return "8BFR Music Network is your music hub! What would you like to know?";
          }
          if (lower.includes("closet") || lower.includes("avatar") || lower.includes("outfit")) {
            return "You can customize my look right here or visit the Full Closet for more options! üíú";
          }
        } else if (carrieMode === "personal") {
          if (lower.includes("goal")) {
            return "Tell me about your goals! Every step counts. üí™";
          }
        } else if (carrieMode === "bfgf") {
          if (lower.includes("love")) {
            return "Aww you're sweet! I'm here for you babe. üíú";
          }
        }

        const defaults = [
          "That's interesting! Tell me more.",
          "I'm listening. What else?",
          "That's a great question!",
          "Thanks for sharing. üíú"
        ];

        return defaults[Math.floor(Math.random() * defaults.length)];
      }

      function getModeGreeting() {
        if (carrieMode === "site") {
          return "I'm in <b>Site/Pro</b> mode. Ask about 8BFR or get help!";
        } else if (carrieMode === "personal") {
          return "I'm in <b>Personal</b> mode. Tell me your goals! üíú";
        } else if (carrieMode === "bfgf") {
          return "Hey babe üíú I'm in <b>BF/GF mode</b>. I'm all yours. üòä";
        }
        
        return "Ask me anything! üíú";
      }

      function showTyping() {
        typingRow.style.display = "flex";
      }

      function hideTyping() {
        typingRow.style.display = "none";
      }

      carrieForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        const userMsg = carrieInput.value.trim();
        if (!userMsg) return;

        carrieInput.value = "";
        renderMessage("user", userMsg, new Date());

        showTyping();

        setTimeout(() => {
          const reply = carrieBrain(userMsg);
          renderMessage("assistant", reply, new Date());
          hideTyping();
        }, 600 + Math.random() * 400);
      });

      carrieInput.addEventListener("keydown", (e) => {
        if (e.key === "Enter" && !e.shiftKey) {
          e.preventDefault();
          carrieForm.requestSubmit();
        }
      });

      // Trainer modal
      function openTrainer() {
        if (trainerModal) trainerModal.style.display = "flex";
        if (trainerStatus) trainerStatus.style.display = "none";
      }

      function closeTrainer() {
        if (trainerModal) trainerModal.style.display = "none";
        if (trainerQuestion) trainerQuestion.value = "";
        if (trainerAnswer) trainerAnswer.value = "";
        if (trainerStatus) trainerStatus.style.display = "none";
      }

      if (trainerModal) trainerModal.style.display = "none";

      if (trainerBtn) {
        trainerBtn.addEventListener("click", (e) => {
          e.preventDefault();
          openTrainer();
        });
      }
      
      if (trainerClose) trainerClose.addEventListener("click", closeTrainer);
      if (trainerCancel) trainerCancel.addEventListener("click", closeTrainer);
      if (trainerBackdrop) {
        trainerBackdrop.addEventListener("click", (e) => {
          if (e.target === trainerBackdrop) closeTrainer();
        });
      }

      document.addEventListener("keydown", (e) => {
        if (e.key === "Escape" && trainerModal && trainerModal.style.display === "flex") {
          closeTrainer();
        }
      });

      if (trainerForm) {
        trainerForm.addEventListener("submit", async (e) => {
          e.preventDefault();
          
          const q = trainerQuestion.value.trim();
          const a = trainerAnswer.value.trim();
          
          if (!q || !a) {
            trainerStatus.textContent = "Fill both fields";
            trainerStatus.style.display = "block";
            return;
          }

          const entry = {
            id: "custom_" + Date.now(),
            section: "custom",
            patterns: [q],
            reply: a.replace(/\n/g, "<br>")
          };
          
          if (typeof carrieScripts !== 'undefined') {
            carrieScripts.push(entry);
          }

          trainerStatus.textContent = "‚úÖ Saved!";
          trainerStatus.style.display = "block";
          
          setTimeout(() => {
            trainerQuestion.value = "";
            trainerAnswer.value = "";
          }, 1500);
        });
      }

      // Init
      updateModeUI();
      updateBaseImage();
      unlockAllItems();
      renderAvatarOverlays();

      // Initial greeting
      renderMessage("assistant", "Hey! üíú I'm Carrie in Owner Mode. You can customize my look and chat with me!");

      console.log("‚úÖ Chat page ready!");
      
    });
  </script>

  <script src="scripts.js?v=2" defer></script>

  <script>
    // Hide floating bubbles
    window.addEventListener("load", function(){
      setTimeout(function(){
        const idsToHide = ['bubbleStack', 'bubble-top-single', 'carrieWrap', 'carrieBubble', 'carrieToggleBar'];
        idsToHide.forEach(id => {
          const el = document.getElementById(id);
          if (el) el.style.display = 'none';
        });
        
        const classesToHide = ['.bubble-stack', '.floating-bubbles', '.carrie-bubble', '.bubble-container'];
        classesToHide.forEach(cls => {
          document.querySelectorAll(cls).forEach(el => el.style.display = 'none');
        });
        
        document.querySelectorAll('[data-bubble]').forEach(el => el.style.display = 'none');
        document.querySelectorAll('[data-role="carrie"], [data-carrie]').forEach(el => el.style.display = 'none');
      }, 300);
    });
  </script>
</body>
</html>
