<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Sign up - 8BFR Music Network</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body { background:#0a0a0a;color:#fff;font-family:Inter,system-ui; padding:1rem; }
    .card{max-width:760px;margin:0 auto;background:#111;padding:1.5rem;border-radius:8px;border:1px solid #222;}
    label{display:block;margin:.5rem 0;color:#ccc;font-weight:600;}
    input, textarea, select{width:100%;padding:.6rem;border-radius:6px;border:1px solid #333;background:#070707;color:#fff}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:1rem}
    .btn{background:#ff0066;color:#fff;padding:.8rem 1rem;border:none;border-radius:6px;cursor:pointer;margin-top:1rem;width:100%;font-weight:600;}
    .btn:disabled{background:#666;cursor:not-allowed;}
    .muted{color:#999;font-size:.9rem}
    .error{color:#ff4444;background:rgba(255,68,68,0.1);padding:.5rem;border-radius:4px;margin:.5rem 0;}
    .success{color:#44ff88;background:rgba(68,255,136,0.1);padding:.5rem;border-radius:4px;margin:.5rem 0;}
    .badge-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(150px,1fr));gap:.5rem;max-height:200px;overflow-y:auto;padding:.5rem;background:#0a0a0a;border-radius:4px;margin-top:.5rem;}
    .badge-item{display:flex;align-items:center;gap:.5rem;}
    .badge-item input{width:auto;}
  </style>
</head>
<body>
  <div class="card">
    <h2>Create Account - 8BFR Music Network</h2>
    <p class="muted">Fill out the form below to create your account. All fields marked with * are required.</p>

    <div class="form">
      <label>Email *</label>
      <input id="email" type="email" required placeholder="your.email@example.com" />

      <label>Password * (min 6 characters)</label>
      <input id="password" type="password" required minlength="6" placeholder="Enter secure password" />

      <label>Username * (unique, no spaces)</label>
      <input id="username" type="text" required placeholder="yourusername" />

      <label>Display Name</label>
      <input id="display_name" type="text" placeholder="Your Display Name" />

      <label>Bio</label>
      <textarea id="bio" rows="3" placeholder="Tell us about yourself..."></textarea>

      <label>Roles (check all that apply) *</label>
      <div class="badge-grid" id="roleContainer" style="margin-bottom:1rem;">
        <!-- Roles will be added here by JavaScript -->
      </div>

      <label>Badges (optional - check all that apply)</label>
      <div class="badge-grid" id="badgeContainer">
        <!-- Badges will be added here by JavaScript -->
      </div>

      <div id="verificationSection" style="display:none;margin-top:1rem;">
        <label>Verification Link (Recommended for Artist/Beatmaker/Producer)</label>
        <input id="verification_link" type="url" placeholder="https://spotify.com/artist/... or similar proof" />
        <p class="muted">Provide a link to verify your professional status (Spotify, SoundCloud, etc)</p>
      </div>

      <div id="message"></div>

      <button id="signupBtn" class="btn">Create Account</button>
      
      <p class="muted" style="text-align:center;margin-top:1rem;">
        Already have an account? <a href="login.html" style="color:#ff0066;">Login here</a>
      </p>
    </div>
  </div>

  <script>
    // CHECK IF SUPABASE LOADED
    setTimeout(() => {
      if (typeof window.supabase === 'undefined') {
        document.getElementById('message').innerHTML = '<div class="error"><strong>ERROR: Supabase library did not load!</strong><br>This usually happens on mobile browsers. Try refreshing the page or using a different browser.</div>';
        document.getElementById('signupBtn').disabled = true;
        document.getElementById('signupBtn').textContent = 'Library Not Loaded';
        return;
      }

      // Show that we're ready
      document.getElementById('message').innerHTML = '<div class="success">✅ Ready to create account!</div>';
    }, 1000);

    const SUPABASE_URL = 'https://novbuvwpjnxwwvdekjhr.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5vdmJ1dndwam54d3d2ZGVramhyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjExODkxODUsImV4cCI6MjA3Njc2NTE4NX0.1UUkdGafh6ZplAX8hi7Bvj94D2gvFQZUl0an1RvcSA0';

    let supabase;
    
    try {
      supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    } catch (e) {
      document.getElementById('message').innerHTML = '<div class="error">Supabase initialization failed: ' + e.message + '</div>';
    }

    // All available roles
    const allRoles = [
      'fan','artist','beatmaker','producer','singer','musician','engineer','songwriter','dj',
      'label','promoter','videographer','photographer','filmmaker','podcaster','distributor',
      'rapper','designer','author','blogger','game_creator','developer','streamer','gamer',
      'influencer','brand_ambassador','community_leader','parent','student','educator',
      'supporter','collector','mentor','kids','mod','admin','owner'
    ];

    // All available badges - COMPLETE LIST
    const allBadges = [
      'artist','beatmaker','producer','singer','musician','engineer','songwriter','dj',
      'label','promoter','videographer','photographer','filmmaker','podcaster','distributor',
      'rapper','designer','author','blogger','game_creator','developer','streamer','gamer',
      'influencer','brand_ambassador','community_leader','fan','parent','student','educator',
      'supporter','collector','mentor','kids','8bfrfan','fyp','g7','mod','admin','owner',
      'donor','sponsor','contest_winner','tournament_champion','event_participant',
      'early_supporter','top_creator','trending','vip_member','beta_tester','founder','verified',
      'carrie_ai_assistant','carrie_performer','carrie_concert_vip','carrie_fashionista','carrie_voice_clone'
    ];

    // Render role checkboxes
    const roleContainer = document.getElementById('roleContainer');
    allRoles.forEach(role => {
      const div = document.createElement('div');
      div.className = 'badge-item';
      div.innerHTML = `
        <input type="checkbox" id="role_${role}" value="${role}">
        <label for="role_${role}" style="margin:0;cursor:pointer;font-size:.85rem;">${role.replace(/_/g, ' ')}</label>
      `;
      roleContainer.appendChild(div);
    });

    // Render badge checkboxes
    const badgeContainer = document.getElementById('badgeContainer');
    allBadges.forEach(badge => {
      const div = document.createElement('div');
      div.className = 'badge-item';
      div.innerHTML = `
        <input type="checkbox" id="badge_${badge}" value="${badge}">
        <label for="badge_${badge}" style="margin:0;cursor:pointer;font-size:.85rem;">${badge}</label>
      `;
      badgeContainer.appendChild(div);
    });

    // Signup function
    document.getElementById('signupBtn').addEventListener('click', async () => {
      if (!supabase) {
        alert('Supabase not initialized! Refresh the page.');
        return;
      }
      
      const email = document.getElementById('email').value.trim();
      const password = document.getElementById('password').value;
      const username = document.getElementById('username').value.trim();
      const display_name = document.getElementById('display_name').value.trim();
      const bio = document.getElementById('bio').value.trim();
      const verification_link = document.getElementById('verification_link').value.trim();

      const messageEl = document.getElementById('message');
      const signupBtn = document.getElementById('signupBtn');
      
      messageEl.innerHTML = '';

      // Get selected roles
      const selectedRoles = [];
      document.querySelectorAll('#roleContainer input:checked').forEach(cb => {
        selectedRoles.push(cb.value);
      });

      // Get selected badges
      const selectedBadges = [];
      document.querySelectorAll('#badgeContainer input:checked').forEach(cb => {
        selectedBadges.push(cb.value);
      });

      // Validation
      if (!email || !password || !username) {
        messageEl.innerHTML = '<div class="error">Email, password, and username are required.</div>';
        return;
      }

      if (selectedRoles.length === 0) {
        messageEl.innerHTML = '<div class="error">Please select at least one role.</div>';
        return;
      }

      if (password.length < 6) {
        messageEl.innerHTML = '<div class="error">Password must be at least 6 characters.</div>';
        return;
      }

      if (username.includes(' ')) {
        messageEl.innerHTML = '<div class="error">Username cannot contain spaces.</div>';
        return;
      }

      // Use first role as primary role for database
      const primaryRole = selectedRoles[0];

      signupBtn.disabled = true;
      signupBtn.textContent = 'Creating account...';
      messageEl.innerHTML = '<div class="muted">Creating your account...</div>';

      try {
        // 1. Sign up user
        const { data: signUpData, error: signUpError } = await supabase.auth.signUp({
          email: email,
          password: password,
          options: {
            data: {
              username: username
            }
          }
        });

        if (signUpError) {
          throw new Error('Signup error: ' + signUpError.message);
        }

        const user = signUpData.user;
        
        if (!user) {
          messageEl.innerHTML = '<div class="success">Account created! Check your email to confirm your account before logging in.</div>';
          signupBtn.textContent = 'Account Created';
          return;
        }

        messageEl.innerHTML = '<div class="muted">Creating profile...</div>';

        // 2. Create profile - combine roles and badges
        const allTags = [...selectedRoles, ...selectedBadges];
        
        const { error: profileError } = await supabase
          .from('profiles')
          .insert({
            user_id: user.id,
            email: email,
            username: username,
            display_name: display_name || username,
            role: primaryRole,
            bio: bio,
            badges: allTags,
            verify_url: verification_link || null,
            verified_artist: false,
            created_at: new Date().toISOString()
          });

        if (profileError) {
          console.error('Profile error:', profileError);
          messageEl.innerHTML = '<div class="error">Account created but profile setup failed: ' + profileError.message + '</div>';
          signupBtn.textContent = 'Profile Error';
          return;
        }

        // 3. Create verification request if artist-type role selected
        const needsVerification = ['artist', 'beatmaker', 'producer', 'singer', 'musician', 'engineer', 'songwriter', 'dj', 'rapper'];
        const hasArtistRole = selectedRoles.some(r => needsVerification.includes(r));
        
        if (hasArtistRole && verification_link) {
          const { error: vrError } = await supabase
            .from('verification_requests')
            .insert({
              user_id: user.id,
              username: username,
              requested_role: selectedRoles.filter(r => needsVerification.includes(r)).join(', '),
              proof_link: verification_link,
              status: 'pending',
              created_at: new Date().toISOString()
            });

          if (vrError) {
            console.warn('Verification request error:', vrError);
          }
        }

        messageEl.innerHTML = '<div class="success">✅ Account created successfully! Check your email to confirm your account, then you can log in.</div>';
        signupBtn.textContent = 'Success!';
        
        // Redirect after 2 seconds
        setTimeout(() => {
          window.location.href = 'login.html';
        }, 2000);

      } catch (error) {
        console.error('Signup error:', error);
        messageEl.innerHTML = '<div class="error">' + error.message + '</div>';
        signupBtn.disabled = false;
        signupBtn.textContent = 'Create Account';
      }
    });
  </script>
</body>
</html>
