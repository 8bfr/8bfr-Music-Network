

```javascript
async function init() {
    try {
        console.log('Initializing admin panel...');
        
        const { data: sessionData, error: sessionError } = await supabase.auth.getSession();
        console.log('Session check:', sessionData);
        
        if (sessionError) {
            console.error('Session error:', sessionError);
        }
        
        if (!sessionData.session) {
            console.log('No active session found, redirecting to login');
            alert('Please log in to access the admin panel');
            window.location.href = 'login.html';
            return;
        }
        
        console.log('Active session found for:', sessionData.session.user.email);
        
        const { data: { user }, error: authError } = await supabase.auth.getUser();
        
        if (authError) {
            console.error('Auth error:', authError);
            alert('Authentication error: ' + authError.message);
            window.location.href = 'login.html';
            return;
        }
        
        if (!user) {
            console.log('No user found, redirecting to login');
            window.location.href = 'login.html';
            return;
        }

        console.log('User authenticated:', user.email);

        console.log('Fetching profile for user_id:', user.id);
        const { data: profile, error: profileError } = await supabase
            .from('profiles')
            .select('*')
            .eq('user_id', user.id)
            .single();

        if (profileError) {
            console.error('Profile error:', profileError);
            
            if (profileError.code === 'PGRST116') {
                console.log('No profile found, creating one...');
                alert('Creating your profile...');
                
                const { data: newProfile, error: createError } = await supabase
                    .from('profiles')
                    .insert({
                        user_id: user.id,
                        username: user.email.split('@')[0],
                        display_name: user.email.split('@')[0],
                        role: 'fan'
                    })
                    .select()
                    .single();
                
                if (createError) {
                    console.error('Error creating profile:', createError);
                    alert('Could not create profile: ' + createError.message);
                    return;
                }
                
                console.log('Profile created:', newProfile);
                alert('Profile created! Please contact owner for admin access.');
                window.location.href = 'index.html';
                return;
            }
            
            alert('Profile error: ' + profileError.message);
            window.location.href = 'index.html';
            return;
        }

        if (!profile) {
            console.error('No profile found for user');
            alert('Profile not found. Please contact support.');
            window.location.href = 'index.html';
            return;
        }

        console.log('Profile loaded:', profile);

        if (profile.role !== 'admin' && profile.role !== 'owner') {
            console.error('Access denied. Role:', profile.role);
            alert('Access Denied: Admin privileges required. Your role: ' + profile.role);
            window.location.href = 'index.html';
            return;
        }

        currentUser = profile;
        const displayName = profile.username || profile.display_name || user.email.split('@')[0];
        console.log('Setting admin name to:', displayName);
        document.getElementById('adminName').textContent = displayName;
        
        console.log('Loading dashboard stats...');
        await loadDashboardStats();
        
        console.log('Loading all data...');
        await loadAllData();
        
        console.log('‚úÖ Admin panel initialized successfully!');
    } catch (error) {
        console.error('‚ùå Critical error during initialization:', error);
        alert('Error initializing admin panel: ' + error.message);
    }
}
```

---

## üéØ OR Just Replace the Entire admin-panel.html

Since you're having the same issue, here's the **COMPLETE FIXED admin-panel.html** file. Just copy and paste to replace your entire file:

**I'll provide the complete file in the next message due to length...**

Actually, let me give you just the **JavaScript section** that needs to be replaced. 

**Find the `<script>` tag (near the bottom) and replace EVERYTHING between `<script>` and `</script>` with this:**

```javascript
const SUPABASE_URL = 'https://novbuvwpjnxwwvdekjhr.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5vdmJ1dndwam54d3d2ZGVramhyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjExODkxODUsImV4cCI6MjA3Njc2NTE4NX0.1UUkdGafh6ZplAX8hi7Bvj94D2gvFQZUl0an1RvcSA0';
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

let currentUser = null;

async function init() {
    try {
        console.log('Initializing admin panel...');
        
        const { data: sessionData, error: sessionError } = await supabase.auth.getSession();
        console.log('Session check:', sessionData);
        
        if (sessionError) {
            console.error('Session error:', sessionError);
        }
        
        if (!sessionData.session) {
            console.log('No active session found, redirecting to login');
            alert('Please log in to access the admin panel');
            window.location.href = 'login.html';
            return;
        }
        
        console.log('Active session found for:', sessionData.session.user.email);
        
        const { data: { user }, error: authError } = await supabase.auth.getUser();
        
        if (authError) {
            console.error('Auth error:', authError);
            alert('Authentication error: ' + authError.message);
            window.location.href = 'login.html';
            return;
        }
        
        if (!user) {
            console.log('No user found, redirecting to login');
            window.location.href = 'login.html';
            return;
        }

        console.log('User authenticated:', user.email);

        console.log('Fetching profile for user_id:', user.id);
        const { data: profile, error: profileError } = await supabase
            .from('profiles')
            .select('*')
            .eq('user_id', user.id)
            .single();

        if (profileError) {
            console.error('Profile error:', profileError);
            
            if (profileError.code === 'PGRST116') {
                console.log('No profile found');
                alert('Profile not found. Please contact owner for admin access.');
                window.location.href = 'index.html';
                return;
            }
            
            alert('Profile error: ' + profileError.message);
            window.location.href = 'index.html';
            return;
        }

        if (!profile) {
            console.error('No profile found for user');
            alert('Profile not found. Please contact support.');
            window.location.href = 'index.html';
            return;
        }

        console.log('Profile loaded:', profile);

        if (profile.role !== 'admin' && profile.role !== 'owner') {
            console.error('Access denied. Role:', profile.role);
            alert('Access Denied: Admin privileges required. Your role: ' + profile.role);
            window.location.href = 'index.html';
            return;
        }

        currentUser = profile;
        const displayName = profile.username || profile.display_name || user.email.split('@')[0];
        console.log('Setting admin name to:', displayName);
        document.getElementById('adminName').textContent = displayName;
        
        console.log('Loading dashboard stats...');
        await loadDashboardStats();
        
        console.log('Loading all data...');
        await loadAllData();
        
        console.log('‚úÖ Admin panel initialized successfully!');
    } catch (error) {
        console.error('‚ùå Critical error during initialization:', error);
        alert('Error initializing admin panel: ' + error.message);
    }
}

function switchTab(tabName) {
    document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
    
    event.target.classList.add('active');
    document.getElementById(tabName).classList.add('active');

    if (tabName === 'verifications') loadAdminVerifications();
    if (tabName === 'content') { loadPosts(); loadComments(); }
    if (tabName === 'mods') loadMods();
    if (tabName === 'ads') loadPendingAds();
    if (tabName === 'reports') loadMyReports();
}

// VERIFICATION VIEWING (READ-ONLY)
async function loadAdminVerifications() {
    const filter = document.getElementById('adminVerificationFilter')?.value || 'pending';
    
    try {
        let queryBuilder = supabase
            .from('verification_requests')
            .select('*')
            .order('created_at', { ascending: false });

        if (filter !== 'all') {
            queryBuilder = queryBuilder.eq('status', filter);
        }

        const { data: requests, error } = await queryBuilder;
        
        if (error) throw error;

        const list = document.getElementById('adminVerificationsList');
        
        if (!requests || requests.length === 0) {
            list.innerHTML = '<p style="text-align: center; color: var(--text-dim); padding: 2rem;">No verification requests found</p>';
            return;
        }

        list.innerHTML = requests.map(req => {
            const statusColor = req.status === 'pending' ? 'var(--warning)' : 
                              req.status === 'approved' ? 'var(--success)' : 
                              'var(--danger)';
            const statusIcon = req.status === 'pending' ? '‚è≥' : 
                             req.status === 'approved' ? '‚úÖ' : 
                             '‚ùå';
            
            return `
                <div class="item">
                    <div>
                        <strong>User ID: ${req.user_id.substring(0, 8)}...</strong>
                        <span style="color: ${statusColor}; margin-left: 0.5rem;">${statusIcon} ${req.status.toUpperCase()}</span><br>
                        <small>Role: <strong>${req.role_requested}</strong></small><br>
                        <small>Link: <a href="${req.verification_link}" target="_blank" style="color: var(--primary);">View Link</a></small><br>
                        <small style="color: var(--text-dim);">Submitted: ${new Date(req.created_at).toLocaleString()}</small>
                        ${req.reviewed_at ? `<br><small style="color: var(--text-dim);">Reviewed: ${new Date(req.reviewed_at).toLocaleString()}</small>` : ''}
                        ${req.denial_reason ? `<br><small style="color: var(--danger);">Reason: ${req.denial_reason}</small>` : ''}
                    </div>
                </div>
            `;
        }).join('');
    } catch (error) {
        console.error('Error loading verification requests:', error);
    }
}

async function loadDashboardStats() {
    try {
        const today = new Date().toISOString().split('T')[0];
        
        const { count: postCount } = await supabase
            .from('posts')
            .select('*', { count: 'exact', head: true })
            .gte('created_at', today);
        
        const { count: commentCount } = await supabase
            .from('comments')
            .select('*', { count: 'exact', head: true })
            .gte('created_at', today);
        
        const { count: adCount } = await supabase
            .from('ads')
            .select('*', { count: 'exact', head: true })
            .eq('status', 'pending');
        
        const { count: modCount } = await supabase
            .from('profiles')
            .select('*', { count: 'exact', head: true })
            .eq('role', 'mod');

        document.getElementById('totalPosts').textContent = postCount || 0;
        document.getElementById('totalComments').textContent = commentCount || 0;
        document.getElementById('pendingAds').textContent = adCount || 0;
        document.getElementById('activeMods').textContent = modCount || 0;
    } catch (error) {
        console.error('Error loading dashboard stats:', error);
    }
}

async function searchContent() {
    const query = document.getElementById('contentSearch').value;
    loadPosts(query);
    loadComments(query);
}

async function loadPosts(query = '') {
    try {
        let queryBuilder = supabase.from('posts').select('*');
        if (query) {
            queryBuilder = queryBuilder.ilike('content', `%${query}%`);
        }
        
        const { data: posts } = await queryBuilder.limit(50).order('created_at', { ascending: false });
        const list = document.getElementById('postsList');
        
        if (!posts || posts.length === 0) {
            list.innerHTML = '<p style="text-align: center; color: var(--text-dim);">No posts found</p>';
            return;
        }
        
        list.innerHTML = posts.map(post => `
            <div class="item">
                <div>
                    <strong>User: ${post.user_id}</strong><br>
                    <small>${post.content?.substring(0, 100)}...</small>
                </div>
                <div class="item-actions">
                    <button class="btn btn-warning" onclick="hidePost('${post.id}')">Hide</button>
                    <button class="btn btn-danger" onclick="reportContent('post', '${post.id}')">Report</button>
                </div>
            </div>
        `).join('');
    } catch (error) {
        console.error('Error loading posts:', error);
    }
}

async function loadComments(query = '') {
    try {
        let queryBuilder = supabase.from('comments').select('*');
        if (query) {
            queryBuilder = queryBuilder.ilike('content', `%${query}%`);
        }
        
        const { data: comments } = await queryBuilder.limit(50).order('created_at', { ascending: false });
        const list = document.getElementById('commentsList');
        
        if (!comments || comments.length === 0) {
            list.innerHTML = '<p style="text-align: center; color: var(--text-dim);">No comments found</p>';
            return;
        }
        
        list.innerHTML = comments.map(comment => `
            <div class="item">
                <div>
                    <strong>User: ${comment.user_id}</strong><br>
                    <small>${comment.content?.substring(0, 100)}...</small>
                </div>
                <div class="item-actions">
                    <button class="btn btn-warning" onclick="hideComment('${comment.id}')">Hide</button>
                    <button class="btn btn-danger" onclick="reportContent('comment', '${comment.id}')">Report</button>
                </div>
            </div>
        `).join('');
    } catch (error) {
        console.error('Error loading comments:', error);
    }
}

async function hidePost(postId) {
    if (!confirm('Hide this post?')) return;
    
    const { error } = await supabase
        .from('posts')
        .update({ hidden: true, hidden_by: currentUser.username })
        .eq('id', postId);
    
    if (!error) {
        alert('Post hidden');
        loadPosts();
    }
}

async function hideComment(commentId) {
    if (!confirm('Hide this comment?')) return;
    
    const { error } = await supabase
        .from('comments')
        .update({ hidden: true, hidden_by: currentUser.username })
        .eq('id', commentId);
    
    if (!error) {
        alert('Comment hidden');
        loadComments();
    }
}

async function kickUser() {
    const userId = document.getElementById('chatUserId').value;
    if (!userId) {
        alert('Please enter a user ID');
        return;
    }

    const { error } = await supabase
        .from('chat_kicks')
        .insert({ user_id: userId, kicked_by: currentUser.username });
    
    if (!error) {
        alert('User kicked from chat');
    }
}

async function muteUser() {
    const userId = document.getElementById('chatUserId').value;
    const duration = document.getElementById('muteDuration').value;
    
    if (!userId) {
        alert('Please enter a user ID');
        return;
    }

    const muteUntil = new Date();
    muteUntil.setMinutes(muteUntil.getMinutes() + parseInt(duration));

    const { error } = await supabase
        .from('chat_mutes')
        .insert({ 
            user_id: userId, 
            muted_by: currentUser.username,
            muted_until: muteUntil.toISOString()
        });
    
    if (!error) {
        alert(`User muted for ${duration} minutes`);
    }
}

async function hideMessage() {
    const messageId = document.getElementById('messageId').value;
    const reason = document.getElementById('messageHideReason').value;
    
    const { error } = await supabase
        .from('messages')
        .update({ 
            hidden: true, 
            hidden_by: currentUser.username,
            hide_reason: reason 
        })
        .eq('id', messageId);
    
    if (!error) {
        alert('Message hidden');
    }
}

async function deleteMessage() {
    if (!confirm('Permanently delete this message?')) return;
    
    const messageId = document.getElementById('messageId').value;
    const reason = document.getElementById('messageHideReason').value;
    
    const { error } = await supabase
        .from('messages')
        .delete()
        .eq('id', messageId);
    
    if (!error) {
        await supabase.from('admin_actions').insert({
            action: 'message_delete',
            target_id: messageId,
            admin_id: currentUser.username,
            reason: reason
        });
        alert('Message deleted');
    }
}

async function loadMods() {
    try {
        const { data: mods } = await supabase
            .from('profiles')
            .select('*')
            .eq('role', 'mod');
        
        const list = document.getElementById('modsList');
        const select = document.getElementById('demoteModId');
        
        if (!mods || mods.length === 0) {
            list.innerHTML = '<p style="text-align: center; color: var(--text-dim);">No moderators found</p>';
            return;
        }
        
        list.innerHTML = mods.map(mod => `
            <div class="item">
                <div>
                    <strong>${mod.username}</strong><br>
                    <small>ID: ${mod.id}</small>
                </div>
                <div class="item-actions">
                    <button class="btn btn-danger" onclick="quickDemote('${mod.id}')">Demote</button>
                </div>
            </div>
        `).join('');
        
        select.innerHTML = '<option value="">Choose moderator...</option>' + 
            mods.map(mod => `<option value="${mod.id}">${mod.username}</option>`).join('');
    } catch (error) {
        console.error('Error loading mods:', error);
    }
}

async function promoteMod() {
    const userId = document.getElementById('promoteUserId').value;
    const reason = document.getElementById('promoteReason').value;
    
    if (!userId || !reason) {
        alert('Please fill in all fields');
        return;
    }

    const { error } = await supabase
        .from('profiles')
        .update({ role: 'mod' })
        .eq('id', userId);
    
    if (!error) {
        await supabase.from('admin_actions').insert({
            action: 'promote_mod',
            target_id: userId,
            admin_id: currentUser.username,
            reason: reason
        });
        alert('User promoted to Moderator');
        loadMods();
    }
}

async function demoteMod() {
    const modId = document.getElementById('demoteModId').value;
    const reason = document.getElementById('demoteReason').value;
    
    if (!modId || !reason) {
        alert('Please fill in all fields');
        return;
    }

    if (!confirm('Demote this moderator to user?')) return;

    const { error } = await supabase
        .from('profiles')
        .update({ role: 'user' })
        .eq('id', modId);
    
    if (!error) {
        await supabase.from('admin_actions').insert({
            action: 'demote_mod',
            target_id: modId,
            admin_id: currentUser.username,
            reason: reason
        });
        alert('Moderator demoted to User');
        loadMods();
    }
}

async function quickDemote(modId) {
    const reason = prompt('Reason for demotion:');
    if (!reason) return;
    
    document.getElementById('demoteModId').value = modId;
    document.getElementById('demoteReason').value = reason;
    demoteMod();
}

async function loadPendingAds() {
    try {
        const { data: ads } = await supabase
            .from('ads')
            .select('*')
            .eq('status', 'pending')
            .order('created_at', { ascending: false });
        
        const list = document.getElementById('pendingAdsList');
        
        if (!ads || ads.length === 0) {
            list.innerHTML = '<p style="text-align: center; color: var(--text-dim);">No pending ads</p>';
            return;
        }
        
        list.innerHTML = ads.map(ad => `
            <div class="item">
                <div>
                    <strong>Ad ID: ${ad.id}</strong><br>
                    <small>By: ${ad.user_id}</small>
                </div>
                <div class="item-actions">
                    <button class="btn" onclick="reviewAd('${ad.id}')">Review</button>
                </div>
            </div>
        `).join('');
    } catch (error) {
        console.error('Error loading pending ads:', error);
    }
}

async function reviewAd(adId) {
    const { data: ad } = await supabase
        .from('ads')
        .select('*')
        .eq('id', adId)
        .single();
    
    document.getElementById('reviewAdId').value = ad.id;
    document.getElementById('adPreview').innerHTML = `
        <h3>${ad.title || 'No title'}</h3>
        <p>${ad.content || 'No content'}</p>
        ${ad.image_url ? `<img src="${ad.image_url}" style="max-width: 100%; margin-top: 1rem;">` : ''}
    `;
    document.getElementById('adReviewSection').style.display = 'block';
}

async function approveAd() {
    const adId = document.getElementById('reviewAdId').value;
    const notes = document.getElementById('adReviewNotes').value;
    const message = document.getElementById('adMessage').value;
    
    const { error } = await supabase
        .from('ads')
        .update({ 
            status: 'approved', 
            approved_by: currentUser.username,
            approval_notes: notes 
        })
        .eq('id', adId);
    
    if (!error) {
        if (message) {
            const { data: ad } = await supabase.from('ads').select('user_id').eq('id', adId).single();
            await supabase.from('messages').insert({
                to_user: ad.user_id,
                from_user: 'system',
                content: message
            });
        }
        alert('Ad approved');
        document.getElementById('adReviewSection').style.display = 'none';
        loadPendingAds();
    }
}

async function denyAd() {
    const adId = document.getElementById('reviewAdId').value;
    const notes = document.getElementById('adReviewNotes').value;
    const message = document.getElementById('adMessage').value;
    
    if (!notes) {
        alert('Please provide a reason for denial');
        return;
    }

    const { error } = await supabase
        .from('ads')
        .update({ 
            status: 'denied', 
            denied_by: currentUser.username,
            denial_reason: notes 
        })
        .eq('id', adId);
    
    if (!error) {
        if (message) {
            const { data: ad } = await supabase.from('ads').select('user_id').eq('id', adId).single();
            await supabase.from('messages').insert({
                to_user: ad.user_id,
                from_user: 'system',
                content: message
            });
        }
        alert('Ad denied');
        document.getElementById('adReviewSection').style.display = 'none';
        loadPendingAds();
    }
}

async function reportToOwner() {
    const contentType = document.getElementById('reportContentType').value;
    const contentId = document.getElementById('reportContentId').value;
    const severity = document.getElementById('reportSeverity').value;
    const details = document.getElementById('reportDetails').value;
    
    if (!contentId || !details) {
        alert('Please fill in all required fields');
        return;
    }

    const { error } = await supabase
        .from('owner_reports')
        .insert({
            content_type: contentType,
            content_id: contentId,
            severity: severity,
            details: details,
            reported_by: currentUser.username,
            reporter_role: 'admin'
        });
    
    if (!error) {
        alert('Report sent to owner');
        document.getElementById('reportContentId').value = '';
        document.getElementById('reportDetails').value = '';
        loadMyReports();
    }
}

async function loadMyReports() {
    try {
        const { data: reports } = await supabase
            .from('owner_reports')
            .select('*')
            .eq('reported_by', currentUser.username)
            .order('created_at', { ascending: false });
        
        const list = document.getElementById('myReportsList');
        
        if (!reports || reports.length === 0) {
            list.innerHTML = '<p style="text-align: center; color: var(--text-dim);">No reports submitted</p>';
            return;
        }
        
        list.innerHTML = reports.map(report => `
            <div class="item">
                <div>
                    <strong>${report.content_type} - ${report.severity}</strong><br>
                    <small>${report.details.substring(0, 100)}...</small><br>
                    <small>Status: ${report.status || 'pending'}</small>
                </div>
            </div>
        `).join('');
    } catch (error) {
        console.error('Error loading reports:', error);
    }
}

function reportContent(type, id) {
    switchTab('reports');
    document.getElementById('reportContentType').value = type;
    document.getElementById('reportContentId').value = id;
}

async function logout() {
    await supabase.auth.signOut();
    window.location.href = 'login.html';
}

function loadAllData() {
    loadPosts();
    loadComments();
    loadMods();
    loadPendingAds();
    loadMyReports();
}

if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', init);
} else {
    init();
}
```

---

