<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Profile - 8BFR Music Network</title>
  <link rel="stylesheet" href="styles.css">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2" data-8bfr-supabase="1" defer></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { padding-bottom: 80px; background: linear-gradient(#0b0014,#000); color: #eae6ff; font-family: system-ui, -apple-system, sans-serif; }
    .profile-header { background: rgba(12,6,24,0.85); border: 1px solid rgba(124,58,237,0.35); border-radius: 16px; padding: 2rem; margin-bottom: 1.5rem; }
    .avatar-ring { width: 110px; height: 110px; border-radius: 50%; background: linear-gradient(135deg, #7c3aed, #a855f7); display: flex; align-items: center; justify-content: center; font-size: 2.8rem; flex-shrink: 0; overflow: hidden; border: 3px solid rgba(124,58,237,0.5); }
    .avatar-ring img { width: 100%; height: 100%; object-fit: cover; }
    .badge { background: rgba(124,58,237,0.15); border: 1px solid rgba(124,58,237,0.4); color: #a855f7; padding: 0.3rem 0.75rem; border-radius: 20px; font-size: 0.78rem; font-weight: 600; display: inline-block; margin: 0.2rem; }
    .badge.verified { border-color: #00d9ff; color: #00d9ff; background: rgba(0,217,255,0.08); }
    .badge.owner { border-color: #f59e0b; color: #f59e0b; background: rgba(245,158,11,0.08); }
    .card { background: rgba(12,6,24,0.7); border: 1px solid rgba(124,58,237,0.3); border-radius: 12px; padding: 1.5rem; margin-bottom: 1.5rem; }
    .card h2 { color: #a855f7; margin-bottom: 1rem; font-size: 1.1rem; font-weight: 700; }
    .form-group { margin-bottom: 1.25rem; }
    .form-group label { display: block; margin-bottom: 0.4rem; font-size: 0.88rem; font-weight: 600; color: rgba(234,230,255,0.75); }
    .form-input { width: 100%; padding: 0.7rem 0.9rem; background: rgba(12,0,25,0.9); border: 1px solid rgba(124,58,237,0.35); border-radius: 8px; color: #eae6ff; font-size: 0.93rem; }
    .form-input:focus { outline: none; border-color: #a855f7; }
    .btn { background: #7c3aed; color: white; border: none; padding: 0.7rem 1.5rem; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 0.9rem; transition: all 0.2s; }
    .btn:hover { background: #6d28d9; }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; }
    .btn-green { background: #059669; }
    .btn-green:hover { background: #047857; }
    .btn-red { background: #dc2626; }
    .btn-red:hover { background: #b91c1c; }
    .song-row { display: flex; align-items: center; gap: 0.75rem; background: rgba(0,0,0,0.3); border: 1px solid rgba(124,58,237,0.2); border-radius: 10px; padding: 0.85rem 1rem; margin-bottom: 0.6rem; }
    .song-cover { width: 46px; height: 46px; border-radius: 8px; background: linear-gradient(135deg,#7c3aed,#a855f7); display: flex; align-items: center; justify-content: center; font-size: 1.3rem; flex-shrink: 0; overflow: hidden; }
    .song-cover img { width: 100%; height: 100%; object-fit: cover; }
    .song-info { flex: 1; min-width: 0; }
    .song-title { font-weight: 700; font-size: 0.92rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .song-meta { font-size: 0.78rem; color: rgba(168,85,247,0.7); margin-top: 0.1rem; }
    .play-btn { width: 38px; height: 38px; border-radius: 50%; background: #7c3aed; border: none; color: white; font-size: 1rem; cursor: pointer; flex-shrink: 0; display: flex; align-items: center; justify-content: center; }
    .play-btn:hover { background: #6d28d9; }
    .upload-zone { border: 2px dashed rgba(124,58,237,0.4); border-radius: 10px; padding: 2rem; text-align: center; cursor: pointer; transition: all 0.2s; }
    .upload-zone:hover, .upload-zone.drag-over { border-color: #a855f7; background: rgba(124,58,237,0.06); }
    .upload-zone input[type=file] { display: none; }
    .progress-bar { height: 6px; background: rgba(124,58,237,0.2); border-radius: 3px; margin-top: 0.75rem; overflow: hidden; }
    .progress-fill { height: 100%; background: linear-gradient(90deg,#7c3aed,#a855f7); border-radius: 3px; transition: width 0.3s; }
    .owner-pick-badge { background: linear-gradient(135deg,#f59e0b,#d97706); color: white; padding: 0.15rem 0.5rem; border-radius: 20px; font-size: 0.68rem; font-weight: 700; }
    .spinner { width: 32px; height: 32px; border-radius: 50%; border: 3px solid rgba(168,85,247,0.2); border-top-color: #a855f7; animation: spin 0.7s linear infinite; margin: 2rem auto; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .tab-btn { background: transparent; border: none; color: rgba(234,230,255,0.6); padding: 0.6rem 1rem; cursor: pointer; font-weight: 600; border-bottom: 2px solid transparent; font-size: 0.9rem; }
    .tab-btn.active { color: #a855f7; border-bottom-color: #a855f7; }
    audio { width: 100%; border-radius: 8px; margin-top: 0.5rem; }
  </style>
</head>
<body>

  <header class="px-4 py-4" style="background:rgba(15,0,30,0.9);border-bottom:1px solid rgba(124,58,237,0.5);position:sticky;top:0;z-index:100;">
    <div class="max-w-4xl mx-auto flex items-center justify-between">
      <a href="index.html" style="color:#a855f7;font-weight:600;text-decoration:none;">â† Home</a>
      <h1 class="text-xl font-extrabold" id="pageTitle">ğŸ‘¤ Profile</h1>
      <div style="width:60px;"></div>
    </div>
  </header>

  <div class="max-w-4xl mx-auto px-4 mt-5">
    <div id="loadingSpinner">
      <div class="spinner"></div>
    </div>
    <div id="profileContent" style="display:none;"></div>
  </div>

  <!-- Create Post Modal -->
  <div id="createPostModal" style="display:none;position:fixed;inset:0;z-index:10000;background:rgba(0,0,0,0.8);backdrop-filter:blur(6px);align-items:center;justify-content:center;padding:1rem;">
    <div style="background:rgba(12,6,24,0.98);border:1px solid rgba(124,58,237,0.5);border-radius:18px;width:100%;max-width:460px;padding:1.5rem;box-shadow:0 20px 50px rgba(0,0,0,0.8);max-height:90vh;overflow-y:auto;">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1.25rem;">
        <h3 style="font-size:1.15rem;font-weight:800;color:#a855f7;">ğŸ“ Create Post</h3>
        <button onclick="closeCreatePost()" style="background:none;border:none;color:#eae6ff;font-size:1.5rem;cursor:pointer;padding:0.25rem;">âœ•</button>
      </div>
      <div style="display:flex;gap:0.5rem;margin-bottom:1.25rem;" id="postTypeButtons">
        <button type="button" class="postTypeBtn active" data-type="text" onclick="selectPostType('text')" style="flex:1;padding:0.65rem;border-radius:10px;border:1px solid rgba(124,58,237,0.4);background:#7c3aed;color:white;font-weight:600;cursor:pointer;font-size:0.85rem;">ğŸ“ Text</button>
        <button type="button" class="postTypeBtn" data-type="photo" onclick="selectPostType('photo')" style="flex:1;padding:0.65rem;border-radius:10px;border:1px solid rgba(124,58,237,0.4);background:rgba(124,58,237,0.2);color:white;font-weight:600;cursor:pointer;font-size:0.85rem;">ğŸ“· Photo</button>
        <button type="button" class="postTypeBtn" data-type="video" onclick="selectPostType('video')" style="flex:1;padding:0.65rem;border-radius:10px;border:1px solid rgba(124,58,237,0.4);background:rgba(124,58,237,0.2);color:white;font-weight:600;cursor:pointer;font-size:0.85rem;">ğŸ¬ Video</button>
      </div>
      <input type="hidden" id="postMediaType" value="text">
      <div style="margin-bottom:1rem;">
        <textarea id="postText" placeholder="What's on your mind? Share an update, thought, or announcementâ€¦" style="width:100%;min-height:120px;padding:0.85rem;background:rgba(12,0,25,0.9);border:1px solid rgba(124,58,237,0.35);border-radius:10px;color:#eae6ff;font-size:0.93rem;resize:vertical;font-family:inherit;"></textarea>
      </div>
      <div id="postMediaUrlGroup" style="display:none;margin-bottom:1rem;">
        <label style="display:block;margin-bottom:0.4rem;font-size:0.85rem;font-weight:600;color:rgba(234,230,255,0.75);">ğŸ”— Media URL</label>
        <input type="url" id="postMediaUrl" placeholder="Paste image or video URL" style="width:100%;padding:0.7rem 0.9rem;background:rgba(12,0,25,0.9);border:1px solid rgba(124,58,237,0.35);border-radius:8px;color:#eae6ff;font-size:0.93rem;">
        <div style="font-size:0.75rem;color:rgba(168,85,247,0.5);margin-top:0.4rem;">ğŸ“· Photos: Direct image links (Imgur, Postimg)<br>ğŸ¬ Videos: YouTube, TikTok, or direct video URLs</div>
      </div>
      <div style="display:flex;gap:0.75rem;align-items:center;">
        <button id="submitPostBtn" onclick="submitPost()" style="flex:1;padding:0.75rem;background:linear-gradient(135deg,#7c3aed,#a855f7);color:white;border:none;border-radius:10px;font-weight:700;font-size:0.95rem;cursor:pointer;">ğŸ“¤ Post</button>
        <button onclick="closeCreatePost()" style="padding:0.75rem 1.25rem;background:rgba(124,58,237,0.15);color:#a855f7;border:1px solid rgba(124,58,237,0.3);border-radius:10px;font-weight:600;cursor:pointer;">Cancel</button>
      </div>
      <div id="postNotice" style="margin-top:0.75rem;font-size:0.85rem;text-align:center;"></div>
    </div>
  </div>

  <script>
  document.addEventListener('DOMContentLoaded', function() {

  // Debug functions (bar hidden, calls kept for safety)
  (function() {
    var d = document.createElement('div');
    d.id = 'mobileDebug';
    d.style.cssText = 'display:none;';
    document.body.appendChild(d);
  })();
  function dbgEarly(msg) {
    var el = document.getElementById('mobileDebug');
    if (el && el.style.display !== 'none') el.innerHTML += msg + '<br>';
  }
  function dbg(msg) { dbgEarly(msg); }

  let db;
  if (window._8bfrSupabaseClient) {
    db = window._8bfrSupabaseClient;
    dbgEarly('âœ… Using shared Supabase client');
  } else if (window.supabase && window.supabase.createClient) {
    const SUPABASE_URL = 'https://novbuvwpjnxwwvdekjhr.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5vdmJ1dndwam54d3d2ZGVramhyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjExODkxODUsImV4cCI6MjA3Njc2NTE4NX0.1UUkdGafh6ZplAX8hi7Bvj94D2gvFQZUl0an1RvcSA0';
    db = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    dbgEarly('âœ… Supabase client created');
  } else {
    dbgEarly('âŒ Supabase not available!');
    document.getElementById('loadingSpinner').innerHTML =
      '<div style="text-align:center;padding:2rem;color:#f87171;">âŒ Supabase failed to load. <a href="." style="color:#a855f7;">Refresh</a></div>';
    return;
  }

  const BADGE_ICONS = {
    artist:'ğŸ¤', beatmaker:'ğŸšï¸', producer:'ğŸ§', singer:'ğŸ™ï¸', musician:'ğŸ¸',
    engineer:'ğŸ›ï¸', songwriter:'ğŸ¼', dj:'ğŸ“€', rapper:'ğŸ¤', label:'ğŸ·ï¸',
    promoter:'ğŸš€', designer:'ğŸ¨', author:'ğŸ“–', blogger:'ğŸ“°', developer:'ğŸ§ ',
    streamer:'ğŸ“¡', gamer:'ğŸ®', game_creator:'ğŸ®', influencer:'ğŸ’«',
    community_leader:'ğŸ‘¥', fan:'ğŸ’', supporter:'ğŸ¤', mentor:'ğŸ§­',
    owner:'ğŸ‘‘', admin:'âš™ï¸', mod:'ğŸ’¬', g7:'ğŸ‘‘',
    verified:'ğŸ›¡ï¸', founder:'âš¡', vip_member:'ğŸ–ï¸', donor:'ğŸ’°',
    sponsor:'ğŸ’µ', beta_tester:'ğŸ§ª', early_supporter:'ğŸ«', top_creator:'ğŸ…'
  };

  const MUSIC_ROLES = ['artist','beatmaker','producer','singer','musician','engineer','songwriter','dj','rapper'];

  let currentUser = null;
  let profileData = null;
  let isOwnProfile = false;
  let uploadingCover = false;

  function showError(msg) {
    document.getElementById('loadingSpinner').style.display = 'none';
    document.getElementById('profileContent').style.display = 'block';
    document.getElementById('profileContent').innerHTML =
      `<div style="text-align:center;padding:4rem;color:rgba(168,85,247,0.7);line-height:1.8;">${msg}</div>`;
  }

  async function init() {
    try {
    dbg('â³ Starting...');
    const params = new URLSearchParams(window.location.search);
    const viewId = params.get('id');

    dbg('â³ Checking auth...');
    let user = null;
    try {
      const { data: { session }, error: sessionErr } = await db.auth.getSession();
      if (sessionErr) { console.error('Auth session error:', sessionErr); dbg('âš ï¸ Auth error: ' + sessionErr.message); }
      user = session?.user || null;
    } catch(authEx) {
      console.error('Auth exception:', authEx);
      dbg('âš ï¸ Auth issue: ' + authEx.message + ' â€” continuing as guest');
    }
    currentUser = user;
    dbg(user ? 'âœ… Logged in: ' + user.email : 'âš ï¸ Not logged in (guest)');

    const targetId = viewId || (currentUser ? currentUser.id : null);

    if (!targetId) {
      showError('Please <a href="login.html" style="color:#a855f7;text-decoration:underline;">log in</a> to view your profile.');
      return;
    }

    dbg('â³ Loading profile for: ' + targetId.substring(0,8) + '...');
    isOwnProfile = !viewId || (currentUser && viewId === currentUser.id);

    const { data: profile, error } = await db
      .from('profiles')
      .select('*, paypal_email, music_section_hidden')
      .eq('user_id', targetId)
      .maybeSingle();

    if (error) { dbg('âŒ Profile error: ' + error.message); showError('Error loading profile: ' + error.message); return; }
    dbg(profile ? 'âœ… Profile found: ' + profile.username : 'âš ï¸ No profile row found');

    if (!profile) {
      if (isOwnProfile && currentUser) {
        showError('Your profile row doesn\'t exist in Supabase yet.<br>Go to <a href="owner-panel.html" style="color:#a855f7;text-decoration:underline;">Owner Panel â†’ Create Profile</a> and create one for your account.');
      } else {
        showError('Profile not found for ID: ' + targetId);
      }
      return;
    }

    profileData = profile;
    document.getElementById('pageTitle').textContent = isOwnProfile ? 'ğŸ‘¤ My Profile' : 'ğŸ‘¤ ' + (profile.display_name || profile.username || 'Profile');
    document.title = (profile.display_name || profile.username || 'Profile') + ' â€” 8BFR Music Network';

    dbg('âœ… Rendering...');
    document.getElementById('loadingSpinner').style.display = 'none';
    document.getElementById('profileContent').style.display = 'block';
    renderProfile();
    } catch(err) { showError('Error: ' + err.message); }
  }

  // â”€â”€ RENDER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function renderProfile() {
    const p = profileData;
    const tags = Array.isArray(p.tags) ? p.tags : [];
    const isMusicCreator = tags.some(t => MUSIC_ROLES.includes(t)) || MUSIC_ROLES.includes(p.role);

    const avatarHtml = p.avatar_url
      ? `<img src="${p.avatar_url}" alt="${p.display_name||p.username}" onerror="this.parentNode.textContent='ğŸ‘¤'">`
      : 'ğŸ‘¤';

    const badgesHtml = tags.map(t => {
      const cls = t === 'verified' ? 'badge verified' : (t === 'owner' || t === 'admin') ? 'badge owner' : 'badge';
      return `<span class="${cls}">${BADGE_ICONS[t]||'ğŸ·ï¸'} ${t}</span>`;
    }).join('') || '<span style="color:rgba(168,85,247,0.4);font-size:0.85rem;">No badges</span>';

    const verifiedHtml = p.verified_artist ? '<span style="color:#00d9ff;font-size:1.1rem;margin-left:6px;">âœ“</span>' : '';

    let html = `
    <div class="profile-header">
      <div style="display:flex;gap:1.5rem;align-items:flex-start;flex-wrap:wrap;">
        <div class="avatar-ring" id="avatarDisplay">${avatarHtml}</div>
        <div style="flex:1;min-width:280px;max-width:100%;">
          <h2 style="font-size:1.7rem;font-weight:800;margin-bottom:0.3rem;">${p.display_name||p.username||'Unknown'}${verifiedHtml}</h2>
          <div style="color:#a855f7;font-size:0.9rem;margin-bottom:0.75rem;">${(p.role||'').toUpperCase()}</div>
          <p style="color:rgba(234,230,255,0.7);font-size:0.92rem;margin-bottom:1rem;line-height:1.6;max-height:150px;overflow-y:auto;padding-right:0.5rem;width:100%;">${p.bio||'No bio yet.'}</p>
          <div style="display:flex;flex-wrap:wrap;gap:0.5rem;max-width:100%;">${badgesHtml}</div>
          <div id="followCounts" style="margin-top:0.75rem;font-size:0.9rem;color:#a855f7;display:flex;gap:1rem;flex-wrap:wrap;"></div>
        </div>
      </div>
    </div>`;

    // â”€â”€ SONGS SECTION â”€â”€
    if (isMusicCreator) {
      html += `
    <div class="card">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:1rem;">
        <h2 style="margin:0;">ğŸµ ${isOwnProfile ? 'My' : (p.display_name||p.username||'Their')+"'s"} Songs</h2>
        ${isOwnProfile ? `<button class="btn" onclick="toggleUploadForm()">+ Upload Song</button>` : ''}
      </div>
      ${isOwnProfile ? `
      <div id="uploadForm" style="display:none;background:rgba(0,0,0,0.3);border-radius:10px;padding:1.25rem;margin-bottom:1.25rem;border:1px solid rgba(124,58,237,0.25);">
        <h3 style="font-size:0.95rem;font-weight:700;margin-bottom:1rem;color:#a855f7;">ğŸ“¤ Upload New Song</h3>
        <div class="form-group">
          <label>Song Title *</label>
          <input class="form-input" type="text" id="uploadTitle" placeholder="e.g. Killa Bees">
        </div>
        <div class="form-group">
          <label>Artist Name</label>
          <input class="form-input" type="text" id="uploadArtist" placeholder="Your artist name">
        </div>
        <div class="form-group">
          <label>Audio File * (MP3, WAV, M4A)</label>
          <div class="upload-zone" id="audioZone" onclick="document.getElementById('audioFile').click()">
            <input type="file" id="audioFile" accept=".mp3,audio/mpeg" onchange="handleAudioSelect(event)">
            <div id="audioZoneText">ğŸµ Click to select audio file</div>
          </div>
        </div>
        <div class="form-group">
          <label>Cover Art (optional)</label>
          <div class="upload-zone" id="coverZone" onclick="document.getElementById('coverFile').click()">
            <input type="file" id="coverFile" accept="image/*" onchange="handleCoverSelect(event)">
            <div id="coverZoneText">ğŸ–¼ï¸ Click to select cover image</div>
          </div>
        </div>
        <div class="form-group">
          <label>Download Price (leave blank for free)</label>
          <input class="form-input" type="number" id="uploadPrice" placeholder="e.g. 1.99" min="0" step="0.01">
        </div>
        <div class="form-group">
          <label>Explicit Content</label>
          <select class="form-input" id="uploadExplicit">
            <option value="false">No</option>
            <option value="true">Yes</option>
          </select>
        </div>
        <div id="uploadProgress" style="display:none;">
          <div style="font-size:0.85rem;color:#a855f7;margin-bottom:0.4rem;" id="uploadStatus">Uploadingâ€¦</div>
          <div class="progress-bar"><div class="progress-fill" id="progressFill" style="width:0%"></div></div>
        </div>
        <div style="display:flex;gap:0.75rem;margin-top:1rem;">
          <button class="btn btn-green" onclick="uploadSong()" id="uploadBtn">â¬†ï¸ Upload Song</button>
          <button class="btn" style="background:rgba(124,58,237,0.2);" onclick="toggleUploadForm()">Cancel</button>
        </div>
        <div id="uploadNotice" style="margin-top:0.75rem;font-size:0.85rem;"></div>
      </div>
      ` : ''}
      <div id="songList"><div class="spinner"></div></div>
    </div>`;
    }

    // â”€â”€ EDIT FORM (own profile only) â”€â”€
    if (isOwnProfile) {
      html += `
    <div class="card">
      <h2>âœï¸ Edit Profile</h2>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:1rem;">
        <div class="form-group">
          <label>Username</label>
          <input class="form-input" type="text" id="editUsername" value="${p.username||''}">
        </div>
        <div class="form-group">
          <label>Display Name</label>
          <input class="form-input" type="text" id="editDisplayName" value="${p.display_name||''}">
        </div>
      </div>
      <div class="form-group">
        <label>Bio</label>
        <textarea class="form-input" id="editBio" rows="3">${p.bio||''}</textarea>
      </div>
      <div class="form-group">
        <label>Avatar URL (paste a direct image link)</label>
        <input class="form-input" type="url" id="editAvatar" value="${p.avatar_url||''}" placeholder="https://â€¦">
      </div>
      ${isMusicCreator ? `<div class="form-group">
        <label>PayPal Email (for receiving payments)</label>
        <input class="form-input" type="email" id="editPaypal" value="${p.paypal_email||''}" placeholder="your@paypal.com">
      </div>` : ''}
      <button class="btn" onclick="saveProfile()">ğŸ’¾ Save Changes</button>
      <span id="saveNotice" style="margin-left:1rem;font-size:0.85rem;"></span>
    </div>`;
    }

    // â”€â”€ POSTS SECTION â”€â”€
    html += `
    <div class="card">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:1rem;">
        <h2 style="margin:0;">ğŸ“ ${isOwnProfile ? 'My' : (p.display_name||p.username||"Their")+"'s"} Posts</h2>
        ${isOwnProfile ? '<button class="btn" onclick="openCreatePost()">+ Create Post</button>' : ''}
      </div>
      <div id="postList"><div class="spinner"></div></div>
    </div>`;

    document.getElementById('profileContent').innerHTML = html;

    if (isMusicCreator) loadSongs(profileData.user_id);
    loadPosts(profileData.user_id);
    loadFollowCounts(profileData.user_id);
  }

  // â”€â”€ LOAD SONGS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function loadSongs(userId) {
    const el = document.getElementById('songList');
    if (!el) return;
    
    if (profileData && profileData.music_section_hidden && !isOwnProfile) {
      el.innerHTML = `
        <div style="background:rgba(239,68,68,0.1);border:1px solid rgba(239,68,68,0.3);border-radius:8px;padding:2rem;text-align:center;">
          <p style="color:#ef4444;font-size:1rem;font-weight:600;margin-bottom:0.5rem;">ğŸš« Music Section Temporarily Hidden</p>
          <p style="color:rgba(239,68,68,0.8);font-size:0.85rem;">This artist's music is currently unavailable.</p>
        </div>`;
      return;
    }
    
    try {
      const { data: songs, error } = await db.from('songs')
        .select('id, title, artist, cover_art, song_url, explicit, featured, price')
        .eq('uploaded_by', userId)
        .order('created_at', { ascending: false });

      if (error) throw error;

      if (!songs || songs.length === 0) {
        el.innerHTML = '<div style="text-align:center;padding:2rem;color:rgba(168,85,247,0.5);font-size:0.9rem;">No songs yet' + (isOwnProfile ? ' â€” upload your first song above!' : '.') + '</div>';
        return;
      }

      let purchasedSongIds = [];
      if (currentUser && !isOwnProfile) {
        const { data: purchases } = await db.from('song_purchases').select('song_id').eq('buyer_id', currentUser.id);
        if (purchases) purchasedSongIds = purchases.map(p => p.song_id);
      }

      el.innerHTML = songs.map(s => {
        const cover = s.cover_art ? `<img src="${s.cover_art}" alt="${s.title}" onerror="this.parentNode.textContent='ğŸµ'">` : 'ğŸµ';
        const featuredBadge = s.featured ? '<span class="owner-pick-badge" style="margin-left:0.4rem;">â­ Featured</span>' : '';
        const deleteBtnHtml = isOwnProfile ? `<button class="btn btn-red" style="padding:0.4rem 0.75rem;font-size:0.8rem;" onclick="deleteSong('${s.id}')">ğŸ—‘ï¸</button>` : '';
        const price = parseFloat(s.price) || 0;
        const priceDisplay = price > 0 ? `<span style="color:#4ade80;font-weight:600;font-size:0.85rem;margin-left:0.5rem;">$${price.toFixed(2)}</span>` : '';
        
        let discountInput = '';
        let downloadBtn = '';
        if (s.song_url && !isOwnProfile) {
          const hasPurchased = purchasedSongIds.includes(s.id);
          if (price > 0) {
            if (hasPurchased) {
              downloadBtn = `<a href="${s.song_url}" download class="btn" style="padding:0.4rem 0.75rem;font-size:0.8rem;background:#4ade80;text-decoration:none;margin-left:0.5rem;">â¬‡ï¸ Download</a>`;
            } else {
              discountInput = `
                <div style="margin-top:0.75rem;">
                  <div style="display:flex;gap:0.5rem;align-items:center;margin-bottom:0.5rem;">
                    <input type="text" id="discount-${s.id}" placeholder="Discount code" style="padding:0.4rem;font-size:0.8rem;background:#0b0014;border:1px solid rgba(124,58,237,0.4);border-radius:6px;color:#eae6ff;flex:1;max-width:150px;">
                    <button onclick="applyDiscount('${s.id}', ${price})" class="btn" style="padding:0.4rem 0.75rem;font-size:0.8rem;">Apply</button>
                    <span id="discount-msg-${s.id}" style="font-size:0.75rem;"></span>
                  </div>
                  <div id="paypal-${s.id}" style="max-width:300px;"></div>
                </div>`;
            }
          } else {
            downloadBtn = `<a href="${s.song_url}" download class="btn" style="padding:0.4rem 0.75rem;font-size:0.8rem;background:#a855f7;text-decoration:none;margin-left:0.5rem;">â¬‡ï¸ Download</a>`;
          }
        }
        
        return `
        <div class="song-row" id="song-${s.id}">
          <div class="song-cover">${cover}</div>
          <div class="song-info">
            <div class="song-title">${s.title||'Untitled'}${s.explicit ? ' <span style="color:#ef4444;font-size:0.7rem;">ğŸ”</span>' : ''}${featuredBadge}${priceDisplay}</div>
            <div class="song-meta">${s.artist||''}</div>
            ${s.song_url ? `<audio controls src="${s.song_url}" preload="none" style="height:32px;margin-top:6px;"></audio>` : ''}
            ${discountInput}
          </div>
          ${downloadBtn}
          ${deleteBtnHtml}
        </div>`;
      }).join('');

      // Render trust payment buttons for unpurchased paid songs
      if (!isOwnProfile) {
        songs.forEach(s => {
          const price = parseFloat(s.price) || 0;
          const hasPurchased = purchasedSongIds.includes(s.id);
          if (price > 0 && !hasPurchased && s.song_url) {
            const container = document.getElementById(`paypal-${s.id}`);
            if (container) {
              let finalPrice = price;
              const discount = appliedDiscounts[s.id];
              if (discount) {
                if (discount.is_free) { finalPrice = 0; } else { finalPrice = Math.max(0, price - (parseFloat(discount.discount_amount) || 0)); }
              }
              if (finalPrice === 0 && discount) {
                container.innerHTML = `<button class="btn" style="background:#00ff88;color:#000;font-weight:700;" onclick="claimFreeSong('${s.id}', '${discount.code}')">Claim Free</button>`;
                return;
              }
              const artistPayPal = profileData.paypal_email;
              if (!artistPayPal) { container.innerHTML = `<p style="font-size:0.75rem;color:#ef4444;">Artist hasn't set up payments yet</p>`; return; }
              container.innerHTML = `
                <div style="background:rgba(124,58,237,0.1);border:1px solid rgba(124,58,237,0.3);padding:0.75rem;border-radius:8px;max-width:350px;">
                  <p style="font-size:0.8rem;margin-bottom:0.5rem;color:#a855f7;"><strong>ğŸ’³ Pay Artist Directly:</strong></p>
                  <p style="font-size:0.75rem;margin-bottom:0.75rem;color:rgba(234,230,255,0.9);">Send <strong>$${finalPrice.toFixed(2)}</strong> to:<br><code style="background:rgba(0,0,0,0.3);padding:0.25rem 0.5rem;border-radius:4px;font-size:0.85rem;">${artistPayPal}</code></p>
                  <button class="btn" onclick="markSongAsPaid('${s.id}', ${finalPrice}, '${artistPayPal}')" style="width:100%;font-size:0.85rem;background:#4ade80;color:#000;">âœ“ I Sent Payment</button>
                  <p style="font-size:0.7rem;margin-top:0.5rem;color:rgba(168,85,247,0.6);font-style:italic;">Honor system - click after sending via PayPal</p>
                </div>`;
            }
          }
        });
      }
    } catch (err) {
      el.innerHTML = `<div style="color:#ef4444;font-size:0.85rem;padding:1rem;">Error loading songs: ${err.message}</div>`;
    }
  }

  // â”€â”€ LOAD POSTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function loadPosts(userId) {
    const el = document.getElementById('postList');
    if (!el) return;
    try {
      const { data: posts, error } = await db.from('posts')
        .select('id, text, media, media_type, likes, shares, favorites, comments, created_at')
        .eq('user_id', userId)
        .order('created_at', { ascending: false })
        .limit(20);
      if (error) throw error;
      if (!posts || posts.length === 0) {
        el.innerHTML = '<div style="text-align:center;padding:2rem;color:rgba(168,85,247,0.5);font-size:0.9rem;">No posts yet' + (isOwnProfile ? ' â€” create your first post above!' : '.') + '</div>';
        return;
      }
      el.innerHTML = posts.map(p => {
        const timeAgo = getTimeAgo(p.created_at);
        let mediaHtml = '';
        if (p.media && (p.media_type === 'photo' || p.media_type === 'image')) {
          mediaHtml = '<div style="margin-top:0.75rem;border-radius:10px;overflow:hidden;"><img src="' + p.media + '" alt="Post" style="width:100%;max-height:400px;object-fit:cover;border-radius:10px;" onerror="this.style.display=\'none\'"></div>';
        } else if (p.media && p.media_type === 'video') {
          const ytMatch = p.media.match(/(?:youtube\.com\/watch\?v=|youtu\.be\/|youtube\.com\/embed\/)([a-zA-Z0-9_-]{11})/);
          if (ytMatch) {
            mediaHtml = '<div style="margin-top:0.75rem;border-radius:10px;overflow:hidden;position:relative;padding-bottom:56.25%;height:0;"><iframe src="https://www.youtube.com/embed/' + ytMatch[1] + '" style="position:absolute;top:0;left:0;width:100%;height:100%;border:none;border-radius:10px;" allowfullscreen></iframe></div>';
          } else {
            mediaHtml = '<div style="margin-top:0.75rem;"><a href="' + p.media + '" target="_blank" rel="noopener" style="color:#00d9ff;font-size:0.85rem;">ğŸ¬ Watch Video â†’</a></div>';
          }
        } else if (p.media && p.media_type === 'audio') {
          mediaHtml = '<div style="margin-top:0.75rem;"><audio controls preload="none" style="width:100%;"><source src="' + p.media + '"></audio></div>';
        }
        const deleteBtn = isOwnProfile ? '<button onclick="deletePost(\'' + p.id + '\')" style="background:none;border:none;color:rgba(239,68,68,0.6);cursor:pointer;font-size:0.8rem;">ğŸ—‘ï¸</button>' : '';
        return '<div style="background:rgba(0,0,0,0.3);border:1px solid rgba(124,58,237,0.2);border-radius:12px;padding:1rem;margin-bottom:0.75rem;">' +
          '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:0.5rem;"><span style="font-size:0.78rem;color:rgba(168,85,247,0.6);">' + timeAgo + '</span>' + deleteBtn + '</div>' +
          (p.text ? '<div style="line-height:1.6;margin-bottom:0.25rem;">' + escapeHtml(p.text) + '</div>' : '') +
          mediaHtml +
          '<div style="display:flex;gap:0.5rem;padding-top:0.5rem;margin-top:0.5rem;border-top:1px solid rgba(124,58,237,0.15);font-size:0.82rem;flex-wrap:wrap;">' +
            '<button onclick="interactPost(\'' + p.id + '\',\'like\',this)" style="background:none;border:none;color:#a855f7;cursor:pointer;padding:0.3rem 0.5rem;border-radius:6px;font-size:0.82rem;" onmouseover="this.style.background=\'rgba(124,58,237,0.15)\'" onmouseout="this.style.background=\'none\'">ğŸ¤ <span>' + (p.likes||0) + '</span></button>' +
            '<button onclick="interactPost(\'' + p.id + '\',\'comment\',this)" style="background:none;border:none;color:#a855f7;cursor:pointer;padding:0.3rem 0.5rem;border-radius:6px;font-size:0.82rem;" onmouseover="this.style.background=\'rgba(124,58,237,0.15)\'" onmouseout="this.style.background=\'none\'">ğŸ’¬ <span>' + (p.comments||0) + '</span></button>' +
            '<button onclick="interactPost(\'' + p.id + '\',\'share\',this)" style="background:none;border:none;color:#a855f7;cursor:pointer;padding:0.3rem 0.5rem;border-radius:6px;font-size:0.82rem;" onmouseover="this.style.background=\'rgba(124,58,237,0.15)\'" onmouseout="this.style.background=\'none\'">ğŸ” <span>' + (p.shares||0) + '</span></button>' +
            '<button onclick="interactPost(\'' + p.id + '\',\'favorite\',this)" style="background:none;border:none;color:#a855f7;cursor:pointer;padding:0.3rem 0.5rem;border-radius:6px;font-size:0.82rem;" onmouseover="this.style.background=\'rgba(124,58,237,0.15)\'" onmouseout="this.style.background=\'none\'">â­ <span>' + (p.favorites||0) + '</span></button>' +
          '</div></div>';
      }).join('');
    } catch (err) {
      el.innerHTML = '<div style="color:#ef4444;font-size:0.85rem;padding:1rem;">Error loading posts: ' + err.message + '</div>';
    }
  }

  function getTimeAgo(dateStr) {
    const diff = Date.now() - new Date(dateStr).getTime();
    const mins = Math.floor(diff / 60000);
    if (mins < 1) return 'Just now';
    if (mins < 60) return mins + 'm ago';
    const hrs = Math.floor(mins / 60);
    if (hrs < 24) return hrs + 'h ago';
    const days = Math.floor(hrs / 24);
    if (days < 30) return days + 'd ago';
    return new Date(dateStr).toLocaleDateString();
  }

  function escapeHtml(str) { const d = document.createElement('div'); d.textContent = str; return d.innerHTML; }

  // â”€â”€ CREATE POST â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function openCreatePost() { document.getElementById('createPostModal').style.display = 'flex'; }
  function closeCreatePost() {
    document.getElementById('createPostModal').style.display = 'none';
    document.getElementById('postText').value = '';
    document.getElementById('postMediaUrl').value = '';
    document.getElementById('postMediaType').value = 'text';
    document.getElementById('postMediaUrlGroup').style.display = 'none';
    document.getElementById('postNotice').textContent = '';
    document.querySelectorAll('.postTypeBtn').forEach(b => { b.style.background = 'rgba(124,58,237,0.2)'; });
    document.querySelector('.postTypeBtn[data-type="text"]').style.background = '#7c3aed';
  }

  function selectPostType(type) {
    document.getElementById('postMediaType').value = type;
    document.querySelectorAll('.postTypeBtn').forEach(b => { b.style.background = b.dataset.type === type ? '#7c3aed' : 'rgba(124,58,237,0.2)'; });
    const urlGroup = document.getElementById('postMediaUrlGroup');
    const urlInput = document.getElementById('postMediaUrl');
    if (type === 'text') { urlGroup.style.display = 'none'; urlInput.value = ''; }
    else {
      urlGroup.style.display = 'block';
      urlInput.placeholder = type === 'photo' ? 'Paste image URL (e.g. https://imgur.com/xxx.jpg)' : 'Paste video URL (e.g. YouTube, TikTok link)';
    }
  }

  async function submitPost() {
    if (!currentUser) { document.getElementById('postNotice').textContent = 'âŒ Please sign in'; document.getElementById('postNotice').style.color = '#ef4444'; return; }
    const text = document.getElementById('postText').value.trim();
    const mediaType = document.getElementById('postMediaType').value;
    const mediaUrl = document.getElementById('postMediaUrl').value.trim();
    if (!text && !mediaUrl) { document.getElementById('postNotice').textContent = 'âš ï¸ Write something or add media'; document.getElementById('postNotice').style.color = '#f59e0b'; return; }
    const btn = document.getElementById('submitPostBtn');
    btn.disabled = true; btn.textContent = 'Postingâ€¦';
    try {
      const { error } = await db.from('posts').insert({
        user_id: currentUser.id, text: text || null,
        media: (mediaType !== 'text' && mediaUrl) ? mediaUrl : null,
        media_type: mediaType, likes: 0, shares: 0, favorites: 0
      });
      if (error) throw error;
      document.getElementById('postNotice').textContent = 'âœ… Post created!';
      document.getElementById('postNotice').style.color = '#4ade80';
      setTimeout(() => { closeCreatePost(); loadPosts(currentUser.id); }, 800);
    } catch (err) {
      document.getElementById('postNotice').textContent = 'âŒ ' + err.message;
      document.getElementById('postNotice').style.color = '#ef4444';
    } finally { btn.disabled = false; btn.textContent = 'ğŸ“¤ Post'; }
  }

  async function deletePost(id) {
    if (!confirm('Delete this post?')) return;
    try { const { error } = await db.from('posts').delete().eq('id', id).eq('user_id', currentUser.id); if (error) throw error; loadPosts(currentUser.id); }
    catch (err) { alert('Error: ' + err.message); }
  }

  // Post interaction (like, comment, share, favorite) on profile page
  window.interactPost = async function(postId, action, btn) {
    if (!currentUser) { alert('Log in to interact with posts'); return; }
    try {
      const { data: post } = await db.from('posts').select('likes,comments,shares,favorites,user_id').eq('id', postId).single();
      if (!post) return;
      if (action === 'like') {
        const n = (post.likes||0) + 1;
        await db.from('posts').update({ likes: n }).eq('id', postId);
        btn.innerHTML = 'â¤ï¸ <span>' + n + '</span>';
        try { await db.rpc('add_algorithm_points', { p_user_id: post.user_id, p_action: 'receive_like', p_points: 2 }); } catch(e) {}
      } else if (action === 'comment') {
        const txt = prompt('Write a comment:');
        if (!txt || !txt.trim()) return;
        const n = (post.comments||0) + 1;
        await db.from('posts').update({ comments: n }).eq('id', postId);
        btn.innerHTML = 'ğŸ’¬ <span>' + n + '</span>';
        try { await db.rpc('add_algorithm_points', { p_user_id: post.user_id, p_action: 'receive_comment', p_points: 5 }); } catch(e) {}
      } else if (action === 'share') {
        const n = (post.shares||0) + 1;
        await db.from('posts').update({ shares: n }).eq('id', postId);
        btn.innerHTML = 'ğŸ” <span>' + n + '</span>';
        try { if (navigator.clipboard) await navigator.clipboard.writeText(location.origin + '/profile.html?id=' + post.user_id); alert('Link copied!'); } catch(e) {}
        try { await db.rpc('add_algorithm_points', { p_user_id: post.user_id, p_action: 'receive_share', p_points: 15 }); } catch(e) {}
      } else if (action === 'favorite') {
        const n = (post.favorites||0) + 1;
        await db.from('posts').update({ favorites: n }).eq('id', postId);
        btn.innerHTML = 'â­ <span>' + n + '</span>';
        try { await db.from('favorites').insert({ user_id: currentUser.id, target_type: 'post', target_id: postId }); } catch(e) {}
      }
      try { await db.rpc('recalc_post_score', { p_post_id: postId }); } catch(e) {}
    } catch(e) { console.error(e); }
  };

  // Load follower/following counts
  async function loadFollowCounts(userId) {
    try {
      const [followers, following, friends] = await Promise.all([
        db.from('follows').select('id', { count: 'exact', head: true }).eq('following_id', userId),
        db.from('follows').select('id', { count: 'exact', head: true }).eq('follower_id', userId),
        db.from('friends').select('id', { count: 'exact', head: true }).or('user_id.eq.' + userId + ',friend_id.eq.' + userId).eq('status', 'accepted')
      ]);
      const countsEl = document.getElementById('followCounts');
      if (countsEl) {
        countsEl.innerHTML = '<span style="cursor:pointer;" onclick="location.href=\'followers.html?id=' + userId + '\'"><strong>' + (followers.count||0) + '</strong> Followers</span> Â· ' +
          '<span style="cursor:pointer;" onclick="location.href=\'following.html?id=' + userId + '\'"><strong>' + (following.count||0) + '</strong> Following</span> Â· ' +
          '<span style="cursor:pointer;" onclick="location.href=\'friends.html?id=' + userId + '\'"><strong>' + (friends.count||0) + '</strong> Friends</span>';
      }
    } catch(e) { console.log('Follow counts:', e); }
  }

  // â”€â”€ UPLOAD HELPERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function toggleUploadForm() {
    const f = document.getElementById('uploadForm');
    f.style.display = f.style.display === 'none' ? 'block' : 'none';
  }

  let selectedAudio = null, selectedCover = null;
  const MAX_AUDIO_MB = 20;
  const ALLOWED_AUDIO_TYPES = ['audio/mpeg', 'audio/mp3'];

  function handleAudioSelect(e) {
    const file = e.target.files[0]; if (!file) return;
    if (!ALLOWED_AUDIO_TYPES.includes(file.type) && !file.name.toLowerCase().endsWith('.mp3')) { setUploadNotice('âŒ Only MP3 files are allowed.', '#ef4444'); e.target.value = ''; return; }
    if (file.size > MAX_AUDIO_MB * 1024 * 1024) { setUploadNotice(`âŒ File too large. Max is ${MAX_AUDIO_MB}MB.`, '#ef4444'); e.target.value = ''; return; }
    selectedAudio = file;
    document.getElementById('audioZoneText').textContent = `âœ… ${file.name} (${(file.size/1024/1024).toFixed(1)}MB)`;
    setUploadNotice('');
    const titleEl = document.getElementById('uploadTitle');
    if (!titleEl.value) titleEl.value = file.name.replace(/\.[^/.]+$/, '').replace(/[-_]/g,' ');
  }

  function handleCoverSelect(e) { const file = e.target.files[0]; if (!file) return; selectedCover = file; document.getElementById('coverZoneText').textContent = 'âœ… ' + file.name; }
  function setUploadNotice(msg, color) { const el = document.getElementById('uploadNotice'); if (el) { el.textContent = msg; el.style.color = color || '#a855f7'; } }
  function setProgress(pct, label) { document.getElementById('uploadProgress').style.display = 'block'; document.getElementById('progressFill').style.width = pct + '%'; document.getElementById('uploadStatus').textContent = label || 'Uploadingâ€¦'; }

  // â”€â”€ UPLOAD SONG â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function uploadSong() {
    if (!currentUser || !currentUser.id) { setUploadNotice('âŒ Please sign in to upload songs.', '#ef4444'); return; }
    const userId = currentUser.id;
    const title = document.getElementById('uploadTitle').value.trim();
    const artist = document.getElementById('uploadArtist').value.trim() || profileData?.display_name || profileData?.username || '';
    const explicit = document.getElementById('uploadExplicit').value === 'true';
    if (!title) { setUploadNotice('Song title is required.', '#ef4444'); return; }
    if (!selectedAudio) { setUploadNotice('Please select an audio file.', '#ef4444'); return; }
    const btn = document.getElementById('uploadBtn');
    btn.disabled = true; setProgress(10, 'Uploading audioâ€¦'); setUploadNotice('');
    try {
      const safeTitle = title.replace(/[^a-zA-Z0-9-]/g, '-').substring(0, 50);
      setUploadNotice('ğŸ“¤ Uploading ' + selectedAudio.name + '...', '#a855f7');
      const audioExt = selectedAudio.name.split('.').pop();
      const audioPath = `${userId}/songs/${Date.now()}-${safeTitle}.${audioExt}`;
      const { data: audioData, error: audioErr } = await db.storage.from('songs').upload(audioPath, selectedAudio, { contentType: selectedAudio.type, upsert: false });
      if (audioErr) { setUploadNotice('âŒ Storage error: ' + audioErr.message, '#ef4444'); throw new Error('Audio upload failed: ' + audioErr.message); }
      setUploadNotice('âœ… Audio uploaded', '#4ade80'); setProgress(60, 'Processing coverâ€¦');
      const { data: audioUrlData } = db.storage.from('songs').getPublicUrl(audioPath);
      const songUrl = audioUrlData.publicUrl;
      let coverUrl = null;
      if (selectedCover) {
        const coverExt = selectedCover.name.split('.').pop();
        const coverPath = `${userId}/covers/${Date.now()}.${coverExt}`;
        const { error: coverErr } = await db.storage.from('songs').upload(coverPath, selectedCover, { contentType: selectedCover.type, upsert: false });
        if (coverErr) { setUploadNotice('âš ï¸ Cover failed: ' + coverErr.message, '#f59e0b'); }
        else { const { data: coverUrlData } = db.storage.from('songs').getPublicUrl(coverPath); coverUrl = coverUrlData.publicUrl; }
      }
      setProgress(80, 'Saving to databaseâ€¦'); setUploadNotice('ğŸ’¾ Savingâ€¦', '#a855f7');
      const { error: insertErr } = await db.from('songs').insert({ title, artist, uploaded_by: userId, song_url: songUrl, cover_art: coverUrl, explicit, featured: false });
      if (insertErr) { setUploadNotice('âŒ Database error: ' + insertErr.message, '#ef4444'); throw new Error(insertErr.message); }
      setProgress(100, 'âœ… Upload complete!'); setUploadNotice('â­ "' + title + '" uploaded!', '#4ade80');
      selectedAudio = null; selectedCover = null;
      document.getElementById('uploadTitle').value = ''; document.getElementById('uploadArtist').value = ''; document.getElementById('uploadPrice').value = '';
      document.getElementById('audioZoneText').textContent = 'ğŸµ Click to select audio file'; document.getElementById('coverZoneText').textContent = 'ğŸ–¼ï¸ Click to select cover image';
      document.getElementById('audioFile').value = ''; document.getElementById('coverFile').value = '';
      setTimeout(() => { toggleUploadForm(); document.getElementById('uploadProgress').style.display = 'none'; loadSongs(currentUser.id); }, 1500);
    } catch (err) { setProgress(0, ''); document.getElementById('uploadProgress').style.display = 'none'; setUploadNotice('âŒ ' + err.message, '#ef4444'); }
    finally { btn.disabled = false; }
  }

  async function deleteSong(id) {
    if (!confirm('Delete this song? This cannot be undone.')) return;
    try { const { error } = await db.from('songs').delete().eq('id', id).eq('uploaded_by', currentUser.id); if (error) throw error; const row = document.getElementById('song-' + id); if (row) row.remove(); }
    catch (err) { alert('Error deleting: ' + err.message); }
  }

  async function saveProfile() {
    if (!currentUser || !currentUser.id) { const n = document.getElementById('saveNotice'); n.textContent = 'âŒ Please sign in'; n.style.color = '#ef4444'; return; }
    const username = document.getElementById('editUsername').value.trim();
    const displayName = document.getElementById('editDisplayName').value.trim();
    const bio = document.getElementById('editBio').value.trim();
    const avatarUrl = document.getElementById('editAvatar').value.trim();
    const paypalEl = document.getElementById('editPaypal');
    const paypalEmail = paypalEl ? paypalEl.value.trim() : null;
    const notice = document.getElementById('saveNotice');
    if (!username) { notice.textContent = 'âš ï¸ Username required'; notice.style.color = '#ef4444'; return; }
    try {
      const updates = { username, display_name: displayName, bio, avatar_url: avatarUrl || null };
      if (paypalEmail !== null) updates.paypal_email = paypalEmail || null;
      const { error } = await db.from('profiles').update(updates).eq('user_id', currentUser.id);
      if (error) throw error;
      notice.textContent = 'âœ… Saved!'; notice.style.color = '#4ade80';
      setTimeout(() => { notice.textContent = ''; }, 2500);
      if (avatarUrl) {
        const avatarEl = document.getElementById('avatarDisplay');
        if (avatarEl) avatarEl.innerHTML = `<img src="${avatarUrl}" alt="avatar" onerror="this.parentNode.textContent='ğŸ‘¤'" style="width:100%;height:100%;object-fit:cover;border-radius:50%;">`;
      }
    } catch (err) { notice.textContent = 'âŒ ' + err.message; notice.style.color = '#ef4444'; }
  }

  // â”€â”€ DRAG & DROP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  (function() {
    ['audioZone','coverZone'].forEach(id => {
      const zone = document.getElementById(id); if (!zone) return;
      zone.addEventListener('dragover', e => { e.preventDefault(); zone.classList.add('drag-over'); });
      zone.addEventListener('dragleave', () => zone.classList.remove('drag-over'));
      zone.addEventListener('drop', e => {
        e.preventDefault(); zone.classList.remove('drag-over');
        const file = e.dataTransfer.files[0]; if (!file) return;
        if (id === 'audioZone') {
          if (!ALLOWED_AUDIO_TYPES.includes(file.type) && !file.name.toLowerCase().endsWith('.mp3')) { setUploadNotice('âŒ Only MP3 files.', '#ef4444'); return; }
          if (file.size > MAX_AUDIO_MB * 1024 * 1024) { setUploadNotice(`âŒ Too large. Max ${MAX_AUDIO_MB}MB.`, '#ef4444'); return; }
          selectedAudio = file; document.getElementById('audioZoneText').textContent = `âœ… ${file.name} (${(file.size/1024/1024).toFixed(1)}MB)`; setUploadNotice('');
        } else { selectedCover = file; document.getElementById('coverZoneText').textContent = 'âœ… ' + file.name; }
      });
    });
  })();

  // Safety timeout
  setTimeout(() => { const s = document.getElementById('loadingSpinner'); if (s && s.style.display !== 'none') showError('Timed out. <a href="login.html" style="color:#a855f7;">Log in again</a>.'); }, 8000);

  init().catch(err => { document.getElementById('loadingSpinner').innerHTML = '<div style="text-align:center;padding:2rem;color:#f87171;">âŒ ' + err.message + '</div>'; });

  // Discount tracking
  const appliedDiscounts = {};

  window.applyDiscount = async function(songId, basePrice) {
    const input = document.getElementById(`discount-${songId}`);
    const msgEl = document.getElementById(`discount-msg-${songId}`);
    const code = input.value.trim().toUpperCase();
    if (!code) { msgEl.textContent = 'Enter a code'; msgEl.style.color = '#ef4444'; return; }
    try {
      const { data: d, error } = await db.from('song_discount_codes').select('*').eq('code', code).or(`song_id.eq.${songId},song_id.is.null`).single();
      if (error || !d) { msgEl.textContent = 'Invalid code'; msgEl.style.color = '#ef4444'; appliedDiscounts[songId] = null; return; }
      if (d.expires_at && new Date(d.expires_at) < new Date()) { msgEl.textContent = 'Code expired'; msgEl.style.color = '#ef4444'; return; }
      if (d.max_uses && d.uses >= d.max_uses) { msgEl.textContent = 'Limit reached'; msgEl.style.color = '#ef4444'; return; }
      appliedDiscounts[songId] = d;
      if (d.is_free) { msgEl.textContent = 'âœ“ FREE!'; msgEl.style.color = '#00ff88'; }
      else { const disc = parseFloat(d.discount_amount)||0; msgEl.textContent = `âœ“ -$${disc.toFixed(2)}`; msgEl.style.color = '#4ade80'; }
      loadSongs(profileData.user_id);
    } catch (err) { msgEl.textContent = 'Error'; msgEl.style.color = '#ef4444'; }
  };

  window.claimFreeSong = async function(songId, discountCode) {
    if (!currentUser) { alert('Please sign in'); return; }
    try {
      const { data: song } = await db.from('songs').select('*').eq('id', songId).single();
      if (!song) throw new Error('Song not found');
      const { error: purchaseErr } = await db.from('song_purchases').insert({ song_id: songId, buyer_id: currentUser.id, buyer_email: currentUser.email, amount_paid: 0, payment_method: 'discount_code', payment_id: 'FREE-' + discountCode });
      if (purchaseErr) throw purchaseErr;
      const a = document.createElement('a'); a.href = song.song_url; a.download = `${song.title}.mp3`; document.body.appendChild(a); a.click(); document.body.removeChild(a);
      alert('Song claimed!'); loadSongs(profileData.user_id);
    } catch (err) { alert('Error: ' + err.message); }
  };

  window.markSongAsPaid = async function(songId, amount, artistPayPal) {
    if (!currentUser) { alert('Please sign in'); return; }
    if (!confirm(`Confirm you sent $${amount.toFixed(2)} to ${artistPayPal} via PayPal?`)) return;
    try {
      const { data: song } = await db.from('songs').select('*').eq('id', songId).single();
      if (!song) throw new Error('Song not found');
      const { data: purchaseData, error: purchaseErr } = await db.from('song_purchases').insert({ song_id: songId, buyer_id: currentUser.id, buyer_email: currentUser.email, amount_paid: amount, payment_method: 'paypal_direct', payment_id: 'DIRECT-' + Date.now(), payment_confirmed: false }).select().single();
      if (purchaseErr) throw purchaseErr;
      await db.rpc('record_song_payout', { p_purchase_id: purchaseData.id, p_song_id: songId, p_total_amount: amount });
      const discount = appliedDiscounts[songId];
      if (discount) await db.from('song_discount_codes').update({ uses: (discount.uses||0) + 1 }).eq('id', discount.id);
      alert('Payment claim submitted! Artist will confirm.'); loadSongs(profileData.user_id);
    } catch (err) { alert('Error: ' + err.message); }
  };

  // Expose functions
  window.toggleUploadForm = toggleUploadForm;
  window.handleAudioSelect = handleAudioSelect;
  window.handleCoverSelect = handleCoverSelect;
  window.uploadSong = uploadSong;
  window.deleteSong = deleteSong;
  window.saveProfile = saveProfile;
  window.openCreatePost = openCreatePost;
  window.closeCreatePost = closeCreatePost;
  window.selectPostType = selectPostType;
  window.submitPost = submitPost;
  window.deletePost = deletePost;
  window.loadPosts = loadPosts;

  }); // end DOMContentLoaded
  </script>

  <script src="scripts.js" defer></script>

  <!-- Avatar & Bubble Toggle -->
  <script>
  (function() {
    const toggleBtn = document.createElement('button');
    toggleBtn.innerHTML = 'ğŸ‘ï¸';
    toggleBtn.style.cssText = 'position:fixed;top:80px;right:20px;z-index:9999;background:rgba(124,58,237,0.9);border:2px solid rgba(124,58,237,1);color:white;width:50px;height:50px;border-radius:50%;cursor:pointer;font-size:24px;display:flex;align-items:center;justify-content:center;box-shadow:0 4px 12px rgba(124,58,237,0.5);';
    document.body.appendChild(toggleBtn);
    let hidden = localStorage.getItem('hideAvatarBubbles') === 'true';
    function update() {
      document.querySelectorAll('[id*="bubble"],[class*="bubble"],[id*="avatar"][id*="switcher"]').forEach(el => { if(el) el.style.display = hidden ? 'none' : ''; });
      toggleBtn.innerHTML = hidden ? 'ğŸ‘ï¸â€ğŸ—¨ï¸' : 'ğŸ‘ï¸';
    }
    toggleBtn.addEventListener('click', () => { hidden = !hidden; localStorage.setItem('hideAvatarBubbles', hidden); update(); });
    update();
  })();
  </script>

  <script src="https://www.paypal.com/sdk/js?client-id=AWx0LwdZ_sCyCE5gEj9mL1ha7ZbG_eZLE_R636KjLXFMV1pOfmGwNg9prM5kVKQspvnpNLJDZxPp100G&currency=USD&intent=capture&components=buttons"></script>

</body>
</html>
