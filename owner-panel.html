<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Owner Panel - 8BFR Music Network</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root {
            --primary: #ff0066;
            --secondary: #00ccff;
            --dark: #0a0a0a;
            --dark-card: #1a1a1a;
            --success: #00ff88;
            --warning: #ffaa00;
            --danger: #ff0044;
            --text: #ffffff;
            --text-dim: #999999;
            --border: #333333;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: system-ui, sans-serif; background: var(--dark); color: var(--text); line-height: 1.6; }
        .header { background: linear-gradient(135deg, var(--dark-card) 0%, #000 100%); border-bottom: 2px solid var(--primary); padding: 1.5rem 2rem; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 100; }
        .header h1 { font-size: 1.8rem; letter-spacing: 2px; color: var(--primary); }
        .user-info { display: flex; align-items: center; gap: 1rem; }
        .logout-btn { background: var(--danger); color: white; border: none; padding: 0.5rem 1.5rem; border-radius: 4px; cursor: pointer; font-weight: 600; }
        .container { max-width: 1400px; margin: 0 auto; padding: 2rem; }
        .tabs { display: flex; gap: 0.5rem; margin-bottom: 2rem; border-bottom: 2px solid var(--border); flex-wrap: wrap; overflow-x: auto; }
        .tab { background: transparent; color: var(--text-dim); border: none; padding: 1rem 1.5rem; cursor: pointer; font-weight: 600; border-bottom: 3px solid transparent; white-space: nowrap; }
        .tab.active { color: var(--primary); border-bottom-color: var(--primary); }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .card { background: var(--dark-card); border: 1px solid var(--border); border-radius: 8px; padding: 1.5rem; margin-bottom: 1.5rem; }
        .card h2 { color: var(--primary); margin-bottom: 1rem; font-size: 1.4rem; }
        .card h3 { color: var(--secondary); margin: 1.5rem 0 1rem 0; font-size: 1.1rem; }
        .form-group { margin-bottom: 1.5rem; }
        .form-group label { display: block; margin-bottom: 0.5rem; font-weight: 600; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 0.75rem; background: var(--dark); border: 1px solid var(--border); border-radius: 4px; color: var(--text); }
        .form-group textarea { min-height: 100px; }
        .btn { background: var(--primary); color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 4px; cursor: pointer; font-weight: 600; margin: 0.25rem; }
        .btn:disabled { background: #666; cursor: not-allowed; }
        .btn-danger { background: var(--danger); }
        .btn-success { background: var(--success); color: #000; }
        .btn-secondary { background: var(--secondary); color: #000; }
        .btn-warning { background: var(--warning); color: #000; }
        .btn-sm { padding: 0.4rem 0.8rem; font-size: 0.85rem; }
        .grid-2 { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1rem; }
        .item-list { max-height: 500px; overflow-y: auto; }
        .item { background: var(--dark); border: 1px solid var(--border); padding: 1rem; margin-bottom: 0.5rem; border-radius: 4px; }
        .item-header { display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.5rem; }
        .item-actions { display: flex; gap: 0.5rem; flex-wrap: wrap; margin-top: 0.5rem; }
        .search-box { width: 100%; padding: 0.75rem; background: var(--dark); border: 1px solid var(--border); border-radius: 4px; color: var(--text); margin-bottom: 1rem; }
        .pill { display: inline-block; padding: 0.25rem 0.75rem; background: rgba(0, 204, 255, 0.2); border-radius: 999px; font-size: 0.85rem; margin: 0.25rem; }
        .pill.role { background: rgba(255, 0, 102, 0.2); }
        .pill.badge { background: rgba(0, 255, 136, 0.2); }
        .muted { color: var(--text-dim); font-size: 0.9rem; }
        .message { padding: 0.75rem; border-radius: 4px; margin: 0.5rem 0; }
        .message.error { background: rgba(255, 68, 68, 0.1); color: #ff4444; }
        .message.success { background: rgba(68, 255, 136, 0.1); color: #44ff88; }
        .checkbox-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 0.5rem; }
        .checkbox-item { display: flex; align-items: center; gap: 0.5rem; }
        .checkbox-item input { width: auto; }
    </style>
</head>
<body>
    <div class="header">
        <h1>OWNER PANEL</h1>
        <div class="user-info">
            <span id="ownerName" class="pill">Loading...</span>
            <button class="logout-btn" onclick="logout()">Logout</button>
        </div>
    </div>

    <div class="container">
        <div class="tabs">
            <button class="tab active" onclick="switchTab('users')">Users</button>
            <button class="tab" onclick="switchTab('badges-roles')">Badges & Roles</button>
            <button class="tab" onclick="switchTab('ads')">Ads</button>
            <button class="tab" onclick="switchTab('economy')">Economy</button>
            <button class="tab" onclick="switchTab('content')">Content</button>
            <button class="tab" onclick="switchTab('analytics')">Analytics</button>
        </div>

        <!-- USERS TAB -->
        <div id="users" class="tab-content active">
            <div class="card">
                <h2>User Management</h2>
                <input type="text" id="userSearch" class="search-box" placeholder="Search users by username, email, role, or badge..." oninput="loadUsers()">
                <button class="btn" onclick="loadUsers()">Refresh</button>
                <button class="btn btn-success" onclick="showCreateUser()">Create User</button>
                <button class="btn btn-secondary" onclick="showCreateDummy()">Create Dummy</button>
                <div class="item-list" id="usersList"><p class="muted">Loading users...</p></div>
            </div>

            <!-- Create User Modal -->
            <div id="createUserCard" class="card" style="display:none;">
                <h2>Create New User</h2>
                <div class="form-group">
                    <label>Email *</label>
                    <input type="email" id="newEmail" placeholder="user@example.com">
                </div>
                <div class="form-group">
                    <label>Username *</label>
                    <input type="text" id="newUsername" placeholder="username">
                </div>
                <div class="form-group">
                    <label>Display Name</label>
                    <input type="text" id="newDisplayName" placeholder="Display Name">
                </div>
                <div class="form-group">
                    <label>Primary Role</label>
                    <select id="newRole"></select>
                </div>
                <div id="createUserMessage"></div>
                <button class="btn" onclick="createUser()">Create User</button>
                <button class="btn btn-secondary" onclick="hideCreateUser()">Cancel</button>
            </div>

            <!-- Create Dummy Modal -->
            <div id="createDummyCard" class="card" style="display:none;">
                <h2>Create Dummy Profile</h2>
                <div class="form-group">
                    <label>Username *</label>
                    <input type="text" id="dummyUsername" placeholder="test_user_123">
                </div>
                <div class="form-group">
                    <label>Display Name</label>
                    <input type="text" id="dummyDisplayName" placeholder="Test User">
                </div>
                <div class="form-group">
                    <label>Role</label>
                    <select id="dummyRole"></select>
                </div>
                <div id="createDummyMessage"></div>
                <button class="btn btn-secondary" onclick="createDummy()">Create Dummy</button>
                <button class="btn" onclick="hideCreateDummy()">Cancel</button>
            </div>

            <!-- Edit User Modal -->
            <div id="editUserCard" class="card" style="display:none;">
                <h2>Edit User Profile</h2>
                <input type="hidden" id="editUserId">
                <div class="form-group">
                    <label>Username</label>
                    <input type="text" id="editUsername">
                </div>
                <div class="form-group">
                    <label>Display Name</label>
                    <input type="text" id="editDisplayName">
                </div>
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" id="editEmail">
                </div>
                <div class="form-group">
                    <label>Bio</label>
                    <textarea id="editBio"></textarea>
                </div>
                
                <h3>Roles</h3>
                <div class="checkbox-grid" id="editRolesGrid"></div>
                
                <h3>Badges</h3>
                <div class="checkbox-grid" id="editBadgesGrid"></div>
                
                <div id="editUserMessage"></div>
                <button class="btn btn-success" onclick="saveUserEdit()">Save Changes</button>
                <button class="btn" onclick="hideEditUser()">Cancel</button>
            </div>
        </div>

        <!-- BADGES & ROLES TAB -->
        <div id="badges-roles" class="tab-content">
            <div class="card">
                <h2>Quick Badge/Role Assignment</h2>
                <div class="form-group">
                    <label>Select User</label>
                    <select id="quickUserId"></select>
                </div>
                
                <h3>Assign Roles</h3>
                <div class="checkbox-grid" id="quickRolesGrid"></div>
                
                <h3>Assign Badges</h3>
                <div class="checkbox-grid" id="quickBadgesGrid"></div>
                
                <div id="quickAssignMessage"></div>
                <button class="btn btn-success" onclick="quickAssignBadgesRoles()">Apply Changes</button>
            </div>

            <div class="card">
                <h2>Approve Verified Badges</h2>
                <p class="muted">Artists and beatmakers requiring verification</p>
                <div class="item-list" id="verificationQueue"><p class="muted">Loading...</p></div>
            </div>
        </div>

        <!-- ADS TAB -->
        <div id="ads" class="tab-content">
            <div class="card">
                <h2>Create Advertisement</h2>
                <div class="form-group">
                    <label>Ad Title</label>
                    <input type="text" id="adTitle" placeholder="Ad Title">
                </div>
                <div class="form-group">
                    <label>Content/Description</label>
                    <textarea id="adContent" placeholder="Ad description or HTML"></textarea>
                </div>
                <div class="form-group">
                    <label>Image URL</label>
                    <input type="text" id="adImage" placeholder="https://...">
                </div>
                <div class="form-group">
                    <label>Redirect URL</label>
                    <input type="text" id="adRedirect" placeholder="https://...">
                </div>
                <div class="form-group">
                    <label>Placement</label>
                    <select id="adPlacement">
                        <option value="feed">Feed</option>
                        <option value="banner">Banner</option>
                        <option value="sidebar">Sidebar</option>
                    </select>
                </div>
                <div id="createAdMessage"></div>
                <button class="btn btn-success" onclick="createAd()">Create Ad</button>
            </div>

            <div class="card">
                <h2>Pending Ads (Approval Queue)</h2>
                <div class="item-list" id="pendingAds"><p class="muted">Loading...</p></div>
            </div>

            <div class="card">
                <h2>All Ads</h2>
                <div class="item-list" id="allAds"><p class="muted">Loading...</p></div>
            </div>
        </div>

        <!-- ECONOMY TAB -->
        <div id="economy" class="tab-content">
            <div class="card">
                <h2>Coin Management</h2>
                <div class="form-group">
                    <label>User ID</label>
                    <input type="text" id="coinUserId" placeholder="user_id">
                </div>
                <div class="form-group">
                    <label>Amount (positive to add, negative to remove)</label>
                    <input type="number" id="coinAmount" placeholder="100">
                </div>
                <div class="form-group">
                    <label>Reason</label>
                    <input type="text" id="coinReason" placeholder="Manual adjustment">
                </div>
                <div id="coinMessage"></div>
                <button class="btn btn-success" onclick="adjustCoins()">Apply Coin Adjustment</button>
            </div>

            <div class="card">
                <h2>Create Discount Code</h2>
                <div class="form-group">
                    <label>Code</label>
                    <input type="text" id="discountCode" placeholder="SUMMER2025">
                </div>
                <div class="form-group">
                    <label>Discount Percentage</label>
                    <input type="number" id="discountPercent" placeholder="20" min="0" max="100">
                </div>
                <div class="form-group">
                    <label>Usage Limit</label>
                    <input type="number" id="discountLimit" placeholder="100">
                </div>
                <div class="form-group">
                    <label>Expiration Date</label>
                    <input type="date" id="discountExpiry">
                </div>
                <div id="discountMessage"></div>
                <button class="btn btn-success" onclick="createDiscount()">Create Discount Code</button>
            </div>

            <div class="card">
                <h2>Active Discount Codes</h2>
                <div class="item-list" id="discountList"><p class="muted">Loading...</p></div>
            </div>
        </div>

        <!-- CONTENT TAB -->
        <div id="content" class="tab-content">
            <div class="card">
                <h2>Post Moderation</h2>
                <button class="btn" onclick="loadPosts()">Refresh Posts</button>
                <div class="item-list" id="postsList"><p class="muted">Loading...</p></div>
            </div>

            <div class="card">
                <h2>Featured Content</h2>
                <div class="form-group">
                    <label>Content ID (post, song, user)</label>
                    <input type="text" id="featureContentId" placeholder="content_id">
                </div>
                <div class="form-group">
                    <label>Content Type</label>
                    <select id="featureType">
                        <option value="post">Post</option>
                        <option value="song">Song</option>
                        <option value="user">User</option>
                    </select>
                </div>
                <div id="featureMessage"></div>
                <button class="btn btn-success" onclick="featureContent()">Feature Content</button>
            </div>
        </div>

        <!-- ANALYTICS TAB -->
        <div id="analytics" class="tab-content">
            <div class="card">
                <h2>Platform Statistics</h2>
                <div class="grid-2">
                    <div class="card">
                        <h3>Total Users</h3>
                        <p id="totalUsers" style="font-size:2rem; color:var(--primary);">-</p>
                    </div>
                    <div class="card">
                        <h3>Total Creators</h3>
                        <p id="totalCreators" style="font-size:2rem; color:var(--success);">-</p>
                    </div>
                    <div class="card">
                        <h3>Total Posts</h3>
                        <p id="totalPosts" style="font-size:2rem; color:var(--secondary);">-</p>
                    </div>
                    <div class="card">
                        <h3>Total Songs</h3>
                        <p id="totalSongs" style="font-size:2rem; color:var(--warning);">-</p>
                    </div>
                </div>
                <button class="btn" onclick="loadAnalytics()">Refresh Analytics</button>
            </div>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://novbuvwpjnxwwvdekjhr.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5vdmJ1dndwam54d3d2ZGVramhyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjExODkxODUsImV4cCI6MjA3Njc2NTE4NX0.1UUkdGafh6ZplAX8hi7Bvj94D2gvFQZUl0an1RvcSA0';
        const ownerSupabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        let currentUser = null;

        // ALL ROLES
        const ALL_ROLES = ['owner', 'admin', 'mod', 'g7', 'verified', 'artist', 'beatmaker', 'producer', 'singer', 'rapper', 'musician', 'songwriter', 'dj', 'engineer', 'label', 'promoter', 'distributor', 'videographer', 'photographer', 'filmmaker', 'podcaster', 'designer', 'author', 'blogger', 'game_creator', 'developer', 'streamer', 'gamer', 'influencer', 'brand_ambassador', 'community_leader', 'mentor', 'supporter', 'fan', 'parent', 'student', 'educator', 'collector', 'kids', 'donor', 'sponsor', 'vip_member', 'early_supporter', 'founder', 'top_creator', 'trending', 'beta_tester', 'contest_winner', 'tournament_champion', 'event_participant', 'carrie_ai_assistant', 'carrie_performer', 'carrie_concert_vip', 'carrie_fashionista', 'carrie_voice_clone', '8bfrfan', 'fyp'];

        // ALL BADGES (same as roles for now)
        const ALL_BADGES = ALL_ROLES;

        async function init() {
            try {
                const { data: sessionData } = await ownerSupabase.auth.getSession();
                if (!sessionData.session) {
                    alert('Please log in');
                    window.location.href = 'login.html';
                    return;
                }
                
                const { data: { user } } = await ownerSupabase.auth.getUser();
                if (!user) {
                    window.location.href = 'login.html';
                    return;
                }
                currentUser = user;

                const { data: profile } = await ownerSupabase.from('profiles').select('*').eq('user_id', user.id).single();
                if (!profile || (profile.role !== 'owner' && (!profile.roles_ordered || profile.roles_ordered[0] !== 'owner'))) {
                    alert('Access Denied: Owner only. Your role: ' + (profile?.role || 'none'));
                    window.location.href = 'index.html';
                    return;
                }
                
                document.getElementById('ownerName').textContent = profile.username || currentUser.email.split('@')[0];
                populateRoleSelects();
                loadUsers();
                loadAnalytics();
            } catch (error) {
                alert('Init error: ' + error.message);
            }
        }

        function populateRoleSelects() {
            const selects = ['newRole', 'dummyRole'];
            selects.forEach(function(id) {
                const select = document.getElementById(id);
                if (!select) return;
                select.innerHTML = ALL_ROLES.map(function(r) {
                    return '<option value="' + r + '">' + r + '</option>';
                }).join('');
            });
        }

        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(function(t) { t.classList.remove('active'); });
            document.querySelectorAll('.tab-content').forEach(function(c) { c.classList.remove('active'); });
            event.target.classList.add('active');
            document.getElementById(tabName).classList.add('active');
            
            // Load data for specific tabs
            if (tabName === 'ads') {
                loadPendingAds();
                loadAllAds();
            } else if (tabName === 'economy') {
                loadDiscounts();
            } else if (tabName === 'content') {
                loadPosts();
            } else if (tabName === 'badges-roles') {
                loadVerificationQueue();
                loadUsersForQuickAssign();
            }
        }

        // USER MANAGEMENT
        async function loadUsers() {
            const search = document.getElementById('userSearch').value.toLowerCase();
            const list = document.getElementById('usersList');
            
            try {
                list.innerHTML = '<p class="muted">Loading...</p>';
                
                const { data: users, error } = await ownerSupabase.from('profiles').select('*').order('created_at', { ascending: false }).limit(100);
                
                if (error) {
                    list.innerHTML = '<p class="message error">Error: ' + error.message + '</p>';
                    return;
                }
                
                let filtered = users;
                if (search) {
                    filtered = users.filter(function(u) {
                        const un = (u.username || '').toLowerCase();
                        const em = (u.email || '').toLowerCase();
                        const ro = (u.role || '').toLowerCase();
                        const badges = Array.isArray(u.badges) ? u.badges.join(',').toLowerCase() : '';
                        return un.includes(search) || em.includes(search) || ro.includes(search) || badges.includes(search);
                    });
                }
                
                if (!filtered || filtered.length === 0) {
                    list.innerHTML = '<p class="muted">No users found</p>';
                    return;
                }
                
                list.innerHTML = filtered.map(function(u) {
                    const roles = Array.isArray(u.roles_ordered) ? u.roles_ordered : (u.role ? [u.role] : []);
                    const badges = Array.isArray(u.badges) ? u.badges : [];
                    
                    return '<div class="item">' +
                        '<div class="item-header">' +
                        '<div><strong>' + escapeHtml(u.username || u.email || 'user') + '</strong>' +
                        '<div class="muted">' + escapeHtml(u.email || 'No email') + '</div></div>' +
                        '</div>' +
                        '<div>' +
                        (roles.length > 0 ? roles.map(function(r) { return '<span class="pill role">' + r + '</span>'; }).join('') : '') +
                        (badges.length > 0 ? badges.map(function(b) { return '<span class="pill badge">' + b + '</span>'; }).join('') : '') +
                        '</div>' +
                        '<div class="item-actions">' +
                        '<button class="btn btn-sm" onclick="editUser(\'' + u.user_id + '\')">Edit</button>' +
                        (u.email ? '<button class="btn btn-sm" onclick="sendPasswordReset(\'' + escapeHtml(u.email) + '\')">Reset Password</button>' : '') +
                        '<button class="btn btn-sm btn-danger" onclick="deleteUser(\'' + u.user_id + '\')">Delete</button>' +
                        '</div>' +
                        '</div>';
                }).join('');
                
            } catch (error) {
                list.innerHTML = '<p class="message error">Exception: ' + error.message + '</p>';
            }
        }

        function showCreateUser() {
            document.getElementById('createUserCard').style.display = 'block';
            document.getElementById('createDummyCard').style.display = 'none';
            document.getElementById('editUserCard').style.display = 'none';
        }

        function hideCreateUser() {
            document.getElementById('createUserCard').style.display = 'none';
        }

        function showCreateDummy() {
            document.getElementById('createDummyCard').style.display = 'block';
            document.getElementById('createUserCard').style.display = 'none';
            document.getElementById('editUserCard').style.display = 'none';
        }

        function hideCreateDummy() {
            document.getElementById('createDummyCard').style.display = 'none';
        }

        async function createUser() {
            const email = document.getElementById('newEmail').value.trim();
            const username = document.getElementById('newUsername').value.trim();
            const displayName = document.getElementById('newDisplayName').value.trim();
            const role = document.getElementById('newRole').value;
            const msg = document.getElementById('createUserMessage');
            
            if (!email || !username) {
                msg.innerHTML = '<p class="message error">Email and username required</p>';
                return;
            }
            
            try {
                const tempPass = Math.random().toString(36) + Math.random().toString(36);
                const { data, error } = await ownerSupabase.auth.signUp({ email: email, password: tempPass });
                
                if (error) {
                    msg.innerHTML = '<p class="message error">' + error.message + '</p>';
                    return;
                }
                
                await ownerSupabase.from('profiles').insert({
                    user_id: data.user.id,
                    email: email,
                    username: username,
                    display_name: displayName || username,
                    role: role,
                    roles_ordered: [role],
                    badges: [],
                    created_at: new Date().toISOString()
                });
                
                msg.innerHTML = '<p class="message success">User created!</p>';
                document.getElementById('newEmail').value = '';
                document.getElementById('newUsername').value = '';
                document.getElementById('newDisplayName').value = '';
                setTimeout(function() { hideCreateUser(); loadUsers(); }, 1000);
                
            } catch (error) {
                msg.innerHTML = '<p class="message error">' + error.message + '</p>';
            }
        }

        async function createDummy() {
            const username = document.getElementById('dummyUsername').value.trim();
            const displayName = document.getElementById('dummyDisplayName').value.trim();
            const role = document.getElementById('dummyRole').value;
            const msg = document.getElementById('createDummyMessage');
            
            if (!username) {
                msg.innerHTML = '<p class="message error">Username required</p>';
                return;
            }
            
            try {
                await ownerSupabase.from('profiles').insert({
                    user_id: 'dummy_' + Date.now(),
                    username: username,
                    display_name: displayName || username,
                    role: role,
                    roles_ordered: [role],
                    badges: [],
                    created_at: new Date().toISOString()
                });
                
                msg.innerHTML = '<p class="message success">Dummy created!</p>';
                document.getElementById('dummyUsername').value = '';
                document.getElementById('dummyDisplayName').value = '';
                setTimeout(function() { hideCreateDummy(); loadUsers(); }, 1000);
                
            } catch (error) {
                msg.innerHTML = '<p class="message error">' + error.message + '</p>';
            }
        }

        async function editUser(userId) {
            try {
                const { data, error } = await ownerSupabase.from('profiles').select('*').eq('user_id', userId).single();
                
                if (error) {
                    alert('Error loading user: ' + error.message);
                    return;
                }
                
                document.getElementById('editUserId').value = userId;
                document.getElementById('editUsername').value = data.username || '';
                document.getElementById('editDisplayName').value = data.display_name || '';
                document.getElementById('editEmail').value = data.email || '';
                document.getElementById('editBio').value = data.bio || '';
                
                // Populate roles checkboxes
                const rolesGrid = document.getElementById('editRolesGrid');
                const userRoles = Array.isArray(data.roles_ordered) ? data.roles_ordered : (data.role ? [data.role] : []);
                rolesGrid.innerHTML = ALL_ROLES.map(function(r) {
                    const checked = userRoles.includes(r) ? 'checked' : '';
                    return '<div class="checkbox-item"><input type="checkbox" id="role_' + r + '" value="' + r + '" ' + checked + '><label for="role_' + r + '">' + r + '</label></div>';
                }).join('');
                
                // Populate badges checkboxes
                const badgesGrid = document.getElementById('editBadgesGrid');
                const userBadges = Array.isArray(data.badges) ? data.badges : [];
                badgesGrid.innerHTML = ALL_BADGES.map(function(b) {
                    const checked = userBadges.includes(b) ? 'checked' : '';
                    return '<div class="checkbox-item"><input type="checkbox" id="badge_' + b + '" value="' + b + '" ' + checked + '><label for="badge_' + b + '">' + b + '</label></div>';
                }).join('');
                
                document.getElementById('createUserCard').style.display = 'none';
                document.getElementById('createDummyCard').style.display = 'none';
                document.getElementById('editUserCard').style.display = 'block';
                
            } catch (error) {
                alert('Exception: ' + error.message);
            }
        }

        function hideEditUser() {
            document.getElementById('editUserCard').style.display = 'none';
        }

        async function saveUserEdit() {
            const userId = document.getElementById('editUserId').value;
            const msg = document.getElementById('editUserMessage');
            
            try {
                // Get selected roles
                const roles = ALL_ROLES.filter(function(r) {
                    const cb = document.getElementById('role_' + r);
                    return cb && cb.checked;
                });
                
                // Get selected badges
                const badges = ALL_BADGES.filter(function(b) {
                    const cb = document.getElementById('badge_' + b);
                    return cb && cb.checked;
                });
                
                const { error } = await ownerSupabase.from('profiles').update({
                    username: document.getElementById('editUsername').value,
                    display_name: document.getElementById('editDisplayName').value,
                    email: document.getElementById('editEmail').value,
                    bio: document.getElementById('editBio').value,
                    role: roles[0] || 'fan',
                    roles_ordered: roles,
                    badges: badges
                }).eq('user_id', userId);
                
                if (error) {
                    msg.innerHTML = '<p class="message error">' + error.message + '</p>';
                    return;
                }
                
                msg.innerHTML = '<p class="message success">User updated!</p>';
                setTimeout(function() { hideEditUser(); loadUsers(); }, 1000);
                
            } catch (error) {
                msg.innerHTML = '<p class="message error">' + error.message + '</p>';
            }
        }

        async function sendPasswordReset(email) {
            if (!confirm('Send password reset to ' + email + '?')) return;
            
            try {
                const { error } = await ownerSupabase.auth.resetPasswordForEmail(email, {
                    redirectTo: 'https://8bfr.github.io/8bfr-Music-Network/change-password.html'
                });
                
                if (error) {
                    alert('Error: ' + error.message);
                    return;
                }
                
                alert('Password reset email sent!');
                
            } catch (error) {
                alert('Exception: ' + error.message);
            }
        }

        async function deleteUser(userId) {
            if (!confirm('Delete this user? Cannot be undone!')) return;
            
            try {
                const { error } = await ownerSupabase.from('profiles').delete().eq('user_id', userId);
                
                if (error) {
                    alert('Error: ' + error.message);
                    return;
                }
                
                alert('User deleted');
                loadUsers();
                
            } catch (error) {
                alert('Exception: ' + error.message);
            }
        }

        // BADGES & ROLES
        async function loadUsersForQuickAssign() {
            try {
                const { data: users } = await ownerSupabase.from('profiles').select('user_id, username, email').order('username');
                
                const select = document.getElementById('quickUserId');
                if (!select) return;
                
                select.innerHTML = '<option value="">Choose user...</option>' + 
                    (users || []).map(function(u) {
                        return '<option value="' + u.user_id + '">' + (u.username || u.email || u.user_id) + '</option>';
                    }).join('');
                
                // Populate grids
                document.getElementById('quickRolesGrid').innerHTML = ALL_ROLES.map(function(r) {
                    return '<div class="checkbox-item"><input type="checkbox" id="qrole_' + r + '" value="' + r + '"><label for="qrole_' + r + '">' + r + '</label></div>';
                }).join('');
                
                document.getElementById('quickBadgesGrid').innerHTML = ALL_BADGES.map(function(b) {
                    return '<div class="checkbox-item"><input type="checkbox" id="qbadge_' + b + '" value="' + b + '"><label for="qbadge_' + b + '">' + b + '</label></div>';
                }).join('');
                
            } catch (error) {
                console.error(error);
            }
        }

        async function quickAssignBadgesRoles() {
            const userId = document.getElementById('quickUserId').value;
            const msg = document.getElementById('quickAssignMessage');
            
            if (!userId) {
                msg.innerHTML = '<p class="message error">Select a user</p>';
                return;
            }
            
            try {
                const roles = ALL_ROLES.filter(function(r) {
                    const cb = document.getElementById('qrole_' + r);
                    return cb && cb.checked;
                });
                
                const badges = ALL_BADGES.filter(function(b) {
                    const cb = document.getElementById('qbadge_' + b);
                    return cb && cb.checked;
                });
                
                const { error } = await ownerSupabase.from('profiles').update({
                    role: roles[0] || 'fan',
                    roles_ordered: roles,
                    badges: badges
                }).eq('user_id', userId);
                
                if (error) {
                    msg.innerHTML = '<p class="message error">' + error.message + '</p>';
                    return;
                }
                
                msg.innerHTML = '<p class="message success">Updated!</p>';
                setTimeout(function() { msg.innerHTML = ''; }, 2000);
                
            } catch (error) {
                msg.innerHTML = '<p class="message error">' + error.message + '</p>';
            }
        }

        async function loadVerificationQueue() {
            const list = document.getElementById('verificationQueue');
            if (!list) return;
            
            try {
                // This would query for users with artist/beatmaker roles but no verified badge
                // For now just show placeholder
                list.innerHTML = '<p class="muted">Verification queue coming soon</p>';
            } catch (error) {
                list.innerHTML = '<p class="message error">' + error.message + '</p>';
            }
        }

        // ADS
        async function createAd() {
            const msg = document.getElementById('createAdMessage');
            
            try {
                const { error } = await ownerSupabase.from('ads').insert({
                    title: document.getElementById('adTitle').value,
                    content: document.getElementById('adContent').value,
                    image_url: document.getElementById('adImage').value,
                    redirect_url: document.getElementById('adRedirect').value,
                    placement: document.getElementById('adPlacement').value,
                    status: 'approved',
                    created_at: new Date().toISOString()
                });
                
                if (error) {
                    msg.innerHTML = '<p class="message error">' + error.message + '</p>';
                    return;
                }
                
                msg.innerHTML = '<p class="message success">Ad created!</p>';
                document.getElementById('adTitle').value = '';
                document.getElementById('adContent').value = '';
                document.getElementById('adImage').value = '';
                document.getElementById('adRedirect').value = '';
                
            } catch (error) {
                msg.innerHTML = '<p class="message error">' + error.message + '</p>';
            }
        }

        async function loadPendingAds() {
            const list = document.getElementById('pendingAds');
            if (!list) return;
            
            try {
                const { data: ads } = await ownerSupabase.from('ads').select('*').eq('status', 'pending');
                
                if (!ads || ads.length === 0) {
                    list.innerHTML = '<p class="muted">No pending ads</p>';
                    return;
                }
                
                list.innerHTML = ads.map(function(a) {
                    return '<div class="item">' +
                        '<strong>' + escapeHtml(a.title || 'Untitled') + '</strong>' +
                        '<div class="item-actions">' +
                        '<button class="btn btn-sm btn-success" onclick="approveAd(\'' + a.id + '\')">Approve</button>' +
                        '<button class="btn btn-sm btn-danger" onclick="denyAd(\'' + a.id + '\')">Deny</button>' +
                        '</div></div>';
                }).join('');
                
            } catch (error) {
                list.innerHTML = '<p class="message error">' + error.message + '</p>';
            }
        }

        async function loadAllAds() {
            const list = document.getElementById('allAds');
            if (!list) return;
            
            try {
                const { data: ads } = await ownerSupabase.from('ads').select('*').order('created_at', { ascending: false });
                
                if (!ads || ads.length === 0) {
                    list.innerHTML = '<p class="muted">No ads</p>';
                    return;
                }
                
                list.innerHTML = ads.map(function(a) {
                    return '<div class="item">' +
                        '<strong>' + escapeHtml(a.title || 'Untitled') + '</strong>' +
                        '<span class="pill">' + a.status + '</span>' +
                        '<div class="item-actions">' +
                        '<button class="btn btn-sm btn-danger" onclick="deleteAd(\'' + a.id + '\')">Delete</button>' +
                        '</div></div>';
                }).join('');
                
            } catch (error) {
                list.innerHTML = '<p class="message error">' + error.message + '</p>';
            }
        }

        async function approveAd(adId) {
            try {
                await ownerSupabase.from('ads').update({ status: 'approved' }).eq('id', adId);
                alert('Ad approved');
                loadPendingAds();
                loadAllAds();
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        async function denyAd(adId) {
            try {
                await ownerSupabase.from('ads').update({ status: 'denied' }).eq('id', adId);
                alert('Ad denied');
                loadPendingAds();
                loadAllAds();
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        async function deleteAd(adId) {
            if (!confirm('Delete this ad?')) return;
            try {
                await ownerSupabase.from('ads').delete().eq('id', adId);
                alert('Ad deleted');
                loadAllAds();
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        // ECONOMY
        async function adjustCoins() {
            const msg = document.getElementById('coinMessage');
            
            try {
                const userId = document.getElementById('coinUserId').value;
                const amount = parseInt(document.getElementById('coinAmount').value);
                const reason = document.getElementById('coinReason').value;
                
                if (!userId || !amount) {
                    msg.innerHTML = '<p class="message error">Fill all fields</p>';
                    return;
                }
                
                // Get current coins
                const { data: profile } = await ownerSupabase.from('profiles').select('coins').eq('user_id', userId).single();
                const currentCoins = profile?.coins || 0;
                
                await ownerSupabase.from('profiles').update({ coins: currentCoins + amount }).eq('user_id', userId);
                
                // Log transaction
                await ownerSupabase.from('coin_transactions').insert({
                    user_id: userId,
                    amount: amount,
                    reason: reason,
                    created_at: new Date().toISOString()
                });
                
                msg.innerHTML = '<p class="message success">Coins adjusted!</p>';
                
            } catch (error) {
                msg.innerHTML = '<p class="message error">' + error.message + '</p>';
            }
        }

        async function createDiscount() {
            const msg = document.getElementById('discountMessage');
            
            try {
                const { error } = await ownerSupabase.from('discount_codes').insert({
                    code: document.getElementById('discountCode').value.toUpperCase(),
                    discount_percent: parseInt(document.getElementById('discountPercent').value),
                    usage_limit: parseInt(document.getElementById('discountLimit').value),
                    expiry_date: document.getElementById('discountExpiry').value,
                    created_at: new Date().toISOString()
                });
                
                if (error) {
                    msg.innerHTML = '<p class="message error">' + error.message + '</p>';
                    return;
                }
                
                msg.innerHTML = '<p class="message success">Discount code created!</p>';
                loadDiscounts();
                
            } catch (error) {
                msg.innerHTML = '<p class="message error">' + error.message + '</p>';
            }
        }

        async function loadDiscounts() {
            const list = document.getElementById('discountList');
            if (!list) return;
            
            try {
                const { data: codes } = await ownerSupabase.from('discount_codes').select('*').order('created_at', { ascending: false });
                
                if (!codes || codes.length === 0) {
                    list.innerHTML = '<p class="muted">No discount codes</p>';
                    return;
                }
                
                list.innerHTML = codes.map(function(c) {
                    return '<div class="item">' +
                        '<strong>' + c.code + '</strong> - ' + c.discount_percent + '% off' +
                        '<div class="muted">Limit: ' + c.usage_limit + ' | Expires: ' + c.expiry_date + '</div>' +
                        '</div>';
                }).join('');
                
            } catch (error) {
                list.innerHTML = '<p class="message error">' + error.message + '</p>';
            }
        }

        // CONTENT
        async function loadPosts() {
            const list = document.getElementById('postsList');
            if (!list) return;
            
            try {
                const { data: posts } = await ownerSupabase.from('posts').select('*').order('created_at', { ascending: false }).limit(50);
                
                if (!posts || posts.length === 0) {
                    list.innerHTML = '<p class="muted">No posts</p>';
                    return;
                }
                
                list.innerHTML = posts.map(function(p) {
                    return '<div class="item">' +
                        '<div>' + escapeHtml(p.content?.substring(0, 100) || 'No content') + '</div>' +
                        '<div class="item-actions">' +
                        '<button class="btn btn-sm" onclick="pinPost(\'' + p.id + '\')">Pin</button>' +
                        '<button class="btn btn-sm btn-danger" onclick="deletePost(\'' + p.id + '\')">Delete</button>' +
                        '</div></div>';
                }).join('');
                
            } catch (error) {
                list.innerHTML = '<p class="message error">' + error.message + '</p>';
            }
        }

        async function pinPost(postId) {
            try {
                await ownerSupabase.from('posts').update({ pinned: true }).eq('id', postId);
                alert('Post pinned');
                loadPosts();
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        async function deletePost(postId) {
            if (!confirm('Delete this post?')) return;
            try {
                await ownerSupabase.from('posts').delete().eq('id', postId);
                alert('Post deleted');
                loadPosts();
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        async function featureContent() {
            const msg = document.getElementById('featureMessage');
            
            try {
                const contentId = document.getElementById('featureContentId').value;
                const type = document.getElementById('featureType').value;
                
                await ownerSupabase.from('featured_content').insert({
                    content_id: contentId,
                    content_type: type,
                    created_at: new Date().toISOString()
                });
                
                msg.innerHTML = '<p class="message success">Content featured!</p>';
                
            } catch (error) {
                msg.innerHTML = '<p class="message error">' + error.message + '</p>';
            }
        }

        // ANALYTICS
        async function loadAnalytics() {
            try {
                const { data: users } = await ownerSupabase.from('profiles').select('user_id, role, badges');
                const { data: posts } = await ownerSupabase.from('posts').select('id');
                const { data: songs } = await ownerSupabase.from('songs').select('id');
                
                document.getElementById('totalUsers').textContent = users?.length || 0;
                
                const creators = (users || []).filter(function(u) {
                    return u.role === 'artist' || u.role === 'beatmaker' || u.role === 'producer';
                });
                document.getElementById('totalCreators').textContent = creators.length;
                
                document.getElementById('totalPosts').textContent = posts?.length || 0;
                document.getElementById('totalSongs').textContent = songs?.length || 0;
                
            } catch (error) {
                console.error('Analytics error:', error);
            }
        }

        async function logout() {
            await ownerSupabase.auth.signOut();
            window.location.href = 'login.html';
        }

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', init);
        } else {
            init();
        }
    </script>
</body>
</html>
