<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Owner Panel - 8BFR</title>
    <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Work+Sans:wght@300;400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { --primary: #7c3aed; --secondary: #6d28d9; --dark: #0b0014; --dark-card: #0c0618; --success: #00ff88; --danger: #ff0044; --text: #eae6ff; --text-dim: #a855f7; --border: rgba(124,58,237,.35); }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Work Sans', sans-serif; background: radial-gradient(1200px 600px at 10% -10%, rgba(124,58,237,.35), transparent 60%), radial-gradient(900px 400px at 110% 10%, rgba(0,217,255,.22), transparent 60%), linear-gradient(#0b0014,#000); color: var(--text); line-height: 1.6; min-height: 100vh; }
        .header { background: rgba(15,0,30,.9); border-bottom: 2px solid var(--primary); padding: 1.5rem 2rem; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 100; box-shadow: 0 4px 20px rgba(124, 58, 237, 0.3); flex-wrap: wrap; gap: 0.5rem; }
        .header h1 { font-family: 'Bebas Neue', cursive; font-size: 2rem; letter-spacing: 2px; color: var(--primary); }
        .user-info { display: flex; align-items: center; gap: 1rem; }
        .logout-btn { background: var(--danger); color: white; border: none; padding: 0.5rem 1.5rem; border-radius: 4px; cursor: pointer; font-weight: 600; transition: all 0.3s; }
        .logout-btn:hover { background: #cc0033; }
        .container { max-width: 1400px; margin: 0 auto; padding: 2rem; }
        .card { background: var(--dark-card); border: 1px solid var(--border); border-radius: 16px; padding: 1.5rem; margin-bottom: 1.5rem; box-shadow: 0 4px 15px rgba(124,58,237,0.2); }
        .card h2 { font-family: 'Bebas Neue', cursive; font-size: 1.5rem; letter-spacing: 1px; color: var(--primary); margin-bottom: 1rem; border-left: 4px solid var(--primary); padding-left: 1rem; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 1rem; margin-bottom: 2rem; }
        .stat-card { background: linear-gradient(135deg, var(--dark-card), var(--dark)); border: 1px solid var(--border); border-radius: 8px; padding: 1.5rem; text-align: center; transition: all 0.3s; }
        .stat-card:hover { transform: translateY(-4px); border-color: var(--primary); }
        .stat-card h3 { font-size: 2rem; color: var(--primary); margin-bottom: 0.5rem; }
        .stat-card p { color: var(--text-dim); font-size: 0.9rem; }
        .nav-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem; margin-bottom: 2rem; }
        .nav-card { background: var(--dark-card); border: 1px solid var(--border); border-radius: 8px; padding: 1.5rem; text-decoration: none; color: var(--text); display: block; transition: all 0.3s; }
        .nav-card:hover { border-color: var(--primary); transform: translateY(-2px); background: rgba(124,58,237,0.1); }
        .nav-card h3 { color: var(--primary); margin-bottom: 0.5rem; font-size: 1.1rem; }
        .nav-card p { color: var(--text-dim); font-size: 0.9rem; margin: 0; }
        .quick-actions { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; }
        .action-btn { background: var(--dark); border: 1px solid var(--border); padding: 1rem; border-radius: 8px; cursor: pointer; transition: all 0.3s; text-align: center; }
        .action-btn:hover { border-color: var(--primary); background: rgba(124,58,237,0.1); }
        .toggle-switch { display: inline-block; width: 50px; height: 26px; background: var(--border); border-radius: 13px; position: relative; cursor: pointer; transition: all 0.3s; }
        .toggle-switch.active { background: var(--success); }
        .toggle-switch::after { content: ''; position: absolute; width: 20px; height: 20px; background: white; border-radius: 50%; top: 3px; left: 3px; transition: all 0.3s; }
        .toggle-switch.active::after { left: 27px; }
        .danger-btn { background: rgba(255,0,68,0.15); border: 1px solid rgba(255,0,68,0.4); color: #ff4466; padding: 0.6rem 1.2rem; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.2s; }
        .danger-btn:hover { background: rgba(255,0,68,0.3); }
        .story-row { display: flex; align-items: center; gap: 1rem; padding: 0.75rem; border-bottom: 1px solid var(--border); }
        .story-row:last-child { border-bottom: none; }
        .spinner { width: 24px; height: 24px; border: 3px solid var(--border); border-top-color: var(--primary); border-radius: 50%; animation: spin 0.7s linear infinite; margin: 0 auto; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div class="header">
        <h1>üëë Owner Panel</h1>
        <div class="user-info">
            <a href="profile.html" style="color:var(--text-dim);text-decoration:none;font-size:0.9rem;">‚Üê Profile</a>
            <span id="userName">Loading...</span>
            <button class="logout-btn" onclick="logout()">Logout</button>
        </div>
    </div>

    <div class="container">
        
        <div class="stats-grid">
            <div class="stat-card"><h3 id="statUsers">‚Äî</h3><p>Total Users</p></div>
            <div class="stat-card"><h3 id="statCreators">‚Äî</h3><p>Creators</p></div>
            <div class="stat-card"><h3 id="statSongs">‚Äî</h3><p>Songs</p></div>
            <div class="stat-card"><h3 id="statPosts">‚Äî</h3><p>Posts</p></div>
            <div class="stat-card"><h3 id="statStories">‚Äî</h3><p>Stories</p></div>
            <div class="stat-card"><h3 id="statSales">‚Äî</h3><p>Song Sales</p></div>
            <div class="stat-card"><h3 id="statRevenue">‚Äî</h3><p>Platform Revenue (20%)</p></div>
        </div>

        <div class="card">
            <h2>Owner Tools</h2>
            <div class="nav-grid">
                <a href="owner-users.html" class="nav-card"><h3>üë• User Management</h3><p>Manage roles, badges, verifications</p></a>
                <a href="owner-studio.html" class="nav-card"><h3>üé® Owner Studio</h3><p>AI tools</p></a>
                <a href="owner-picks.html" class="nav-card"><h3>‚≠ê Owner Picks</h3><p>Feature artists, tracks, videos</p></a>
                <a href="owner-ads.html" class="nav-card"><h3>üì¢ Ads Manager</h3><p>Approve & manage ads</p></a>
                <a href="owner-coupons.html" class="nav-card"><h3>üéüÔ∏è Ad Discount Codes</h3><p>Create ad coupons</p></a>
                <a href="owner-song-discounts.html" class="nav-card"><h3>üéµ Song Discounts</h3><p>Manage all song discount codes</p></a>
                <a href="owner-payouts.html" class="nav-card"><h3>üí∞ Artist Payouts</h3><p>Process artist earnings (80/20)</p></a>
                <a href="owner-verifications.html" class="nav-card"><h3>‚úÖ Verifications</h3><p>Approve artist/beatmaker requests</p></a>
                <a href="create-profile.html" class="nav-card"><h3>‚ûï Create Profile</h3><p>Add profiles for new or existing users</p></a>
                <a href="settings.html" class="nav-card"><h3>‚öôÔ∏è Settings</h3><p>PayPal & site configuration</p></a>
            </div>
        </div>

        <!-- CONTENT MANAGEMENT -->
        <div class="card">
            <h2>üìã Content Management</h2>
            <div id="storyManager">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem;flex-wrap:wrap;gap:0.5rem;">
                    <h3 style="color:var(--text);font-size:1rem;">Recent Stories</h3>
                    <div style="display:flex;gap:0.5rem;flex-wrap:wrap;">
                        <button class="danger-btn" onclick="deleteAllStories()">üóëÔ∏è Delete ALL Stories</button>
                        <button class="danger-btn" onclick="deleteExpiredStories()">üßπ Clean Expired</button>
                    </div>
                </div>
                <div id="storyList"><div class="spinner"></div></div>
            </div>
        </div>

        <!-- ACTIVITY LOG (inline) -->
        <div class="card">
            <h2>üìã Recent Activity</h2>
            <div id="activityLog"><div class="spinner"></div></div>
        </div>

        <div class="card">
            <h2>Quick Actions</h2>
            <div class="quick-actions">
                <div class="action-btn" onclick="toggleFeature('ai')">
                    <div>ü§ñ AI Features</div>
                    <div class="toggle-switch active" id="aiToggle"></div>
                    <div style="font-size: 0.8rem; color: var(--text-dim); margin-top: 0.5rem;">Currently Enabled</div>
                </div>
                <div class="action-btn" onclick="toggleFeature('maintenance')">
                    <div>üîß Maintenance Mode</div>
                    <div class="toggle-switch" id="maintenanceToggle"></div>
                    <div style="font-size: 0.8rem; color: var(--text-dim); margin-top: 0.5rem;">Currently Disabled</div>
                </div>
            </div>
        </div>

    </div>

    <script src="scripts.js" defer onerror="console.warn('scripts.js failed to load')"></script>
    <script>
        const SUPABASE_URL = 'https://novbuvwpjnxwwvdekjhr.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5vdmJ1dndwam54d3d2ZGVramhyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjExODkxODUsImV4cCI6MjA3Njc2NTE4NX0.1UUkdGafh6ZplAX8hi7Bvj94D2gvFQZUl0an1RvcSA0';
        const s = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        let currentSession = null;
        
        async function init() {
            try {
                const { data: { session } } = await s.auth.getSession();
                if (!session) { location.href = 'login.html?return=owner-panel.html'; return; }
                currentSession = session;
                const { data: profile } = await s.from('profiles').select('*').eq('user_id', session.user.id).single();
                if (!profile || profile.role !== 'owner') { alert('Owner access only.'); location.href = 'index.html'; return; }
                document.getElementById('userName').textContent = 'üëë ' + (profile.display_name || profile.username || profile.email);
                loadStats();
                loadStories();
                loadActivity();
            } catch (error) {
                console.error('Init error:', error);
                document.getElementById('userName').textContent = 'Error';
            }
        }

        async function loadStats() {
            // Each stat loads independently ‚Äî if a table doesn't exist it just shows 0
            try { const { count } = await s.from('profiles').select('*', { count: 'exact', head: true }); document.getElementById('statUsers').textContent = count || 0; } catch(e) { document.getElementById('statUsers').textContent = '0'; }
            
            try {
                const { data: creators } = await s.from('profiles').select('user_id').or('role.eq.artist,role.eq.beatmaker,role.eq.producer,role.eq.singer,role.eq.rapper,role.eq.musician,role.eq.songwriter,role.eq.dj');
                document.getElementById('statCreators').textContent = (creators || []).length;
            } catch(e) { document.getElementById('statCreators').textContent = '0'; }

            try { const { count } = await s.from('songs').select('*', { count: 'exact', head: true }); document.getElementById('statSongs').textContent = count || 0; } catch(e) { document.getElementById('statSongs').textContent = '0'; }
            try { const { count } = await s.from('posts').select('*', { count: 'exact', head: true }); document.getElementById('statPosts').textContent = count || 0; } catch(e) { document.getElementById('statPosts').textContent = '0'; }
            try { const { count } = await s.from('stories').select('*', { count: 'exact', head: true }); document.getElementById('statStories').textContent = count || 0; } catch(e) { document.getElementById('statStories').textContent = '0'; }
            try { const { count } = await s.from('song_purchases').select('*', { count: 'exact', head: true }); document.getElementById('statSales').textContent = count || 0; } catch(e) { document.getElementById('statSales').textContent = '0'; }
            
            try {
                const { data: payouts } = await s.from('artist_payouts').select('platform_amount');
                let total = 0;
                if (payouts) payouts.forEach(p => total += parseFloat(p.platform_amount) || 0);
                document.getElementById('statRevenue').textContent = '$' + total.toFixed(2);
            } catch(e) { document.getElementById('statRevenue').textContent = '$0.00'; }
        }

        async function loadStories() {
            const el = document.getElementById('storyList');
            try {
                const { data: stories, error } = await s.from('stories').select('id, user_id, text, background_color, media_url, media_type, created_at, expires_at').order('created_at', { ascending: false }).limit(20);
                if (error) throw error;
                if (!stories || stories.length === 0) { el.innerHTML = '<p style="color:var(--text-dim);text-align:center;padding:1rem;">No stories in database.</p>'; return; }
                
                const uids = [...new Set(stories.map(st => st.user_id).filter(Boolean))];
                let pm = {};
                if (uids.length > 0) {
                    const { data: profs } = await s.from('profiles').select('user_id, username, display_name').in('user_id', uids);
                    if (profs) profs.forEach(p => pm[p.user_id] = p);
                }

                el.innerHTML = stories.map(st => {
                    const p = pm[st.user_id] || {};
                    const name = p.display_name || p.username || (st.user_id ? st.user_id.substring(0,8) : 'Unknown');
                    const preview = st.text ? st.text.substring(0, 50) + (st.text.length > 50 ? '...' : '') : (st.media_url ? 'üì∏ Photo' : '‚Äî');
                    const expired = st.expires_at && new Date(st.expires_at) < new Date();
                    const ago = timeAgo(st.created_at);
                    return '<div class="story-row">' +
                        '<div style="min-width:12px;height:12px;border-radius:50%;background:' + (st.background_color || '#7c3aed') + ';flex-shrink:0;"></div>' +
                        '<div style="flex:1;min-width:0;"><div style="font-weight:600;font-size:0.9rem;">' + name + (expired ? ' <span style="color:#ef4444;font-size:0.75rem;">EXPIRED</span>' : '') + '</div><div style="font-size:0.8rem;color:var(--text-dim);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">' + preview + '</div><div style="font-size:0.7rem;color:rgba(168,85,247,0.5);">' + ago + '</div></div>' +
                        '<button onclick="deleteStory(\'' + st.id + '\')" class="danger-btn" style="padding:0.3rem 0.6rem;font-size:0.75rem;">üóëÔ∏è</button>' +
                    '</div>';
                }).join('');
            } catch(e) { el.innerHTML = '<p style="color:#ef4444;">Error: ' + e.message + '</p>'; }
        }

        async function loadActivity() {
            const el = document.getElementById('activityLog');
            try {
                // Show recent posts, stories, and signups as activity
                const [posts, stories, profiles] = await Promise.all([
                    s.from('posts').select('id, user_id, text, created_at').order('created_at', { ascending: false }).limit(5),
                    s.from('stories').select('id, user_id, text, created_at').order('created_at', { ascending: false }).limit(5),
                    s.from('profiles').select('user_id, username, display_name, created_at').order('created_at', { ascending: false }).limit(5)
                ]);
                
                let items = [];
                if (posts.data) posts.data.forEach(p => items.push({ type: 'üìù Post', user: p.user_id, text: (p.text||'').substring(0,40), time: p.created_at }));
                if (stories.data) stories.data.forEach(st => items.push({ type: 'üìñ Story', user: st.user_id, text: (st.text||'Photo').substring(0,40), time: st.created_at }));
                if (profiles.data) profiles.data.forEach(p => items.push({ type: 'üë§ Signup', user: p.user_id, text: p.display_name || p.username || '', time: p.created_at }));
                
                items.sort((a, b) => new Date(b.time) - new Date(a.time));
                items = items.slice(0, 15);

                if (items.length === 0) { el.innerHTML = '<p style="color:var(--text-dim);text-align:center;">No activity yet.</p>'; return; }

                el.innerHTML = items.map(item => {
                    return '<div style="display:flex;gap:0.75rem;padding:0.5rem 0;border-bottom:1px solid var(--border);font-size:0.85rem;">' +
                        '<span style="flex-shrink:0;">' + item.type + '</span>' +
                        '<span style="flex:1;color:var(--text-dim);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">' + item.text + '</span>' +
                        '<span style="color:rgba(168,85,247,0.5);flex-shrink:0;font-size:0.75rem;">' + timeAgo(item.time) + '</span>' +
                    '</div>';
                }).join('');
            } catch(e) { el.innerHTML = '<p style="color:var(--text-dim);">Activity unavailable.</p>'; }
        }

        window.deleteStory = async function(storyId) {
            if (!confirm('Delete this story?')) return;
            try {
                const { error } = await s.from('stories').delete().eq('id', storyId);
                if (error) throw error;
                loadStories();
                loadStats();
            } catch(e) { alert('Error: ' + e.message); }
        };

        window.deleteAllStories = async function() {
            if (!confirm('‚ö†Ô∏è DELETE ALL STORIES? This cannot be undone.')) return;
            if (!confirm('Are you absolutely sure? ALL stories will be permanently deleted.')) return;
            try {
                // Delete all stories by matching any user_id (not null)
                const { error } = await s.from('stories').delete().not('id', 'is', null);
                if (error) throw error;
                alert('‚úÖ All stories deleted.');
                loadStories();
                loadStats();
            } catch(e) { alert('Error: ' + e.message); }
        };

        window.deleteExpiredStories = async function() {
            if (!confirm('Delete all expired stories?')) return;
            try {
                const { error } = await s.from('stories').delete().lt('expires_at', new Date().toISOString());
                if (error) throw error;
                alert('‚úÖ Expired stories cleaned up.');
                loadStories();
                loadStats();
            } catch(e) { alert('Error: ' + e.message); }
        };

        function toggleFeature(feature) {
            const toggle = document.getElementById(feature + 'Toggle');
            if (toggle) toggle.classList.toggle('active');
        }

        function timeAgo(d) {
            if (!d) return '';
            const m = Math.floor((Date.now() - new Date(d).getTime()) / 60000);
            if (m < 1) return 'now';
            if (m < 60) return m + 'm ago';
            const h = Math.floor(m / 60);
            if (h < 24) return h + 'h ago';
            const dy = Math.floor(h / 24);
            if (dy < 30) return dy + 'd ago';
            return new Date(d).toLocaleDateString();
        }

        async function logout() {
            await s.auth.signOut();
            location.href = 'login.html';
        }

        if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', init);
        else init();
    </script>

</body>
</html>
