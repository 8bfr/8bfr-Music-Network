<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Owner Panel - 8BFR</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root{--primary:#ff0066;--secondary:#00ccff;--dark:#0a0a0a;--dark-card:#1a1a1a;--success:#00ff88;--warning:#ffaa00;--danger:#ff0044;--text:#ffffff;--text-dim:#999999;--border:#333333}*{margin:0;padding:0;box-sizing:border-box}body{font-family:system-ui,sans-serif;background:var(--dark);color:var(--text);line-height:1.6;overflow-x:hidden}.header{background:linear-gradient(135deg,var(--dark-card) 0%,#000 100%);border-bottom:2px solid var(--primary);padding:1.5rem;display:flex;justify-content:space-between;align-items:center;position:sticky;top:0;z-index:100}.header h1{font-size:1.5rem;color:var(--primary)}.logout-btn{background:var(--danger);color:white;border:none;padding:0.5rem 1rem;border-radius:4px;cursor:pointer}.container{max-width:1400px;margin:0 auto;padding:1rem}.tabs{display:flex;gap:0.5rem;margin-bottom:1rem;border-bottom:2px solid var(--border);overflow-x:auto}.tab{background:transparent;color:var(--text-dim);border:none;padding:0.75rem 1rem;cursor:pointer;border-bottom:3px solid transparent;white-space:nowrap;font-size:0.9rem}.tab.active{color:var(--primary);border-bottom-color:var(--primary)}.tab-content{display:none}.tab-content.active{display:block}.card{background:var(--dark-card);border:1px solid var(--border);border-radius:8px;padding:1rem;margin-bottom:1rem}.card h2{color:var(--primary);margin-bottom:0.75rem;font-size:1.2rem}.card h3{color:var(--secondary);margin:1rem 0 0.5rem 0;font-size:1rem}.form-group{margin-bottom:1rem}.form-group label{display:block;margin-bottom:0.25rem;font-weight:600;font-size:0.9rem}.form-group input,.form-group select,.form-group textarea{width:100%;padding:0.6rem;background:var(--dark);border:1px solid var(--border);border-radius:4px;color:var(--text);font-size:0.9rem}.form-group textarea{min-height:80px}.btn{background:var(--primary);color:white;border:none;padding:0.6rem 1.2rem;border-radius:4px;cursor:pointer;margin:0.25rem;font-size:0.9rem}.btn-danger{background:var(--danger)}.btn-success{background:var(--success);color:#000}.btn-secondary{background:var(--secondary);color:#000}.btn-warning{background:var(--warning);color:#000}.btn-sm{padding:0.4rem 0.7rem;font-size:0.8rem}.item-list{max-height:400px;overflow-y:auto}.item{background:var(--dark);border:1px solid var(--border);padding:0.75rem;margin-bottom:0.5rem;border-radius:4px}.item-actions{display:flex;gap:0.3rem;flex-wrap:wrap;margin-top:0.5rem}.pill{display:inline-block;padding:0.2rem 0.6rem;background:rgba(0,204,255,0.2);border-radius:999px;font-size:0.75rem;margin:0.2rem}.pill.role{background:rgba(255,0,102,0.2)}.pill.badge{background:rgba(0,255,136,0.2)}.muted{color:var(--text-dim);font-size:0.85rem}.message{padding:0.6rem;border-radius:4px;margin:0.5rem 0;font-size:0.9rem}.message.error{background:rgba(255,68,68,0.1);color:#ff4444}.message.success{background:rgba(68,255,136,0.1);color:#44ff88}.checkbox-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(130px,1fr));gap:0.4rem;max-height:300px;overflow-y:auto;border:1px solid var(--border);padding:0.5rem;border-radius:4px}.checkbox-item{display:flex;align-items:center;gap:0.4rem;font-size:0.85rem}.checkbox-item input{width:auto}.modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.9);z-index:1000;overflow-y:auto}.modal.active{display:block}.modal-content{background:var(--dark-card);margin:1rem auto;max-width:600px;padding:1.5rem;border-radius:8px;border:1px solid var(--border)}
    </style>
</head>
<body>
    <div class="header">
        <h1>OWNER PANEL</h1>
        <div><span id="ownerName" class="pill">...</span><button class="logout-btn" onclick="logout()">Logout</button></div>
    </div>

    <div class="container">
        <div class="tabs">
            <button class="tab active" onclick="switchTab('users')">Users</button>
            <button class="tab" onclick="switchTab('badges')">Badges/Roles</button>
            <button class="tab" onclick="switchTab('hashtags')">Hashtags</button>
            <button class="tab" onclick="switchTab('ads')">Ads</button>
            <button class="tab" onclick="switchTab('economy')">Economy</button>
            <button class="tab" onclick="switchTab('content')">Content</button>
            <button class="tab" onclick="switchTab('chat')">Chat</button>
            <button class="tab" onclick="switchTab('stats')">Stats</button>
        </div>

        <div id="users" class="tab-content active">
            <div class="card">
                <h2>Users</h2>
                <input type="text" id="userSearch" placeholder="Search..." oninput="loadUsers()" style="width:100%;padding:0.6rem;background:var(--dark);border:1px solid var(--border);border-radius:4px;color:var(--text);margin-bottom:0.5rem;">
                <button class="btn btn-sm" onclick="loadUsers()">Refresh</button>
                <button class="btn btn-sm btn-success" onclick="showModal('createUser')">New User</button>
                <button class="btn btn-sm btn-secondary" onclick="showModal('createDummy')">Dummy</button>
                <div class="item-list" id="usersList"><p class="muted">Loading...</p></div>
            </div>
        </div>

        <div id="badges" class="tab-content">
            <div class="card">
                <h2>Badges & Roles</h2>
                <div class="form-group"><label>User</label><select id="brUser"></select></div>
                <h3>Roles (Site Permissions)</h3><div class="checkbox-grid" id="rolesGrid"></div>
                <h3>Badges (Achievements)</h3><div class="checkbox-grid" id="badgesGrid"></div>
                <div id="brMsg"></div>
                <button class="btn btn-success" onclick="saveBR()">Save Changes</button>
            </div>
        </div>

        <div id="hashtags" class="tab-content">
            <div class="card">
                <h2>New Hashtag</h2>
                <div class="form-group"><label>Name (without #)</label><input type="text" id="htName" placeholder="trending"></div>
                <div class="form-group"><label>Algorithm Points</label><input type="number" id="htPts" placeholder="100"></div>
                <div id="htMsg"></div>
                <button class="btn btn-success" onclick="createHT()">Create</button>
            </div>
            <div class="card"><h2>All Hashtags</h2><button class="btn btn-sm" onclick="loadHT()">Refresh</button><div class="item-list" id="htList"></div></div>
        </div>

        <div id="ads" class="tab-content">
            <div class="card"><h2>Pending Approval</h2><button class="btn btn-sm" onclick="loadAdsPending()">Refresh</button><div class="item-list" id="adsPending"></div></div>
            <div class="card"><h2>All Ads</h2><button class="btn btn-sm" onclick="loadAdsAll()">Refresh</button><div class="item-list" id="adsAll"></div></div>
        </div>

        <div id="economy" class="tab-content">
            <div class="card">
                <h2>Adjust Coins</h2>
                <div class="form-group"><label>User</label><select id="coinUser"></select></div>
                <div class="form-group"><label>Amount (+ add, - remove)</label><input type="number" id="coinAmt" placeholder="100"></div>
                <div class="form-group"><label>Current Balance: <span id="coinBal">-</span></label></div>
                <div id="coinMsg"></div>
                <button class="btn btn-success" onclick="adjustCoins()">Apply</button>
            </div>
            <div class="card">
                <h2>Discount Code</h2>
                <div class="form-group"><label>Code</label><input type="text" id="dcCode" placeholder="PROMO2025"></div>
                <div class="form-group"><label>Amount</label><select id="dcAmt"><option value="1">$1.00</option><option value="2">$2.00</option><option value="3">$3.00</option><option value="4">$4.00</option><option value="5">FREE</option></select></div>
                <div class="form-group"><label>Expiry</label><select id="dcExp"><option value="">No Expiration</option><option value="7">7 days</option><option value="30">30 days</option></select></div>
                <div id="dcMsg"></div>
                <button class="btn btn-success" onclick="createDC()">Create</button>
            </div>
            <div class="card"><h2>Active Codes</h2><button class="btn btn-sm" onclick="loadDC()">Refresh</button><div class="item-list" id="dcList"></div></div>
        </div>

        <div id="content" class="tab-content">
            <div class="card">
                <h2>Feature Content</h2>
                <div class="form-group"><label>Type</label><select id="ftType" onchange="loadFT()"><option value="post">Post</option><option value="song">Song</option><option value="artist">Artist</option><option value="beatmaker">Beatmaker</option><option value="user">User</option></select></div>
                <div class="form-group"><label>Select Content</label><select id="ftId"></select></div>
                <div id="ftMsg"></div>
                <button class="btn btn-success" onclick="feature()">Feature</button>
            </div>
            <div class="card"><h2>Posts</h2><button class="btn btn-sm" onclick="loadPosts()">Refresh</button><div class="item-list" id="postList"></div></div>
        </div>

        <div id="chat" class="tab-content">
            <div class="card">
                <h2>User Actions</h2>
                <div class="form-group"><label>Select User</label><select id="chatUser"></select></div>
                <button class="btn btn-warning btn-sm" onclick="mute()">Mute</button>
                <button class="btn btn-danger btn-sm" onclick="kick()">Kick</button>
                <button class="btn btn-danger btn-sm" onclick="banChat()">Ban Chat</button>
                <button class="btn btn-danger btn-sm" onclick="banSite()">Ban Site</button>
                <div id="chatMsg"></div>
            </div>
            <div class="card">
                <h2>Message Moderation</h2>
                <div class="form-group"><label>Select Message</label><select id="msgSel"></select></div>
                <button class="btn btn-warning btn-sm" onclick="hideMsg()">Hide</button>
                <button class="btn btn-danger btn-sm" onclick="delMsg()">Delete</button>
                <div id="msgMsg"></div>
            </div>
            <div class="card">
                <h2>Promote/Demote</h2>
                <div class="form-group"><label>User</label><select id="pmUser"></select></div>
                <h3>Select Roles (multiple)</h3>
                <div class="checkbox-grid" id="pmRoles"></div>
                <div id="pmMsg"></div>
                <button class="btn btn-success" onclick="promote()">Save Roles</button>
            </div>
        </div>

        <div id="stats" class="tab-content">
            <div class="card">
                <h2>Platform Stats</h2><button class="btn btn-sm" onclick="loadStats()">Refresh</button>
                <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:1rem;margin-top:1rem;">
                    <div class="card"><h3>Users</h3><p id="stUsers" style="font-size:2rem;color:var(--primary);">0</p></div>
                    <div class="card"><h3>Creators</h3><p id="stCreators" style="font-size:2rem;color:var(--success);">0</p></div>
                    <div class="card"><h3>Posts</h3><p id="stPosts" style="font-size:2rem;color:var(--secondary);">0</p></div>
                    <div class="card"><h3>Songs</h3><p id="stSongs" style="font-size:2rem;color:var(--warning);">0</p></div>
                </div>
            </div>
        </div>
    </div>

    <div id="createUser" class="modal"><div class="modal-content"><h2>New User</h2><div class="form-group"><label>Email</label><input id="nuEmail"></div><div class="form-group"><label>Username</label><input id="nuUser"></div><div class="form-group"><label>Display Name</label><input id="nuName"></div><div class="form-group"><label>Role</label><select id="nuRole"></select></div><div id="nuMsg"></div><button class="btn btn-success" onclick="createU()">Create</button><button class="btn" onclick="hideModal('createUser')">Cancel</button></div></div>

    <div id="createDummy" class="modal"><div class="modal-content"><h2>Dummy</h2><div class="form-group"><label>Username</label><input id="duUser"></div><div class="form-group"><label>Display Name</label><input id="duName"></div><div class="form-group"><label>Role</label><select id="duRole"></select></div><div id="duMsg"></div><button class="btn btn-success" onclick="createD()">Create</button><button class="btn" onclick="hideModal('createDummy')">Cancel</button></div></div>

    <div id="editUser" class="modal"><div class="modal-content"><h2>Edit User</h2><input type="hidden" id="euId"><div class="form-group"><label>Username</label><input id="euUser"></div><div class="form-group"><label>Display Name</label><input id="euName"></div><div class="form-group"><label>Email</label><input id="euEmail"></div><div class="form-group"><label>Bio</label><textarea id="euBio"></textarea></div><div id="euMsg"></div><button class="btn btn-success" onclick="saveEdit()">Save</button><button class="btn" onclick="hideModal('editUser')">Cancel</button></div></div>

    <div id="reviewAd" class="modal"><div class="modal-content"><h2>Review Ad</h2><input type="hidden" id="raId"><div id="raPrev" style="padding:1rem;background:var(--dark);border:1px solid var(--border);border-radius:4px;margin-bottom:1rem;"></div><div class="form-group"><label>Message to User</label><textarea id="raMsg" placeholder="Optional message..."></textarea></div><button class="btn btn-success" onclick="approveAd()">Approve Ad</button><button class="btn btn-danger" onclick="denyAd()">Deny Ad</button><button class="btn" onclick="hideModal('reviewAd')">Cancel</button></div></div>

    <script>
const SUPABASE_URL='https://novbuvwpjnxwwvdekjhr.supabase.co';const SUPABASE_KEY='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5vdmJ1dndwam54d3d2ZGVramhyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjExODkxODUsImV4cCI6MjA3Njc2NTE4NX0.1UUkdGafh6ZplAX8hi7Bvj94D2gvFQZUl0an1RvcSA0';const sup=window.supabase.createClient(SUPABASE_URL,SUPABASE_KEY);let cu=null;const ROLES=['owner','admin','mod','founder','carrie_ai_assistant','carrie_performer','carrie_voice_clone','carrie_fashionista','carrie_concert_vip','vip_member','beta_tester','sponsor','donor','parent','g7','verified'];const BADGES=['artist','beatmaker','producer','singer','rapper','musician','songwriter','dj','engineer','label','promoter','distributor','videographer','photographer','filmmaker','podcaster','designer','author','blogger','game_creator','developer','streamer','gamer','influencer','brand_ambassador','community_leader','mentor','supporter','fan','student','educator','collector','kids','top_creator','contest_winner','tournament_champion','event_participant','early_supporter'];async function init(){try{const{data:s}=await sup.auth.getSession();if(!s.session){alert('Login');window.location.href='login.html';return}const{data:{user}}=await sup.auth.getUser();if(!user){window.location.href='login.html';return}cu=user;const{data:p}=await sup.from('profiles').select('*').eq('user_id',user.id).single();if(!p||(p.role!=='owner'&&(!p.roles_ordered||!p.roles_ordered.includes('owner')))){alert('Owner only');window.location.href='index.html';return}document.getElementById('ownerName').textContent=p.username||cu.email.split('@')[0];popSel();loadUsers();loadStats()}catch(e){alert('Error: '+e.message)}}function popSel(){['nuRole','duRole'].forEach(id=>{const s=document.getElementById(id);if(s)s.innerHTML=ROLES.map(r=>'<option value="'+r+'">'+r+'</option>').join('')})}function switchTab(n){document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));document.querySelectorAll('.tab-content').forEach(c=>c.classList.remove('active'));event.target.classList.add('active');document.getElementById(n).classList.add('active');if(n==='ads'){loadAdsPending();loadAdsAll()}else if(n==='economy'){loadUserSel('coinUser');loadDC()}else if(n==='content'){loadPosts();loadFT()}else if(n==='chat'){loadUserSel('chatUser');loadUserSel('pmUser');loadMessages()}else if(n==='badges'){loadUserBR()}else if(n==='hashtags'){loadHT()}}async function loadUsers(){const s=document.getElementById('userSearch').value.toLowerCase();const l=document.getElementById('usersList');try{l.innerHTML='<p class="muted">Loading...</p>';const{data:u,error:e}=await sup.from('profiles').select('*').order('created_at',{ascending:false});if(e)throw e;let f=u||[];if(s)f=f.filter(x=>(x.username||'').toLowerCase().includes(s)||(x.email||'').toLowerCase().includes(s)||(x.role||'').toLowerCase().includes(s));if(f.length===0){l.innerHTML='<p class="muted">None</p>';return}l.innerHTML=f.map(x=>{const r=x.roles_ordered||(x.role?[x.role]:[]);const b=x.badges||[];return'<div class="item"><div><strong>'+esc(x.username||x.email||'user')+'</strong><div class="muted">'+esc(x.email||'No email')+'</div><div class="muted">Coins: '+(x.coins||0)+'</div></div><div>'+r.map(y=>'<span class="pill role">'+y+'</span>').join('')+b.map(y=>'<span class="pill badge">'+y+'</span>').join('')+'</div><div class="item-actions"><button class="btn btn-sm" onclick="editU(\''+x.user_id+'\')">Edit</button>'+(x.email?'<button class="btn btn-sm" onclick="resetPW(\''+esc(x.email)+'\')">Reset PW</button>':'')+'<button class="btn btn-sm btn-danger" onclick="delU(\''+x.user_id+'\')">Delete</button></div></div>'}).join('')}catch(e){l.innerHTML='<p class="message error">'+e.message+'</p>'}}function showModal(id){document.getElementById(id).classList.add('active')}function hideModal(id){document.getElementById(id).classList.remove('active')}async function createU(){const e=document.getElementById('nuEmail').value.trim();const u=document.getElementById('nuUser').value.trim();const n=document.getElementById('nuName').value.trim();const r=document.getElementById('nuRole').value;const m=document.getElementById('nuMsg');if(!e||!u){m.innerHTML='<p class="message error">Email & username required</p>';return}try{const p=Math.random().toString(36)+Math.random().toString(36);const{data:d,error:er}=await sup.auth.signUp({email:e,password:p});if(er)throw er;if(!d.user)throw new Error('No user');await sup.from('profiles').insert({user_id:d.user.id,email:e,username:u,display_name:n||u,role:r,roles_ordered:[r],badges:[],coins:0,created_at:new Date().toISOString()});m.innerHTML='<p class="message success">Created!</p>';document.getElementById('nuEmail').value='';document.getElementById('nuUser').value='';document.getElementById('nuName').value='';setTimeout(()=>{hideModal('createUser');loadUsers()},1000)}catch(er){m.innerHTML='<p class="message error">'+er.message+'</p>'}}async function createD(){const u=document.getElementById('duUser').value.trim();const n=document.getElementById('duName').value.trim();const r=document.getElementById('duRole').value;const m=document.getElementById('duMsg');if(!u){m.innerHTML='<p class="message error">Username required</p>';return}try{await sup.from('profiles').insert({user_id:'dummy_'+Date.now()+'_'+Math.random().toString(36).substr(2,9),username:u,display_name:n||u,role:r,roles_ordered:[r],badges:[],coins:0,created_at:new Date().toISOString()});m.innerHTML='<p class="message success">Created!</p>';document.getElementById('duUser').value='';document.getElementById('duName').value='';setTimeout(()=>{hideModal('createDummy');loadUsers()},1000)}catch(e){m.innerHTML='<p class="message error">'+e.message+'</p>'}}async function editU(id){try{const{data:d,error:e}=await sup.from('profiles').select('*').eq('user_id',id).single();if(e)throw e;document.getElementById('euId').value=id;document.getElementById('euUser').value=d.username||'';document.getElementById('euName').value=d.display_name||'';document.getElementById('euEmail').value=d.email||'';document.getElementById('euBio').value=d.bio||'';showModal('editUser')}catch(e){alert('Error: '+e.message)}}async function saveEdit(){const id=document.getElementById('euId').value;const m=document.getElementById('euMsg');try{const{error:e}=await sup.from('profiles').update({username:document.getElementById('euUser').value,display_name:document.getElementById('euName').value,email:document.getElementById('euEmail').value,bio:document.getElementById('euBio').value}).eq('user_id',id);if(e)throw e;m.innerHTML='<p class="message success">Updated!</p>';setTimeout(()=>{hideModal('editUser');loadUsers()},1000)}catch(e){m.innerHTML='<p class="message error">'+e.message+'</p>'}}async function resetPW(e){if(!confirm('Send reset to '+e+'?'))return;try{const{error:er}=await sup.auth.resetPasswordForEmail(e,{redirectTo:'https://8bfr.github.io/8bfr-Music-Network/change-password.html'});if(er)throw er;alert('Sent!')}catch(er){alert('Error: '+er.message)}}async function delU(id){if(!confirm('Delete? Cannot undo!'))return;try{const{error:e}=await sup.from('profiles').delete().eq('user_id',id);if(e)throw e;alert('Deleted');loadUsers()}catch(e){alert('Error: '+e.message)}}async function loadUserBR(){try{const{data:u}=await sup.from('profiles').select('user_id,username,email,roles_ordered,badges').order('username');const s=document.getElementById('brUser');s.innerHTML='<option value="">Choose user...</option>'+(u||[]).map(x=>'<option value="'+x.user_id+'">'+(x.username||x.email||x.user_id)+'</option>').join('');s.onchange=function(){if(this.value)loadBR(this.value)}}catch(e){}}async function loadBR(id){try{const{data:d}=await sup.from('profiles').select('*').eq('user_id',id).single();if(!d)return;const r=d.roles_ordered||(d.role?[d.role]:[]);const b=d.badges||[];document.getElementById('rolesGrid').innerHTML=ROLES.map(x=>{const c=r.includes(x)?'checked':'';return'<div class="checkbox-item"><input type="checkbox" id="r_'+x+'" value="'+x+'" '+c+'><label for="r_'+x+'">'+x+'</label></div>'}).join('');document.getElementById('badgesGrid').innerHTML=BADGES.map(x=>{const c=b.includes(x)?'checked':'';return'<div class="checkbox-item"><input type="checkbox" id="b_'+x+'" value="'+x+'" '+c+'><label for="b_'+x+'">'+x+'</label></div>'}).join('')}catch(e){}}async function saveBR(){const id=document.getElementById('brUser').value;const m=document.getElementById('brMsg');if(!id){m.innerHTML='<p class="message error">Select user</p>';return}try{const r=ROLES.filter(x=>document.getElementById('r_'+x)?.checked);const b=BADGES.filter(x=>document.getElementById('b_'+x)?.checked);const{error:e}=await sup.from('profiles').update({role:r[0]||'fan',roles_ordered:r,badges:b}).eq('user_id',id);if(e)throw e;m.innerHTML='<p class="message success">Saved!</p>';setTimeout(()=>{m.innerHTML='';loadUsers()},1500)}catch(e){m.innerHTML='<p class="message error">'+e.message+'</p>'}}async function createHT(){const n=document.getElementById('htName').value.trim();const p=parseInt(document.getElementById('htPts').value);const m=document.getElementById('htMsg');if(!n||!p){m.innerHTML='<p class="message error">Fill all fields</p>';return}try{const{error:e}=await sup.from('hashtags').insert({name:n.toLowerCase().replace('#',''),algorithm_points:p,created_at:new Date().toISOString()});if(e)throw e;m.innerHTML='<p class="message success">Created!</p>';document.getElementById('htName').value='';document.getElementById('htPts').value='';loadHT()}catch(e){m.innerHTML='<p class="message error">'+e.message+'</p>'}}async function loadHT(){const l=document.getElementById('htList');if(!l)return;try{const{data:h}=await sup.from('hashtags').select('*').order('algorithm_points',{ascending:false});if(!h||h.length===0){l.innerHTML='<p class="muted">No hashtags yet</p>';return}l.innerHTML=h.map(x=>'<div class="item"><strong>#'+x.name+'</strong> - '+x.algorithm_points+' pts<button class="btn btn-sm btn-danger" onclick="delHT(\''+x.id+'\')">Delete</button></div>').join('')}catch(e){l.innerHTML='<p class="message error">'+e.message+'</p>'}}async function delHT(id){if(!confirm('Delete hashtag?'))return;try{await sup.from('hashtags').delete().eq('id',id);loadHT()}catch(e){alert('Error: '+e.message)}}async function loadAdsPending(){const l=document.getElementById('adsPending');if(!l)return;try{const{data:a}=await sup.from('ads').select('*').eq('status','pending').order('created_at',{ascending:false});if(!a||a.length===0){l.innerHTML='<p class="muted">No pending ads</p>';return}l.innerHTML=a.map(x=>'<div class="item"><strong>'+esc(x.title||'Untitled')+'</strong><div class="muted">By: '+(x.user_email||x.user_id||'Unknown')+'</div><button class="btn btn-sm btn-success" onclick="revAd(\''+x.id+'\')">Review</button></div>').join('')}catch(e){l.innerHTML='<p class="message error">'+e.message+'</p>'}}async function loadAdsAll(){const l=document.getElementById('adsAll');if(!l)return;try{const{data:a}=await sup.from('ads').select('*').order('created_at',{ascending:false});if(!a||a.length===0){l.innerHTML='<p class="muted">No ads</p>';return}l.innerHTML=a.map(x=>'<div class="item"><strong>'+esc(x.title||'Untitled')+'</strong><span class="pill">'+x.status+'</span>'+(x.admin_message?'<div class="muted">Note: '+esc(x.admin_message)+'</div>':'')+'<button class="btn btn-sm btn-danger" onclick="delAd(\''+x.id+'\')">Delete</button></div>').join('')}catch(e){l.innerHTML='<p class="message error">'+e.message+'</p>'}}async function revAd(id){try{const{data:d}=await sup.from('ads').select('*').eq('id',id).single();if(!d)return;document.getElementById('raId').value=id;document.getElementById('raPrev').innerHTML='<h3>'+esc(d.title||'No title')+'</h3><p>'+esc(d.content||'No content')+'</p>'+(d.image_url?'<img src="'+esc(d.image_url)+'" style="max-width:100%;margin-top:0.5rem;">':'')+'<div class="muted" style="margin-top:0.5rem;">By: '+(d.user_email||d.user_id||'Unknown')+'</div>';showModal('reviewAd')}catch(e){alert('Error: '+e.message)}}async function approveAd(){const id=document.getElementById('raId').value;const msg=document.getElementById('raMsg').value;try{await sup.from('ads').update({status:'approved',admin_message:msg||null}).eq('id',id);alert('Ad approved!');hideModal('reviewAd');loadAdsPending();loadAdsAll()}catch(e){alert('Error: '+e.message)}}async function denyAd(){const id=document.getElementById('raId').value;const msg=document.getElementById('raMsg').value;if(!msg){alert('Please provide a reason for denial');return}try{await sup.from('ads').update({status:'denied',admin_message:msg}).eq('id',id);alert('Ad denied. User will receive your message.');hideModal('reviewAd');loadAdsPending();loadAdsAll()}catch(e){alert('Error: '+e.message)}}async function delAd(id){if(!confirm('Delete this ad?'))return;try{await sup.from('ads').delete().eq('id',id);loadAdsAll()}catch(e){alert('Error: '+e.message)}}async function loadUserSel(sid){try{const{data:u}=await sup.from('profiles').select('user_id,username,email,coins').order('username');const s=document.getElementById(sid);if(!s)return;s.innerHTML='<option value="">Choose user...</option>'+(u||[]).map(x=>'<option value="'+x.user_id+'" data-coins="'+(x.coins||0)+'">'+(x.username||x.email||x.user_id)+'</option>').join('');if(sid==='coinUser'){s.onchange=function(){const opt=this.options[this.selectedIndex];document.getElementById('coinBal').textContent=opt.getAttribute('data-coins')||'0'}}if(sid==='pmUser'){s.onchange=async function(){if(!this.value)return;try{const{data:d}=await sup.from('profiles').select('roles_ordered').eq('user_id',this.value).single();const ur=d?.roles_ordered||[];document.getElementById('pmRoles').innerHTML=ROLES.map(x=>{const c=ur.includes(x)?'checked':'';return'<div class="checkbox-item"><input type="checkbox" id="pmr_'+x+'" value="'+x+'" '+c+'><label for="pmr_'+x+'">'+x+'</label></div>'}).join('')}catch(e){}}}}catch(e){}}async function adjustCoins(){const id=document.getElementById('coinUser').value;const a=parseInt(document.getElementById('coinAmt').value);const m=document.getElementById('coinMsg');if(!id||!a){m.innerHTML='<p class="message error">Select user and enter amount</p>';return}try{const{data:p}=await sup.from('profiles').select('coins').eq('user_id',id).single();const c=p?.coins||0;const newBal=c+a;await sup.from('profiles').update({coins:newBal}).eq('user_id',id);m.innerHTML='<p class="message success">Coins adjusted! New balance: '+newBal+'</p>';document.getElementById('coinBal').textContent=newBal;document.getElementById('coinAmt').value='';setTimeout(()=>m.innerHTML='',2000)}catch(e){m.innerHTML='<p class="message error">'+e.message+'</p>'}}async function createDC(){const c=document.getElementById('dcCode').value.toUpperCase();const a=parseFloat(document.getElementById('dcAmt').value);const x=document.getElementById('dcExp').value;const m=document.getElementById('dcMsg');if(!c){m.innerHTML='<p class="message error">Code required</p>';return}try{const ex=x?new Date(Date.now()+parseInt(x)*24*60*60*1000).toISOString():null;const{error:e}=await sup.from('discount_codes').insert({code:c,discount_amount:a,expiry_date:ex,used:false,created_at:new Date().toISOString()});if(e)throw e;m.innerHTML='<p class="message success">Code created!</p>';document.getElementById('dcCode').value='';loadDC()}catch(e){m.innerHTML='<p class="message error">'+e.message+'</p>'}}async function loadDC(){const l=document.getElementById('dcList');if(!l)return;try{const{data:d}=await sup.from('discount_codes').select('*').order('created_at',{ascending:false});if(!d||d.length===0){l.innerHTML='<p class="muted">No codes</p>';return}l.innerHTML=d.map(x=>'<div class="item"><strong>'+x.code+'</strong> - $'+x.discount_amount+(x.used?' <span class="pill">USED</span>':' <span class="pill badge">ACTIVE</span>')+(x.expiry_date?' <div class="muted">Exp: '+new Date(x.expiry_date).toLocaleDateString()+'</div>':'')+'<button class="btn btn-sm btn-danger" onclick="delDC(\''+x.id+'\')">Delete</button></div>').join('')}catch(e){l.innerHTML='<p class="message error">'+e.message+'</p>'}}async function delDC(id){if(!confirm('Delete discount code?'))return;try{await sup.from('discount_codes').delete().eq('id',id);loadDC()}catch(e){alert('Error: '+e.message)}}async function loadFT(){const t=document.getElementById('ftType').value;const s=document.getElementById('ftId');try{let d=[];if(t==='post'){const r=await sup.from('posts').select('id,content').limit(100);d=(r.data||[]).map(x=>({id:x.id,name:(x.content||'').substring(0,50)}))}else if(t==='song'){const r=await sup.from('songs').select('id,title').limit(100);d=(r.data||[]).map(x=>({id:x.id,name:x.title||'Untitled'}))}else if(t==='artist'){const r=await sup.from('profiles').select('user_id,username').contains('badges',['artist']).limit(100);d=(r.data||[]).map(x=>({id:x.user_id,name:x.username||'User'}))}else if(t==='beatmaker'){const r=await sup.from('profiles').select('user_id,username').contains('badges',['beatmaker']).limit(100);d=(r.data||[]).map(x=>({id:x.user_id,name:x.username||'User'}))}else if(t==='user'){const r=await sup.from('profiles').select('user_id,username').limit(100);d=(r.data||[]).map(x=>({id:x.user_id,name:x.username||'User'}))}s.innerHTML='<option value="">Choose...</option>'+d.map(x=>'<option value="'+x.id+'">'+esc(x.name)+'</option>').join('')}catch(e){}}async function feature(){const t=document.getElementById('ftType').value;const id=document.getElementById('ftId').value;const m=document.getElementById('ftMsg');if(!id){m.innerHTML='<p class="message error">Select content</p>';return}try{const{error:e}=await sup.from('featured_content').insert({content_type:t,content_id:id,created_at:new Date().toISOString()});if(e)throw e;m.innerHTML='<p class="message success">Content featured!</p>';setTimeout(()=>m.innerHTML='',2000)}catch(e){m.innerHTML='<p class="message error">'+e.message+'</p>'}}async function loadPosts(){const l=document.getElementById('postList');if(!l)return;try{const{data:p}=await sup.from('posts').select('*').order('created_at',{ascending:false}).limit(50);if(!p||p.length===0){l.innerHTML='<p class="muted">No posts</p>';return}l.innerHTML=p.map(x=>'<div class="item"><div>'+esc((x.content||'').substring(0,100))+'</div><div class="item-actions"><button class="btn btn-sm btn-danger" onclick="delPost(\''+x.id+'\')">Delete</button></div></div>').join('')}catch(e){l.innerHTML='<p class="message error">'+e.message+'</p>'}}async function delPost(id){if(!confirm('Delete post?'))return;try{await sup.from('posts').delete().eq('id',id);loadPosts()}catch(e){alert('Error: '+e.message)}}async function loadMessages(){try{const{data:m}=await sup.from('messages').select('id,content,user_id').order('created_at',{ascending:false}).limit(50);const s=document.getElementById('msgSel');if(!s)return;s.innerHTML='<option value="">Choose message...</option>'+(m||[]).map(x=>'<option value="'+x.id+'">'+(x.content||'').substring(0,50)+'...</option>').join('')}catch(e){}}async function mute(){const id=document.getElementById('chatUser').value;const m=document.getElementById('chatMsg');if(!id){m.innerHTML='<p class="message error">Select user</p>';return}try{await sup.from('profiles').update({muted:true}).eq('user_id',id);m.innerHTML='<p class="message success">User muted</p>';setTimeout(()=>m.innerHTML='',2000)}catch(e){m.innerHTML='<p class="message error">'+e.message+'</p>'}}async function kick(){const id=document.getElementById('chatUser').value;const m=document.getElementById('chatMsg');if(!id){m.innerHTML='<p class="message error">Select user</p>';return}m.innerHTML='<p class="message success">User kicked from chat</p>';setTimeout(()=>m.innerHTML='',2000)}async function banChat(){const id=document.getElementById('chatUser').value;const m=document.getElementById('chatMsg');if(!id){m.innerHTML='<p class="message error">Select user</p>';return}try{await sup.from('profiles').update({chat_banned:true}).eq('user_id',id);m.innerHTML='<p class="message success">User banned from chat</p>';setTimeout(()=>m.innerHTML='',2000)}catch(e){m.innerHTML='<p class="message error">'+e.message+'</p>'}}async function banSite(){const id=document.getElementById('chatUser').value;const m=document.getElementById('chatMsg');if(!id||!confirm('BAN USER FROM ENTIRE SITE?'))return;try{await sup.from('profiles').update({site_banned:true}).eq('user_id',id);m.innerHTML='<p class="message success">User banned from entire site</p>';setTimeout(()=>m.innerHTML='',2000)}catch(e){m.innerHTML='<p class="message error">'+e.message+'</p>'}}async function hideMsg(){const id=document.getElementById('msgSel').value;const m=document.getElementById('msgMsg');if(!id){m.innerHTML='<p class="message error">Select message</p>';return}try{await sup.from('messages').update({hidden:true}).eq('id',id);m.innerHTML='<p class="message success">Message hidden</p>';setTimeout(()=>m.innerHTML='',2000)}catch(e){m.innerHTML='<p class="message error">'+e.message+'</p>'}}async function delMsg(){const id=document.getElementById('msgSel').value;const m=document.getElementById('msgMsg');if(!id||!confirm('Delete message permanently?'))return;try{await sup.from('messages').delete().eq('id',id);m.innerHTML='<p class="message success">Message deleted</p>';loadMessages();setTimeout(()=>m.innerHTML='',2000)}catch(e){m.innerHTML='<p class="message error">'+e.message+'</p>'}}async function promote(){const id=document.getElementById('pmUser').value;const m=document.getElementById('pmMsg');if(!id){m.innerHTML='<p class="message error">Select user</p>';return}try{const r=ROLES.filter(x=>document.getElementById('pmr_'+x)?.checked);if(r.length===0){m.innerHTML='<p class="message error">Select at least one role</p>';return}await sup.from('profiles').update({role:r[0],roles_ordered:r}).eq('user_id',id);m.innerHTML='<p class="message success">Roles updated: '+r.join(', ')+'</p>';loadUsers();setTimeout(()=>m.innerHTML='',2000)}catch(e){m.innerHTML='<p class="message error">'+e.message+'</p>'}}async function loadStats(){try{const{data:u}=await sup.from('profiles').select('user_id,badges');const{data:p}=await sup.from('posts').select('id');const{data:s}=await sup.from('songs').select('id');document.getElementById('stUsers').textContent=u?.length||0;const cr=(u||[]).filter(x=>{const b=x.badges||[];return b.includes('artist')||b.includes('beatmaker')||b.includes('producer')});document.getElementById('stCreators').textContent=cr.length;document.getElementById('stPosts').textContent=p?.length||0;document.getElementById('stSongs').textContent=s?.length||0}catch(e){}}async function logout(){await sup.auth.signOut();window.location.href='login.html'}function esc(t){if(!t)return'';const d=document.createElement('div');d.textContent=t;return d.innerHTML}if(document.readyState==='loading'){document.addEventListener('DOMContentLoaded',init)}else{init()}
    </script>
</body>
</html>
