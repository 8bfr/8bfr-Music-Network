<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>ğŸ“» 8BFR Radio â€” 8BFR Music Network</title>
  <link rel="icon" href="assets/images/favicon.png">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body { font-family: system-ui, -apple-system, sans-serif; background: linear-gradient(#0b0014, #000); color: #eae6ff; margin: 0; min-height: 100vh; padding-bottom: 80px; overflow-x: hidden; }
    .radio-card { background: rgba(12,6,24,0.85); border: 1px solid rgba(124,58,237,0.4); border-radius: 16px; box-shadow: 0 0 30px rgba(124,58,237,0.2); }
    .vinyl { width: 180px; height: 180px; border-radius: 50%; border: 3px solid rgba(124,58,237,0.5); background: radial-gradient(circle, #1a0030 30%, #0b0014 70%); display: flex; align-items: center; justify-content: center; box-shadow: 0 0 40px rgba(124,58,237,0.3); margin: 0 auto; position: relative; overflow: hidden; }
    .vinyl.spinning { animation: spin 3s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .vinyl-art { width: 80px; height: 80px; border-radius: 50%; object-fit: cover; border: 2px solid rgba(124,58,237,0.6); }
    .vinyl-ring { position: absolute; border-radius: 50%; border: 1px solid rgba(124,58,237,0.15); }
    .vinyl-ring:nth-child(1) { width: 160px; height: 160px; }
    .vinyl-ring:nth-child(2) { width: 130px; height: 130px; }
    .vinyl-ring:nth-child(3) { width: 100px; height: 100px; }
    .progress-track { width: 100%; height: 6px; background: rgba(124,58,237,0.2); border-radius: 3px; cursor: pointer; }
    .progress-fill { height: 100%; background: linear-gradient(90deg, #7c3aed, #a855f7); border-radius: 3px; transition: width 0.3s linear; }
    .ctrl-btn { width: 48px; height: 48px; border-radius: 50%; border: 1px solid rgba(124,58,237,0.5); background: rgba(12,6,24,0.9); color: #eae6ff; font-size: 1.3rem; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s; }
    .ctrl-btn:hover { background: rgba(124,58,237,0.3); border-color: #a855f7; }
    .ctrl-btn.active { background: rgba(124,58,237,0.4); border-color: #a855f7; color: #a855f7; }
    .play-btn { width: 60px; height: 60px; font-size: 1.6rem; background: #7c3aed; border-color: #7c3aed; color: white; }
    .play-btn:hover { background: #6d28d9; }
    .queue-item { display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem; background: rgba(124,58,237,0.05); border: 1px solid rgba(124,58,237,0.15); border-radius: 10px; cursor: pointer; transition: all 0.2s; }
    .queue-item:hover { background: rgba(124,58,237,0.15); border-color: rgba(124,58,237,0.4); }
    .queue-cover { width: 42px; height: 42px; border-radius: 8px; background: linear-gradient(135deg, #7c3aed, #a855f7); display: flex; align-items: center; justify-content: center; font-size: 1.2rem; flex-shrink: 0; overflow: hidden; }
    .queue-cover img { width: 100%; height: 100%; object-fit: cover; }
    .toast { position: fixed; bottom: 90px; left: 50%; transform: translateX(-50%); background: rgba(124,58,237,0.95); color: white; padding: 0.6rem 1.2rem; border-radius: 20px; font-size: 0.85rem; z-index: 9999; opacity: 0; transition: opacity 0.3s; pointer-events: none; }
    .toast.show { opacity: 1; }
    .volume-slider { -webkit-appearance: none; width: 100%; height: 4px; background: rgba(124,58,237,0.3); border-radius: 2px; outline: none; }
    .volume-slider::-webkit-slider-thumb { -webkit-appearance: none; width: 14px; height: 14px; border-radius: 50%; background: #a855f7; cursor: pointer; }
    .bottom-nav-item { display: flex; flex-direction: column; align-items: center; gap: 0.25rem; padding: 0.5rem 0.75rem; text-decoration: none; color: #a855f7; transition: all 0.2s; border-radius: 0.5rem; flex: 1; max-width: 100px; }
    .bottom-nav-item:hover { background: rgba(124,58,237,0.2); }
    .bottom-nav-item.active { color: #fff; background: rgba(124,58,237,0.3); }
  </style>
</head>
<body>

  <header class="px-4 py-4" style="background:rgba(15,0,30,0.9); border-bottom:1px solid rgba(124,58,237,0.5);">
    <div class="max-w-3xl mx-auto flex items-center justify-between">
      <div>
        <h1 class="text-xl font-bold flex items-center gap-2">ğŸ“» 8BFR Radio</h1>
        <p class="text-xs text-purple-300/80">Non-stop music from verified artists</p>
      </div>
      <div class="flex items-center gap-2">
        <span class="inline-block w-2 h-2 rounded-full bg-red-500 animate-pulse"></span>
        <span class="text-xs text-red-400 font-semibold">LIVE</span>
      </div>
    </div>
  </header>

  <main class="max-w-3xl mx-auto px-4 mt-6">
    <div class="flex gap-4 mb-4 text-sm justify-center">
      <div class="flex items-center gap-1"><span class="text-purple-400">ğŸµ</span><span id="statTracks" class="font-bold text-purple-300">0</span><span class="text-purple-200/60 ml-1">Tracks</span></div>
      <div class="flex items-center gap-1"><span class="text-purple-400">ğŸ¤</span><span id="statArtists" class="font-bold text-purple-300">0</span><span class="text-purple-200/60 ml-1">Artists</span></div>
    </div>

    <div class="radio-card p-6 mb-6">
      <div class="vinyl mb-4" id="vinyl">
        <div class="vinyl-ring"></div><div class="vinyl-ring"></div><div class="vinyl-ring"></div>
        <img id="vinylArt" class="vinyl-art" src="assets/images/default_post.jpg" alt="Album art" onerror="this.src='assets/images/default_post.jpg'">
      </div>
      <div class="text-center mb-4">
        <div id="nowTitle" class="font-bold text-lg">Loading radio...</div>
        <a id="nowArtistLink" href="#" class="text-purple-400 text-sm hover:underline">
          <span id="nowArtist">â€”</span><span id="nowVerified" style="color:#00d9ff;display:none;"> âœ“</span>
        </a>
      </div>
      <div class="flex items-center gap-2 mb-4 text-xs text-purple-300/70">
        <span id="timeElapsed">0:00</span>
        <div class="progress-track flex-1" id="progressTrack"><div class="progress-fill" id="progressFill" style="width:0%"></div></div>
        <span id="timeDuration">0:00</span>
      </div>
      <div class="flex items-center justify-center gap-3 mb-4">
        <button class="ctrl-btn active" id="btnShuffle" title="Shuffle">ğŸ”€</button>
        <button class="ctrl-btn" id="btnPrev" title="Previous">â®</button>
        <button class="ctrl-btn play-btn" id="btnPlay" title="Play/Pause">â–¶</button>
        <button class="ctrl-btn" id="btnNext" title="Next">â­</button>
        <button class="ctrl-btn" id="btnRepeat" title="Repeat">ğŸ”</button>
      </div>
      <div class="flex justify-center gap-3 mb-4">
        <button class="ctrl-btn" id="btnLike" title="Like" style="width:40px;height:40px;font-size:1rem;">ğŸ¤</button>
        <button class="ctrl-btn" id="btnShare" title="Share" style="width:40px;height:40px;font-size:1rem;">ğŸ”—</button>
        <button class="ctrl-btn" id="btnBuy" title="Buy" style="width:40px;height:40px;font-size:1rem;display:none;">ğŸ›’</button>
      </div>
      <div class="flex items-center gap-2 px-4">
        <span class="text-sm">ğŸ”Š</span>
        <input type="range" min="0" max="100" value="80" class="volume-slider flex-1" id="volumeSlider">
      </div>
      <audio id="audioPlayer" preload="auto"></audio>
    </div>

    <div id="emptyState" class="radio-card p-6 mb-6" style="display:none;">
      <div style="text-align:center;padding:3rem 1rem;">
        <div style="font-size:4rem;margin-bottom:1rem;">ğŸ“»</div>
        <h3 class="text-lg font-bold mb-2">No tracks available yet</h3>
        <p class="text-purple-300/70 mb-4">Verified artists can upload music to be played on 8BFR Radio.</p>
        <a href="featured.html" style="background:#7c3aed;color:white;padding:0.6rem 1.2rem;border-radius:8px;text-decoration:none;font-weight:600;">Browse Artists</a>
      </div>
    </div>

    <div class="radio-card p-4 mb-6" id="queueSection">
      <h3 class="font-bold text-sm text-purple-400 mb-3">ğŸ¶ Up Next</h3>
      <div id="queueList" class="flex flex-col gap-2"></div>
    </div>
  </main>

  <div id="toast" class="toast"></div>

  <nav class="fixed bottom-0 left-0 right-0 z-50 bg-[rgba(15,0,30,0.95)] backdrop-blur-md border-t border-purple-500/40">
    <div class="max-w-6xl mx-auto px-2 py-2">
      <div class="flex items-center justify-around gap-1">
        <a href="index.html" class="bottom-nav-item"><div style="font-size:1.25rem;">ğŸ </div><div style="font-size:0.7rem;font-weight:600;">Home</div></a>
        <a href="search.html" class="bottom-nav-item"><div style="font-size:1.25rem;">ğŸ”</div><div style="font-size:0.7rem;font-weight:600;">Search</div></a>
        <a href="feed.html" class="bottom-nav-item"><div style="font-size:1.25rem;">ğŸ“°</div><div style="font-size:0.7rem;font-weight:600;">Feed</div></a>
        <a href="radio.html" class="bottom-nav-item active"><div style="font-size:1.25rem;">ğŸ“»</div><div style="font-size:0.7rem;font-weight:600;">Radio</div></a>
        <a href="shop.html" class="bottom-nav-item"><div style="font-size:1.25rem;">ğŸ›’</div><div style="font-size:0.7rem;font-weight:600;">Shop</div></a>
      </div>
    </div>
  </nav>

  <script src="scripts.js?v=radio2" defer></script>
  <script>
  (async function() {
    const SUPABASE_URL = 'https://novbuvwpjnxwwvdekjhr.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5vdmJ1dndwam54d3d2ZGVramhyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjExODkxODUsImV4cCI6MjA3Njc2NTE4NX0.1UUkdGafh6ZplAX8hi7Bvj94D2gvFQZUl0an1RvcSA0';
    const db = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    let playlist = [], currentIndex = -1, isPlaying = false, isShuffled = true, isRepeat = false;

    const audio = document.getElementById('audioPlayer');
    const vinyl = document.getElementById('vinyl');
    const vinylArt = document.getElementById('vinylArt');
    const nowTitle = document.getElementById('nowTitle');
    const nowArtist = document.getElementById('nowArtist');
    const nowArtistLink = document.getElementById('nowArtistLink');
    const nowVerified = document.getElementById('nowVerified');
    const progressFill = document.getElementById('progressFill');
    const progressTrack = document.getElementById('progressTrack');
    const timeElapsed = document.getElementById('timeElapsed');
    const timeDuration = document.getElementById('timeDuration');
    const btnPlay = document.getElementById('btnPlay');
    const queueList = document.getElementById('queueList');

    async function loadSongs() {
      try {
        // First check: any songs at all?
        const { data: allSongs, error: allErr } = await db.from('songs').select('id, title, song_url, price');
        console.log('ğŸµ Radio: ALL songs in DB:', allSongs);
        if (allErr) { console.error('Radio query error:', allErr); showEmpty(); return; }
        if (!allSongs || allSongs.length === 0) { console.log('Radio: songs table is empty'); showEmpty(); return; }

        // Filter to playable songs (have a song_url)
        const songs = allSongs.filter(s => s.song_url && s.song_url.trim() !== '');
        console.log('ğŸµ Radio: Playable songs (with URL):', songs.length, songs);
        if (songs.length === 0) {
          console.log('Radio: songs exist but none have song_url set');
          document.getElementById('emptyState').innerHTML = '<div style="text-align:center;padding:2rem;"><div style="font-size:3rem;margin-bottom:1rem;">ğŸµ</div><h3 style="color:#a855f7;font-size:1.3rem;margin-bottom:0.5rem;">Songs Found But No Audio URLs</h3><p style="color:rgba(168,85,247,0.7);margin-bottom:0.5rem;">' + allSongs.length + ' song(s) in database, but none have an audio file URL.</p><p style="color:rgba(168,85,247,0.5);font-size:0.85rem;">Upload songs with audio files from your profile page.</p></div>';
          return;
        }

        // Get full data for playable songs
        const songIds = songs.map(s => s.id);
        const { data: fullSongs } = await db.from('songs').select('id, title, artist, cover_art, song_url, uploaded_by, price').in('id', songIds);

        const uploaderIds = [...new Set((fullSongs||[]).map(s => s.uploaded_by).filter(Boolean))];
        let profileMap = {};
        if (uploaderIds.length > 0) {
          const { data: profiles } = await db.from('profiles')
            .select('user_id, username, display_name, verified_artist, badges')
            .in('user_id', uploaderIds);
          if (profiles) profiles.forEach(p => { profileMap[p.user_id] = p; });
        }

        playlist = (fullSongs||[]).map(s => {
          const pr = profileMap[s.uploaded_by] || {};
          return {
            id: s.id, title: s.title || 'Untitled',
            artist: s.artist || pr.display_name || pr.username || 'Unknown',
            cover: s.cover_art || 'assets/images/default_post.jpg',
            url: s.song_url, uploadedBy: s.uploaded_by,
            price: parseFloat(s.price) || 0,
            verified: !!pr.verified_artist
          };
        });

        document.getElementById('statTracks').textContent = playlist.length;
        document.getElementById('statArtists').textContent = new Set(playlist.map(t => t.artist)).size;

        if (isShuffled) shuffle();
        renderQueue();
        document.getElementById('emptyState').style.display = 'none';
        document.querySelector('.radio-card').style.display = 'block';
        document.getElementById('queueSection').style.display = 'block';
        if (playlist.length > 0) {
          currentIndex = 0;
          loadTrack(0);
          // Browsers block autoplay â€” try, and if blocked show tap-to-play
          setTimeout(function() {
            audio.play().then(function() {
              isPlaying = true; btnPlay.textContent = 'â¸'; vinyl.classList.add('spinning');
            }).catch(function() {
              // Autoplay blocked â€” show tap prompt
              nowTitle.textContent = 'â–¶ Tap Play â€” ' + playlist[0].title;
            });
          }, 600);
        }
      } catch (err) { console.error('Radio:', err); showEmpty(); }
    }

    function showEmpty() {
      document.getElementById('emptyState').style.display = 'block';
      document.getElementById('queueSection').style.display = 'none';
      nowTitle.textContent = 'No tracks available';
      nowArtist.textContent = 'Upload songs to get started';
    }

    function shuffle() {
      for (let i = playlist.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [playlist[i], playlist[j]] = [playlist[j], playlist[i]];
      }
    }

    function loadTrack(idx) {
      if (idx < 0 || idx >= playlist.length) return;
      currentIndex = idx;
      const t = playlist[idx];
      audio.src = t.url; audio.load();
      vinylArt.src = t.cover;
      nowTitle.textContent = t.title;
      nowArtist.textContent = t.artist;
      nowArtistLink.href = t.uploadedBy ? 'profile.html?id=' + t.uploadedBy : '#';
      nowVerified.style.display = t.verified ? 'inline' : 'none';
      const buyBtn = document.getElementById('btnBuy');
      buyBtn.style.display = t.price > 0 ? 'flex' : 'none';
      progressFill.style.width = '0%';
      timeElapsed.textContent = '0:00'; timeDuration.textContent = '0:00';
      renderQueue();
      // Award listen point to artist
      if (t.uploadedBy) db.rpc('award_points', { p_user_id: t.uploadedBy, p_action: 'song_played', p_points: 1, p_description: 'Radio play' }).catch(() => {});
    }

    function playTrack() {
      if (!playlist.length) return;
      audio.play().then(() => { isPlaying = true; btnPlay.textContent = 'â¸'; vinyl.classList.add('spinning'); })
        .catch(() => { btnPlay.textContent = 'â–¶'; });
    }
    function pauseTrack() { audio.pause(); isPlaying = false; btnPlay.textContent = 'â–¶'; vinyl.classList.remove('spinning'); }

    function nextTrack() {
      if (!playlist.length) return;
      let n = currentIndex + 1;
      if (n >= playlist.length) { if (isRepeat) n = 0; else { pauseTrack(); return; } }
      loadTrack(n); playTrack();
    }
    function prevTrack() {
      if (!playlist.length) return;
      if (audio.currentTime > 3) { audio.currentTime = 0; return; }
      let p = currentIndex - 1; if (p < 0) p = playlist.length - 1;
      loadTrack(p); playTrack();
    }

    btnPlay.addEventListener('click', () => { if (isPlaying) pauseTrack(); else playTrack(); });
    document.getElementById('btnNext').addEventListener('click', nextTrack);
    document.getElementById('btnPrev').addEventListener('click', prevTrack);

    document.getElementById('btnShuffle').addEventListener('click', function() {
      isShuffled = !isShuffled; this.classList.toggle('active', isShuffled);
      if (isShuffled) { const cur = playlist[currentIndex]; shuffle(); const i = playlist.findIndex(t => t.id === cur.id); if (i > 0) [playlist[0], playlist[i]] = [playlist[i], playlist[0]]; currentIndex = 0; renderQueue(); }
      showToast(isShuffled ? 'ğŸ”€ Shuffle on' : 'Shuffle off');
    });

    document.getElementById('btnRepeat').addEventListener('click', function() {
      isRepeat = !isRepeat; this.classList.toggle('active', isRepeat);
      showToast(isRepeat ? 'ğŸ” Repeat on' : 'Repeat off');
    });

    document.getElementById('btnLike').addEventListener('click', function() {
      const liked = this.textContent === 'â¤ï¸'; this.textContent = liked ? 'ğŸ¤' : 'â¤ï¸';
      showToast(liked ? 'Removed from favorites' : 'â¤ï¸ Added to favorites');
    });

    document.getElementById('btnShare').addEventListener('click', async function() {
      const t = playlist[currentIndex]; if (!t) return;
      const txt = 'ğŸµ Listening to "' + t.title + '" by ' + t.artist + ' on 8BFR Radio!';
      try { if (navigator.share) await navigator.share({ title: '8BFR Radio', text: txt, url: location.href });
      else { await navigator.clipboard.writeText(txt + ' ' + location.href); showToast('ğŸ“‹ Link copied!'); }
      } catch(e) {}
    });

    document.getElementById('btnBuy').addEventListener('click', () => {
      const t = playlist[currentIndex]; if (t) location.href = 'checkout.html?song=' + t.id + '&price=' + t.price;
    });

    document.getElementById('volumeSlider').addEventListener('input', e => { audio.volume = e.target.value / 100; });
    audio.volume = 0.8;

    audio.addEventListener('timeupdate', () => {
      if (!audio.duration) return;
      progressFill.style.width = (audio.currentTime / audio.duration * 100) + '%';
      timeElapsed.textContent = fmt(audio.currentTime); timeDuration.textContent = fmt(audio.duration);
    });
    audio.addEventListener('ended', nextTrack);

    progressTrack.addEventListener('click', e => {
      if (!audio.duration) return;
      const r = progressTrack.getBoundingClientRect();
      audio.currentTime = ((e.clientX - r.left) / r.width) * audio.duration;
    });

    function renderQueue() {
      const up = [];
      for (let i = 1; i <= Math.min(8, playlist.length - 1); i++) {
        const idx = (currentIndex + i) % playlist.length;
        up.push({ ...playlist[idx], qi: idx });
      }
      queueList.innerHTML = up.map(t => '<div class="queue-item" onclick="window._rJump(' + t.qi + ')">' +
        '<div class="queue-cover">' + (t.cover !== 'assets/images/default_post.jpg' ? '<img src="' + t.cover + '" onerror="this.parentElement.innerHTML=\'ğŸµ\'">' : 'ğŸµ') + '</div>' +
        '<div style="flex:1;min-width:0;"><div style="font-weight:600;font-size:0.9rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">' + t.title + '</div>' +
        '<div style="font-size:0.78rem;color:#a855f7;">' + t.artist + (t.verified ? ' <span style="color:#00d9ff;">âœ“</span>' : '') + '</div></div>' +
        '<div style="color:#a855f7;opacity:0.5;">ğŸµ</div></div>').join('');
    }
    window._rJump = function(i) { loadTrack(i); playTrack(); };

    function fmt(s) { if (!s || isNaN(s)) return '0:00'; return Math.floor(s/60) + ':' + (Math.floor(s%60) < 10 ? '0' : '') + Math.floor(s%60); }
    function showToast(m) { const t = document.getElementById('toast'); t.textContent = m; t.classList.add('show'); setTimeout(() => t.classList.remove('show'), 2000); }

    document.addEventListener('keydown', e => {
      if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;
      if (e.code === 'Space') { e.preventDefault(); if (isPlaying) pauseTrack(); else playTrack(); }
      if (e.code === 'ArrowRight') nextTrack();
      if (e.code === 'ArrowLeft') prevTrack();
    });

    await loadSongs();
  })();
  </script>
</body>
</html>
