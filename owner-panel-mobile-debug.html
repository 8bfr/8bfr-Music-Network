<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Owner Panel Mobile Debug - 8BFR</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body {
            font-family: system-ui, -apple-system, sans-serif;
            background: #0a0a0a;
            color: #fff;
            padding: 1rem;
            margin: 0;
        }
        .header {
            background: linear-gradient(135deg, #1a1a1a, #000);
            border: 2px solid #ff0066;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            text-align: center;
        }
        h1 {
            margin: 0;
            font-size: 1.5rem;
            color: #ff0066;
        }
        .debug-box {
            background: #1a1a1a;
            border: 1px solid #333;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
        }
        .success {
            border-left: 4px solid #00ff88;
            background: rgba(0, 255, 136, 0.1);
        }
        .error {
            border-left: 4px solid #ff0044;
            background: rgba(255, 0, 68, 0.1);
        }
        .info {
            border-left: 4px solid #00ccff;
            background: rgba(0, 204, 255, 0.1);
        }
        .warning {
            border-left: 4px solid #ffaa00;
            background: rgba(255, 170, 0, 0.1);
        }
        .step-title {
            font-weight: bold;
            margin-bottom: 0.5rem;
            font-size: 1rem;
        }
        pre {
            background: #000;
            padding: 0.5rem;
            border-radius: 4px;
            overflow-x: auto;
            font-size: 0.75rem;
            margin-top: 0.5rem;
        }
        .btn {
            background: #ff0066;
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 4px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            width: 100%;
            margin-top: 1rem;
        }
        .loading {
            text-align: center;
            padding: 2rem;
            font-size: 1.2rem;
            color: #00ccff;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üîç Owner Panel Debug</h1>
        <p style="margin: 0.5rem 0 0 0; font-size: 0.9rem; opacity: 0.8;">Mobile Diagnostic Tool</p>
    </div>

    <div id="output">
        <div class="loading">üîÑ Running diagnostics...</div>
    </div>

    <button class="btn" onclick="window.location.href='login.html'" style="display: none;" id="loginBtn">
        Go to Login Page
    </button>

    <button class="btn" onclick="location.reload()" style="display: none;" id="retryBtn">
        üîÑ Retry Diagnostics
    </button>

    <script>
        const SUPABASE_URL = 'https://novbuvwpjnxwwvdekjhr.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5vdmJ1dndwam54d3d2ZGVramhyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjExODkxODUsImV4cCI6MjA3Njc2NTE4NX0.1UUkdGafh6ZplAX8hi7Bvj94D2gvFQZUl0an1RvcSA0';
        
        const output = document.getElementById('output');
        const loginBtn = document.getElementById('loginBtn');
        const retryBtn = document.getElementById('retryBtn');
        
        let stepNumber = 0;

        function addStep(title, type = 'info', data = null) {
            stepNumber++;
            const box = document.createElement('div');
            box.className = `debug-box ${type}`;
            
            let icon = 'üìã';
            if (type === 'success') icon = '‚úÖ';
            if (type === 'error') icon = '‚ùå';
            if (type === 'warning') icon = '‚ö†Ô∏è';
            
            box.innerHTML = `
                <div class="step-title">${icon} Step ${stepNumber}: ${title}</div>
                ${data ? `<pre>${JSON.stringify(data, null, 2)}</pre>` : ''}
            `;
            output.appendChild(box);
            
            // Auto-scroll to bottom
            window.scrollTo(0, document.body.scrollHeight);
        }

        async function runDiagnostics() {
            output.innerHTML = '';
            stepNumber = 0;
            loginBtn.style.display = 'none';
            retryBtn.style.display = 'none';

            try {
                addStep('Initializing Supabase Client', 'info');
                
                if (!window.supabase) {
                    addStep('Supabase library not loaded!', 'error');
                    retryBtn.style.display = 'block';
                    return;
                }

                const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
                addStep('Supabase client created', 'success');

                addStep('Checking for active session', 'info');
                const { data: sessionData, error: sessionError } = await supabase.auth.getSession();
                
                if (sessionError) {
                    addStep('Session Error', 'error', sessionError);
                    loginBtn.style.display = 'block';
                    return;
                }

                if (!sessionData.session) {
                    addStep('No Active Session Found', 'warning', {
                        message: 'You are not logged in',
                        action: 'Please log in first'
                    });
                    loginBtn.style.display = 'block';
                    return;
                }

                addStep('Active Session Found', 'success', {
                    email: sessionData.session.user.email,
                    user_id: sessionData.session.user.id
                });

                addStep('Getting User Details', 'info');
                const { data: { user }, error: authError } = await supabase.auth.getUser();
                
                if (authError) {
                    addStep('Authentication Error', 'error', authError);
                    loginBtn.style.display = 'block';
                    return;
                }

                if (!user) {
                    addStep('No User Found', 'error');
                    loginBtn.style.display = 'block';
                    return;
                }

                addStep('User Authenticated', 'success', {
                    id: user.id,
                    email: user.email
                });

                addStep('Fetching Profile from Database', 'info');
                const { data: profile, error: profileError } = await supabase
                    .from('profiles')
                    .select('*')
                    .eq('user_id', user.id)
                    .single();

                if (profileError) {
                    addStep('Profile Error', 'error', {
                        code: profileError.code,
                        message: profileError.message,
                        hint: profileError.code === 'PGRST116' ? 'Profile does not exist - needs to be created' : profileError.hint
                    });
                    
                    if (profileError.code === 'PGRST116') {
                        addStep('Creating Profile Automatically', 'warning');
                        
                        const { data: newProfile, error: createError } = await supabase
                            .from('profiles')
                            .insert({
                                user_id: user.id,
                                username: user.email.split('@')[0],
                                display_name: user.email.split('@')[0],
                                role: 'owner'
                            })
                            .select()
                            .single();
                        
                        if (createError) {
                            addStep('Failed to Create Profile', 'error', createError);
                            retryBtn.style.display = 'block';
                            return;
                        }
                        
                        addStep('Profile Created Successfully!', 'success', {
                            username: newProfile.username,
                            role: newProfile.role,
                            message: 'Refresh this page to continue'
                        });
                        retryBtn.style.display = 'block';
                        return;
                    }
                    
                    retryBtn.style.display = 'block';
                    return;
                }

                if (!profile) {
                    addStep('No Profile Data Returned', 'error');
                    retryBtn.style.display = 'block';
                    return;
                }

                addStep('Profile Loaded', 'success', {
                    id: profile.id,
                    username: profile.username,
                    display_name: profile.display_name,
                    role: profile.role,
                    points: profile.points
                });

                addStep('Checking Role Permissions', 'info');
                
                if (profile.role !== 'owner') {
                    addStep('Access Denied', 'error', {
                        your_role: profile.role,
                        required_role: 'owner',
                        message: 'You need owner role to access the owner panel'
                    });
                    return;
                }

                addStep('Role Verified: OWNER ‚úì', 'success');

                addStep('Testing Database Access', 'info');
                
                const { count: userCount, error: countError } = await supabase
                    .from('profiles')
                    .select('*', { count: 'exact', head: true });
                
                if (countError) {
                    addStep('Database Query Error', 'error', countError);
                } else {
                    addStep('Database Access Working', 'success', {
                        total_users: userCount
                    });
                }

                const { data: posts, error: postsError } = await supabase
                    .from('posts')
                    .select('*')
                    .limit(1);
                
                if (postsError) {
                    addStep('Posts Table Error', 'warning', postsError);
                } else {
                    addStep('Posts Table Accessible', 'success', {
                        posts_found: posts?.length || 0
                    });
                }

                addStep('üéâ ALL CHECKS PASSED!', 'success', {
                    status: 'Owner panel should work',
                    username: profile.username || profile.display_name,
                    message: 'You can now use the owner panel'
                });

                const box = document.createElement('div');
                box.className = 'debug-box success';
                box.innerHTML = `
                    <div class="step-title">‚ú® Ready to Go!</div>
                    <p style="margin: 0.5rem 0;">Your account is properly configured. The owner panel should work now.</p>
                    <button class="btn" onclick="window.location.href='owner-panel.html'" style="margin-top: 1rem;">
                        Open Owner Panel
                    </button>
                `;
                output.appendChild(box);

            } catch (error) {
                addStep('Critical Error', 'error', {
                    message: error.message,
                    stack: error.stack
                });
                retryBtn.style.display = 'block';
            }
        }

        // Run on page load
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', runDiagnostics);
        } else {
            runDiagnostics();
        }
    </script>
</body>
</html>
