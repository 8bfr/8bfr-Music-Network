<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Login — 8BFR Music Network</title>
  <link rel="icon" href="assets/images/favicon.png">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    :root { --ring: rgba(124,58,237,.65); --glass: rgba(12,6,24,.88); }
    body { font-family: system-ui, -apple-system, sans-serif; background: radial-gradient(1200px 600px at 10% -10%, rgba(124,58,237,.35), transparent 60%), radial-gradient(900px 400px at 110% 10%, rgba(0,217,255,.22), transparent 60%), linear-gradient(#0b0014,#000); color: #eae6ff; margin: 0; min-height: 100vh; display: flex; flex-direction: column; }
    header { position: relative; z-index: 5; background: rgba(15,0,30,.9); border-bottom: 1px solid rgba(124,58,237,.5); }
    .section-card { border: 1px solid rgba(124,58,237,.35); background: #0c0618; border-radius: 16px; box-shadow: 0 0 24px rgba(124,58,237,.25); }
    .btn { display: inline-flex; justify-content: center; align-items: center; gap: .4rem; background: #120327; border: 1px solid rgba(124,58,237,.6); color: #eae6ff; padding: .6rem .95rem; border-radius: .75rem; text-decoration: none; font-size: .9rem; cursor: pointer; }
    .btn-primary { background: #7c3aed; border-color: #7c3aed; color: #fff; }
    .btn-primary:hover { filter: brightness(1.05); }
    .btn-ghost { background: transparent; }
    .error-text { font-size: .8rem; color: #fecaca; }
    footer { border-top: 1px solid rgba(124,58,237,.35); background: #050013cc; margin-top: auto; }
  </style>
</head>
<body>
  <header class="px-4 py-4">
    <div class="max-w-4xl mx-auto flex items-end justify-between gap-3">
      <div class="flex items-center gap-3">
        <img src="assets/images/logo_8bfr.svg" alt="8BFR logo" class="h-10 w-auto" onerror="this.onerror=null;this.src='assets/images/8bfr.png'">
        <div>
          <h1 class="text-2xl font-extrabold">8BFR <span class="text-[#00d9ff]">Music</span> Network</h1>
          <p class="text-[10px] text-green-300/90 font-mono">LOGIN</p>
          <p class="text-xs sm:text-sm text-purple-300/80 -mt-1">Sign in to unlock studio tools, profiles, and tournaments.</p>
        </div>
      </div>
      <a href="index.html" class="text-[#00d9ff] underline/50 hover:underline" style="position:relative;z-index:6">← Back home</a>
    </div>
  </header>
  <main class="px-4 mt-8 mb-10">
    <div class="max-w-md mx-auto section-card p-6 sm:p-7">
      <h2 class="text-xl font-bold mb-2">Log in to your 8BFR account</h2>
      <p class="text-sm text-purple-200/90 mb-5">Use the email and password you signed up with.</p>
      <form id="loginForm" class="space-y-4">
        <div>
          <label for="email" class="block text-sm mb-1">Email</label>
          <input id="email" type="email" required autocomplete="email" class="w-full rounded-lg border border-purple-500/70 bg-black/40 px-3 py-2 text-sm outline-none focus:ring-2 focus:ring-purple-400">
        </div>
        <div>
          <label for="password" class="block text-sm mb-1">Password</label>
          <input id="password" type="password" required autocomplete="current-password" class="w-full rounded-lg border border-purple-500/70 bg-black/40 px-3 py-2 text-sm outline-none focus:ring-2 focus:ring-purple-400">
        </div>
        <p id="loginError" class="error-text mb-1 hidden"></p>
        <button id="loginButton" type="submit" class="btn btn-primary w-full mt-2">Log in</button>
      </form>
      <div class="mt-5 space-y-2 text-sm text-purple-100/90">
        <button type="button" id="forgotButton" class="btn btn-ghost w-full" onclick="doReset()">Forgot password?</button>
        <button type="button" class="btn btn-ghost w-full" onclick="window.location.href='signup.html';">Need an account? Sign up free</button>
        <button type="button" class="btn btn-ghost w-full" onclick="window.location.href='index.html';">Continue as guest (limited access)</button>
      </div>
    </div>
  </main>
  <footer class="px-4 py-4">
    <div class="max-w-4xl mx-auto text-center text-[11px] text-purple-300/80">© 2025 8BFR Music Network — "Empowering creators, connecting the world."</div>
  </footer>
  <script src="scripts.js" defer></script>
  <script>
  document.addEventListener('DOMContentLoaded', function() {
    if (!window.supabase || !window.supabase.createClient) {
      var e = document.getElementById('loginError');
      if (e) { e.textContent = 'Login system temporarily unavailable. Please refresh.'; e.classList.remove('hidden'); }
      return;
    }
    var db = window.supabase.createClient('https://novbuvwpjnxwwvdekjhr.supabase.co','eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5vdmJ1dndwam54d3d2ZGVramhyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjExODkxODUsImV4cCI6MjA3Njc2NTE4NX0.1UUkdGafh6ZplAX8hi7Bvj94D2gvFQZUl0an1RvcSA0');
    // If already logged in, redirect
    db.auth.getSession().then(function(r) { if (r.data.session) window.location.href = 'profile.html'; });
    document.getElementById('loginForm').addEventListener('submit', async function(ev) {
      ev.preventDefault();
      var email = document.getElementById('email').value.trim();
      var password = document.getElementById('password').value;
      var errEl = document.getElementById('loginError');
      var btn = document.getElementById('loginButton');
      if (!email || !password) return;
      errEl.classList.add('hidden'); errEl.textContent = '';
      btn.disabled = true; btn.textContent = 'Logging in…';
      try {
        var res = await db.auth.signInWithPassword({ email: email, password: password });
        if (res.error) throw res.error;
        // Award daily login points
        try { await db.rpc('add_algorithm_points', { p_user_id: res.data.user.id, p_action: 'daily_login', p_points: 5 }); } catch(e) {}
        // Ensure profile exists
        var pr = await db.from('profiles').select('user_id').eq('user_id', res.data.user.id).single();
        if (!pr.data) {
          await db.from('profiles').insert({ user_id: res.data.user.id, email: email, username: email.split('@')[0].replace(/[^a-zA-Z0-9_]/g,'_'), role: 'fan', badges: ['fan'] });
        }
        // Redirect to return URL or profile
        var params = new URLSearchParams(window.location.search);
        var ret = params.get('return') || 'profile.html';
        window.location.href = ret;
      } catch(err) {
        var m = err.message || 'Login failed.';
        if (m.includes('Invalid login')) m = 'Incorrect email or password.';
        errEl.textContent = m; errEl.classList.remove('hidden');
        btn.disabled = false; btn.textContent = 'Log in';
      }
    });
    window.doReset = async function() {
      var email = document.getElementById('email').value.trim();
      var errEl = document.getElementById('loginError');
      if (!email) { errEl.textContent = 'Enter your email first, then click Forgot password.'; errEl.classList.remove('hidden'); return; }
      try {
        var r = await db.auth.resetPasswordForEmail(email);
        if (r.error) throw r.error;
        errEl.textContent = ''; errEl.classList.add('hidden');
        alert('Password reset email sent! Check your inbox.');
      } catch(e) { errEl.textContent = e.message; errEl.classList.remove('hidden'); }
    };
  });
  </script>
</body>
</html>
