<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Community Feed ‚Äî 8BFR Music Network</title>
  <link rel="icon" href="assets/images/favicon.png">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body { font-family: system-ui, -apple-system, sans-serif; background: linear-gradient(#0b0014, #000); color: #eae6ff; margin: 0; min-height: 100vh; padding-bottom: 80px; }
    .feed-card { background: rgba(12,6,24,0.85); border: 1px solid rgba(124,58,237,0.3); border-radius: 14px; padding: 1.25rem; margin-bottom: 1rem; }
    .feed-card:hover { border-color: rgba(124,58,237,0.5); }
    .tab-bar { display: flex; gap: 0; border-bottom: 1px solid rgba(124,58,237,0.3); margin-bottom: 1.5rem; }
    .tab-btn { flex: 1; text-align: center; padding: 0.75rem; font-weight: 600; font-size: 0.9rem; cursor: pointer; color: rgba(234,230,255,0.5); border-bottom: 2px solid transparent; background: none; border-top: none; border-left: none; border-right: none; transition: all 0.2s; }
    .tab-btn.active { color: #a855f7; border-bottom-color: #a855f7; }
    .tab-btn:hover { color: rgba(234,230,255,0.8); }
    .action-btn { background: none; border: none; color: #a855f7; cursor: pointer; font-size: 0.85rem; display: inline-flex; align-items: center; gap: 0.3rem; padding: 0.4rem 0.6rem; border-radius: 8px; transition: all 0.2s; }
    .action-btn:hover { background: rgba(124,58,237,0.15); }
    .spinner { width: 32px; height: 32px; border-radius: 50%; border: 3px solid rgba(168,85,247,0.2); border-top-color: #a855f7; animation: spin 0.7s linear infinite; margin: 2rem auto; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .bottom-nav-item { display: flex; flex-direction: column; align-items: center; gap: 0.25rem; padding: 0.5rem 0.75rem; text-decoration: none; color: #a855f7; transition: all 0.2s; border-radius: 0.5rem; flex: 1; max-width: 100px; }
    .bottom-nav-item:hover { background: rgba(124,58,237,0.2); }
    .bottom-nav-item.active { color: #fff; background: rgba(124,58,237,0.3); }
  </style>
</head>
<body>

  <header class="px-4 py-4" style="background:rgba(15,0,30,0.9);border-bottom:1px solid rgba(124,58,237,0.5);">
    <div class="max-w-2xl mx-auto flex items-center justify-between">
      <div>
        <h1 class="text-xl font-bold">üó®Ô∏è Community Feed</h1>
        <p class="text-xs text-purple-300/80">See what creators are sharing</p>
      </div>
      <button onclick="location.href='profile.html'" style="background:#7c3aed;color:white;border:none;padding:0.5rem 1rem;border-radius:8px;font-weight:600;cursor:pointer;font-size:0.85rem;">+ Post</button>
    </div>
  </header>

  <main class="max-w-2xl mx-auto px-4 mt-4">
    <div class="tab-bar">
      <button class="tab-btn active" data-tab="trending">üî• Trending</button>
      <button class="tab-btn" data-tab="latest">üïê Latest</button>
      <button class="tab-btn" data-tab="following">üë• Following</button>
    </div>
    <div id="feedLoading"><div class="spinner"></div></div>
    <div id="feedList"></div>
    <div id="feedEmpty" style="display:none;text-align:center;padding:3rem 1rem;">
      <div style="font-size:4rem;margin-bottom:1rem;">üó®Ô∏è</div>
      <h3 style="font-size:1.1rem;font-weight:700;margin-bottom:0.5rem;">No posts yet</h3>
      <p style="color:#a855f7;opacity:0.8;margin-bottom:1rem;">Be the first to share something!</p>
      <a href="profile.html" style="background:#7c3aed;color:white;padding:0.6rem 1.2rem;border-radius:8px;text-decoration:none;font-weight:600;">Create a Post</a>
    </div>
    <button id="loadMoreBtn" style="display:none;width:100%;padding:0.75rem;background:rgba(124,58,237,0.15);border:1px solid rgba(124,58,237,0.3);border-radius:10px;color:#a855f7;font-weight:600;cursor:pointer;margin-top:0.5rem;">Load More</button>
  </main>

  <nav class="fixed bottom-0 left-0 right-0 z-50 bg-[rgba(15,0,30,0.95)] backdrop-blur-md border-t border-purple-500/40">
    <div class="max-w-6xl mx-auto px-2 py-2">
      <div class="flex items-center justify-around gap-1">
        <a href="index.html" class="bottom-nav-item"><div style="font-size:1.25rem;">üè†</div><div style="font-size:0.7rem;font-weight:600;">Home</div></a>
        <a href="search.html" class="bottom-nav-item"><div style="font-size:1.25rem;">üîç</div><div style="font-size:0.7rem;font-weight:600;">Search</div></a>
        <a href="feed.html" class="bottom-nav-item active"><div style="font-size:1.25rem;">üì∞</div><div style="font-size:0.7rem;font-weight:600;">Feed</div></a>
        <a href="radio.html" class="bottom-nav-item"><div style="font-size:1.25rem;">üìª</div><div style="font-size:0.7rem;font-weight:600;">Radio</div></a>
        <a href="shop.html" class="bottom-nav-item"><div style="font-size:1.25rem;">üõí</div><div style="font-size:0.7rem;font-weight:600;">Shop</div></a>
      </div>
    </div>
  </nav>

  <script src="scripts.js?v=feed2" defer></script>
  <script>
  (async function() {
    const db = window.supabase.createClient(
      'https://novbuvwpjnxwwvdekjhr.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5vdmJ1dndwam54d3d2ZGVramhyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjExODkxODUsImV4cCI6MjA3Njc2NTE4NX0.1UUkdGafh6ZplAX8hi7Bvj94D2gvFQZUl0an1RvcSA0'
    );
    let currentTab = 'trending', currentUser = null, offset = 0;
    const PAGE = 20;

    try { const { data: { session } } = await db.auth.getSession(); if (session) currentUser = session.user; } catch(e) {}

    document.querySelectorAll('.tab-btn').forEach(btn => {
      btn.addEventListener('click', function() {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        this.classList.add('active');
        currentTab = this.dataset.tab;
        offset = 0;
        loadFeed();
      });
    });
    document.getElementById('loadMoreBtn').addEventListener('click', () => { offset += PAGE; loadFeed(true); });

    async function loadFeed(append) {
      if (!append) {
        document.getElementById('feedLoading').style.display = 'block';
        document.getElementById('feedList').innerHTML = '';
        document.getElementById('feedEmpty').style.display = 'none';
        document.getElementById('loadMoreBtn').style.display = 'none';
      }
      try {
        let query = db.from('posts').select('*');
        if (currentTab === 'trending') {
          query = query.order('algorithm_score', { ascending: false, nullsFirst: false }).order('created_at', { ascending: false });
        } else if (currentTab === 'latest') {
          query = query.order('created_at', { ascending: false });
        } else if (currentTab === 'following') {
          if (!currentUser) {
            document.getElementById('feedLoading').style.display = 'none';
            document.getElementById('feedList').innerHTML = '<div class="feed-card" style="text-align:center;padding:2rem;"><p style="color:#a855f7;">Log in to see posts from people you follow.</p><a href="login.html" style="color:#7c3aed;font-weight:600;">Log In</a></div>';
            return;
          }
          const { data: follows } = await db.from('follows').select('following_id').eq('follower_id', currentUser.id);
          const ids = (follows || []).map(f => f.following_id);
          if (!ids.length) {
            document.getElementById('feedLoading').style.display = 'none';
            document.getElementById('feedList').innerHTML = '<div class="feed-card" style="text-align:center;padding:2rem;"><p style="color:#a855f7;">You\'re not following anyone yet.</p><a href="members.html" style="color:#7c3aed;font-weight:600;">Browse Members</a></div>';
            return;
          }
          query = query.in('user_id', ids).order('created_at', { ascending: false });
        }

        const { data: posts, error } = await query.range(offset, offset + PAGE - 1);
        if (error) throw error;
        document.getElementById('feedLoading').style.display = 'none';
        if ((!posts || !posts.length) && !append) { document.getElementById('feedEmpty').style.display = 'block'; return; }

        const authorIds = [...new Set((posts || []).map(p => p.user_id).filter(Boolean))];
        let pm = {};
        if (authorIds.length) {
          const { data: profiles } = await db.from('profiles').select('user_id,username,display_name,avatar_url,verified_artist,algorithm_tier').in('user_id', authorIds);
          if (profiles) profiles.forEach(p => { pm[p.user_id] = p; });
        }

        const fl = document.getElementById('feedList');
        (posts || []).forEach(post => { fl.insertAdjacentHTML('beforeend', renderPost(post, pm[post.user_id] || {})); });
        document.getElementById('loadMoreBtn').style.display = (posts && posts.length >= PAGE) ? 'block' : 'none';
      } catch(err) {
        console.error('Feed:', err);
        document.getElementById('feedLoading').style.display = 'none';
        document.getElementById('feedList').innerHTML = '<div class="feed-card" style="text-align:center;padding:2rem;color:#ef4444;">Error loading feed.</div>';
      }
    }

    function renderPost(post, pr) {
      const name = pr.display_name || pr.username || 'User';
      const av = pr.avatar_url ? '<img src="'+pr.avatar_url+'" style="width:100%;height:100%;object-fit:cover;" onerror="this.parentElement.innerHTML=\'üéµ\'">' : 'üéµ';
      const v = pr.verified_artist ? '<span style="color:#00d9ff;margin-left:4px;">‚úì</span>' : '';
      const tier = pr.algorithm_tier || 'Bronze';
      const tc = {Bronze:'#cd7f32',Silver:'#c0c0c0',Gold:'#ffd700',Platinum:'#e5e4e2',Diamond:'#b9f2ff'};
      const tb = '<span style="font-size:0.7rem;color:'+(tc[tier]||'#cd7f32')+';margin-left:4px;">'+tier+'</span>';
      const ago = timeAgo(post.created_at);
      const sc = (post.algorithm_score||0);
      const si = sc > 100 ? 'üî•' : sc > 50 ? '‚≠ê' : '';

      let media = '';
      if (post.media && (post.media_type === 'image' || post.media_type === 'photo')) media = '<div style="margin:0.75rem 0;border-radius:10px;overflow:hidden;"><img src="'+post.media+'" style="width:100%;max-height:400px;object-fit:cover;" onerror="this.style.display=\'none\'"></div>';
      else if (post.media && post.media_type === 'video') {
        const yt = post.media.match(/(?:youtube\.com\/watch\?v=|youtu\.be\/|youtube\.com\/embed\/)([a-zA-Z0-9_-]{11})/);
        if (yt) media = '<div style="margin:0.75rem 0;position:relative;padding-bottom:56.25%;height:0;border-radius:10px;overflow:hidden;"><iframe src="https://www.youtube.com/embed/'+yt[1]+'" style="position:absolute;inset:0;width:100%;height:100%;border:none;" allowfullscreen></iframe></div>';
        else media = '<div style="margin:0.75rem 0;border-radius:10px;overflow:hidden;"><video controls preload="none" style="width:100%;max-height:400px;"><source src="'+post.media+'"></video></div>';
      }
      else if (post.media && post.media_type === 'audio') media = '<div style="margin:0.75rem 0;"><audio controls preload="none" style="width:100%;"><source src="'+post.media+'"></audio></div>';

      return '<div class="feed-card" data-post-id="'+post.id+'">' +
        '<div style="display:flex;align-items:center;gap:0.75rem;margin-bottom:0.75rem;">' +
          '<a href="profile.html?id='+post.user_id+'" style="width:44px;height:44px;border-radius:50%;background:linear-gradient(135deg,#7c3aed,#a855f7);display:flex;align-items:center;justify-content:center;font-size:1.2rem;flex-shrink:0;overflow:hidden;text-decoration:none;">'+av+'</a>' +
          '<div style="flex:1;min-width:0;"><a href="profile.html?id='+post.user_id+'" style="font-weight:700;font-size:0.95rem;text-decoration:none;color:#eae6ff;">'+esc(name)+v+'</a> '+tb+'<div style="font-size:0.78rem;color:#a855f7;opacity:0.7;">'+ago+' '+si+'</div></div></div>' +
        (post.text ? '<div style="margin-bottom:0.5rem;line-height:1.55;word-break:break-word;">'+esc(post.text)+'</div>' : '') +
        media +
        '<div style="display:flex;gap:0.5rem;padding-top:0.6rem;border-top:1px solid rgba(124,58,237,0.15);">' +
          '<button class="action-btn" onclick="likePost(\''+post.id+'\',this)">ü§ç <span>'+(post.likes||0)+'</span></button>' +
          '<button class="action-btn" onclick="commentPost(\''+post.id+'\')">üí¨ <span>'+(post.comments||0)+'</span></button>' +
          '<button class="action-btn" onclick="sharePost(\''+post.id+'\',this)">üîÅ <span>'+(post.shares||0)+'</span></button>' +
          '<button class="action-btn" onclick="favPost(\''+post.id+'\',this)">‚≠ê <span>'+(post.favorites||0)+'</span></button>' +
        '</div></div>';
    }

    function esc(s) { return s ? s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;') : ''; }
    function timeAgo(d) {
      if (!d) return '';
      const m = Math.floor((Date.now() - new Date(d).getTime()) / 60000);
      if (m < 1) return 'Just now'; if (m < 60) return m+'m ago';
      const h = Math.floor(m/60); if (h < 24) return h+'h ago';
      const dy = Math.floor(h/24); if (dy < 7) return dy+'d ago';
      return new Date(d).toLocaleDateString();
    }

    window.likePost = async function(id, btn) {
      if (!currentUser) { alert('Log in to like posts'); return; }
      try {
        const { data } = await db.from('posts').select('likes,user_id').eq('id',id).single();
        if (!data) return;
        const n = (data.likes||0)+1;
        await db.from('posts').update({likes:n}).eq('id',id);
        btn.innerHTML = '‚ù§Ô∏è <span>'+n+'</span>';
        try { await db.rpc('add_algorithm_points',{p_user_id:data.user_id,p_action:'receive_like',p_points:2}); } catch(e){}
        try { await db.rpc('recalc_post_score',{p_post_id:id}); } catch(e){}
      } catch(e){ console.error(e); }
    };

    window.commentPost = async function(id) {
      if (!currentUser) { alert('Log in to comment'); return; }
      // Toggle comment section
      let commentSection = document.getElementById('comments-' + id);
      if (commentSection) { commentSection.style.display = commentSection.style.display === 'none' ? 'block' : 'none'; return; }
      // Create comment section
      const postCard = document.querySelector('[data-post-id="' + id + '"]');
      if (!postCard) return;
      commentSection = document.createElement('div');
      commentSection.id = 'comments-' + id;
      commentSection.style.cssText = 'margin-top:0.75rem;padding-top:0.75rem;border-top:1px solid rgba(124,58,237,0.2);';
      commentSection.innerHTML = '<div class="spinner" style="width:20px;height:20px;margin:0.5rem auto;"></div>';
      postCard.appendChild(commentSection);
      // Load existing comments
      try {
        const { data: comments } = await db.from('post_comments').select('id, user_id, text, created_at').eq('post_id', id).order('created_at', { ascending: true }).limit(30);
        let cHtml = '';
        if (comments && comments.length > 0) {
          const uids = [...new Set(comments.map(c => c.user_id))];
          const { data: profs } = await db.from('profiles').select('user_id, username, display_name').in('user_id', uids);
          const pm = {}; if (profs) profs.forEach(p => pm[p.user_id] = p);
          cHtml = comments.map(c => {
            const cp = pm[c.user_id] || {};
            const mine = currentUser && c.user_id === currentUser.id;
            const ago = Math.floor((Date.now() - new Date(c.created_at).getTime())/60000);
            const timeStr = ago < 1 ? 'now' : ago < 60 ? ago+'m' : ago < 1440 ? Math.floor(ago/60)+'h' : Math.floor(ago/1440)+'d';
            return '<div style="padding:0.4rem 0;display:flex;justify-content:space-between;"><div><span style="font-weight:600;font-size:0.8rem;color:#a855f7;">' + (cp.display_name||cp.username||'User') + '</span> <span style="font-size:0.83rem;">' + c.text.replace(/</g,'&lt;') + '</span> <span style="font-size:0.7rem;color:rgba(168,85,247,0.4);">' + timeStr + '</span></div>' +
            (mine ? '<button onclick="delFeedComment(\''+c.id+'\',\''+id+'\')" style="background:none;border:none;color:rgba(239,68,68,0.5);cursor:pointer;font-size:0.7rem;">‚úï</button>' : '') + '</div>';
          }).join('');
        }
        commentSection.innerHTML = cHtml +
          '<div style="display:flex;gap:0.5rem;margin-top:0.5rem;"><input id="cinput-' + id + '" type="text" placeholder="Write a comment..." style="flex:1;background:rgba(0,0,0,0.3);border:1px solid rgba(124,58,237,0.3);border-radius:6px;padding:0.4rem 0.6rem;color:#eae6ff;font-size:0.83rem;" onkeypress="if(event.key===\'Enter\')sendFeedComment(\''+id+'\')"><button onclick="sendFeedComment(\'' + id + '\')" style="background:#7c3aed;border:none;color:white;padding:0.4rem 0.75rem;border-radius:6px;cursor:pointer;font-size:0.83rem;">Send</button></div>';
      } catch(e) { commentSection.innerHTML = '<p style="color:#ef4444;font-size:0.8rem;">Error loading comments</p>'; }
    };

    window.sendFeedComment = async function(postId) {
      const input = document.getElementById('cinput-' + postId);
      if (!input || !input.value.trim() || !currentUser) return;
      const text = input.value.trim(); input.value = '';
      try {
        await db.from('post_comments').insert({ post_id: postId, user_id: currentUser.id, text: text });
        const { data } = await db.from('posts').select('comments,user_id').eq('id', postId).single();
        if (data) {
          await db.from('posts').update({ comments: (data.comments||0)+1 }).eq('id', postId);
          try { await db.rpc('add_algorithm_points', { p_user_id: data.user_id, p_action: 'receive_comment', p_points: 5 }); } catch(e){}
        }
        // Reload comments
        document.getElementById('comments-' + postId).remove();
        commentPost(postId);
      } catch(e) { alert('Error: ' + e.message); }
    };

    window.delFeedComment = async function(commentId, postId) {
      try {
        await db.from('post_comments').delete().eq('id', commentId).eq('user_id', currentUser.id);
        const { data } = await db.from('posts').select('comments').eq('id', postId).single();
        if (data) await db.from('posts').update({ comments: Math.max(0, (data.comments||1)-1) }).eq('id', postId);
        document.getElementById('comments-' + postId).remove();
        commentPost(postId);
      } catch(e) { console.error(e); }
    };

    window.sharePost = async function(id, btn) {
      try {
        const { data } = await db.from('posts').select('shares,user_id,text').eq('id',id).single();
        if (!data) return;
        const n = (data.shares||0)+1;
        await db.from('posts').update({shares:n}).eq('id',id);
        btn.innerHTML = 'üîÅ <span>'+n+'</span>';
        const t = 'Check out this post on 8BFR: '+(data.text||'').substring(0,100);
        try { if (navigator.share) await navigator.share({title:'8BFR',text:t,url:location.href}); else { await navigator.clipboard.writeText(t); alert('Link copied!'); } } catch(e){}
        if (data.user_id) { try { await db.rpc('add_algorithm_points',{p_user_id:data.user_id,p_action:'receive_share',p_points:15}); } catch(e){} }
        try { await db.rpc('recalc_post_score',{p_post_id:id}); } catch(e){}
      } catch(e){ console.error(e); }
    };

    window.favPost = async function(id, btn) {
      if (!currentUser) { alert('Log in to favorite'); return; }
      try {
        const { data } = await db.from('posts').select('favorites').eq('id',id).single();
        if (!data) return;
        const n = (data.favorites||0)+1;
        await db.from('posts').update({favorites:n}).eq('id',id);
        btn.innerHTML = '‚≠ê <span>'+n+'</span>';
        try { await db.from('favorites').insert({user_id:currentUser.id,target_type:'post',target_id:id}); } catch(e){}
      } catch(e){ console.error(e); }
    };

    await loadFeed();
  })();
  </script>
</body>
</html>
