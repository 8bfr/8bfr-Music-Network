<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Create Story ‚Äî 8BFR</title>
<link rel="icon" href="assets/images/favicon.png">
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
body { background: linear-gradient(#0b0014, #000); color: #eae6ff; font-family: system-ui, -apple-system, sans-serif; margin: 0; padding: 0; min-height: 100vh; }
.card { border: 1px solid rgba(124, 58, 237, 0.4); background: rgba(12, 6, 24, 0.8); border-radius: 16px; box-shadow: 0 0 24px rgba(124, 58, 237, 0.2); padding: 2rem; margin-bottom: 2rem; }
.input, .textarea { width: 100%; padding: 0.75rem; background: rgba(18, 3, 39, 0.8); border: 1px solid rgba(124, 58, 237, 0.6); border-radius: 0.75rem; color: #fff; font-size: 1rem; box-sizing: border-box; }
.input:focus, .textarea:focus { outline: none; border-color: #a855f7; box-shadow: 0 0 0 3px rgba(124, 58, 237, 0.2); }
.textarea { resize: vertical; min-height: 120px; font-family: inherit; line-height: 1.6; }
label { font-size: 0.9rem; font-weight: 600; opacity: 0.9; display: block; margin-bottom: 0.5rem; color: #a855f7; }
.btn { display: inline-block; background: #7c3aed; color: #fff; padding: 0.75rem 1.5rem; border-radius: 0.75rem; text-decoration: none; font-weight: 600; cursor: pointer; transition: all 0.2s; border: none; font-size: 1rem; }
.btn:hover { background: #6d28d9; transform: translateY(-1px); }
.btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
.btn-secondary { background: transparent; color: #a855f7; border: 1px solid rgba(124, 58, 237, 0.6); }
.btn-secondary:hover { background: rgba(124, 58, 237, 0.2); }
.type-selector { display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem; margin-bottom: 2rem; }
.type-option { padding: 1.5rem; border: 2px solid rgba(124, 58, 237, 0.3); border-radius: 12px; cursor: pointer; text-align: center; transition: all 0.2s; background: rgba(124, 58, 237, 0.05); }
.type-option:hover { border-color: rgba(124, 58, 237, 0.6); background: rgba(124, 58, 237, 0.1); }
.type-option.active { border-color: #a855f7; background: rgba(124, 58, 237, 0.2); box-shadow: 0 0 20px rgba(124, 58, 237, 0.3); }
.type-icon { font-size: 2.5rem; margin-bottom: 0.5rem; }
.type-label { font-weight: 600; font-size: 1.1rem; }
.background-selector { display: grid; grid-template-columns: repeat(4, 1fr); gap: 0.75rem; margin-bottom: 1rem; }
.background-option { aspect-ratio: 1; border-radius: 12px; cursor: pointer; border: 3px solid transparent; transition: all 0.2s; }
.background-option:hover { transform: scale(1.05); }
.background-option.active { border-color: #fff; box-shadow: 0 0 20px rgba(255, 255, 255, 0.5); }
.preview-card { max-width: 300px; aspect-ratio: 9/16; margin: 0 auto; border-radius: 16px; overflow: hidden; box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5); display: flex; align-items: center; justify-content: center; padding: 2rem; text-align: center; position: relative; }
.preview-text { font-size: 1.5rem; font-weight: 600; color: #fff; text-shadow: 0 2px 8px rgba(0, 0, 0, 0.3); line-height: 1.4; }
.preview-image { width: 100%; height: 100%; object-fit: cover; position: absolute; inset: 0; }
.file-upload { position: relative; border: 2px dashed rgba(124, 58, 237, 0.6); border-radius: 12px; padding: 2rem; text-align: center; cursor: pointer; transition: all 0.2s; }
.file-upload:hover { border-color: #a855f7; background: rgba(124, 58, 237, 0.05); }
.file-upload input[type="file"] { position: absolute; opacity: 0; width: 100%; height: 100%; top: 0; left: 0; cursor: pointer; }
.help-text { font-size: 0.85rem; opacity: 0.7; margin-top: 0.5rem; }
</style>
</head>
<body>

<header class="px-4 py-4 bg-[rgba(15,0,30,.95)] border-b border-purple-500/40 sticky top-0 z-50 backdrop-blur-md">
  <div class="max-w-4xl mx-auto flex items-center justify-between">
    <a href="profile.html" class="btn-secondary btn">‚Üê Back</a>
    <h1 class="text-xl font-bold">Create Story</h1>
    <span style="width: 80px;"></span>
  </div>
</header>

<main class="max-w-4xl mx-auto px-4 py-8">
  
  <div id="authGate" style="display:none;">
    <div class="card" style="text-align:center;padding:3rem;">
      <div style="font-size:3rem;margin-bottom:1rem;">üîí</div>
      <h2 style="font-size:1.3rem;margin-bottom:0.5rem;">Log in to create stories</h2>
      <a href="login.html?return=story-upload.html" class="btn" style="margin-top:1rem;">üîì Log In</a>
    </div>
  </div>

  <div id="mainContent" style="display:none;">

  <!-- Story Type Selector -->
  <div class="card">
    <h2 style="font-size: 1.5rem; font-weight: bold; margin-bottom: 1.5rem; color: #a855f7;">Choose Story Type</h2>
    <div class="type-selector">
      <div class="type-option active" id="typeText" onclick="selectType('text')">
        <div class="type-icon">üìù</div>
        <div class="type-label">Text</div>
        <div style="font-size: 0.85rem; opacity: 0.8; margin-top: 0.25rem;">Share a message</div>
      </div>
      <div class="type-option" id="typeImage" onclick="selectType('image')">
        <div class="type-icon">üì∏</div>
        <div class="type-label">Photo</div>
        <div style="font-size: 0.85rem; opacity: 0.8; margin-top: 0.25rem;">Upload an image</div>
      </div>
    </div>
  </div>

  <!-- Text Story -->
  <div id="textSection" class="card">
    <h3 style="font-size: 1.25rem; font-weight: 600; margin-bottom: 1.5rem; color: #a855f7;">Text Story</h3>
    <div style="margin-bottom: 1.5rem;">
      <label for="textContent">Your Message *</label>
      <textarea id="textContent" class="textarea" placeholder="What's on your mind?&#10;&#10;Share an update, announcement, or thought...&#10;Max 200 characters for best display" maxlength="200" oninput="updatePreview()"></textarea>
      <div class="help-text"><span id="charCount">0</span> / 200 characters</div>
    </div>
    <div style="margin-bottom: 1.5rem;">
      <label>Background Color</label>
      <div class="background-selector">
        <div class="background-option active" style="background: linear-gradient(135deg, #7c3aed, #a855f7);" data-bg="#7c3aed" data-gradient="linear-gradient(135deg, #7c3aed, #a855f7)" onclick="selectBackground(this)"></div>
        <div class="background-option" style="background: linear-gradient(135deg, #ec4899, #8b5cf6);" data-bg="#ec4899" data-gradient="linear-gradient(135deg, #ec4899, #8b5cf6)" onclick="selectBackground(this)"></div>
        <div class="background-option" style="background: linear-gradient(135deg, #06b6d4, #3b82f6);" data-bg="#06b6d4" data-gradient="linear-gradient(135deg, #06b6d4, #3b82f6)" onclick="selectBackground(this)"></div>
        <div class="background-option" style="background: linear-gradient(135deg, #10b981, #059669);" data-bg="#10b981" data-gradient="linear-gradient(135deg, #10b981, #059669)" onclick="selectBackground(this)"></div>
        <div class="background-option" style="background: linear-gradient(135deg, #f59e0b, #d97706);" data-bg="#f59e0b" data-gradient="linear-gradient(135deg, #f59e0b, #d97706)" onclick="selectBackground(this)"></div>
        <div class="background-option" style="background: linear-gradient(135deg, #ef4444, #dc2626);" data-bg="#ef4444" data-gradient="linear-gradient(135deg, #ef4444, #dc2626)" onclick="selectBackground(this)"></div>
        <div class="background-option" style="background: linear-gradient(135deg, #8b5cf6, #6366f1);" data-bg="#8b5cf6" data-gradient="linear-gradient(135deg, #8b5cf6, #6366f1)" onclick="selectBackground(this)"></div>
        <div class="background-option" style="background: linear-gradient(135deg, #14b8a6, #0d9488);" data-bg="#14b8a6" data-gradient="linear-gradient(135deg, #14b8a6, #0d9488)" onclick="selectBackground(this)"></div>
      </div>
    </div>
  </div>

  <!-- Image Story -->
  <div id="imageSection" class="card" style="display: none;">
    <h3 style="font-size: 1.25rem; font-weight: 600; margin-bottom: 1.5rem; color: #a855f7;">Photo Story</h3>
    <div style="margin-bottom: 1.5rem;">
      <label for="imageUrl">Image URL</label>
      <input type="url" id="imageUrl" class="input" placeholder="https://example.com/image.jpg" oninput="updatePreview()">
      <div class="help-text">Enter a direct link to an image (jpg, png, gif, webp)</div>
    </div>
    <div style="margin-bottom: 1.5rem;">
      <label>Or Upload From Device</label>
      <div class="file-upload">
        <input type="file" accept="image/*" id="imageFile" onchange="handleFileUpload(this)">
        <div style="font-size: 2rem; margin-bottom: 0.5rem;">üì∏</div>
        <div style="font-weight: 600; margin-bottom: 0.25rem;">Click to Upload</div>
        <div class="help-text">JPG, PNG, GIF, WebP (max 5MB)</div>
      </div>
    </div>
  </div>

  <!-- Preview -->
  <div class="card">
    <h3 style="font-size: 1.25rem; font-weight: 600; margin-bottom: 1.5rem; color: #a855f7; text-align: center;">Preview</h3>
    <div id="preview" class="preview-card" style="background: linear-gradient(135deg, #7c3aed, #a855f7);">
      <div class="preview-text" id="previewText">Your story will appear here</div>
    </div>
  </div>

  <!-- Actions -->
  <div class="card">
    <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
      <button type="button" class="btn" id="publishBtn" onclick="publishStory()" style="flex: 1;">üì§ Share Story</button>
      <a href="profile.html" class="btn btn-secondary" style="flex: 1; text-align: center;">Cancel</a>
    </div>
    <div id="publishNotice" style="margin-top:0.75rem;font-size:0.9rem;text-align:center;"></div>
    <div style="margin-top: 1.5rem; padding: 1rem; background: rgba(0, 217, 255, 0.1); border-radius: 12px; border-left: 4px solid #00d9ff;">
      <div style="font-weight: 600; margin-bottom: 0.5rem; color: #00d9ff;">‚è±Ô∏è Story Lifespan</div>
      <p style="margin: 0; font-size: 0.9rem; line-height: 1.6;">Your story will be visible for <strong>24 hours</strong>, then automatically disappear. You can delete it anytime from your profile.</p>
    </div>
  </div>

  </div><!-- /mainContent -->
</main>

<script>
const SUPABASE_URL = 'https://novbuvwpjnxwwvdekjhr.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5vdmJ1dndwam54d3d2ZGVramhyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjExODkxODUsImV4cCI6MjA3Njc2NTE4NX0.1UUkdGafh6ZplAX8hi7Bvj94D2gvFQZUl0an1RvcSA0';
const db = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

let currentUser = null;
let currentType = 'text';
let selectedBgColor = '#7c3aed';
let selectedGradient = 'linear-gradient(135deg, #7c3aed, #a855f7)';

(async function() {
  try {
    const { data: { session } } = await db.auth.getSession();
    if (!session) { document.getElementById('authGate').style.display = 'block'; return; }
    currentUser = session.user;
    document.getElementById('mainContent').style.display = 'block';
  } catch(e) { document.getElementById('authGate').style.display = 'block'; }
})();

function selectType(type) {
  currentType = type;
  document.getElementById('typeText').classList.toggle('active', type === 'text');
  document.getElementById('typeImage').classList.toggle('active', type === 'image');
  document.getElementById('textSection').style.display = type === 'text' ? 'block' : 'none';
  document.getElementById('imageSection').style.display = type === 'image' ? 'block' : 'none';
  updatePreview();
}

function selectBackground(element) {
  document.querySelectorAll('.background-option').forEach(opt => opt.classList.remove('active'));
  element.classList.add('active');
  selectedBgColor = element.getAttribute('data-bg');
  selectedGradient = element.getAttribute('data-gradient');
  updatePreview();
}

function updatePreview() {
  const preview = document.getElementById('preview');
  const previewText = document.getElementById('previewText');

  if (currentType === 'text') {
    const content = document.getElementById('textContent').value.trim();
    document.getElementById('charCount').textContent = content.length;

    // KEY FIX: set background via cssText to properly apply gradients
    preview.style.cssText = 'max-width:300px;aspect-ratio:9/16;margin:0 auto;border-radius:16px;overflow:hidden;box-shadow:0 10px 40px rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;padding:2rem;text-align:center;position:relative;background:' + selectedGradient + ';';
    previewText.style.display = 'block';
    previewText.textContent = content || 'Your story will appear here';

    const existingImg = preview.querySelector('.preview-image');
    if (existingImg) existingImg.remove();
  } else if (currentType === 'image') {
    const imageUrl = document.getElementById('imageUrl').value.trim();
    previewText.style.display = 'none';

    if (imageUrl) {
      preview.style.cssText = 'max-width:300px;aspect-ratio:9/16;margin:0 auto;border-radius:16px;overflow:hidden;box-shadow:0 10px 40px rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;padding:2rem;text-align:center;position:relative;background:#000;';
      const existingImg = preview.querySelector('.preview-image');
      if (existingImg) existingImg.remove();
      const img = document.createElement('img');
      img.src = imageUrl;
      img.className = 'preview-image';
      img.onerror = () => { previewText.style.display = 'block'; previewText.textContent = 'Invalid image URL'; img.remove(); };
      preview.appendChild(img);
    } else {
      preview.style.cssText = 'max-width:300px;aspect-ratio:9/16;margin:0 auto;border-radius:16px;overflow:hidden;box-shadow:0 10px 40px rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;padding:2rem;text-align:center;position:relative;background:linear-gradient(135deg,#7c3aed,#a855f7);';
      previewText.style.display = 'block';
      previewText.textContent = 'Add an image to preview';
    }
  }
}

function handleFileUpload(input) {
  if (input.files && input.files[0]) {
    const file = input.files[0];
    if (file.size > 5 * 1024 * 1024) { alert('‚ö†Ô∏è File too large! Max 5MB.'); input.value = ''; return; }
    if (!file.type.startsWith('image/')) { alert('‚ö†Ô∏è Upload an image file.'); input.value = ''; return; }
    const reader = new FileReader();
    reader.onload = (e) => { document.getElementById('imageUrl').value = e.target.result; updatePreview(); };
    reader.readAsDataURL(file);
  }
}

async function publishStory() {
  if (!currentUser) { alert('Please log in first.'); return; }
  const notice = document.getElementById('publishNotice');
  const btn = document.getElementById('publishBtn');

  let text = null, mediaUrl = null, mediaType = null;

  if (currentType === 'text') {
    text = document.getElementById('textContent').value.trim();
    if (!text) { notice.innerHTML = '<span style="color:#ef4444;">‚ö†Ô∏è Enter a message for your story.</span>'; return; }
    if (text.length > 200) { notice.innerHTML = '<span style="color:#ef4444;">‚ö†Ô∏è Keep it under 200 characters.</span>'; return; }
  } else {
    mediaUrl = document.getElementById('imageUrl').value.trim();
    if (!mediaUrl) { notice.innerHTML = '<span style="color:#ef4444;">‚ö†Ô∏è Add an image URL or upload a photo.</span>'; return; }
    mediaType = 'image';
  }

  btn.disabled = true; btn.textContent = 'Publishing...'; notice.innerHTML = '';

  try {
    const storyData = {
      user_id: currentUser.id,
      text: text,
      background_color: selectedBgColor,
      media_url: mediaUrl,
      media_type: mediaType,
      font_size: '24px',
      text_align: 'center',
      expires_at: new Date(Date.now() + 24 * 60 * 60 * 1000).toISOString()
    };

    const { error } = await db.from('stories').insert(storyData);
    if (error) throw error;

    // Award algorithm points
    try { await db.rpc('add_algorithm_points', { p_user_id: currentUser.id, p_action: 'create_story', p_points: 10 }); } catch(e) {}

    notice.innerHTML = '<span style="color:#4ade80;">‚úÖ Story published! Redirecting...</span>';
    setTimeout(() => { window.location.href = 'profile.html'; }, 1200);
  } catch(err) {
    notice.innerHTML = '<span style="color:#ef4444;">‚ùå ' + err.message + '</span>';
    btn.disabled = false; btn.textContent = 'üì§ Share Story';
  }
}
</script>

<script src="scripts.js" defer></script>

<!-- Safe avatar toggle (NO MutationObserver) -->
<script>
(function() {
  const toggleBtn = document.createElement('button');
  toggleBtn.innerHTML = 'üëÅÔ∏è';
  toggleBtn.style.cssText = 'position:fixed;top:80px;right:20px;z-index:9999;background:rgba(124,58,237,0.9);border:2px solid rgba(124,58,237,1);color:white;width:50px;height:50px;border-radius:50%;cursor:pointer;font-size:24px;display:flex;align-items:center;justify-content:center;box-shadow:0 4px 12px rgba(124,58,237,0.5);';
  document.body.appendChild(toggleBtn);
  let hidden = localStorage.getItem('hideAvatarBubbles') === 'true';
  function update() {
    document.querySelectorAll('[id*="bubble"],[class*="bubble"],[id*="avatar"][id*="switcher"]').forEach(el => { if(el) el.style.display = hidden ? 'none' : ''; });
    toggleBtn.innerHTML = hidden ? 'üëÅÔ∏è‚Äçüó®Ô∏è' : 'üëÅÔ∏è';
  }
  toggleBtn.addEventListener('click', () => { hidden = !hidden; localStorage.setItem('hideAvatarBubbles', hidden); update(); });
  update();
})();
</script>

</body>
</html>
