<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Checkout ‚Äî 8BFR Music Network</title>
  <link rel="icon" href="assets/images/favicon.png">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body { font-family: system-ui, -apple-system, sans-serif; background: linear-gradient(#0b0014, #000); color: #eae6ff; margin: 0; min-height: 100vh; padding-bottom: 80px; }
    .card { background: rgba(12,6,24,0.85); border: 1px solid rgba(124,58,237,0.35); border-radius: 16px; padding: 1.5rem; margin-bottom: 1.5rem; box-shadow: 0 0 20px rgba(124,58,237,0.15); }
    .btn { display: inline-flex; align-items: center; justify-content: center; gap: 0.4rem; background: #7c3aed; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 10px; font-size: 0.95rem; font-weight: 700; cursor: pointer; text-decoration: none; width: 100%; }
    .btn:hover { background: #6d28d9; }
    .btn-green { background: #22c55e; }
    .btn-green:hover { background: #16a34a; }
    .spinner { width: 40px; height: 40px; border: 3px solid rgba(124,58,237,0.2); border-top-color: #a855f7; border-radius: 50%; animation: spin 0.8s linear infinite; margin: 2rem auto; }
    @keyframes spin { to { transform: rotate(360deg); } }
  </style>
</head>
<body>
  <header style="background:rgba(15,0,30,0.9);border-bottom:1px solid rgba(124,58,237,0.5);padding:1rem;">
    <div class="max-w-4xl mx-auto flex items-center justify-between">
      <a href="index.html" style="color:#a855f7;text-decoration:none;font-weight:600;">‚Üê Home</a>
      <h1 class="text-xl font-extrabold">üõí Checkout</h1>
      <a href="profile.html" style="color:#a855f7;text-decoration:none;font-size:0.9rem;">My Profile</a>
    </div>
  </header>

  <main class="max-w-lg mx-auto px-4 mt-6">
    <div id="loading"><div class="spinner"></div><p style="text-align:center;color:#a855f7;">Loading song details...</p></div>
    <div id="checkoutContent" style="display:none;"></div>
    <div id="noSong" style="display:none;" class="card">
      <div style="text-align:center;padding:2rem;">
        <div style="font-size:3rem;margin-bottom:1rem;">üéµ</div>
        <h2 style="font-size:1.3rem;font-weight:700;margin-bottom:0.5rem;">No Song Selected</h2>
        <p style="color:#a855f7;margin-bottom:1.5rem;">Browse songs and click Buy to purchase.</p>
        <a href="radio.html" class="btn" style="max-width:200px;margin:0 auto;">üéß Browse Music</a>
      </div>
    </div>
  </main>

  <script src="scripts.js" defer></script>
  <script>
  (async function() {
    const SUPABASE_URL = 'https://novbuvwpjnxwwvdekjhr.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5vdmJ1dndwam54d3d2ZGVramhyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjExODkxODUsImV4cCI6MjA3Njc2NTE4NX0.1UUkdGafh6ZplAX8hi7Bvj94D2gvFQZUl0an1RvcSA0';
    const db = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    const params = new URLSearchParams(window.location.search);
    const songId = params.get('song');
    const loading = document.getElementById('loading');
    const content = document.getElementById('checkoutContent');
    const noSong = document.getElementById('noSong');

    if (!songId) { loading.style.display = 'none'; noSong.style.display = 'block'; return; }

    // Get current user
    let currentUser = null;
    try {
      const { data: { session } } = await db.auth.getSession();
      if (session) currentUser = session.user;
    } catch(e) {}

    // Load song
    try {
      const { data: song, error } = await db.from('songs').select('id, title, artist, cover_art, song_url, price, uploaded_by').eq('id', songId).single();
      if (error || !song) { loading.style.display = 'none'; noSong.style.display = 'block'; return; }

      const price = parseFloat(song.price) || 0;

      // Get artist profile
      let artistProfile = {};
      if (song.uploaded_by) {
        const { data: ap } = await db.from('profiles').select('username, display_name, paypal_email, verified_artist').eq('user_id', song.uploaded_by).single();
        if (ap) artistProfile = ap;
      }

      // Check if already purchased
      let alreadyPurchased = false;
      if (currentUser) {
        const { data: existing } = await db.from('song_purchases').select('id').eq('buyer_id', currentUser.id).eq('song_id', songId).limit(1);
        if (existing && existing.length > 0) alreadyPurchased = true;
      }

      loading.style.display = 'none';
      content.style.display = 'block';

      const cover = song.cover_art || 'assets/images/default_post.jpg';
      const artistName = artistProfile.display_name || artistProfile.username || song.artist || 'Unknown';

      if (price === 0) {
        // Free song
        content.innerHTML = `
          <div class="card">
            <div style="display:flex;gap:1rem;align-items:center;margin-bottom:1.5rem;">
              <img src="${cover}" style="width:80px;height:80px;border-radius:10px;object-fit:cover;" onerror="this.src='assets/images/default_post.jpg'">
              <div>
                <h2 style="font-size:1.2rem;font-weight:700;">${song.title || 'Untitled'}</h2>
                <p style="color:#a855f7;font-size:0.9rem;">${artistName}</p>
                <p style="color:#22c55e;font-weight:700;font-size:1.1rem;">FREE</p>
              </div>
            </div>
            ${song.song_url ? `
              <a href="${song.song_url}" download class="btn btn-green" style="margin-bottom:0.75rem;">‚¨áÔ∏è Download Free</a>
              <audio controls src="${song.song_url}" preload="none" style="width:100%;margin-top:0.5rem;"></audio>
            ` : '<p style="color:#ef4444;">Download not available yet.</p>'}
          </div>`;
        return;
      }

      if (alreadyPurchased) {
        content.innerHTML = `
          <div class="card">
            <div style="display:flex;gap:1rem;align-items:center;margin-bottom:1.5rem;">
              <img src="${cover}" style="width:80px;height:80px;border-radius:10px;object-fit:cover;" onerror="this.src='assets/images/default_post.jpg'">
              <div>
                <h2 style="font-size:1.2rem;font-weight:700;">${song.title || 'Untitled'}</h2>
                <p style="color:#a855f7;font-size:0.9rem;">${artistName}</p>
                <p style="color:#22c55e;font-weight:700;">‚úÖ Already Purchased</p>
              </div>
            </div>
            ${song.song_url ? `<a href="${song.song_url}" download class="btn btn-green">‚¨áÔ∏è Download</a>` : ''}
          </div>`;
        return;
      }

      if (!currentUser) {
        content.innerHTML = `
          <div class="card" style="text-align:center;">
            <div style="display:flex;gap:1rem;align-items:center;margin-bottom:1.5rem;">
              <img src="${cover}" style="width:80px;height:80px;border-radius:10px;object-fit:cover;" onerror="this.src='assets/images/default_post.jpg'">
              <div style="text-align:left;">
                <h2 style="font-size:1.2rem;font-weight:700;">${song.title || 'Untitled'}</h2>
                <p style="color:#a855f7;font-size:0.9rem;">${artistName}</p>
                <p style="color:#f59e0b;font-weight:700;font-size:1.1rem;">$${price.toFixed(2)}</p>
              </div>
            </div>
            <p style="color:#a855f7;margin-bottom:1rem;">Log in to purchase this song.</p>
            <a href="login.html?return=checkout.html%3Fsong%3D${songId}" class="btn">üîì Log In to Buy</a>
          </div>`;
        return;
      }

      // Paid song checkout
      const paypalEmail = artistProfile.paypal_email;
      content.innerHTML = `
        <div class="card">
          <div style="display:flex;gap:1rem;align-items:center;margin-bottom:1.5rem;">
            <img src="${cover}" style="width:80px;height:80px;border-radius:10px;object-fit:cover;" onerror="this.src='assets/images/default_post.jpg'">
            <div>
              <h2 style="font-size:1.2rem;font-weight:700;">${song.title || 'Untitled'}</h2>
              <p style="color:#a855f7;font-size:0.9rem;">${artistName} ${artistProfile.verified_artist ? '<span style="color:#00d9ff;">‚úì</span>' : ''}</p>
              <p style="color:#f59e0b;font-weight:700;font-size:1.3rem;">$${price.toFixed(2)}</p>
            </div>
          </div>
          ${song.song_url ? `<div style="margin-bottom:1rem;"><p style="font-size:0.8rem;color:#a855f7;margin-bottom:0.5rem;">Preview:</p><audio controls src="${song.song_url}" preload="none" style="width:100%;"></audio></div>` : ''}
        </div>

        <div class="card">
          <h3 style="font-weight:700;margin-bottom:1rem;color:#a855f7;">üí≥ Pay Artist Directly</h3>
          ${paypalEmail ? `
            <div style="background:rgba(124,58,237,0.1);border:1px solid rgba(124,58,237,0.3);padding:1rem;border-radius:10px;margin-bottom:1rem;">
              <p style="font-size:0.9rem;margin-bottom:0.75rem;">Send <strong style="color:#f59e0b;">$${price.toFixed(2)}</strong> to the artist's PayPal:</p>
              <div style="background:rgba(0,0,0,0.3);padding:0.75rem;border-radius:8px;display:flex;align-items:center;justify-content:space-between;margin-bottom:0.75rem;">
                <code style="font-size:0.95rem;">${paypalEmail}</code>
                <button onclick="navigator.clipboard.writeText('${paypalEmail}');this.textContent='Copied!';setTimeout(()=>this.textContent='üìã',1500)" style="background:none;border:none;color:#a855f7;cursor:pointer;font-size:1.1rem;">üìã</button>
              </div>
              <a href="https://www.paypal.com/paypalme/${paypalEmail.split('@')[0]}/${price.toFixed(2)}" target="_blank" rel="noopener" class="btn" style="background:#0070ba;margin-bottom:0.75rem;">
                üí≥ Open PayPal to Pay $${price.toFixed(2)}
              </a>
              <p style="font-size:0.8rem;color:rgba(168,85,247,0.7);margin-top:0.5rem;text-align:center;">
                After sending, click "I Sent Payment" below.
              </p>
            </div>
            <button onclick="confirmPayment('${songId}', ${price}, '${paypalEmail}')" class="btn btn-green" id="confirmBtn">
              ‚úÖ I Sent Payment ‚Äî Unlock Download
            </button>
            <p style="font-size:0.75rem;color:rgba(168,85,247,0.5);text-align:center;margin-top:0.75rem;font-style:italic;">
              Honor system ‚Äî the artist trusts you sent payment via PayPal.
            </p>
          ` : `
            <div style="background:rgba(239,68,68,0.1);border:1px solid rgba(239,68,68,0.3);padding:1rem;border-radius:10px;text-align:center;">
              <p style="color:#ef4444;font-weight:600;">‚ö†Ô∏è Artist hasn't set up payments yet</p>
              <p style="color:rgba(239,68,68,0.7);font-size:0.85rem;margin-top:0.5rem;">Contact the artist or check back later.</p>
            </div>
          `}
        </div>

        <div id="downloadSection" style="display:none;" class="card">
          <div style="text-align:center;">
            <div style="font-size:2.5rem;margin-bottom:0.5rem;">üéâ</div>
            <h3 style="font-weight:700;color:#22c55e;margin-bottom:1rem;">Purchase Complete!</h3>
            ${song.song_url ? `<a href="${song.song_url}" download class="btn btn-green">‚¨áÔ∏è Download Song</a>` : '<p style="color:#a855f7;">Download will be available soon.</p>'}
          </div>
        </div>`;

    } catch(err) {
      loading.style.display = 'none';
      content.style.display = 'block';
      content.innerHTML = `<div class="card"><p style="color:#ef4444;">Error loading song: ${err.message}</p></div>`;
    }

    // Confirm payment handler
    window.confirmPayment = async function(sid, amount, artistPaypal) {
      const btn = document.getElementById('confirmBtn');
      if (!btn) return;
      btn.disabled = true; btn.textContent = 'Recording purchase...';
      try {
        await db.from('song_purchases').insert({
          buyer_id: currentUser.id,
          song_id: sid,
          amount: amount,
          artist_paypal: artistPaypal,
          status: 'trust_payment'
        });
        // Award points to artist
        try {
          const { data: song } = await db.from('songs').select('uploaded_by').eq('id', sid).single();
          if (song) await db.rpc('add_algorithm_points', { p_user_id: song.uploaded_by, p_action: 'receive_purchase', p_points: 50 });
        } catch(e) {}
        btn.style.display = 'none';
        document.getElementById('downloadSection').style.display = 'block';
      } catch(e) {
        btn.textContent = '‚úÖ I Sent Payment ‚Äî Unlock Download';
        btn.disabled = false;
        alert('Error: ' + e.message);
      }
    };
  })();
  </script>
</body>
</html>
