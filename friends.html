<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Friends ‚Äî 8BFR Music Network</title>
  <link rel="icon" href="assets/images/favicon.png">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body { font-family: system-ui, -apple-system, sans-serif; background: linear-gradient(#0b0014, #000); color: #eae6ff; margin: 0; min-height: 100vh; padding-bottom: 80px; }
    .card { background: rgba(12,6,24,0.85); border: 1px solid rgba(124,58,237,0.35); border-radius: 16px; padding: 1.5rem; margin-bottom: 1rem; }
    .user-row { display: flex; align-items: center; gap: 1rem; padding: 0.75rem; border-radius: 10px; transition: background 0.2s; }
    .user-row:hover { background: rgba(124,58,237,0.1); }
    .avatar { width: 48px; height: 48px; border-radius: 50%; background: linear-gradient(135deg, #7c3aed, #a855f7); display: flex; align-items: center; justify-content: center; font-size: 1.3rem; overflow: hidden; flex-shrink: 0; }
    .avatar img { width: 100%; height: 100%; object-fit: cover; }
    .tab { padding: 0.5rem 1rem; border: none; background: rgba(124,58,237,0.15); color: #a855f7; border-radius: 8px; cursor: pointer; font-size: 0.85rem; font-weight: 600; }
    .tab.active { background: #7c3aed; color: white; }
    .btn-accept { background: #22c55e; color: white; border: none; padding: 0.35rem 0.75rem; border-radius: 6px; font-size: 0.8rem; cursor: pointer; }
    .btn-decline { background: rgba(239,68,68,0.15); border: 1px solid rgba(239,68,68,0.4); color: #ef4444; padding: 0.35rem 0.75rem; border-radius: 6px; font-size: 0.8rem; cursor: pointer; }
    .spinner { width: 40px; height: 40px; border: 3px solid rgba(124,58,237,0.2); border-top-color: #a855f7; border-radius: 50%; animation: spin 0.8s linear infinite; margin: 2rem auto; }
    @keyframes spin { to { transform: rotate(360deg); } }
  </style>
</head>
<body>
  <header style="background:rgba(15,0,30,0.9);border-bottom:1px solid rgba(124,58,237,0.5);padding:1rem;position:sticky;top:0;z-index:100;">
    <div class="max-w-4xl mx-auto flex items-center justify-between">
      <a href="javascript:history.back()" style="color:#a855f7;text-decoration:none;font-weight:600;">‚Üê Back</a>
      <h1 class="text-xl font-extrabold">Friends</h1>
      <div style="width:60px;"></div>
    </div>
  </header>

  <main class="max-w-lg mx-auto px-4 mt-4">
    <div id="tabs" style="display:none;margin-bottom:1rem;display:flex;gap:0.5rem;">
      <button class="tab active" onclick="showTab('friends',this)">ü§ù Friends</button>
      <button class="tab" onclick="showTab('pending',this)">üì© Requests</button>
    </div>
    <div id="loading"><div class="spinner"></div></div>
    <div id="friendsList"></div>
    <div id="pendingList" style="display:none;"></div>
    <div id="empty" style="display:none;" class="card">
      <div style="text-align:center;padding:2rem;color:#a855f7;">
        <div style="font-size:3rem;margin-bottom:0.5rem;">ü§ù</div>
        <p>No friends yet. Visit profiles and send friend requests!</p>
        <a href="members.html" style="color:#00d9ff;margin-top:0.5rem;display:inline-block;">Browse Members ‚Üí</a>
      </div>
    </div>
  </main>

  <script src="scripts.js" defer></script>
  <script>
  let db, currentUser;
  (async function() {
    db = window.supabase.createClient('https://novbuvwpjnxwwvdekjhr.supabase.co','eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5vdmJ1dndwam54d3d2ZGVramhyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjExODkxODUsImV4cCI6MjA3Njc2NTE4NX0.1UUkdGafh6ZplAX8hi7Bvj94D2gvFQZUl0an1RvcSA0');
    try { const { data: { session } } = await db.auth.getSession(); if (session) currentUser = session.user; } catch(e) {}
    if (!currentUser) {
      document.getElementById('loading').style.display = 'none';
      document.getElementById('empty').style.display = 'block';
      document.getElementById('tabs').style.display = 'none';
      return;
    }
    const uid = currentUser.id;

    try {
      // Load accepted friends
      const { data: friends } = await db.from('friends').select('id, user_id, friend_id').or(`user_id.eq.${uid},friend_id.eq.${uid}`).eq('status', 'accepted');
      // Load pending requests TO me
      const { data: pending } = await db.from('friends').select('id, user_id').eq('friend_id', uid).eq('status', 'pending');

      document.getElementById('loading').style.display = 'none';
      document.getElementById('tabs').style.display = 'flex';

      // Get all user IDs
      const allIds = new Set();
      (friends||[]).forEach(f => { allIds.add(f.user_id === uid ? f.friend_id : f.user_id); });
      (pending||[]).forEach(f => { allIds.add(f.user_id); });
      const idArr = [...allIds];

      let pm = {};
      if (idArr.length > 0) {
        const { data: profiles } = await db.from('profiles').select('user_id, username, display_name, avatar_url, verified_artist, role').in('user_id', idArr);
        if (profiles) profiles.forEach(p => pm[p.user_id] = p);
      }

      // Render friends
      if (!friends || friends.length === 0) {
        document.getElementById('empty').style.display = 'block';
      } else {
        document.getElementById('friendsList').innerHTML = friends.map(f => {
          const otherId = f.user_id === uid ? f.friend_id : f.user_id;
          const p = pm[otherId] || {};
          const name = p.display_name || p.username || 'User';
          const av = p.avatar_url ? `<img src="${p.avatar_url}" onerror="this.parentElement.textContent='üë§'">` : 'üë§';
          const v = p.verified_artist ? ' <span style="color:#00d9ff;">‚úì</span>' : '';
          return `<a href="profile.html?id=${otherId}" style="text-decoration:none;color:inherit;"><div class="user-row"><div class="avatar">${av}</div><div style="flex:1;"><div style="font-weight:600;">${name}${v}</div><div style="font-size:0.8rem;color:#a855f7;">@${p.username||'user'}</div></div></div></a>`;
        }).join('');
      }

      // Render pending
      if (pending && pending.length > 0) {
        document.querySelectorAll('.tab')[1].textContent = `üì© Requests (${pending.length})`;
        document.getElementById('pendingList').innerHTML = pending.map(f => {
          const p = pm[f.user_id] || {};
          const name = p.display_name || p.username || 'User';
          const av = p.avatar_url ? `<img src="${p.avatar_url}" onerror="this.parentElement.textContent='üë§'">` : 'üë§';
          return `<div class="user-row" id="req-${f.id}"><div class="avatar">${av}</div><div style="flex:1;"><div style="font-weight:600;">${name}</div><div style="font-size:0.8rem;color:#a855f7;">wants to be friends</div></div><div style="display:flex;gap:0.5rem;"><button class="btn-accept" onclick="respondFriend('${f.id}','accepted')">Accept</button><button class="btn-decline" onclick="respondFriend('${f.id}','declined')">Decline</button></div></div>`;
        }).join('');
      } else {
        document.getElementById('pendingList').innerHTML = '<div style="text-align:center;padding:2rem;color:#a855f7;">No pending requests.</div>';
      }
    } catch(e) {
      document.getElementById('loading').style.display = 'none';
      document.getElementById('friendsList').innerHTML = `<div class="card"><p style="color:#ef4444;">Error: ${e.message}</p></div>`;
    }
  })();

  function showTab(tab, btn) {
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    btn.classList.add('active');
    document.getElementById('friendsList').style.display = tab === 'friends' ? 'block' : 'none';
    document.getElementById('pendingList').style.display = tab === 'pending' ? 'block' : 'none';
    document.getElementById('empty').style.display = 'none';
  }

  async function respondFriend(id, status) {
    try {
      await db.from('friends').update({ status }).eq('id', id);
      const row = document.getElementById('req-' + id);
      if (row) {
        if (status === 'accepted') { row.innerHTML = '<div style="padding:0.5rem;color:#22c55e;text-align:center;">‚úÖ Accepted!</div>'; }
        else { row.remove(); }
      }
    } catch(e) { alert(e.message); }
  }
  </script>
</body>
</html>
