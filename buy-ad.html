
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Buy an Ad - 8BFR Music Network</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://js.stripe.com/v3/"></script>
    <style>
        body {
            background: linear-gradient(#0b0014, #000);
            color: #eae6ff;
            font-family: system-ui, sans-serif;
            min-height: 100vh;
            padding: 2rem 1rem;
        }
        .card {
            background: rgba(12, 6, 24, 0.8);
            border: 1px solid rgba(124, 58, 237, 0.4);
            border-radius: 16px;
            padding: 2rem;
            max-width: 600px;
            margin: 0 auto;
        }
        input, select, textarea {
            width: 100%;
            padding: 0.75rem;
            background: #0b0014;
            border: 1px solid rgba(124, 58, 237, 0.4);
            border-radius: 8px;
            color: #eae6ff;
            margin-bottom: 1rem;
        }
        .btn {
            background: #7c3aed;
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-weight: 600;
            width: 100%;
            margin-bottom: 0.75rem;
        }
        .btn:hover { background: #6d28d9; }
        .btn-stripe { background: #635bff; }
        .btn-stripe:hover { background: #5145e5; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .price-display {
            background: rgba(124, 58, 237, 0.2);
            border: 1px solid rgba(124, 58, 237, 0.4);
            padding: 1.5rem;
            border-radius: 8px;
            margin: 1rem 0;
        }
        label {
            display: block;
            margin-bottom: 0.5rem;
            color: #a855f7;
            font-weight: 600;
        }
        .back-link {
            color: #a855f7;
            text-decoration: none;
            display: inline-block;
            margin-bottom: 1rem;
        }
        .back-link:hover { color: #c084fc; }
        .divider {
            text-align: center;
            margin: 1rem 0;
            color: #a855f7;
            font-size: 0.9rem;
        }
        #paypal-button-container {
            margin-bottom: 0.75rem;
            min-height: 55px;
        }
        #paypal-status {
            text-align: center;
            padding: 0.75rem;
            font-size: 0.85rem;
        }
    </style>
</head>
<body>
    <div class="card">
        <a href="index.html" class="back-link">&#8592; Back to Home</a>

        <h1 style="font-size: 2rem; font-weight: 800; margin-bottom: 0.5rem; color: #7c3aed;">Buy Ad Space</h1>
        <p style="color: #a855f7; margin-bottom: 2rem;">Reach thousands of music creators and fans</p>

        <form id="adForm">
            <div>
                <label for="adTitle">Ad Title *</label>
                <input type="text" id="adTitle" required placeholder="Your ad headline">
            </div>
            <div>
                <label for="adLink">Website Link *</label>
                <input type="url" id="adLink" required placeholder="https://yoursite.com">
            </div>
            <div>
                <label for="adImage">Ad Image * (1200x600px recommended, max 5MB)</label>
                <input type="file" id="adImage" accept="image/*" required>
            </div>
            <div>
                <label for="adType">Ad Type *</label>
                <select id="adType">
                    <option value="carousel">Main Ad (Ads Page)</option>
                    <option value="featured">Featured Ad (Home + Ads Page)</option>
                </select>
            </div>
            <div>
                <label for="adDuration">Duration *</label>
                <select id="adDuration">
                    <option value="7">7 Days</option>
                    <option value="14">14 Days</option>
                    <option value="30">30 Days</option>
                </select>
            </div>
            <div>
                <label for="discountCode">Discount Code (optional)</label>
                <div style="display: flex; gap: 0.5rem;">
                    <input type="text" id="discountCode" placeholder="Enter code">
                    <button type="button" id="applyBtn" class="btn" style="width: auto; padding: 0.75rem 1rem;">Apply</button>
                </div>
                <p id="discountMessage" style="margin-top: 0.5rem; font-size: 0.9rem;"></p>
            </div>

            <div class="price-display">
                <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                    <span>Base Price:</span>
                    <span id="basePrice">$5.00</span>
                </div>
                <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem; color: #00ff88;" id="discountRow" hidden>
                    <span>Discount:</span>
                    <span id="discountAmount">-$0.00</span>
                </div>
                <div style="display: flex; justify-content: space-between; border-top: 1px solid rgba(124, 58, 237, 0.4); padding-top: 0.5rem; font-size: 1.25rem; font-weight: 700;">
                    <span>Total:</span>
                    <span id="finalPrice">$5.00</span>
                </div>
            </div>

            <p style="color: #a855f7; font-size: 0.9rem; margin-bottom: 1rem; font-weight: 600;">Choose Payment Method:</p>

            <div id="paypal-button-container"></div>
            <p id="paypal-status" style="color: #a855f7;">Loading PayPal...</p>

            <div class="divider">OR</div>

            <button type="button" id="stripe-button" class="btn btn-stripe">
                &#128179; Pay with Credit Card (Stripe)
            </button>
        </form>

        <p style="margin-top: 1rem; font-size: 0.8rem; color: #a855f7; text-align: center;">
            Your ad will be reviewed within 24 hours
        </p>
    </div>

    <script>
    (function() {
        var SUPABASE_URL = 'https://novbuvwpjnxwwvdekjhr.supabase.co';
        var SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5vdmJ1dndwam54d3d2ZGVramhyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjExODkxODUsImV4cCI6MjA3Njc2NTE4NX0.1UUkdGafh6ZplAX8hi7Bvj94D2gvFQZUl0an1RvcSA0';
        var WEBHOOK_URL = 'https://qjzcoybmcrmonzjctama.supabase.co/functions/v1/paypal-webhook';
        var sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        var stripeObj = Stripe('pk_live_51OkBOuEvK9FbOwLilOaOLSHSLx47wT1q7T6xiMuODRF2j4a2DM0BHI16A5z8ovscAfhv83l7d1OFPbUjehHtQIeH00RwDCQ0I1');

        var PRICES = {
            carousel: { 7: 5, 14: 8, 30: 12 },
            featured: { 7: 10, 14: 18, 30: 30 }
        };

        var STRIPE_PRICE_IDS = {
            'carousel_7':  'price_1SxvB9EvK9FbOwLivDlFaHpj',
            'carousel_14': 'price_1SxvFCEvK9FbOwLi8mYGzBXx',
            'carousel_30': 'price_1SxvGdEvK9FbOwLip3sLzCje',
            'featured_7':  'price_1SxvIHEvK9FbOwLiIaEDZWwZ',
            'featured_14': 'price_1SxvLWEvK9FbOwLi4crOdTRW',
            'featured_30': 'price_1SxvMuEvK9FbOwLiwDx4itL5'
        };

        var discountData = null;
        var finalPrice = 5;

        function updatePrice() {
            var type = document.getElementById('adType').value;
            var duration = document.getElementById('adDuration').value;
            var basePrice = PRICES[type][duration];
            finalPrice = basePrice;
            if (discountData) {
                var amt = parseFloat(discountData.discount_amount || 0);
                finalPrice = Math.max(0, basePrice - amt);
                document.getElementById('discountRow').hidden = false;
                document.getElementById('discountAmount').textContent = '-$' + amt.toFixed(2);
            } else {
                document.getElementById('discountRow').hidden = true;
            }
            document.getElementById('basePrice').textContent = '$' + basePrice.toFixed(2);
            document.getElementById('finalPrice').textContent = '$' + finalPrice.toFixed(2);
        }

        document.getElementById('adType').addEventListener('change', updatePrice);
        document.getElementById('adDuration').addEventListener('change', updatePrice);

        document.getElementById('applyBtn').addEventListener('click', async function() {
            var code = document.getElementById('discountCode').value.trim().toUpperCase();
            var msgEl = document.getElementById('discountMessage');
            if (!code) { msgEl.textContent = 'Please enter a code'; msgEl.style.color = '#ff0044'; return; }
            try {
                var res = await sb.from('discount_codes').select('*').eq('code', code).single();
                if (res.error || !res.data) {
                    msgEl.textContent = 'Invalid code'; msgEl.style.color = '#ff0044';
                    discountData = null; updatePrice(); return;
                }
                if (res.data.max_uses && res.data.uses >= res.data.max_uses) {
                    msgEl.textContent = 'Code expired'; msgEl.style.color = '#ff0044';
                    discountData = null; updatePrice(); return;
                }
                discountData = res.data; updatePrice();
                msgEl.textContent = 'Discount applied!'; msgEl.style.color = '#00ff88';
            } catch (err) {
                msgEl.textContent = 'Error applying code'; msgEl.style.color = '#ff0044';
            }
        });

        function validateForm() {
            var title = document.getElementById('adTitle').value.trim();
            var link = document.getElementById('adLink').value.trim();
            var image = document.getElementById('adImage').files[0];
            if (!title || !link || !image) { alert('Please fill in all required fields'); return false; }
            return true;
        }

        async function saveAdToDatabase(paymentMethod, paymentId) {
            try {
                var userRes = await sb.auth.getUser();
                var user = userRes.data ? userRes.data.user : null;
                var adData = {
                    user_id: user ? user.id : null,
                    title: document.getElementById('adTitle').value.trim(),
                    link_url: document.getElementById('adLink').value.trim(),
                    ad_type: document.getElementById('adType').value,
                    duration_days: parseInt(document.getElementById('adDuration').value),
                    amount_paid: finalPrice,
                    payment_method: paymentMethod,
                    payment_id: paymentId,
                    status: 'pending',
                    created_at: new Date().toISOString(),
                    expires_at: new Date(Date.now() + parseInt(document.getElementById('adDuration').value) * 86400000).toISOString()
                };
                var insertRes = await sb.from('ads').insert(adData);
                if (insertRes.error) {
                    console.error('DB error:', insertRes.error);
                    alert('Payment successful but error saving ad. Contact support with ID: ' + paymentId);
                } else {
                    if (discountData) {
                        await sb.from('discount_codes').update({ uses: (discountData.uses || 0) + 1 }).eq('code', discountData.code);
                    }
                    alert('Payment successful! Your ad is pending approval. Payment ID: ' + paymentId);
                    window.location.href = 'index.html';
                }
            } catch (err) {
                console.error('Error:', err);
                alert('Payment successful but error occurred. Contact support.');
            }
        }

        // PAYPAL
        var ppStatus = document.getElementById('paypal-status');
        var ppScript = document.createElement('script');
        ppScript.src = 'https://www.paypal.com/sdk/js?client-id=AWx0LwdZ_sCyCE5gEj9mL1ha7ZbG_eZLE_R636KjLXFMV1pOfmGwNg9prM5kVKQspvnpNLJDZxPp100G&currency=USD&intent=capture&components=buttons';
        ppScript.setAttribute('data-sdk-integration-source', 'button-factory');

        ppScript.onload = function() {
            console.log('PayPal SDK loaded');
            ppStatus.style.display = 'none';
            window.paypal.Buttons({
                style: { layout: 'vertical', color: 'gold', shape: 'rect', label: 'paypal', height: 45 },
                createOrder: function(data, actions) {
                    if (!validateForm()) return actions.reject();
                    return actions.order.create({
                        purchase_units: [{
                            amount: { value: finalPrice.toFixed(2) },
                            description: 'Ad on 8BFR Music Network'
                        }]
                    });
                },
                onApprove: function(data, actions) {
                    ppStatus.style.display = 'block';
                    ppStatus.textContent = 'Processing payment...';
                    ppStatus.style.color = '#00ff88';
                    return actions.order.capture().then(function(details) {
                        fetch(WEBHOOK_URL, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ event_type: 'PAYMENT.CAPTURE.COMPLETED', resource: details })
                        }).catch(function(e) { console.warn('Webhook failed:', e); });
                        return saveAdToDatabase('paypal', details.id);
                    });
                },
                onCancel: function() { console.log('PayPal cancelled'); },
                onError: function(err) {
                    console.error('PayPal error:', err);
                    ppStatus.style.display = 'block';
                    ppStatus.textContent = 'PayPal error. Please try again.';
                    ppStatus.style.color = '#ff0044';
                }
            }).render('#paypal-button-container').then(function() {
                console.log('PayPal buttons rendered');
            }).catch(function(err) {
                console.error('PayPal render failed:', err);
                ppStatus.style.display = 'block';
                ppStatus.textContent = 'PayPal failed to render. Reload page.';
                ppStatus.style.color = '#ff0044';
            });
        };

        ppScript.onerror = function() {
            ppStatus.textContent = 'PayPal could not load. Check connection or reload.';
            ppStatus.style.color = '#ff0044';
        };

        document.body.appendChild(ppScript);

        // STRIPE
        document.getElementById('stripe-button').addEventListener('click', async function() {
            if (!validateForm()) return;
            var type = document.getElementById('adType').value;
            var duration = document.getElementById('adDuration').value;
            var priceId = STRIPE_PRICE_IDS[type + '_' + duration];
            if (!priceId) { alert('Stripe config error. Use PayPal.'); return; }

            this.disabled = true;
            this.textContent = 'Redirecting to Stripe...';

            try {
                localStorage.setItem('8bfr_pending_ad', JSON.stringify({
                    title: document.getElementById('adTitle').value.trim(),
                    link_url: document.getElementById('adLink').value.trim(),
                    ad_type: type,
                    duration_days: parseInt(duration),
                    amount_paid: finalPrice,
                    discount_code: discountData ? discountData.code : null
                }));

                var result = await stripeObj.redirectToCheckout({
                    lineItems: [{ price: priceId, quantity: 1 }],
                    mode: 'payment',
                    successUrl: window.location.origin + '/ad-success.html?session_id={CHECKOUT_SESSION_ID}',
                    cancelUrl: window.location.href
                });
                if (result.error) alert('Stripe error: ' + result.error.message);
            } catch (err) {
                console.error('Stripe error:', err);
                alert('Error: ' + err.message);
            }
            this.disabled = false;
            this.textContent = 'Pay with Credit Card (Stripe)';
        });

        updatePrice();
    })();
    </script>
</body>
</html>
 
