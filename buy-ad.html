<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Buy an Ad - 8BFR Music Network</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://js.stripe.com/v3/"></script>
    <style>
        body {
            background: linear-gradient(#0b0014, #000);
            color: #eae6ff;
            font-family: system-ui, sans-serif;
            min-height: 100vh;
            padding: 2rem 1rem;
        }
        .card {
            background: rgba(12, 6, 24, 0.8);
            border: 1px solid rgba(124, 58, 237, 0.4);
            border-radius: 16px;
            padding: 2rem;
            max-width: 600px;
            margin: 0 auto;
        }
        input, select, textarea {
            width: 100%;
            padding: 0.75rem;
            background: #0b0014;
            border: 1px solid rgba(124, 58, 237, 0.4);
            border-radius: 8px;
            color: #eae6ff;
            margin-bottom: 1rem;
        }
        .btn {
            background: #7c3aed;
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-weight: 600;
            width: 100%;
            margin-bottom: 0.75rem;
        }
        .btn:hover { background: #6d28d9; }
        .btn-stripe { background: #635bff; }
        .btn-stripe:hover { background: #5145e5; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .price-display {
            background: rgba(124, 58, 237, 0.2);
            border: 1px solid rgba(124, 58, 237, 0.4);
            padding: 1.5rem;
            border-radius: 8px;
            margin: 1rem 0;
        }
        label {
            display: block;
            margin-bottom: 0.5rem;
            color: #a855f7;
            font-weight: 600;
        }
        .back-link {
            color: #a855f7;
            text-decoration: none;
            display: inline-block;
            margin-bottom: 1rem;
        }
        .back-link:hover { color: #c084fc; }
        .divider {
            text-align: center;
            margin: 1rem 0;
            color: #a855f7;
            font-size: 0.9rem;
        }
        #paypal-button-container {
            margin-bottom: 0.75rem;
            min-height: 50px;
        }
        .pp-loading {
            text-align: center;
            color: #a855f7;
            padding: 1rem;
            font-size: 0.9rem;
        }
        .pp-loading .spin {
            display: inline-block;
            width: 16px; height: 16px;
            border: 2px solid #a855f7;
            border-top-color: transparent;
            border-radius: 50%;
            animation: sp 0.8s linear infinite;
            vertical-align: middle;
            margin-right: 0.5rem;
        }
        @keyframes sp { to { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div class="card">
        <a href="index.html" class="back-link">â† Back to Home</a>
        
        <h1 style="font-size: 2rem; font-weight: 800; margin-bottom: 0.5rem; color: #7c3aed;">Buy Ad Space</h1>
        <p style="color: #a855f7; margin-bottom: 2rem;">Reach thousands of music creators and fans</p>
        
        <form id="adForm">
            <div>
                <label for="adTitle">Ad Title *</label>
                <input type="text" id="adTitle" required placeholder="Your ad headline">
            </div>
            <div>
                <label for="adLink">Website Link *</label>
                <input type="url" id="adLink" required placeholder="https://yoursite.com">
            </div>
            <div>
                <label for="adImage">Ad Image * (1200x600px recommended, max 5MB)</label>
                <input type="file" id="adImage" accept="image/*" required>
            </div>
            <div>
                <label for="adType">Ad Type *</label>
                <select id="adType" onchange="updatePrice()">
                    <option value="carousel">Carousel Ad</option>
                    <option value="featured">Featured Ad</option>
                </select>
            </div>
            <div>
                <label for="adDuration">Duration *</label>
                <select id="adDuration" onchange="updatePrice()">
                    <option value="7">7 Days</option>
                    <option value="14">14 Days</option>
                    <option value="30">30 Days</option>
                </select>
            </div>
            <div>
                <label for="discountCode">Discount Code (optional)</label>
                <div style="display: flex; gap: 0.5rem;">
                    <input type="text" id="discountCode" placeholder="Enter code">
                    <button type="button" onclick="applyDiscount()" class="btn" style="width: auto; padding: 0.75rem 1rem;">Apply</button>
                </div>
                <p id="discountMessage" style="margin-top: 0.5rem; font-size: 0.9rem;"></p>
            </div>
            
            <div class="price-display">
                <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                    <span>Base Price:</span>
                    <span id="basePrice">$5.00</span>
                </div>
                <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem; color: #00ff88;" id="discountRow" hidden>
                    <span>Discount:</span>
                    <span id="discountAmount">-$0.00</span>
                </div>
                <div style="display: flex; justify-content: space-between; border-top: 1px solid rgba(124, 58, 237, 0.4); padding-top: 0.5rem; font-size: 1.25rem; font-weight: 700;">
                    <span>Total:</span>
                    <span id="finalPrice">$5.00</span>
                </div>
            </div>
            
            <p style="color: #a855f7; font-size: 0.9rem; margin-bottom: 1rem; font-weight: 600;">Choose Payment Method:</p>
            
            <!-- PayPal -->
            <div id="paypal-button-container">
                <div class="pp-loading" id="pp-loading"><span class="spin"></span> Loading PayPal...</div>
            </div>
            
            <div class="divider">OR</div>
            
            <!-- Stripe -->
            <button type="button" id="stripe-button" class="btn btn-stripe">
                ğŸ’³ Pay with Credit Card (Stripe)
            </button>
        </form>
        
        <p style="margin-top: 1rem; font-size: 0.8rem; color: #a855f7; text-align: center;">
            Your ad will be reviewed within 24 hours
        </p>
    </div>

    <!-- ALL scripts at end of body, PayPal SDK loaded dynamically -->
    <script>
        // â”€â”€ Config â”€â”€
        const SUPABASE_URL = 'https://novbuvwpjnxwwvdekjhr.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5vdmJ1dndwam54d3d2ZGVramhyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjExODkxODUsImV4cCI6MjA3Njc2NTE4NX0.1UUkdGafh6ZplAX8hi7Bvj94D2gvFQZUl0an1RvcSA0';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        const stripe = Stripe('pk_live_51OkBOuEvK9FbOwLilOaOLSHSLx47wT1q7T6xiMuODRF2j4a2DM0BHI16A5z8ovscAfhv83l7d1OFPbUjehHtQIeH00RwDCQ0I1');

        const PRICES = {
            carousel: { 7: 5, 14: 8, 30: 12 },
            featured: { 7: 10, 14: 18, 30: 30 }
        };

        /*  â”€â”€ STRIPE PRICE IDS â”€â”€
            To enable Stripe, create products in your Stripe Dashboard:
            Dashboard â†’ Products â†’ + Add Product â†’ set name & price â†’ copy Price ID
            Then paste each price_XXXX ID below.
        */
        const STRIPE_PRICE_IDS = {
            'carousel_7':  '',   // paste price_XXXX here
            'carousel_14': '',
            'carousel_30': '',
            'featured_7':  '',
            'featured_14': '',
            'featured_30': ''
        };

        let discountData = null;
        let finalPrice = 5;

        // â”€â”€ Price â”€â”€
        function updatePrice() {
            const type = document.getElementById('adType').value;
            const duration = document.getElementById('adDuration').value;
            const basePrice = PRICES[type][duration];
            finalPrice = basePrice;

            if (discountData) {
                const amt = parseFloat(discountData.discount_amount || 0);
                finalPrice = Math.max(0, basePrice - amt);
                document.getElementById('discountRow').hidden = false;
                document.getElementById('discountAmount').textContent = '-$' + amt.toFixed(2);
            } else {
                document.getElementById('discountRow').hidden = true;
            }
            document.getElementById('basePrice').textContent = '$' + basePrice.toFixed(2);
            document.getElementById('finalPrice').textContent = '$' + finalPrice.toFixed(2);
        }

        // â”€â”€ Discount â”€â”€
        async function applyDiscount() {
            const code = document.getElementById('discountCode').value.trim().toUpperCase();
            const msgEl = document.getElementById('discountMessage');
            if (!code) { msgEl.textContent = 'Please enter a code'; msgEl.style.color = '#ff0044'; return; }

            try {
                const { data, error } = await supabase.from('discount_codes').select('*').eq('code', code).single();
                if (error || !data) {
                    msgEl.textContent = 'âŒ Invalid code'; msgEl.style.color = '#ff0044';
                    discountData = null; updatePrice(); return;
                }
                if (data.max_uses && data.uses >= data.max_uses) {
                    msgEl.textContent = 'âŒ Code expired'; msgEl.style.color = '#ff0044';
                    discountData = null; updatePrice(); return;
                }
                discountData = data; updatePrice();
                msgEl.textContent = 'âœ“ Discount applied!'; msgEl.style.color = '#00ff88';
            } catch (err) {
                msgEl.textContent = 'âŒ Error applying code'; msgEl.style.color = '#ff0044';
                console.error(err);
            }
        }

        // â”€â”€ Validate â”€â”€
        function validateForm() {
            const title = document.getElementById('adTitle').value.trim();
            const link = document.getElementById('adLink').value.trim();
            const image = document.getElementById('adImage').files[0];
            if (!title || !link || !image) { alert('Please fill in all required fields'); return false; }
            return true;
        }

        // â”€â”€ Save to DB â”€â”€
        async function saveAdToDatabase(paymentMethod, paymentId) {
            try {
                const { data: { user } } = await supabase.auth.getUser();
                const adData = {
                    user_id: user?.id || null,
                    title: document.getElementById('adTitle').value.trim(),
                    link_url: document.getElementById('adLink').value.trim(),
                    ad_type: document.getElementById('adType').value,
                    duration_days: parseInt(document.getElementById('adDuration').value),
                    amount_paid: finalPrice,
                    payment_method: paymentMethod,
                    payment_id: paymentId,
                    status: 'pending',
                    created_at: new Date().toISOString(),
                    expires_at: new Date(Date.now() + parseInt(document.getElementById('adDuration').value) * 86400000).toISOString()
                };
                const { error } = await supabase.from('ads').insert(adData);
                if (error) {
                    console.error('DB error:', error);
                    alert('Payment successful but error saving ad. Contact support with ID: ' + paymentId);
                } else {
                    if (discountData) {
                        await supabase.from('discount_codes').update({ uses: (discountData.uses || 0) + 1 }).eq('code', discountData.code);
                    }
                    alert('âœ“ Payment successful! Your ad is pending approval. Payment ID: ' + paymentId);
                    window.location.href = 'index.html';
                }
            } catch (err) {
                console.error('Error:', err);
                alert('Payment successful but error occurred. Contact support.');
            }
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        //  PAYPAL - Load SDK dynamically with onload
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        (function loadPayPal() {
            var s = document.createElement('script');
            s.src = 'https://www.paypal.com/sdk/js?client-id=AWx0LwdZ_sCyCE5gEj9mL1ha7ZbG_eZLE_R636KjLXFMV1pOfmGwNg9prM5kVKQspvnpNLJDZxPp100G&currency=USD';

            s.onload = function() {
                console.log('âœ… PayPal SDK loaded');
                var loader = document.getElementById('pp-loading');
                if (loader) loader.remove();

                paypal.Buttons({
                    style: { layout: 'vertical', color: 'gold', shape: 'rect', label: 'paypal' },
                    createOrder: function(data, actions) {
                        if (!validateForm()) return Promise.reject(new Error('Validation failed'));
                        return actions.order.create({
                            purchase_units: [{
                                amount: { value: finalPrice.toFixed(2) },
                                description: 'Ad on 8BFR Music Network - ' + document.getElementById('adDuration').value + ' days'
                            }]
                        });
                    },
                    onApprove: function(data, actions) {
                        return actions.order.capture().then(async function(details) {
                            console.log('âœ… PayPal captured:', details.id);
                            await saveAdToDatabase('paypal', details.id);
                        });
                    },
                    onCancel: function() { console.log('PayPal cancelled'); },
                    onError: function(err) {
                        console.error('PayPal error:', err);
                        alert('Payment error. Please try again.');
                    }
                }).render('#paypal-button-container').then(function() {
                    console.log('âœ… PayPal buttons rendered');
                }).catch(function(err) {
                    console.error('PayPal render error:', err);
                    document.getElementById('paypal-button-container').innerHTML =
                        '<p style="color:#ff0044;text-align:center;">âŒ PayPal failed to render. <a href="javascript:location.reload()" style="color:#a855f7;text-decoration:underline;">Reload</a></p>';
                });
            };

            s.onerror = function() {
                console.error('âŒ PayPal SDK failed to load');
                document.getElementById('paypal-button-container').innerHTML =
                    '<p style="color:#ff0044;text-align:center;">âŒ PayPal failed to load. <a href="javascript:location.reload()" style="color:#a855f7;text-decoration:underline;">Reload</a></p>';
            };

            document.head.appendChild(s);
        })();

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        //  STRIPE CHECKOUT
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        document.getElementById('stripe-button').addEventListener('click', async function() {
            if (!validateForm()) return;

            var type = document.getElementById('adType').value;
            var duration = document.getElementById('adDuration').value;
            var priceId = STRIPE_PRICE_IDS[type + '_' + duration];

            if (!priceId) {
                alert(
                    'Stripe is not fully set up yet.\n\n' +
                    'To enable credit card payments:\n' +
                    '1. Go to Stripe Dashboard â†’ Products\n' +
                    '2. Create a product for each ad type + duration\n' +
                    '3. Copy each Price ID (price_XXXX) into the\n' +
                    '   STRIPE_PRICE_IDS object in buy-ad.html\n\n' +
                    'Please use PayPal for now!'
                );
                return;
            }

            this.disabled = true;
            this.textContent = 'â³ Redirecting to Stripe...';

            try {
                // Store ad info for after redirect
                localStorage.setItem('8bfr_pending_ad', JSON.stringify({
                    title: document.getElementById('adTitle').value.trim(),
                    link_url: document.getElementById('adLink').value.trim(),
                    ad_type: type,
                    duration_days: parseInt(duration),
                    amount_paid: finalPrice,
                    discount_code: discountData ? discountData.code : null
                }));

                var result = await stripe.redirectToCheckout({
                    lineItems: [{ price: priceId, quantity: 1 }],
                    mode: 'payment',
                    successUrl: window.location.origin + '/ad-success.html?session_id={CHECKOUT_SESSION_ID}',
                    cancelUrl: window.location.href
                });
                if (result.error) {
                    alert('Stripe error: ' + result.error.message);
                }
            } catch (err) {
                console.error('Stripe error:', err);
                alert('Error connecting to Stripe. Please try PayPal.');
            }

            this.disabled = false;
            this.textContent = 'ğŸ’³ Pay with Credit Card (Stripe)';
        });

        // â”€â”€ Init â”€â”€
        updatePrice();
    </script>
</body>
</html>
