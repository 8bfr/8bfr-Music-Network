<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Featured Artists ‚Äî 8BFR Music Network</title>
<link rel="icon" href="assets/images/favicon.png" />
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
  * { box-sizing: border-box; }
  body {
    background: linear-gradient(#0b0014, #000);
    color: #eae6ff;
    font-family: system-ui, -apple-system, sans-serif;
    margin: 0; padding: 0;
  }
  .header {
    background: rgba(15, 0, 30, 0.95);
    border-bottom: 1px solid rgba(124, 58, 237, 0.5);
    position: sticky; top: 0; z-index: 100;
    backdrop-filter: blur(12px);
  }
  .featured-badge {
    display: inline-block;
    background: linear-gradient(135deg, #f59e0b, #d97706);
    color: white; padding: 0.4rem 1rem; border-radius: 20px;
    font-size: 0.85rem; font-weight: 700; margin-bottom: 1rem;
  }
  .artist-card {
    background: rgba(12, 6, 24, 0.8);
    border: 1px solid rgba(124, 58, 237, 0.35);
    border-radius: 16px; padding: 1.5rem;
    transition: all 0.3s; position: relative; overflow: hidden;
  }
  .artist-card:hover {
    border-color: rgba(168, 85, 247, 0.6);
    box-shadow: 0 8px 32px rgba(124, 58, 237, 0.3);
  }
  .artist-avatar {
    width: 80px; height: 80px; border-radius: 50%;
    background: linear-gradient(135deg, #7c3aed, #a855f7);
    display: flex; align-items: center; justify-content: center;
    font-size: 2.5rem; margin: 0 auto 1rem;
    box-shadow: 0 4px 20px rgba(124, 58, 237, 0.4);
    overflow: hidden;
  }
  .artist-avatar img { width: 100%; height: 100%; object-fit: cover; }
  .artist-name {
    font-size: 1.2rem; font-weight: 700; text-align: center;
    margin-bottom: 0.5rem;
    display: flex; align-items: center; justify-content: center; gap: 0.4rem;
  }
  .verified-badge { color: #00d9ff; font-size: 1rem; }
  .artist-badges {
    display: flex; gap: 0.5rem; justify-content: center;
    flex-wrap: wrap; margin-bottom: 1rem;
  }
  .badge {
    padding: 0.3rem 0.75rem; border-radius: 20px; font-size: 0.75rem; font-weight: 600;
    background: rgba(124, 58, 237, 0.2); border: 1px solid rgba(124, 58, 237, 0.4); color: #a855f7;
  }
  .view-profile-btn {
    display: block; width: 100%; padding: 0.75rem;
    background: linear-gradient(135deg, #7c3aed, #a855f7);
    border: none; color: white; border-radius: 10px; font-weight: 600;
    cursor: pointer; transition: all 0.2s; text-align: center; text-decoration: none;
  }
  .view-profile-btn:hover {
    box-shadow: 0 4px 20px rgba(124, 58, 237, 0.5);
    transform: translateY(-2px);
  }
  .admin-panel {
    display: none;
    background: rgba(124, 58, 237, 0.08);
    border: 1px solid rgba(124, 58, 237, 0.35);
    border-radius: 14px; padding: 1.25rem 1.5rem; margin-bottom: 2rem;
  }
  .admin-panel h3 { margin: 0 0 1rem; font-size: 1rem; font-weight: 700; color: #a855f7; }
  .admin-panel-row { display: flex; gap: 0.75rem; align-items: center; flex-wrap: wrap; }
  .admin-select {
    flex: 1; min-width: 220px; padding: 0.6rem 0.9rem;
    border-radius: 9px; border: 1px solid rgba(124, 58, 237, 0.4);
    background: rgba(0,0,0,0.4); color: #eae6ff; font-size: 0.9rem; cursor: pointer;
  }
  .admin-select option { background: #1a0030; }
  .feature-btn {
    padding: 0.6rem 1.25rem;
    background: linear-gradient(135deg, #f59e0b, #d97706);
    border: none; border-radius: 9px; color: white; font-weight: 700;
    font-size: 0.9rem; cursor: pointer; transition: all 0.2s; white-space: nowrap;
  }
  .feature-btn:hover { opacity: 0.9; transform: translateY(-1px); }
  .admin-notice { margin-top: 0.6rem; font-size: 0.8rem; color: rgba(168,85,247,0.6); min-height: 1.2em; }
  .admin-controls { display: none; margin-top: 0.75rem; gap: 0.5rem; }
  .remove-btn {
    flex: 1; padding: 0.6rem; border: 1px solid rgba(239,68,68,0.5);
    border-radius: 8px; font-size: 0.85rem; font-weight: 600; cursor: pointer;
    background: rgba(239,68,68,0.2); color: #ef4444; transition: all 0.2s;
  }
  .remove-btn:hover { background: rgba(239,68,68,0.4); }
  .spinner {
    width: 40px; height: 40px; border-radius: 50%;
    border: 3px solid rgba(168,85,247,0.2); border-top-color: #a855f7;
    animation: spin 0.7s linear infinite; margin: 3rem auto;
  }
  @keyframes spin { to { transform: rotate(360deg); } }
  @media (max-width: 640px) { .artist-grid { grid-template-columns: 1fr !important; } }
</style>
</head>
<body>

<header class="header">
  <div class="max-w-6xl mx-auto px-4 py-4 flex items-center justify-between">
    <a href="index.html" style="color:#a855f7;text-decoration:none;font-weight:600;">‚Üê Home</a>
    <h1 style="font-size:1.25rem;font-weight:800;background:linear-gradient(135deg,#f59e0b,#d97706);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;">
      ‚≠ê Featured Artists
    </h1>
    <div style="width:80px;"></div>
  </div>
</header>

<main class="max-w-6xl mx-auto px-4 py-6">

  <div style="text-align:center;margin-bottom:2rem;">
    <div class="featured-badge">‚ú® HAND-PICKED BY 8BFR</div>
    <p style="color:#a855f7;opacity:0.8;font-size:0.95rem;">Exceptional talent selected by our team</p>
  </div>

  <!-- ADMIN PANEL -->
  <div class="admin-panel" id="adminPanel">
    <h3>‚öôÔ∏è Admin ‚Äî Manage Featured Artists</h3>
    <div class="admin-panel-row">
      <select class="admin-select" id="artistDropdown">
        <option value="">Loading artists‚Ä¶</option>
      </select>
      <button class="feature-btn" id="featureBtn" onclick="featureSelected()">‚≠ê Feature Artist</button>
    </div>
    <div class="admin-notice" id="adminNotice">Loading profiles from Supabase‚Ä¶</div>
  </div>

  <div id="loadingSpinner" style="display:none;"><div class="spinner"></div></div>
  <div id="statusMsg" style="display:none;background:rgba(124,58,237,0.15);border:1px solid rgba(124,58,237,0.4);border-radius:10px;padding:0.75rem 1rem;margin-bottom:1rem;font-size:0.85rem;color:#a855f7;"></div>

  <div id="featuredArtists" style="display:none;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:1.5rem;" class="artist-grid"></div>

  <div id="emptyState" style="display:none;text-align:center;padding:4rem 2rem;color:#a855f7;opacity:0.7;">
    <div style="font-size:4rem;margin-bottom:1rem;">‚≠ê</div>
    <div style="font-size:1.2rem;font-weight:600;margin-bottom:0.5rem;">No featured artists yet</div>
    <div style="font-size:0.9rem;">Check back soon for hand-picked talent!</div>
  </div>

  <div id="errorState" style="display:none;text-align:center;padding:3rem 2rem;color:#ef4444;opacity:0.8;">
    <div style="font-size:3rem;margin-bottom:1rem;">‚ö†Ô∏è</div>
    <div id="errorMsg" style="font-size:0.95rem;"></div>
  </div>

</main>

<script src="scripts.js?v=6" defer></script>

<script>
const SUPABASE_URL = 'https://novbuvwpjnxwwvdekjhr.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5vdmJ1dndwam54d3d2ZGVramhyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjExODkxODUsImV4cCI6MjA3Njc2NTE4NX0.1UUkdGafh6ZplAX8hi7Bvj94D2gvFQZUl0an1RvcSA0';
const { createClient } = window.supabase;
const db = createClient(SUPABASE_URL, SUPABASE_KEY);

// Cache so we only hit Supabase once per page load
let _roleCache = null;

async function getUserRole() {
  if (_roleCache !== null) return _roleCache;
  try {
    // getSession() reads from localStorage instantly ‚Äî no network call
    const { data: { session } } = await db.auth.getSession();
    const user = session?.user;
    if (!user) { _roleCache = ''; return ''; }

    const { data: profile, error } = await db
      .from('profiles')
      .select('role')
      .eq('user_id', user.id)
      .maybeSingle();

    if (error) { _roleCache = ''; return ''; }
    _roleCache = (profile?.role || '').toLowerCase().trim();
    return _roleCache;
  } catch(e) {
    _roleCache = '';
    return '';
  }
}

async function isAdmin() {
  const role = await getUserRole();
  return ['owner', 'admin', 'mod', 'moderator'].includes(role);
}

function logAdminAction(action, targetId) {
  try {
    const logs = JSON.parse(localStorage.getItem('admin_activity_log') || '[]');
    logs.push({ action, targetId, targetType: 'artist',
      performedBy: localStorage.getItem('username') || 'Admin',
      timestamp: Date.now() });
    if (logs.length > 1000) logs.shift();
    localStorage.setItem('admin_activity_log', JSON.stringify(logs));
    const notifs = JSON.parse(localStorage.getItem('owner_notifications') || '[]');
    notifs.push({ type: 'admin_action', action, targetId, targetType: 'artist',
      performedBy: localStorage.getItem('username'), timestamp: Date.now(), read: false });
    localStorage.setItem('owner_notifications', JSON.stringify(notifs));
  } catch(e) {}
}

function showNotice(msg, type) {
  const el = document.getElementById('adminNotice');
  el.textContent = msg;
  el.style.color = type === 'success' ? '#4ade80' : type === 'warn' ? '#f59e0b' : 'rgba(168,85,247,0.6)';
}

async function populateDropdown(currentlyFeatured) {
  const dropdown = document.getElementById('artistDropdown');
  dropdown.innerHTML = '<option value="">Loading‚Ä¶</option>';
  try {
    const { data: profiles, error } = await db
      .from('profiles')
      .select('user_id, username, display_name, role, badges')
      .or('role.eq.artist,role.eq.beatmaker,role.eq.songwriter,badges.cs.{artist},badges.cs.{beatmaker}')
      .order('username', { ascending: true });

    if (error) throw error;

    if (!profiles || profiles.length === 0) {
      dropdown.innerHTML = '<option value="" disabled>No profiles found in database</option>';
      showNotice('No profiles found in Supabase profiles table.', 'warn');
      return;
    }

    const featuredIds = new Set((currentlyFeatured || []).map(p => p.user_id));
    const validProfiles = profiles.filter(p => p.user_id && p.user_id !== 'null');
    const skipped = profiles.length - validProfiles.length;
    dropdown.innerHTML = '<option value="">‚Äî Select an artist to feature ‚Äî</option>';
    // Only include profiles that have a valid user_id
    validProfiles.forEach(p => {
      const name = p.display_name || p.username || p.user_id;
      const already = featuredIds.has(p.user_id);
      const opt = document.createElement('option');
      opt.value = p.user_id;
      opt.textContent = already ? ('‚≠ê ' + name + ' (already featured)') : name;
      if (already) opt.style.color = '#f59e0b';
      dropdown.appendChild(opt);
    });
    const skipNote = skipped > 0 ? ' (' + skipped + ' skipped ‚Äî no user_id)' : '';
    showNotice(validProfiles.length + ' profile(s)' + skipNote + ' ¬∑ ' + featuredIds.size + ' currently featured', 'info');
  } catch (err) {
    dropdown.innerHTML = '<option value="" disabled>Error loading profiles</option>';
    showNotice('Error: ' + (err.message || err), 'warn');
  }
}

async function featureSelected() {
  const dropdown = document.getElementById('artistDropdown');
  const userId = dropdown.value;
  if (!userId || userId === 'null' || userId.length < 10) { 
    showNotice('Please select a valid profile.', 'warn'); return; 
  }

  const btn = document.getElementById('featureBtn');
  btn.disabled = true; btn.textContent = 'Saving‚Ä¶';

  try {
    const { data: existing } = await db.from('featured_content')
      .select('id').eq('content_type', 'artist').eq('content_id', userId).maybeSingle();

    if (existing) {
      showNotice('This artist is already featured!', 'warn');
      btn.disabled = false; btn.textContent = '‚≠ê Feature Artist';
      return;
    }

    const { error } = await db.from('featured_content').insert({
      content_type: 'artist',
      content_id: userId
    });

    if (error) throw error;
    logAdminAction('featured_add', userId);
    showNotice('‚≠ê Artist added to featured!', 'success');
    await loadFeaturedArtists();
  } catch (err) {
    showNotice('Error: ' + (err.message || err), 'warn');
  } finally {
    btn.disabled = false; btn.textContent = '‚≠ê Feature Artist';
  }
}

async function removeFeatured(userId) {
  if (!confirm('Remove this artist from featured?')) return;
  try {
    const { error } = await db.from('featured_content')
      .delete().eq('content_type', 'artist').eq('content_id', userId);
    if (error) throw error;
    logAdminAction('featured_remove', userId);
    await loadFeaturedArtists();
  } catch (err) {
    alert('Error removing: ' + (err.message || err));
  }
}

async function loadFeaturedArtists() {
  const spinner = document.getElementById('loadingSpinner');
  const grid    = document.getElementById('featuredArtists');
  const empty   = document.getElementById('emptyState');
  const errEl   = document.getElementById('errorState');

  const statusEl = document.getElementById('statusMsg');
  function setStatus(msg) {
    statusEl.style.display = 'block';
    statusEl.textContent = msg;
  }

  spinner.style.display = 'block';
  grid.style.display = 'none';
  empty.style.display = 'none';
  errEl.style.display = 'none';

  // Check admin status from Supabase ‚Äî runs in parallel, doesn't block artists loading
  const adminMode = await isAdmin();
  setStatus('Step 1: Checking session‚Ä¶ ' + (adminMode ? '‚úÖ Admin' : 'üë§ Not admin / not logged in'));

  try { // main try ‚Äî spinner is ALWAYS hidden in finally below
    setStatus('Step 2: Loading featured_content rows‚Ä¶');
    const { data: featured, error: featError } = await db
      .from('featured_content')
      .select('content_id')
      .eq('content_type', 'artist')
      .order('created_at', { ascending: false });

    if (featError) throw new Error('featured_content query failed: ' + featError.message);

    setStatus('Step 3: Got ' + (featured?.length || 0) + ' featured rows. IDs: ' + (featured?.map(f=>f.content_id?.substring(0,8)+'‚Ä¶').join(', ') || 'none'));

    if (!featured || featured.length === 0) {
      empty.style.display = 'block';
      if (adminMode) populateDropdown([]);
      return;
    }

    setStatus('Step 4: Loading profiles for those IDs‚Ä¶');
    const { data: profiles, error: profError } = await db
      .from('profiles')
      .select('user_id, username, display_name, bio, badges, avatar_url, role, verified_artist')
      .in('user_id', featured.map(f => f.content_id))
      .or('role.eq.artist,role.eq.beatmaker,role.eq.songwriter,badges.cs.{artist},badges.cs.{beatmaker}');

    if (profError) throw new Error('profiles query failed: ' + profError.message);

    setStatus('Step 5: Got ' + (profiles?.length || 0) + ' matching profiles.');

    if (adminMode) populateDropdown(profiles || []);

    if (!profiles || profiles.length === 0) {
      setStatus('‚ö†Ô∏è featured_content has ' + featured.length + ' rows but no matching profiles.user_id found. Check that content_id values match profiles.user_id exactly.');
      empty.style.display = 'block';
      return;
    }
    
    statusEl.style.display = 'none';

    const badgeEmoji = { artist:'üé§', beatmaker:'üéöÔ∏è', songwriter:'‚úçÔ∏è', verified:'‚úì', founder:'üëë' };

    grid.innerHTML = profiles.map(p => {
      const name = p.display_name || p.username || 'Unknown Artist';
      const badges = Array.isArray(p.badges) ? p.badges : [];
      const badgesHTML = badges.map(b =>
        '<span class="badge">' + (badgeEmoji[b] || '') + ' ' + b.toUpperCase() + '</span>'
      ).join('');
      const avatarInner = p.avatar_url
        ? '<img src="' + p.avatar_url + '" alt="' + name + '" onerror="this.parentNode.textContent=&#39;üéµ&#39;">'
        : 'üéµ';

      return '<div class="artist-card">' +
        '<div class="artist-avatar">' + avatarInner + '</div>' +
        '<div class="artist-name">' + name + (p.verified_artist ? '<span class="verified-badge">‚úì</span>' : '') + '</div>' +
        (badgesHTML ? '<div class="artist-badges">' + badgesHTML + '</div>' : '') +
        (p.bio ? '<div style="text-align:center;font-size:0.9rem;color:#a855f7;opacity:0.8;margin-bottom:1rem;line-height:1.5;">' + p.bio + '</div>' : '') +
        '<a href="profile.html?id=' + encodeURIComponent(p.user_id) + '" class="view-profile-btn">üë§ View Profile</a>' +
        (adminMode ? '<div class="admin-controls" style="display:flex;"><button class="remove-btn" onclick="removeFeatured(&quot;' + p.user_id + '&quot;)">‚ùå Remove Featured</button></div>' : '') +
        '</div>';
    }).join('');

    grid.style.display = 'grid';

  } catch (err) {
    document.getElementById('errorMsg').textContent = 'Could not load featured artists: ' + (err.message || err);
    errEl.style.display = 'block';
    console.error('Featured artists error:', err);
  } finally {
    spinner.style.display = 'none';
  }
}

document.addEventListener('DOMContentLoaded', function() {
  // Load artists immediately ‚Äî don't wait for role check
  loadFeaturedArtists();
  
  // Check admin role in parallel ‚Äî shows panel when ready
  isAdmin().then(adminMode => {
    if (adminMode) document.getElementById('adminPanel').style.display = 'block';
  });
});

window.addEventListener('load', function() {
  setTimeout(function() {
    ['bubbleStack','bubble-top-single','carrieWrap','carrieBubble','carrieToggleBar'].forEach(id => {
      const el = document.getElementById(id); if (el) el.style.display = 'none';
    });
    ['.bubble-stack','.floating-bubbles','.carrie-bubble','.bubble-container'].forEach(cls => {
      document.querySelectorAll(cls).forEach(el => el.style.display = 'none');
    });
    document.querySelectorAll('[data-bubble],[data-role="carrie"],[data-carrie]').forEach(el => el.style.display = 'none');
  }, 300);
});
</script>

<script>
(function() {
  const toggleBtn = document.createElement('button');
  toggleBtn.id = 'avatarToggle';
  toggleBtn.innerHTML = 'üëÅÔ∏è';
  toggleBtn.title = 'Toggle Avatar/Bubbles';
  toggleBtn.style.cssText = 'position:fixed;top:80px;right:20px;z-index:9999;background:rgba(124,58,237,0.9);border:2px solid rgba(124,58,237,1);color:white;width:50px;height:50px;border-radius:50%;cursor:pointer;font-size:24px;display:flex;align-items:center;justify-content:center;box-shadow:0 4px 12px rgba(124,58,237,0.5);transition:all 0.3s ease;';
  toggleBtn.addEventListener('mouseenter', function() { this.style.transform = 'scale(1.1)'; });
  toggleBtn.addEventListener('mouseleave', function() { this.style.transform = 'scale(1)'; });
  document.body.appendChild(toggleBtn);
  let isHidden = localStorage.getItem('hideAvatarBubbles') === 'true';
  function updateVisibility() {
    [document.getElementById('homeAvatarSwitcher'),
     ...document.querySelectorAll('[id*="bubble"]'),
     ...document.querySelectorAll('[class*="bubble"]'),
     ...document.querySelectorAll('[id*="avatar"][id*="switcher"]')
    ].forEach(el => { if (el) el.style.display = isHidden ? 'none' : ''; });
    toggleBtn.innerHTML = isHidden ? 'üëÅÔ∏è‚Äçüó®Ô∏è' : 'üëÅÔ∏è';
    toggleBtn.title = isHidden ? 'Show Avatar/Bubbles' : 'Hide Avatar/Bubbles';
  }
  toggleBtn.addEventListener('click', function() {
    isHidden = !isHidden;
    localStorage.setItem('hideAvatarBubbles', isHidden);
    updateVisibility();
  });
  updateVisibility();
})();
</script>

</body>
</html>
