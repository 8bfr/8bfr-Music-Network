<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Settings - 8BFR Music Network</title>
  <link rel="stylesheet" href="styles.css">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2" defer></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { padding-bottom: 80px; background: linear-gradient(#0b0014,#000); color: #eae6ff; font-family: system-ui, -apple-system, sans-serif; }
    .card { background: rgba(12,6,24,0.7); border: 1px solid rgba(124,58,237,0.3); border-radius: 12px; padding: 1.5rem; margin-bottom: 1.5rem; }
    .form-group { margin-bottom: 1.5rem; }
    label { display: block; font-size: 0.9rem; color: #a855f7; margin-bottom: 0.5rem; font-weight: 600; }
    input { width: 100%; padding: 0.75rem; background: #0b0014; border: 1px solid rgba(124,58,237,0.4); border-radius: 8px; color: #eae6ff; font-size: 0.95rem; }
    .btn { background: #7c3aed; color: white; border: none; padding: 0.75rem 2rem; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 0.95rem; }
    .btn:hover { background: #6d28d9; }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; }
  </style>
</head>
<body>

  <header class="px-4 py-4" style="background:rgba(15,0,30,0.9);border-bottom:1px solid rgba(124,58,237,0.5);position:sticky;top:0;z-index:100;">
    <div class="max-w-4xl mx-auto flex items-center justify-between">
      <a href="profile.html" style="color:#a855f7;font-weight:600;text-decoration:none;">‚Üê Profile</a>
      <h1 class="text-xl font-extrabold">‚öôÔ∏è Settings</h1>
      <div style="width:80px;"></div>
    </div>
  </header>

  <div class="max-w-4xl mx-auto px-4 mt-5">
    
    <!-- PAYMENT SETTINGS -->
    <div class="card">
      <h2 style="font-size:1.25rem;font-weight:700;margin-bottom:1.5rem;color:#a855f7;">üí≥ Payment Settings</h2>
      
      <div class="card" style="background:rgba(124,58,237,0.1);border-color:rgba(124,58,237,0.4);margin-bottom:1.5rem;">
        <p style="font-size:0.9rem;line-height:1.6;color:rgba(234,230,255,0.9);">
          <strong>‚ö†Ô∏è REQUIRED for selling songs:</strong> Add your PayPal email below. Buyers will send payments directly to YOUR PayPal (you receive 100%).<br>
          <strong>Your responsibility:</strong> Send 20% platform fee to <code style="background:rgba(0,0,0,0.3);padding:0.25rem 0.5rem;border-radius:4px;">8bfr.music@gmail.com</code> after each sale.
        </p>
      </div>

      <form id="settingsForm" onsubmit="saveSettings(event)">
        <div class="form-group">
          <label>PayPal Email *</label>
          <input type="email" id="paypalEmail" placeholder="your.email@example.com" required>
          <p style="font-size:0.8rem;color:rgba(168,85,247,0.7);margin-top:0.5rem;">
            Buyers will see this and send payment here. Make sure it's correct!
          </p>
        </div>

        <button type="submit" class="btn" id="saveBtn">Save Settings</button>
        <p id="saveNotice" style="margin-top:1rem;font-size:0.9rem;text-align:center;"></p>
      </form>
    </div>

  </div>

  <script src="scripts.js" defer></script>
  
  <script>
  document.addEventListener('DOMContentLoaded', async function() {
    const SUPABASE_URL = 'https://novbuvwpjnxwwvdekjhr.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5vdmJ1dndwam54d3d2ZGVramhyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjExODkxODUsImV4cCI6MjA3Njc2NTE4NX0.1UUkdGafh6ZplAX8hi7Bvj94D2gvFQZUl0an1RvcSA0';
    
    let db;
    if (window._8bfrSupabaseClient) {
      db = window._8bfrSupabaseClient;
    } else if (window.supabase && window.supabase.createClient) {
      db = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    } else {
      alert('Supabase failed to load');
      return;
    }

    let currentUser = null;

    try {
      const { data: { session } } = await db.auth.getSession();
      if (!session || !session.user) {
        window.location.href = 'login.html';
        return;
      }

      currentUser = session.user;

      // Load current settings
      const { data: profile } = await db.from('profiles')
        .select('paypal_email')
        .eq('user_id', currentUser.id)
        .single();

      if (profile && profile.paypal_email) {
        document.getElementById('paypalEmail').value = profile.paypal_email;
      }

    } catch (err) {
      console.error('Init error:', err);
      alert('Error: ' + err.message);
    }

    window.saveSettings = async function(e) {
      e.preventDefault();
      
      const paypalEmail = document.getElementById('paypalEmail').value.trim();
      const notice = document.getElementById('saveNotice');
      const saveBtn = document.getElementById('saveBtn');

      if (!paypalEmail) {
        notice.textContent = '‚ö†Ô∏è PayPal email is required';
        notice.style.color = '#ef4444';
        return;
      }

      try {
        saveBtn.disabled = true;
        saveBtn.textContent = 'Saving...';

        const { error } = await db.from('profiles')
          .update({ paypal_email: paypalEmail })
          .eq('user_id', currentUser.id);

        if (error) throw error;

        notice.textContent = '‚úì Settings saved!';
        notice.style.color = '#4ade80';
        saveBtn.textContent = 'Save Settings';
        saveBtn.disabled = false;

        setTimeout(() => {
          notice.textContent = '';
        }, 3000);

      } catch (err) {
        console.error('Save error:', err);
        notice.textContent = '‚ùå Error: ' + err.message;
        notice.style.color = '#ef4444';
        saveBtn.textContent = 'Save Settings';
        saveBtn.disabled = false;
      }
    };
  });
  </script>

</body>
</html>
