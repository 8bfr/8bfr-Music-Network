<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Messages ‚Äî 8BFR</title>
<link rel="icon" href="assets/images/favicon.png">
<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Work+Sans:wght@300;400;600;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
:root{--primary:#7c3aed;--dark:#0b0014;--card:#0c0618;--text:#eae6ff;--dim:#a855f7;--border:rgba(124,58,237,.35);}
*{margin:0;padding:0;box-sizing:border-box;}
body{font-family:'Work Sans',sans-serif;background:linear-gradient(#0b0014,#000);color:var(--text);min-height:100vh;}
.header{background:rgba(15,0,30,.95);border-bottom:2px solid var(--primary);padding:1rem 1.5rem;display:flex;justify-content:space-between;align-items:center;position:sticky;top:0;z-index:100;}
.header h1{font-family:'Bebas Neue',cursive;font-size:1.5rem;color:var(--primary);}
.container{max-width:800px;margin:0 auto;padding:1.5rem;}
.tabs{display:flex;gap:.5rem;margin-bottom:1.5rem;flex-wrap:wrap;}
.tab{padding:.5rem 1rem;border-radius:8px;border:1px solid var(--border);background:rgba(124,58,237,.08);color:var(--dim);cursor:pointer;font-size:.85rem;font-weight:600;transition:all .15s;}
.tab:hover{background:rgba(124,58,237,.15);}
.tab.active{background:var(--primary);color:#fff;border-color:var(--primary);}
.tab .badge{background:rgba(239,68,68,.8);color:#fff;font-size:.65rem;padding:.1rem .35rem;border-radius:10px;margin-left:.3rem;}
.card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:1.25rem;margin-bottom:1rem;transition:border-color .15s;}
.card:hover{border-color:var(--primary);}
.card-header{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:.5rem;}
.card-title{font-weight:700;font-size:.95rem;}
.card-time{font-size:.7rem;color:rgba(234,230,255,.35);}
.card-body{font-size:.88rem;color:var(--dim);line-height:1.6;}
.card-quote{background:rgba(124,58,237,.06);border-left:3px solid var(--primary);padding:.4rem .6rem;border-radius:0 6px 6px 0;margin:.5rem 0;font-size:.82rem;}
.card-actions{display:flex;gap:.5rem;margin-top:.75rem;flex-wrap:wrap;}
.btn-sm{padding:.35rem .7rem;border-radius:6px;border:none;cursor:pointer;font-size:.8rem;font-weight:600;transition:all .15s;}
.btn-primary{background:var(--primary);color:#fff;}.btn-primary:hover{background:#6d28d9;}
.btn-outline{background:rgba(124,58,237,.1);border:1px solid var(--border);color:var(--text);}.btn-outline:hover{background:rgba(124,58,237,.2);}
.btn-success{background:rgba(34,197,94,.8);color:#fff;}.btn-success:hover{background:rgba(34,197,94,1);}
.btn-danger{background:rgba(239,68,68,.8);color:#fff;}.btn-danger:hover{background:rgba(239,68,68,1);}
.status-badge{display:inline-block;font-size:.65rem;padding:.15rem .4rem;border-radius:4px;font-weight:600;text-transform:uppercase;}
.status-pending{background:rgba(245,158,11,.2);color:#f59e0b;border:1px solid rgba(245,158,11,.4);}
.status-reviewed{background:rgba(59,130,246,.2);color:#3b82f6;border:1px solid rgba(59,130,246,.4);}
.status-action{background:rgba(239,68,68,.2);color:#ef4444;border:1px solid rgba(239,68,68,.4);}
.status-dismissed{background:rgba(107,114,128,.2);color:#6b7280;border:1px solid rgba(107,114,128,.4);}
.empty{text-align:center;padding:3rem;color:var(--dim);}
.empty div{font-size:3rem;margin-bottom:.75rem;}
.links-row{display:flex;gap:1rem;margin-bottom:1.5rem;flex-wrap:wrap;}
.link-card{flex:1;min-width:150px;background:var(--card);border:1px solid var(--border);border-radius:12px;padding:1rem;text-align:center;text-decoration:none;color:var(--text);transition:all .2s;}
.link-card:hover{border-color:var(--primary);transform:translateY(-2px);}
.link-card .icon{font-size:1.5rem;margin-bottom:.3rem;}
.link-card .label{font-size:.85rem;font-weight:600;color:var(--primary);}
</style>
</head>
<body>
<div class="header">
  <a href="index.html" style="color:var(--dim);text-decoration:none;font-weight:600;">‚Üê Home</a>
  <h1>üì¨ Messages</h1>
  <span></span>
</div>

<div class="container">
  <!-- Quick links -->
  <div class="links-row">
    <a href="dm.html" class="link-card">
      <div class="icon">‚úâÔ∏è</div>
      <div class="label">Direct Messages</div>
    </a>
    <a href="chatroom.html" class="link-card">
      <div class="icon">üí¨</div>
      <div class="label">Community Chat</div>
    </a>
  </div>

  <!-- Tabs (owner sees Reports, everyone sees Notifications) -->
  <div class="tabs" id="tabs"></div>

  <!-- Content -->
  <div id="content"></div>
</div>

<script src="scripts.js" defer></script>
<script>
const SUPABASE_URL='https://novbuvwpjnxwwvdekjhr.supabase.co';
const SUPABASE_ANON='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5vdmJ1dndwam54d3d2ZGVramhyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjExODkxODUsImV4cCI6MjA3Njc2NTE4NX0.1UUkdGafh6ZplAX8hi7Bvj94D2gvFQZUl0an1RvcSA0';
const db=window.supabase.createClient(SUPABASE_URL,SUPABASE_ANON);
const OWNER_ID='cb556180-f032-4b21-9470-1d786f2664ab';

let currentUser=null;
let isOwner=false;
let activeTab='notifications';
let reports=[];
let pendingCount=0;

async function init(){
  const{data:{session}}=await db.auth.getSession();
  if(!session){location.href='login.html?return=messages.html';return;}
  currentUser=session.user;
  isOwner=currentUser.id===OWNER_ID;

  // Check profile role too
  const{data:profile}=await db.from('profiles').select('role').eq('user_id',currentUser.id).single();
  if(profile&&profile.role==='owner')isOwner=true;

  buildTabs();
  loadTab(activeTab);
}

function buildTabs(){
  const tabs=document.getElementById('tabs');
  let html='<div class="tab active" data-tab="notifications" onclick="loadTab(\'notifications\')">üîî Notifications</div>';
  html+='<div class="tab" data-tab="dms" onclick="loadTab(\'dms\')">‚úâÔ∏è Recent DMs</div>';
  if(isOwner){
    html+='<div class="tab" data-tab="reports" onclick="loadTab(\'reports\')">üö© Reports <span class="badge" id="reportBadge" style="display:none;">0</span></div>';
  }
  tabs.innerHTML=html;

  // Load report count
  if(isOwner)loadReportCount();
}

async function loadReportCount(){
  const{count}=await db.from('message_reports').select('*',{count:'exact',head:true}).eq('status','pending');
  pendingCount=count||0;
  const badge=document.getElementById('reportBadge');
  if(badge){
    if(pendingCount>0){badge.style.display='inline';badge.textContent=pendingCount;}
    else badge.style.display='none';
  }
}

function loadTab(tab){
  activeTab=tab;
  document.querySelectorAll('.tab').forEach(t=>{
    t.classList.toggle('active',t.dataset.tab===tab);
  });
  if(tab==='notifications')loadNotifications();
  else if(tab==='dms')loadRecentDMs();
  else if(tab==='reports')loadReports();
}

// NOTIFICATIONS (placeholder for now - could be follow notifications, purchase alerts, etc.)
function loadNotifications(){
  const box=document.getElementById('content');
  box.innerHTML='<div class="empty"><div>üîî</div><h3>No notifications yet</h3><p style="font-size:.85rem;color:var(--dim);">You\'ll see follow alerts, purchase notifications, and system messages here.</p></div>';
}

// RECENT DMs summary
async function loadRecentDMs(){
  const box=document.getElementById('content');
  box.innerHTML='<div style="text-align:center;padding:2rem;color:var(--dim);">Loading...</div>';

  const{data}=await db.from('direct_messages')
    .select('id,sender_id,receiver_id,message,is_read,created_at')
    .or('sender_id.eq.'+currentUser.id+',receiver_id.eq.'+currentUser.id)
    .order('created_at',{ascending:false})
    .limit(50);

  if(!data||data.length===0){
    box.innerHTML='<div class="empty"><div>‚úâÔ∏è</div><h3>No messages yet</h3><p style="font-size:.85rem;">Start a conversation in <a href="dm.html" style="color:var(--primary);">Direct Messages</a></p></div>';
    return;
  }

  // Group by partner, show latest
  const seen={};
  const recent=[];
  data.forEach(dm=>{
    const pid=dm.sender_id===currentUser.id?dm.receiver_id:dm.sender_id;
    if(!seen[pid]){seen[pid]=true;recent.push({...dm,partnerId:pid});}
  });

  // Get profiles
  const pids=recent.map(r=>r.partnerId);
  const{data:profiles}=await db.from('profiles').select('user_id,username,display_name,avatar_url').in('user_id',pids);
  const pMap={};
  if(profiles)profiles.forEach(p=>pMap[p.user_id]=p);

  box.innerHTML=recent.slice(0,20).map(r=>{
    const p=pMap[r.partnerId]||{username:'user',display_name:'User'};
    const isSent=r.sender_id===currentUser.id;
    const unread=!isSent&&!r.is_read?' <span style="color:var(--primary);font-weight:700;">‚óè NEW</span>':'';
    return '<div class="card" style="cursor:pointer;" onclick="location.href=\'dm.html?user='+r.partnerId+'\'">'+
      '<div class="card-header"><div class="card-title">'+(p.display_name||p.username)+unread+'</div><div class="card-time">'+timeAgo(r.created_at)+'</div></div>'+
      '<div class="card-body">'+(isSent?'You: ':'')+esc(r.message.substring(0,100))+'</div></div>';
  }).join('');
}

// REPORTS (owner only)
async function loadReports(){
  const box=document.getElementById('content');
  box.innerHTML='<div style="text-align:center;padding:2rem;color:var(--dim);">Loading reports...</div>';

  const{data,error}=await db.from('message_reports').select('*').order('created_at',{ascending:false}).limit(50);
  if(error){box.innerHTML='<div class="card">Error loading reports.</div>';return;}
  if(!data||data.length===0){
    box.innerHTML='<div class="empty"><div>‚úÖ</div><h3>No reports</h3><p style="font-size:.85rem;color:var(--dim);">All clear! No messages have been reported.</p></div>';
    return;
  }
  reports=data;

  // Get reporter + reported profiles
  const userIds=[...new Set(data.flatMap(r=>[r.reporter_id,r.reported_user_id]))];
  const{data:profiles}=await db.from('profiles').select('user_id,username,display_name').in('user_id',userIds);
  const pMap={};
  if(profiles)profiles.forEach(p=>pMap[p.user_id]=p);

  box.innerHTML=data.map(r=>{
    const reporter=pMap[r.reporter_id]||{username:'unknown'};
    const reported=pMap[r.reported_user_id]||{username:'unknown'};
    const statusClass='status-'+r.status;
    const source=r.message_source==='dm'?'DM':'Chat Room';

    let actions='';
    if(r.status==='pending'){
      actions='<button class="btn-sm btn-success" onclick="updateReport(\''+r.id+'\',\'reviewed\')">‚úÖ Mark Reviewed</button>'+
        '<button class="btn-sm btn-danger" onclick="updateReport(\''+r.id+'\',\'action_taken\')">‚ö° Action Taken</button>'+
        '<button class="btn-sm btn-outline" onclick="updateReport(\''+r.id+'\',\'dismissed\')">Dismiss</button>';
    }

    return '<div class="card">'+
      '<div class="card-header">'+
        '<div class="card-title">üö© Report ‚Äî '+esc(reported.display_name||reported.username)+'</div>'+
        '<div><span class="status-badge '+statusClass+'">'+r.status+'</span></div>'+
      '</div>'+
      '<div class="card-body">'+
        '<div style="font-size:.78rem;color:rgba(234,230,255,.4);margin-bottom:.5rem;">'+
          'Reported by: <strong>'+(reporter.display_name||reporter.username)+'</strong> ‚Ä¢ Source: '+source+' ‚Ä¢ '+timeAgo(r.created_at)+
        '</div>'+
        '<div class="card-quote">"'+esc(r.message_text)+'"</div>'+
        (r.reason?'<div style="margin-top:.4rem;"><strong>Reason:</strong> '+esc(r.reason)+'</div>':'')+
      '</div>'+
      '<div class="card-actions">'+actions+
        '<button class="btn-sm btn-outline" onclick="location.href=\'dm.html?user='+r.reported_user_id+'\'">Message User</button>'+
        '<button class="btn-sm btn-danger" onclick="banFromReport(\''+r.reported_user_id+'\',\''+(reported.display_name||reported.username)+'\')">üö´ Ban User</button>'+
      '</div></div>';
  }).join('');
}

async function updateReport(reportId,status){
  await db.from('message_reports').update({status:status,reviewed_by:currentUser.id,reviewed_at:new Date().toISOString()}).eq('id',reportId);
  loadReports();
  loadReportCount();
}

async function banFromReport(userId,username){
  if(!confirm('Ban '+username+' from community chat?'))return;
  await db.from('chatroom_bans').insert({user_id:userId,banned_by:currentUser.id,reason:'Banned after report review',ban_type:'permanent'});
  alert(username+' has been banned.');
}

function esc(s){const d=document.createElement('div');d.textContent=s;return d.innerHTML;}
function timeAgo(d){const s=Math.floor((Date.now()-new Date(d))/1000);if(s<60)return'just now';if(s<3600)return Math.floor(s/60)+'m ago';if(s<86400)return Math.floor(s/3600)+'h ago';return Math.floor(s/86400)+'d ago';}

init();
</script>

<!-- Safe avatar toggle -->
<script>
(function(){var b=document.createElement('button');b.innerHTML='üëÅÔ∏è';b.style.cssText='position:fixed;top:80px;right:20px;z-index:9999;background:rgba(124,58,237,0.9);border:2px solid rgba(124,58,237,1);color:white;width:50px;height:50px;border-radius:50%;cursor:pointer;font-size:24px;display:flex;align-items:center;justify-content:center;box-shadow:0 4px 12px rgba(124,58,237,0.5);';document.body.appendChild(b);var h=localStorage.getItem('hideAvatarBubbles')==='true';function u(){document.querySelectorAll('[id*="bubble"],[class*="bubble"],[id*="avatar"][id*="switcher"]').forEach(function(el){if(el)el.style.display=h?'none':'';});b.innerHTML=h?'üëÅÔ∏è‚Äçüó®Ô∏è':'üëÅÔ∏è';}b.addEventListener('click',function(){h=!h;localStorage.setItem('hideAvatarBubbles',h);u();});u();})();
</script>
</body>
</html>
